<!DOCTYPE html>

<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Edificios Escolares - UABC</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            /* Paleta Principal */
            --negro: #121212;
            --negro-claro: #1E1E1E;
            --verde-oscuro: #2E7D32;
            --verde-medio: #4CAF50;
            --verde-claro: #81C784;
            --amarillo-oscuro: #F57F17;
            --amarillo-medio: #FFC107;
            --amarillo-claro: #FFE082;
            --gris-claro: #E0E0E0;
            --gris-texto: #BDBDBD;
            --disponible: #4CAF50;
            --ocupado: #FFC107;
            --accesible: #FF9800;
            --error: #f44336;
            --virtual: #9c27b0;
            --blanco: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--negro) 0%, var(--verde-oscuro) 100%);
            min-height: 100vh;
            color: var(--blanco);
            overflow-x: hidden;
        }

        .principal-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .principal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 30px;
            background-color: #0d1a0d;
            /* Fondo verde muy oscuro como en la imagen */
            border-bottom: 2px solid #1a331a;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: var(--gris-claro);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s;
            display: block;
        }

        .menu-toggle:hover {
            color: var(--verde-claro);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .header-logos {
            display: flex;
            align-items: center;
        }

        .logo-uabc-fca {
            height: 50px;
            width: auto;
        }

        .header-info {
            display: flex;
            flex-direction: column;
        }

        .system-title {
            font-size: 18px;
            font-weight: 700;
            color: #afffa4;
            /* Verde claro vibrante */
        }

        .faculty-name {
            font-size: 12px;
            color: var(--gris-texto);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--verde-medio);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: #5d251f;
            /* Rojo oscuro cálido como en la imagen */
            border: 1px solid #7a3129;
            border-radius: 5px;
            color: #fbd5d5;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background: var(--verde-medio);
            color: white;
        }

        .main-layout {
            flex: 1;
            display: flex;
            position: relative;
        }

        .sidebar {
            width: 250px;
            background-color: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            left: 0;
            top: 0;
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .sidebar-logo {
            width: 120px;
            height: auto;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--verde-claro);
            text-align: center;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--gris-texto);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .sidebar-link:hover {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--gris-claro);
            border-left-color: var(--verde-medio);
        }

        .sidebar-link.active {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--verde-claro);
            border-left-color: var(--verde-medio);
        }

        .sidebar-link i {
            width: 24px;
            font-size: 18px;
            margin-right: 15px;
        }

        .sidebar-link span {
            font-size: 16px;
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 30px;
            max-width: calc(100% - 250px);
            transition: all 0.3s ease;
        }

        .sidebar-collapsed .sidebar {
            left: -250px;
        }

        .sidebar-collapsed .main-content {
            margin-left: 0;
            max-width: 100%;
        }

        #content-section {
            min-height: 400px;
        }

        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--gris-claro);
            text-shadow: 0 0 10px rgba(3, 169, 244, 0.3);
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--gris-texto);
            max-width: 600px;
            margin: 0 auto;
        }

        .section-header {
            margin-bottom: 30px;
        }

        .section-header h1 {
            font-size: 28px;
            color: var(--verde-claro);
            margin-bottom: 10px;
        }

        .section-header p {
            color: var(--gris-texto);
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .dashboard-card {
            background-color: rgba(30, 30, 30, 0.7);
            border-radius: 12px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s;
            border: 1px solid rgba(79, 209, 197, 0.2);
        }

        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--verde-oscuro), var(--verde-medio));
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }

        .card-content h3 {
            font-size: 24px;
            margin-bottom: 5px;
            color: var(--verde-claro);
        }

        .card-content p {
            color: var(--gris-texto);
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            flex: 1;
            min-width: 250px;
        }

        .search-bar input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--gris-texto);
            border-radius: 5px;
            background-color: var(--negro-claro);
            color: var(--gris-claro);
            font-size: 14px;
        }

        .search-bar button {
            padding: 10px 20px;
            background: var(--verde-medio);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .search-bar button:hover {
            background: var(--verde-claro);
        }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid var(--amarillo-medio);
            border-radius: 5px;
            color: var(--amarillo-medio);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--amarillo-medio);
            color: var(--negro);
        }

        .buildings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }

        .loading-buildings {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            gap: 15px;
            color: var(--gris-texto);
        }

        .building-card {
            background-color: rgba(30, 30, 30, 0.7);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 209, 197, 0.2);
            transition: all 0.3s ease;
        }

        .building-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .building-icon {
            width: 50px;
            height: 50px;
            background-color: var(--verde-medio);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin-right: 15px;
        }

        .building-info h3 {
            font-size: 24px;
            font-weight: 500;
            color: var(--verde-claro);
            margin-bottom: 5px;
        }

        .building-info p {
            color: var(--gris-texto);
            font-size: 14px;
        }

        .floor-toggle {
            width: 100%;
            padding: 15px;
            background: linear-gradient(90deg, var(--verde-oscuro), var(--verde-medio));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .floor-toggle:hover {
            background: linear-gradient(90deg, var(--verde-medio), var(--verde-claro));
            transform: translateY(-2px);
        }

        .floor-toggle i {
            margin-left: auto;
            transition: transform 0.3s;
        }

        .floor-toggle.active i {
            transform: rotate(180deg);
        }

        .salon-grid {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
            margin-top: 10px;
            max-height: 0;
            overflow-x: auto;
            overflow-y: hidden;
            transition: all 0.5s ease;
            padding-bottom: 5px;
        }

        .salon-grid.active {
            max-height: 500px;
        }

        .salon-card {
            flex: 0 0 auto;
            width: 150px;
            background-color: var(--negro-claro);
            border: 2px solid var(--verde-medio);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            transition: all 0.3s;
            cursor: pointer;
            min-height: 70px;
            font-size: 16px;
        }

        .salon-card:hover {
            transform: scale(1.05) rotate(1deg);
        }

        .salon-card.disponible {
            border-color: var(--disponible);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .salon-card.ocupado {
            border-color: var(--ocupado);
            background-color: rgba(255, 193, 7, 0.1);
        }

        .salon-card.accesible {
            border-color: var(--accesible);
        }

        .users-controls {
            margin-bottom: 20px;
        }

        .btn-primary {
            padding: 10px 20px;
            background: var(--verde-medio);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: var(--verde-claro);
        }

        .btn-secondary {
            padding: 10px 20px;
            background: transparent;
            color: var(--gris-claro);
            border: 1px solid var(--gris-texto);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .users-list-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 30px;
            overflow-x: auto;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .users-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 5px;
        }

        /* Rediseño de Inicio */
        .home-dashboard {
            padding: 10px 0;
        }

        .home-stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .home-stat-card {
            background-color: rgba(18, 18, 18, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .home-stat-card:hover {
            transform: translateY(-5px);
            background-color: rgba(25, 25, 25, 0.9);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .home-stat-icon-wrapper {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .icon-blue {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        .icon-green {
            background: linear-gradient(135deg, #4CAF50, #388E3C);
        }

        .icon-orange {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }

        .icon-purple {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
        }

        .home-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--blanco);
            line-height: 1;
        }

        .home-stat-label {
            font-size: 13px;
            color: var(--gris-texto);
            font-weight: 400;
        }

        .home-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            color: var(--verde-claro);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .home-section-title i {
            font-size: 18px;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .quick-action-box {
            background: rgba(0, 0, 0, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .quick-action-box i {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .quick-action-box h3 {
            font-size: 16px;
            margin: 0;
            color: var(--blanco);
        }

        .quick-action-box p {
            font-size: 13px;
            color: var(--gris-texto);
            margin: 0;
        }

        .action-green {
            border-color: rgba(76, 175, 80, 0.5);
        }

        .action-green i {
            color: #81C784;
        }

        .action-green:hover {
            background: rgba(76, 175, 80, 0.05);
            border-color: #81C784;
        }

        .action-yellow {
            border-color: rgba(255, 193, 7, 0.5);
        }

        .action-yellow i {
            color: #FFC107;
        }

        .action-yellow:hover {
            background: rgba(255, 193, 7, 0.05);
            border-color: #FFC107;
        }

        .action-blue {
            border-color: rgba(33, 150, 243, 0.5);
        }

        .action-blue i {
            color: #64B5F6;
        }

        .action-blue:hover {
            background: rgba(33, 150, 243, 0.05);
            border-color: #64B5F6;
        }

        .algorithm-info-card {
            background-color: rgba(18, 18, 18, 0.8);
            border-radius: 15px;
            padding: 25px;
            border-left: 5px solid var(--verde-medio);
        }

        .algorithm-text {
            color: var(--gris-texto);
            line-height: 1.6;
            font-size: 14px;
        }

        .algorithm-text b {
            color: #CE93D8;
        }

        .users-table th {
            text-align: left;
            padding: 15px 20px;
            color: var(--verde-claro);
            font-weight: 600;
            font-size: 16px;
            border-bottom: 2px solid rgba(76, 175, 80, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .users-table th i {
            margin-right: 10px;
        }

        .users-table tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
            cursor: pointer;
        }

        .users-table tr:hover {
            background: rgba(76, 175, 80, 0.15);
            transform: scale(1.002);
        }

        /* Estilos para el Modal de Detalles (replicando imagen) */
        .user-detail-modal-custom {
            background: #1a1a1a !important;
            color: white !important;
            border-radius: 15px !important;
            padding: 20px !important;
            width: 500px !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8) !important;
        }

        .user-details-body {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
        }

        .detail-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-icon-box {
            width: 40px;
            height: 40px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: #66BB6A;
            font-size: 18px;
        }

        .detail-content {
            text-align: left;
            flex: 1;
        }

        .detail-label {
            font-size: 10px;
            color: #777;
            text-transform: uppercase;
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 15px;
            font-weight: 700;
            color: #eee;
        }

        .detail-value.role-admin {
            color: #FFA726;
        }

        .detail-value.role-user {
            color: #9575CD;
        }

        .detail-value.status-active {
            color: #66BB6A;
        }

        .detail-value.status-inactive {
            color: #EF5350;
        }

        .modal-action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .modal-btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            transition: all 0.2s;
            color: white;
        }

        .btn-edit-modal {
            background: #42a5f5;
        }

        .btn-pass-modal {
            background: #ffa726;
        }

        .btn-status-modal {
            background: #ef5350;
        }

        .modal-btn:hover {
            filter: brightness(1.15);
            transform: translateY(-2px);
        }

        .swal2-close {
            color: #666 !important;
            font-size: 26px !important;
        }

        .swal2-close:hover {
            color: #fff !important;
        }

        /* Prevención de salto por scrollbar */
        body.swal2-shown:not(.swal2-no-backdrop):not(.swal2-toast-column) {
            overflow-y: scroll !important;
            padding-right: 0px !important;
        }

        .users-table td {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 15px;
            color: var(--gris-claro);
        }

        .users-table td i.user-icon {
            color: var(--verde-claro);
            margin-right: 12px;
            font-size: 18px;
        }

        /* Badges de Rol */
        .role-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .role-badge.admin {
            color: #FFB347;
            /* Color oro/naranja */
        }

        .role-badge.user,
        .role-badge.usuario {
            color: #B39DDB;
            /* Color morado suave */
        }

        .role-badge i {
            font-size: 14px;
        }

        /* Badges de Estado */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .status-badge.status-active {
            color: var(--verde-claro);
        }

        .status-badge.status-inactive {
            color: #FF5252;
        }

        .status-badge i {
            font-size: 16px;
        }

        /* Acciones */
        .actions-cell {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--gris-texto);
            font-size: 16px;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--blanco);
        }

        .action-btn.edit:hover {
            color: #448AFF;
        }

        .action-btn.reset:hover {
            color: var(--amarillo-medio);
        }

        .action-btn.deactivate:hover {
            color: #FF5252;
        }

        .action-btn.activate:hover {
            color: var(--verde-claro);
        }

        .hint-text {
            text-align: center;
            color: var(--gris-texto);
            font-size: 13px;
            margin-bottom: 15px;
            font-style: italic;
        }

        /* Estilos para el Formulario de Edición (replicando imagen) */
        .edit-form-container {
            text-align: left;
            padding: 10px 5px;
        }

        .edit-group {
            margin-bottom: 20px;
        }

        .edit-label {
            color: #FFB347;
            /* Color Oro */
            display: block;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .edit-input-wrapper {
            position: relative;
        }

        .edit-input,
        .edit-select {
            width: 100%;
            background: #121212 !important;
            border: 2px solid #333 !important;
            border-radius: 10px !important;
            padding: 12px 15px !important;
            color: white !important;
            font-size: 15px !important;
            outline: none !important;
            transition: border-color 0.3s !important;
        }

        .edit-input:focus,
        .edit-select:focus {
            border-color: #4CAF50 !important;
        }

        .edit-input:disabled {
            background: #1A1A1A !important;
            border-color: #222 !important;
            color: #888 !important;
            cursor: not-allowed;
        }

        .edit-hint {
            display: block;
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .edit-footer-hint {
            text-align: center;
            color: #888;
            font-size: 12px;
            margin: 20px 0;
        }

        .edit-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn-save-changes {
            background: #388E3C !important;
            color: white !important;
            padding: 12px 25px !important;
            border-radius: 12px !important;
            border: 2px solid #2E7D32 !important;
            font-weight: 700 !important;
            cursor: pointer !important;
            font-size: 15px !important;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3) !important;
        }

        .btn-cancel-edit {
            background: #1A1A1A !important;
            color: white !important;
            padding: 12px 25px !important;
            border-radius: 12px !important;
            border: 1px solid #444 !important;
            font-weight: 700 !important;
            cursor: pointer !important;
            font-size: 15px !important;
        }

        .btn-save-changes:hover {
            background: #43A047 !important;
            transform: translateY(-2px);
        }

        .btn-cancel-edit:hover {
            border-color: #666 !important;
            background: #222 !important;
        }

        /* Estilos específicos para Nuevo Usuario */
        .new-user-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 25px;
            color: #81C784;
        }

        .new-user-header i {
            font-size: 32px;
        }

        .new-user-header h2 {
            margin: 0;
            font-size: 28px;
        }

        .new-user-label {
            color: #81C784 !important;
            /* Color Verde claro */
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .new-user-label i {
            font-size: 16px;
        }

        .btn-create-final {
            background: #4CAF50 !important;
            color: white !important;
            padding: 12px 25px !important;
            border-radius: 12px !important;
            border: none !important;
            font-weight: 700 !important;
            cursor: pointer !important;
            font-size: 16px !important;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3) !important;
            transition: all 0.3s !important;
        }

        .btn-create-final:hover {
            background: #45a049 !important;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4) !important;
        }

        .btn-cancel-final {
            background: #1A1A1A !important;
            color: white !important;
            padding: 12px 25px !important;
            border-radius: 12px !important;
            border: 1px solid #444 !important;
            font-weight: 700 !important;
            cursor: pointer !important;
            font-size: 16px !important;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s !important;
        }

        .btn-cancel-final:hover {
            border-color: #666 !important;
            background: #222 !important;
        }

        .settings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .settings-card {
            background: rgba(30, 30, 30, 0.7);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(79, 209, 197, 0.2);
        }

        .settings-card h3 {
            color: var(--verde-claro);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }


        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 1002;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--disponible);
        }

        .notification.info {
            background-color: var(--verde-medio);
        }

        .notification.warning {
            background-color: var(--amarillo-medio);
            color: var(--negro);
        }

        .notification.error {
            background-color: #f44336;
        }

        .principal-footer {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .credits {
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--gris-texto);
            font-weight: 500;
        }

        .lide-logo-footer {
            height: 30px;
            width: auto;
        }

        .lide-text {
            font-size: 12px;
            color: var(--gris-texto);
            font-style: italic;
        }

        .action-btn {
            padding: 15px 20px;
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid var(--verde-medio);
            border-radius: 8px;
            color: var(--verde-claro);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .action-btn:hover {
            background: var(--verde-medio);
            color: white;
            transform: translateY(-2px);
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .quick-actions h2 {
            color: var(--verde-claro);
            margin-bottom: 20px;
            font-size: 24px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: rgba(30, 30, 30, 0.95);
            margin: 15% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            color: var(--blanco);
            position: relative;
        }

        .close {
            color: var(--gris-texto);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--blanco);
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }

        .status-badge.available {
            background-color: var(--disponible);
            color: white;
        }

        .status-badge.occupied {
            background-color: var(--ocupado);
            color: var(--negro);
        }

        .status-badge.accessible {
            background-color: var(--accesible);
            color: white;
        }

        .group-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .group-name {
            font-weight: 600;
            color: var(--verde-claro);
        }

        .schedule {
            font-size: 14px;
            color: var(--gris-texto);
            margin-top: 5px;
        }

        .salon-grid-modal {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .salon-card-modal {
            background-color: var(--negro);
            border: 2px solid var(--verde-medio);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            transition: all 0.3s;
            cursor: pointer;
            min-height: 80px;
            font-size: 18px;
            position: relative;
        }

        .salon-card-modal:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .salon-card-modal.disponible {
            border-color: var(--disponible);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .salon-card-modal.ocupado {
            border-color: var(--ocupado);
            background-color: rgba(255, 193, 7, 0.1);
        }

        .salon-card-modal.accesible {
            border-color: var(--accesible);
            background-color: rgba(255, 152, 0, 0.1);
        }

        .salon-details {
            margin-top: 20px;
        }

        .groups-list {
            margin-top: 20px;
        }

        .group-schedule {
            margin-top: 5px;
            color: var(--gris-texto);
            font-size: 14px;
        }

        .schedule-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .schedule-table th {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 12px;
            text-align: left;
            color: var(--verde-claro);
            border-bottom: 1px solid var(--verde-medio);
        }

        .schedule-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .schedule-table tr:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .time-slot {
            font-weight: bold;
            color: var(--amarillo-claro);
        }

        .current-time {
            background-color: rgba(76, 175, 80, 0.2);
            border-left: 4px solid var(--verde-medio);
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .error-message {
            text-align: center;
            padding: 40px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            margin: 20px;
        }

        /* Estilos del módulo de asignación */
        .process-section {
            background-color: rgba(30, 30, 30, 0.9);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: var(--verde-claro);
            font-size: 1.2em;
        }

        .file-upload-area {
            border: 2px dashed var(--verde-medio);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            color: var(--gris-claro);
        }

        .file-upload-area:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .file-upload-area.dragover {
            border-color: var(--amarillo-medio);
            background-color: rgba(255, 193, 7, 0.1);
        }

        .file-list {
            margin: 15px 0;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin-bottom: 8px;
        }

        .file-item.success {
            border-left: 3px solid var(--disponible);
        }

        .file-item.error {
            border-left: 3px solid var(--error);
        }

        .file-item.processing {
            border-left: 3px solid var(--amarillo-medio);
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--verde-oscuro), var(--verde-medio));
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: var(--gris-texto);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .stat-card.presencial {
            border-color: var(--disponible);
        }

        .stat-card.virtual {
            border-color: #9c27b0;
        }

        .stat-card.laboratorio {
            border-color: var(--amarillo-medio);
        }

        .stat-card.error {
            border-color: var(--error);
        }

        .stat-card.asignada {
            border-color: var(--verde-claro);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--verde-claro);
        }

        .stat-label {
            color: var(--gris-texto);
            margin-top: 5px;
            font-size: 0.9em;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .results-table th,
        .results-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-table th {
            background-color: rgba(0, 0, 0, 0.5);
            color: var(--verde-claro);
        }

        .results-table tr:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--gris-texto);
            border-radius: 5px;
            color: var(--gris-texto);
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background-color: var(--verde-medio);
            color: white;
            border-color: var(--verde-medio);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .visualization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .salon-visual {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            border: 2px solid var(--verde-medio);
        }

        .salon-visual.ocupado {
            border-color: var(--ocupado);
        }

        .salon-visual.disponible {
            border-color: var(--disponible);
        }

        .salon-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .salon-name {
            font-weight: bold;
            font-size: 1.1em;
            color: white;
        }

        .salon-capacity {
            color: var(--gris-texto);
            font-size: 0.9em;
        }

        .occupation-bar {
            height: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .occupation-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--verde-oscuro), var(--verde-medio));
            transition: width 0.3s;
        }

        .schedule-timeline {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .time-block {
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--verde-claro);
        }

        .log-container {
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry.info {
            color: var(--verde-claro);
        }

        .log-entry.success {
            color: var(--disponible);
        }

        .log-entry.error {
            color: var(--error);
        }

        .log-entry.warning {
            color: var(--amarillo-medio);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        /* Modal de Grupos Prioritarios */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: rgba(30, 30, 30, 0.98);
            margin: 2% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .modal-header h2 {
            color: var(--verde-claro);
            margin: 0;
        }

        .close-modal {
            color: var(--gris-texto);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: white;
        }

        .priority-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            min-height: 60px;
        }

        .priority-tag {
            background-color: var(--verde-medio);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .priority-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            line-height: 1;
        }

        .priority-tag button:hover {
            opacity: 0.8;
        }

        .group-search {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .group-search input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--gris-texto);
            border-radius: 5px;
            background-color: var(--negro-claro);
            color: var(--blanco);
            font-size: 14px;
        }

        .group-search input:focus {
            outline: none;
            border-color: var(--verde-medio);
        }

        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .group-btn {
            padding: 10px 5px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--gris-texto);
            border-radius: 5px;
            color: var(--gris-claro);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .group-btn:hover {
            background-color: rgba(76, 175, 80, 0.2);
            border-color: var(--verde-medio);
        }

        .group-btn.selected {
            background-color: var(--verde-medio);
            color: white;
            border-color: var(--verde-medio);
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .swal-overlay {
            background-color: rgba(0, 0, 0, 0.7) !important;
        }

        /* Estilos para la visualización tipo matriz */
        .salon-matrix-section {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .salon-matrix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .salon-matrix-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--verde-claro);
        }

        .salon-matrix-info {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--gris-texto);
        }

        .salon-matrix-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--gris-texto);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-color.assigned {
            background-color: rgba(76, 175, 80, 0.5);
            border: 1px solid var(--verde-medio);
        }

        .legend-color.priority {
            background-color: rgba(255, 193, 7, 0.5);
            border: 1px solid var(--amarillo-medio);
        }

        .legend-color.empty {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .legend-color.lunch {
            background-color: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }

        @media (max-width: 768px) {
            .principal-header {
                padding: 10px 15px;
            }

            .header-info {
                display: none;
            }

            .sidebar {
                left: -250px;
                height: 100vh;
            }

            .sidebar.active {
                left: 0;
            }

            .main-content {
                margin-left: 0;
                max-width: 100%;
                padding: 20px;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .user-info span {
                display: none;
            }

            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            .buildings-container {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .search-bar {
                min-width: 100%;
            }

            .users-table {
                font-size: 12px;
            }

            .user-actions {
                flex-direction: column;
            }

            .btn-small {
                padding: 3px 6px;
                font-size: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .visualization-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
            }

            .groups-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--verde-medio);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-indicator {
            text-align: center;
            padding: 40px;
            color: var(--gris-texto);
        }

        /* Mensaje de bienvenida */
        .welcome-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(46, 125, 50, 0.95);
            color: var(--blanco);
            padding: 14px 22px;
            border-radius: 8px;
            border-left: 3px solid var(--amarillo-medio);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 4000;
            font-size: 14px;
            animation: slideInRight 0.4s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* --- STYLES FROM mm.html FOR SALON VISUALIZATION --- */
        .status-badge.occupied {
            background-color: var(--ocupado);
            color: var(--negro);
        }

        .status-badge.accessible {
            background-color: var(--accesible);
            color: white;
        }

        .group-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .group-name {
            font-weight: 600;
            color: var(--verde-claro);
        }

        .schedule {
            font-size: 14px;
            color: var(--gris-texto);
            margin-top: 5px;
        }

        .salon-grid-modal {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .salon-card-modal {
            background-color: var(--negro);
            border: 2px solid var(--verde-medio);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            transition: all 0.3s;
            cursor: pointer;
            min-height: 80px;
            font-size: 18px;
            position: relative;
        }

        .salon-card-modal:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .salon-card-modal.disponible {
            border-color: var(--disponible);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .salon-card-modal.ocupado {
            border-color: var(--ocupado);
            background-color: rgba(255, 193, 7, 0.1);
        }

        .salon-card-modal.accesible {
            border-color: var(--accesible);
            background-color: rgba(255, 152, 0, 0.1);
        }

        .salon-details {
            margin-top: 20px;
        }

        .groups-list {
            margin-top: 20px;
        }

        .group-schedule {
            margin-top: 5px;
            color: var(--gris-texto);
            font-size: 14px;
        }

        .schedule-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }

        .schedule-table th {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 12px;
            text-align: left;
            color: var(--verde-claro);
            border-bottom: 1px solid var(--verde-medio);
        }

        .schedule-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .schedule-table tr:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }

        .time-slot {
            font-weight: bold;
            color: var(--amarillo-claro);
        }

        .current-time {
            background-color: rgba(76, 175, 80, 0.2);
            border-left: 4px solid var(--verde-medio);
        }

        /* Estilos para la visualización tipo matriz */
        .salon-matrix-section {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .salon-matrix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .salon-matrix-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--verde-claro);
        }

        .salon-matrix-info {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: var(--gris-texto);
        }

        .salon-matrix-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--gris-texto);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .legend-color.assigned {
            background-color: rgba(76, 175, 80, 0.5);
            border: 1px solid var(--verde-medio);
        }

        .legend-color.priority {
            background-color: rgba(255, 193, 7, 0.5);
            border: 1px solid var(--amarillo-medio);
        }

        .legend-color.empty {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .legend-color.lunch {
            background-color: rgba(244, 67, 54, 0.3);
            border: 1px solid #f44336;
        }

        /* Modal Styles Overlay */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: rgba(30, 30, 30, 0.98);
            margin: 2% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .close {
            color: var(--gris-texto);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--blanco);
        }

        /* --- NEW DAILY LIST VISUALIZATION STYLES --- */
        .daily-schedule-section {
            margin-top: 25px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .day-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--amarillo-claro);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--amarillo-medio);
        }

        .daily-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
            color: var(--blanco);
        }

        .daily-table th {
            text-align: left;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--verde-claro);
            font-weight: 500;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .daily-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .daily-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-icon-libre {
            color: #4CAF50;
        }

        .status-icon-asignado {
            color: #FF5252;
        }

        .hora-cell {
            font-weight: 600;
            color: var(--gris-claro);
            width: 120px;
        }

        .grupo-cell {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            color: var(--amarillo-claro);
        }

        .salon-header-new {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: var(--blanco);
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ============================================
           ESTILOS DE NOTIFICACIONES
           ============================================ */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
            z-index: 9999;
            max-width: 400px;
            min-width: 280px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            gap: 14px;
            transform: translateX(calc(100% + 40px));
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification i {
            font-size: 20px;
            flex-shrink: 0;
        }

        .notification span {
            flex: 1;
            line-height: 1.4;
        }

        /* Notificación de éxito (verde) */
        .notification.success {
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
            border-left: 4px solid #81C784;
        }

        .notification.success i {
            color: #81C784;
        }

        /* Notificación de información (azul) */
        .notification.info {
            background: linear-gradient(135deg, #1565C0 0%, #0D47A1 100%);
            border-left: 4px solid #64B5F6;
        }

        .notification.info i {
            color: #64B5F6;
        }

        /* Notificación de advertencia (oro/amarillo) */
        .notification.warning {
            background: linear-gradient(135deg, #F57F17 0%, #E65100 100%);
            border-left: 4px solid #FFE082;
        }

        .notification.warning i {
            color: #FFE082;
        }

        /* Notificación de error (rojo) */
        .notification.error {
            background: linear-gradient(135deg, #C62828 0%, #B71C1C 100%);
            border-left: 4px solid #EF9A9A;
        }

        .notification.error i {
            color: #EF9A9A;
        }

        /* Animación de salida */
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(calc(100% + 40px));
                opacity: 0;
            }
        }

        /* Animación de entrada suave para bienvenida */
        .welcome-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%);
            color: #ffffff;
            padding: 16px 24px;
            border-radius: 12px;
            border-left: 4px solid #81C784;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            z-index: 9999;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 14px;
            animation: slideInRight 0.4s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(120%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ============================================
           ESTILOS GLOBALES PARA SWEETALERT2
           ============================================ */
        .swal2-popup {
            background: linear-gradient(180deg, #1a1a1a 0%, #121212 100%) !important;
            border: 1px solid rgba(76, 175, 80, 0.3) !important;
            border-radius: 16px !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6) !important;
        }

        .swal2-title {
            color: #ffffff !important;
            font-weight: 600 !important;
        }

        .swal2-html-container,
        .swal2-content {
            color: #b0b0b0 !important;
        }

        .swal2-confirm {
            background: linear-gradient(135deg, #2E7D32 0%, #1B5E20 100%) !important;
            border: none !important;
            border-radius: 8px !important;
            padding: 12px 28px !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
        }

        .swal2-confirm:hover {
            background: linear-gradient(135deg, #388E3C 0%, #2E7D32 100%) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.4) !important;
        }

        .swal2-cancel {
            background: #424242 !important;
            border: 1px solid #616161 !important;
            border-radius: 8px !important;
            padding: 12px 28px !important;
            font-weight: 600 !important;
            color: #ffffff !important;
            transition: all 0.3s ease !important;
        }

        .swal2-cancel:hover {
            background: #616161 !important;
            transform: translateY(-2px) !important;
        }

        .swal2-icon.swal2-success {
            border-color: #4CAF50 !important;
            color: #4CAF50 !important;
        }

        .swal2-icon.swal2-success .swal2-success-ring {
            border-color: rgba(76, 175, 80, 0.3) !important;
        }

        .swal2-icon.swal2-success [class^='swal2-success-line'] {
            background-color: #4CAF50 !important;
        }

        .swal2-icon.swal2-info {
            border-color: #64B5F6 !important;
            color: #64B5F6 !important;
        }

        .swal2-icon.swal2-warning {
            border-color: #FFB74D !important;
            color: #FFB74D !important;
        }

        .swal2-icon.swal2-error {
            border-color: #EF5350 !important;
            color: #EF5350 !important;
        }

        .swal2-icon.swal2-error [class^='swal2-x-mark-line'] {
            background-color: #EF5350 !important;
        }

        .swal2-icon.swal2-question {
            border-color: #81C784 !important;
            color: #81C784 !important;
        }

        .swal2-timer-progress-bar {
            background: linear-gradient(90deg, #4CAF50 0%, #81C784 100%) !important;
        }

        .swal2-loader {
            border-color: #4CAF50 transparent #4CAF50 transparent !important;
        }

        .swal2-footer {
            color: #757575 !important;
            border-top-color: rgba(255, 255, 255, 0.1) !important;
        }

        .swal2-close {
            color: #757575 !important;
        }

        .swal2-close:hover {
            color: #ffffff !important;
        }

        /* Nuevos Estilos para Secciones Adicionales */
        .badge-turno {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-matutino {
            background-color: rgba(33, 150, 243, 0.2);
            color: #2196F3;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }

        .badge-vespertino {
            background-color: rgba(255, 112, 67, 0.2);
            color: #FF7043;
            border: 1px solid rgba(255, 112, 67, 0.3);
        }

        .report-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-stat-card {
            background: rgba(18, 18, 18, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .report-stat-card:hover {
            background: rgba(25, 25, 25, 0.8);
            border-color: rgba(76, 175, 80, 0.2);
        }

        .report-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--verde-claro);
            margin-bottom: 5px;
        }

        .report-stat-label {
            font-size: 13px;
            color: var(--gris-texto);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--gris-texto);
            text-align: center;
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .horarios-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 12px;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 12px;
            color: var(--gris-texto);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px;
            border-radius: 8px;
            outline: none;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            border-color: var(--verde-medio);
        }

        .btn-upload-csv {
            background: var(--verde-medio);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .btn-upload-csv:hover {
            background: var(--verde-claro);
            transform: translateY(-2px);
        }

        .table-lide {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .table-lide th {
            text-align: left;
            padding: 12px 15px;
            color: var(--verde-claro);
            font-weight: 600;
            border-bottom: 1px solid rgba(76, 175, 80, 0.3);
            font-size: 13px;
            text-transform: uppercase;
        }

        .table-lide td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            font-size: 14px;
        }

        .table-lide tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .btn-action-small {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn-action-small:hover {
            background: var(--verde-medio);
        }
    </style>
</head>

<body>
    <div class="principal-wrapper" id="principalWrapper">
        <!-- Overlay para cerrar menú -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Menú lateral -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="https://i.postimg.cc/Znt6wPm1/logo-lide.webp" alt="Logo LIDE" class="sidebar-logo">
                <span class="sidebar-title">Sistema de Gestión</span>
            </div>

            <nav class="sidebar-nav">
                <a href="#" class="sidebar-link active" onclick="loadContent('inicio')">
                    <i class="fas fa-home"></i>
                    <span>Inicio</span>
                </a>
                <a href="#" class="sidebar-link" onclick="loadContent('horarios')">
                    <i class="fas fa-clock"></i>
                    <span>Horarios</span>
                </a>
                <a href="#" class="sidebar-link" onclick="loadContent('grupos')">
                    <i class="fas fa-users-class"></i>
                    <span>Grupos</span>
                </a>
                <a href="#" class="sidebar-link" onclick="loadContent('edificios')">
                    <i class="fas fa-building"></i>
                    <span>Salones</span>
                </a>
                <a href="#" class="sidebar-link" onclick="loadContent('asignacion')">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <span>Asignación de Salones</span>
                </a>
                <a href="#" class="sidebar-link" onclick="loadContent('reportes')">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </a>
                <a href="#" class="sidebar-link" onclick="loadContent('usuarios')">
                    <i class="fas fa-user-cog"></i>
                    <span>Usuarios</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <small style="color: var(--gris-texto); font-weight: 700; letter-spacing: 2px;">LIDE</small>
            </div>
        </aside>

        <!-- Contenido principal -->
        <div class="main-content" id="mainContent">
            <header class="principal-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-info">
                        <div class="system-title">Sistema de Asignación de Salones - FCA UABC</div>
                    </div>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <span id="userName" style="color: var(--gris-claro); font-weight: 500;">Administrador</span>
                        <button class="logout-btn" id="logoutBtn">
                            <i class="fas fa-sign-out-alt"></i> Salir
                        </button>
                    </div>
                </div>
            </header>

            <main class="main-container">
                <!-- Contenido dinámico se cargará aquí -->
                <div id="content-section">
                    <!-- Contenido inicial se carga aquí -->
                </div>
            </main>

            <footer class="principal-footer">
                <div class="credits">
                    <span>Desarrollado por:</span>
                    <img src="https://i.postimg.cc/Znt6wPm1/logo-lide.webp" alt="Logo LIDE" class="lide-logo-footer">
                </div>
            </footer>
        </div>
    </div>

    <!-- Modal para Salones del Piso -->
    <div id="floorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeFloorModal()">&times;</span>
            <h2 class="floor-modal-title" id="floorModalTitle">Salones del Piso</h2>
            <div id="floorSalonsContainer" class="salon-grid-modal">
                <!-- Los salones se cargarán aquí dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Modal para Detalles del Salón -->
    <div id="salonModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSalonModal()">&times;</span>
            <h2 id="salonName">Nombre del Salón</h2>
            <div id="salonStatus"></div>
            <div id="salonDetails" class="salon-details">
                <h3>Grupos Asignados</h3>
                <div id="groupsList" class="groups-list">
                    <!-- Los grupos se cargarán aquí -->
                </div>

                <h3 style="margin-top: 25px;">Horario del Salón</h3>
                <table class="schedule-table" id="scheduleTable">
                    <thead>
                        <tr>
                            <th>Hora</th>
                            <th>Lunes</th>
                            <th>Martes</th>
                            <th>Miércoles</th>
                            <th>Jueves</th>
                            <th>Viernes</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                        <!-- Los horarios se cargarán aquí -->
                    </tbody>
                </table>
                <div id="currentStatus"
                    style="margin-top: 20px; padding: 15px; border-radius: 8px; background-color: rgba(0,0,0,0.2);">
                    <h4>Estado actual:</h4>
                    <p id="currentStatusText"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // VARIABLES GLOBALES Y CONFIGURACIÓN
        // ============================================

        // Configuración de salones por piso
        // Configuración de salones por piso
        let floorSalons = {};

        // Datos de salones con horarios y grupos
        let salonData = {};

        // Variable para evitar doble inicialización
        let isInitialized = false;

        // Variables globales para el sistema de asignación
        let sistema = null;
        let archivosSeleccionados = [];
        let gruposDetectados = [];
        let gruposPrioritarios = new Set();
        let rawCSVData = []; // Para almacenar los datos crudos del CSV
        const DIAS_ORDEN = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];

        const CONFIG_EDIFICIOS = {
            'D': { pisos: 4, salonesPorPiso: [6, 6, 6, 6] },
            'E': { pisos: 4, salonesPorPiso: [6, 6, 6, 5] },
            'F': { pisos: 4, salonesPorPiso: [4, 4, 4, 4] }
        };

        const MATERIAS_LABORATORIO = {
            'TroncoComun': { 1: ["38973"], 2: ["38982"] },
            'LIN': {
                3: ["38984", "39038", "39039", "39040", "39041", "39042"],
                4: ["39043", "39044", "39047", "50600", "50601"],
                5: ["39048", "39049", "39050", "39051", "39058"],
                6: ["39056", "39052", "13595"],
                7: ["39060", "39062", "39061", "39063", "50602"],
                8: ["39067", "39068", "39076", "39083", "39088"]
            },
            'LC': { 6: ["39025"], 7: ["39009"], 8: ["39014"] },
            'LAE': { 4: ["40309"] }
        };

        // Variables globales para persistencia y filtros
        // Función para guardar filtros actuales
        function guardarFiltros() {
            const filtros = {
                currentFilter: currentFilter,
                edificioFilter: edificioFilter,
                pisoFilter: pisoFilter,
                grupoSearchTerm: grupoSearchTerm
            };
            try {
                localStorage.setItem('filtrosVisualizador', JSON.stringify(filtros));
            } catch (error) {
                console.error('Error al guardar filtros:', error);
            }
        }

        // Función para cargar filtros guardados
        function cargarFiltros() {
            try {
                const filtrosGuardados = localStorage.getItem('filtrosVisualizador');
                if (filtrosGuardados) {
                    const filtros = JSON.parse(filtrosGuardados);
                    currentFilter = filtros.currentFilter || 'all';
                    edificioFilter = filtros.edificioFilter || null;
                    pisoFilter = filtros.pisoFilter || null;
                    grupoSearchTerm = filtros.grupoSearchTerm || null;

                    // Aplicar filtros cargados a la UI
                    if (grupoSearchTerm) {
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput) {
                            searchInput.value = grupoSearchTerm;
                        }
                    }

                    if (edificioFilter) {
                        aplicarFiltroEdificio(edificioFilter);
                    }

                    return true;
                }
            } catch (error) {
                console.error('Error al cargar filtros:', error);
            }
            return false;
        }

        // Función para aplicar filtro por edificio
        function aplicarFiltroEdificio(edificio) {
            edificioFilter = edificio;
            currentFilter = 'building';
            guardarFiltros();

            // Actualizar botones de filtro
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            const edificioBtn = document.querySelector(`.filter-btn[data-edificio="${edificio}"]`);
            if (edificioBtn) {
                edificioBtn.classList.add('active');
            }

            showNotification(`Filtrando por edificio ${edificio}`, 'info');
        }

        // Función para aplicar filtro por piso
        function aplicarFiltroPiso(piso) {
            pisoFilter = piso;
            currentFilter = 'floor';
            guardarFiltros();

            showNotification(`Filtrando por piso ${piso}`, 'info');
        }

        // Función para buscar grupo
        function buscarGrupoEnHorarios(termino) {
            grupoSearchTerm = termino;
            guardarFiltros();

            if (!termino || termino.trim() === '') {
                showNotification('Ingresa un término de búsqueda', 'warning');
                return;
            }

            const datos = cargarDatosAsignacion();
            if (!datos || !datos.asignaciones) {
                showNotification('No hay horarios guardados para buscar', 'warning');
                return;
            }

            // Buscar en asignaciones
            const resultados = datos.asignaciones.filter(asignacion => {
                if (!asignacion.clase) return false;
                return asignacion.clase.grupoId?.toLowerCase().includes(termino.toLowerCase()) ||
                    asignacion.clase.nombreAsignatura?.toLowerCase().includes(termino.toLowerCase()) ||
                    asignacion.clase.maestro?.toLowerCase().includes(termino.toLowerCase());
            });

            if (resultados.length > 0) {
                showNotification(`Se encontraron ${resultados.length} resultados para "${termino}"`, 'success');
                return resultados;
            } else {
                showNotification(`No se encontraron resultados para "${termino}"`, 'warning');
                return [];
            }
        }
        let edificioFilter = null;
        let pisoFilter = null;
        let grupoSearchTerm = null;

        // Variables para la visualización de edificios
        // (Definidas arriba como globales: salonData, floorSalons)

        // ============================================
        // CLASES DEL SISTEMA DE ASIGNACIÓN
        // ============================================

        class Salon {
            constructor(id, edificio, piso, capacidad, accesible = false) {
                this.id = id;
                this.edificio = edificio;
                this.piso = piso;
                this.capacidad = capacidad;
                this.accesible = accesible;
                this.horariosOcupados = [];
                this.asignacionesBloques = [];
                this.grupoAsignadoFijo = null;
            }

            estaDisponible(horario, dia) {
                return !this.horariosOcupados.some(h =>
                    h.dia === dia && this.horariosSeSuperponen(h.horario, horario)
                );
            }

            horariosSeSuperponen(horario1, horario2) {
                const inicio1 = this.convertirHoraAMinutos(horario1.horaInicio);
                const fin1 = this.convertirHoraAMinutos(horario1.horaFin);
                const inicio2 = this.convertirHoraAMinutos(horario2.horaInicio);
                const fin2 = this.convertirHoraAMinutos(horario2.horaFin);
                return inicio1 < fin2 && fin1 > inicio2;
            }

            convertirHoraAMinutos(hora) {
                const [horas, minutos] = hora.split(':').map(Number);
                return horas * 60 + minutos;
            }

            agregarHorarioOcupado(dia, horario, grupoId) {
                const existe = this.horariosOcupados.some(h =>
                    h.dia === dia &&
                    h.horario.horaInicio === horario.horaInicio &&
                    h.horario.horaFin === horario.horaFin
                );
                if (!existe) {
                    this.horariosOcupados.push({ dia, horario, grupoId });
                }
            }

            ocupar(dia, horario, grupoId) {
                this.agregarHorarioOcupado(dia, horario, grupoId);
            }
        }

        // Helper para verificar solapamiento de tiempo (VERSIÓN ROBUSTA)
        function isTimeOverlap(start1, end1, start2, end2) {
            if (!start1 || !end1 || !start2 || !end2) return false;

            const parseTime = (t) => {
                const parts = t.trim().split(':');
                if (parts.length < 2) return 0;
                return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            };

            const h1start = parseTime(start1);
            const h1end = parseTime(end1);
            const h2start = parseTime(start2);
            const h2end = parseTime(end2);

            return h1start < h2end && h1end > h2start;
        }

        // Función para sincronizar salonData (usada por edificios) con sistema.salones (usada por asignación)
        function sincronizarGlobalSalonDataDesdeSistema() {
            if (!sistema || !sistema.salones) return;

            sistema.salones.forEach(salonSistema => {
                const sId = salonSistema.id;
                if (!salonData[sId]) return;

                // Limpiar schedule previo
                for (let h = 7; h < 22; h++) {
                    const k = `${h.toString().padStart(2, '0')}:00-${(h + 1).toString().padStart(2, '0')}:00`;
                    salonData[sId].schedule[k] = ["", "", "", "", ""];
                }

                // Poblar con horarios de sistema.salones
                const dias = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];
                salonSistema.horariosOcupados.forEach(h => {
                    const diaIdx = dias.indexOf(h.dia.trim());
                    if (diaIdx === -1) return;

                    // Marcar como ocupado en la vista de edificios
                    salonData[sId].status = 'ocupado';

                    // Intentar encontrar el nombre de la materia/maestro desde las asignaciones del sistema
                    const asignacionInfo = sistema.asignaciones.find(a => a.salonId === sId && a.grupoId === h.grupoId && a.dia === h.dia);

                    const existeGrupo = salonData[sId].groups.find(g => g.name === h.grupoId);
                    if (!existeGrupo) {
                        salonData[sId].groups.push({
                            name: h.grupoId,
                            code: asignacionInfo ? asignacionInfo.materia : 'Asignatura',
                            teacher: asignacionInfo ? asignacionInfo.maestro : 'Por asignar',
                            schedule: `${h.dia}: ${h.horario.horaInicio}-${h.horario.horaFin}`
                        });
                    } else if (asignacionInfo && !existeGrupo.schedule.includes(h.dia)) {
                        existeGrupo.schedule += `, ${h.dia}: ${h.horario.horaInicio}-${h.horario.horaFin}`;
                    }

                    const inicioMin = parseInt(h.horario.horaInicio.split(':')[0]) * 60 + parseInt(h.horario.horaInicio.split(':')[1]);
                    const finMin = parseInt(h.horario.horaFin.split(':')[0]) * 60 + parseInt(h.horario.horaFin.split(':')[1]);

                    // Map to 1-hour slots in salonData.schedule
                    for (let h_hour = 7; h_hour < 22; h_hour++) {
                        const sMin = h_hour * 60;
                        const eMin = (h_hour + 1) * 60;
                        if (sMin < finMin && eMin > inicioMin) {
                            const k = `${h_hour.toString().padStart(2, '0')}:00-${(h_hour + 1).toString().padStart(2, '0')}:00`;
                            if (salonData[sId].schedule[k]) {
                                salonData[sId].schedule[k][diaIdx] = h.grupoId;
                            }
                        }
                    }
                });
            });
            console.log("Global salonData sincronizada con sistema.");
        }

        class Grupo {
            constructor(id, carrera, semestre, numero, cantidadAlumnos) {
                this.id = id;
                this.carrera = carrera;
                this.semestre = semestre;
                this.numero = numero;
                this.cantidadAlumnos = cantidadAlumnos;
                this.salonAsignado = null;
            }
        }

        class Horario {
            constructor(horaInicio, horaFin) {
                this.horaInicio = horaInicio;
                this.horaFin = horaFin;
            }
        }

        class Clase {
            constructor(datos) {
                this.idUnico = datos.id_unico;
                this.codigoAsignatura = datos.codigo_asignatura;
                this.nombreAsignatura = datos.nombre_asignatura;
                this.maestro = datos.maestro;
                this.edificioActual = datos.edificio;
                this.salonActual = datos.salon;
                this.capacidadRequerida = parseInt(datos.capacidad);
                this.grupoId = datos.grupo;
                this.diaSemana = datos.dia_semana;
                this.horaInicio = datos.hora_inicio;
                this.horaFin = datos.hora_fin;
                this.duracionMin = parseInt(datos.duracion_min);
                this.modalidad = datos.modalidad;
                this.tipo = datos.tipo;
                this.extraerInfoGrupo();
            }

            extraerInfoGrupo() {
                if (this.grupoId && this.grupoId !== 'VIR' && this.grupoId.length >= 3) {
                    const mapaCarrera = { '2': 200, '3': 300, '4': 400, '5': 500, '6': 600, '9': 900 };
                    this.carrera = mapaCarrera[this.grupoId[0]] || parseInt(this.grupoId[0]) * 100;
                    const s = parseInt(this.grupoId[1]);
                    const n = parseInt(this.grupoId[2]);
                    this.semestre = Number.isInteger(s) ? s : null;
                    this.numeroGrupo = Number.isInteger(n) ? n : null;
                } else {
                    this.carrera = null;
                    this.semestre = null;
                    this.numeroGrupo = null;
                }
            }
        }

        class SistemaAsignacion {
            constructor() {
                this.salones = [];
                this.grupos = new Map();
                this.clases = [];
                this.asignaciones = [];
                this.errores = [];
                this.clasesLaboratorio = [];
                this.clasesVirtuales = [];
                this.clasesPorGrupoDia = new Map();
                this.gruposDivididos = new Map();
                this.inicializarSalones();
            }

            inicializarSalones() {
                for (const [edificio, config] of Object.entries(CONFIG_EDIFICIOS)) {
                    const { pisos, salonesPorPiso } = config;
                    for (let piso = 1; piso <= pisos; piso++) {
                        const cantidad = salonesPorPiso[piso - 1];
                        for (let i = 1; i <= cantidad; i++) {
                            const id = `${edificio}-${piso}${i.toString().padStart(2, '0')}`;
                            const accesible = piso === 1;
                            this.salones.push(new Salon(id, edificio, piso, 40, accesible));
                        }
                    }
                }
            }

            esMateriaLaboratorio(clase) {
                if (!clase.semestre) return null;
                if (MATERIAS_LABORATORIO.TroncoComun[clase.semestre]?.includes(clase.codigoAsignatura)) return 'Tronco Común';
                if (MATERIAS_LABORATORIO.LIN[clase.semestre]?.includes(clase.codigoAsignatura)) return 'LIN';
                if (MATERIAS_LABORATORIO.LC[clase.semestre]?.includes(clase.codigoAsignatura)) return 'LC';
                if (MATERIAS_LABORATORIO.LAE[clase.semestre]?.includes(clase.codigoAsignatura)) return 'LAE';
                return null;
            }

            procesarClase(clase) {
                const tipoLaboratorio = this.esMateriaLaboratorio(clase);
                if (tipoLaboratorio) {
                    this.clasesLaboratorio.push({ clase, tipo: tipoLaboratorio });
                } else if (clase.modalidad === 'Virtual') {
                    this.clasesVirtuales.push({ clase, mensaje: 'Clase virtual' });
                } else {
                    this.clases.push(clase);
                    if (!this.grupos.has(clase.grupoId)) {
                        this.grupos.set(clase.grupoId, new Grupo(
                            clase.grupoId, clase.carrera, clase.semestre,
                            clase.numeroGrupo, clase.capacidadRequerida
                        ));
                    } else {
                        const grupo = this.grupos.get(clase.grupoId);
                        if (clase.capacidadRequerida > grupo.cantidadAlumnos) {
                            grupo.cantidadAlumnos = clase.capacidadRequerida;
                        }
                    }
                }
            }

            generarReporte() {
                return {
                    resumen: {
                        totalClases: this.clases.length + this.clasesVirtuales.length + this.clasesLaboratorio.length,
                        clasesPresenciales: this.clases.length,
                        clasesVirtuales: this.clasesVirtuales.length,
                        clasesLaboratorio: this.clasesLaboratorio.length,
                        asignadas: this.asignaciones.length,
                        errores: this.errores.length,
                        gruposDivididos: this.gruposDivididos.size
                    },
                    asignaciones: this.asignaciones,
                    errores: this.errores,
                    laboratorio: this.clasesLaboratorio,
                    virtuales: this.clasesVirtuales,
                    gruposDivididos: Array.from(this.gruposDivididos.entries())
                };
            }
        }

        class AsignadorAutomatico {
            constructor(sistema, gruposPrioritarios = []) {
                this.sistema = sistema;
                this.gruposPrioritarios = Array.isArray(gruposPrioritarios) ? gruposPrioritarios : [];
            }

            asignarSalones() {
                const gruposUnicos = this.obtenerGruposOrdenadosPorPrioridad();
                for (const grupoId of gruposUnicos) {
                    const grupo = this.sistema.grupos.get(grupoId);
                    const horariosOcupados = this.calcularHorariosOcupadosPorGrupo(grupoId);
                    if (horariosOcupados.length === 0) continue;

                    let salon = this.buscarSalonDisponibleParaHorarios(grupo, horariosOcupados);
                    if (salon) {
                        this.asignarSalonAGrupo(grupo, salon, horariosOcupados);
                    } else {
                        const salonExhaustivo = this.buscarSalonExhaustivoParaSemanaCompleta(grupo, horariosOcupados);
                        if (salonExhaustivo) {
                            this.asignarSalonAGrupo(grupo, salonExhaustivo, horariosOcupados);
                        } else {
                            const asignacionDividida = this.intentarAsignacionDividida(grupo, horariosOcupados);
                            if (!asignacionDividida) {
                                const clasesGrupo = this.sistema.clases.filter(c => c.grupoId === grupoId);
                                clasesGrupo.forEach(clase => {
                                    this.sistema.errores.push({ clase, mensaje: 'No hay salones disponibles' });
                                });
                            }
                        }
                    }
                }

                this.sistema.clasesLaboratorio.forEach(item => {
                    this.sistema.asignaciones.push({
                        clase: item.clase,
                        salon: null,
                        bloque: 'Laboratorio',
                        mensaje: `Laboratorio: ${item.tipo}`
                    });
                });
            }

            obtenerGruposOrdenadosPorPrioridad() {
                const gruposUnicos = Array.from(new Set(this.sistema.clases.map(clase => clase.grupoId)));
                return gruposUnicos.sort((a, b) => {
                    const aTemprano = this.grupoTieneHorarioTemprano(a);
                    const bTemprano = this.grupoTieneHorarioTemprano(b);
                    if (aTemprano && !bTemprano) return -1;
                    if (!aTemprano && bTemprano) return 1;

                    const aPrioritario = this.gruposPrioritarios.includes(a);
                    const bPrioritario = this.gruposPrioritarios.includes(b);
                    if (aPrioritario && !bPrioritario) return -1;
                    if (!aPrioritario && bPrioritario) return 1;

                    const grupoA = this.sistema.grupos.get(a);
                    const grupoB = this.sistema.grupos.get(b);
                    if (grupoA && grupoB && grupoA.semestre !== grupoB.semestre) {
                        return grupoA.semestre - grupoB.semestre;
                    }
                    return a.localeCompare(b);
                });
            }

            grupoTieneHorarioTemprano(grupoId) {
                const clasesGrupo = this.sistema.clases.filter(c => c.grupoId === grupoId);
                return clasesGrupo.some(clase => ['07:00', '08:00', '09:00'].includes(clase.horaInicio));
            }

            calcularHorariosOcupadosPorGrupo(grupoId) {
                const clasesPresenciales = this.sistema.clases.filter(c => c.grupoId === grupoId);
                const horariosOcupados = [];
                clasesPresenciales.forEach(clase => {
                    horariosOcupados.push({ dia: clase.diaSemana, horario: new Horario(clase.horaInicio, clase.horaFin) });
                });
                return horariosOcupados;
            }

            buscarSalonDisponibleParaHorarios(grupo, horariosOcupados) {
                let salonesCandidatos = this.sistema.salones.filter(salon => {
                    for (const horarioInfo of horariosOcupados) {
                        if (!this.salonDisponibleEnBloque(salon, grupo, horarioInfo.horario, horarioInfo.dia)) {
                            return false;
                        }
                    }
                    return true;
                });

                if (salonesCandidatos.length === 0) return null;

                // Si es grupo prioritario, priorizar salones del piso 1
                if (this.gruposPrioritarios.includes(grupo.id)) {
                    const salonesPiso1 = salonesCandidatos.filter(s => s.piso === 1);
                    if (salonesPiso1.length > 0) {
                        salonesCandidatos = salonesPiso1;
                    }
                }

                salonesCandidatos.sort((a, b) => {
                    const ajusteA = Math.abs(a.capacidad - grupo.cantidadAlumnos);
                    const ajusteB = Math.abs(b.capacidad - grupo.cantidadAlumnos);
                    if (ajusteA !== ajusteB) return ajusteA - ajusteB;
                    return a.piso - b.piso;
                });

                return salonesCandidatos[0];
            }

            buscarSalonExhaustivoParaSemanaCompleta(grupo, horariosOcupados) {
                return this.buscarSalonDisponibleParaHorarios(grupo, horariosOcupados);
            }

            salonDisponibleEnBloque(salon, grupo, horario, dia) {
                if (salon.capacidad < grupo.cantidadAlumnos) return false;
                return salon.estaDisponible(horario, dia);
            }

            asignarSalonAGrupo(grupo, salon, horariosOcupados) {
                const diasHorarios = new Set(horariosOcupados.map(h => h.dia));
                const clasesGrupo = this.sistema.clases.filter(c => c.grupoId === grupo.id && diasHorarios.has(c.diaSemana));

                clasesGrupo.forEach(clase => {
                    clase.salonActual = salon.id;
                    clase.edificioActual = salon.edificio;
                    this.sistema.asignaciones.push({
                        clase: clase,
                        salon: salon,
                        salonId: salon.id,
                        grupoId: grupo.id,
                        horario: { horaInicio: clase.horaInicio, horaFin: clase.horaFin },
                        dia: clase.diaSemana,
                        materia: clase.nombreAsignatura,
                        maestro: clase.maestro,
                        bloque: 'Asignado',
                        mensaje: `${clase.nombreAsignatura} en ${salon.id}`
                    });
                });

                horariosOcupados.forEach(horarioInfo => {
                    salon.ocupar(horarioInfo.dia, horarioInfo.horario, grupo.id);
                });
                salon.grupoAsignadoFijo = grupo.id;
            }

            intentarAsignacionDividida(grupo, horariosOcupados) {
                const diasUnicos = [...new Set(horariosOcupados.map(h => h.dia))].sort();
                if (diasUnicos.length < 2) return false;

                const puntoDivision = Math.floor(diasUnicos.length / 2);
                const diasPrimera = diasUnicos.slice(0, puntoDivision);
                const diasSegunda = diasUnicos.slice(puntoDivision);

                const horariosPrimera = horariosOcupados.filter(h => diasPrimera.includes(h.dia));
                const horariosSegunda = horariosOcupados.filter(h => diasSegunda.includes(h.dia));

                const salonPrimera = this.buscarSalonDisponibleParaHorarios(grupo, horariosPrimera);
                const salonSegunda = this.buscarSalonDisponibleParaHorarios(grupo, horariosSegunda);

                if (salonPrimera && salonSegunda) {
                    this.asignarSalonAGrupo(grupo, salonPrimera, horariosPrimera);
                    this.asignarSalonAGrupo(grupo, salonSegunda, horariosSegunda);
                    this.sistema.gruposDivididos.set(grupo.id, {
                        salones: [salonPrimera, salonSegunda],
                        dias: { [salonPrimera.id]: diasPrimera, [salonSegunda.id]: diasSegunda }
                    });
                    return true;
                }
                return false;
            }
        }

        // ============================================
        // FUNCIONES DE PERSISTENCIA
        // ============================================


        // Función para guardar datos de asignación en el servidor y localmente
        function guardarDatosAsignacion() {
            if (!sistema) return;

            const reporte = sistema.generarReporte();
            const datosAGuardar = {
                resumen: reporte.resumen,
                clases: sistema.clases,
                clasesVirtuales: sistema.clasesVirtuales,
                clasesLaboratorio: sistema.clasesLaboratorio,
                errores: sistema.errores,
                gruposPrioritarios: Array.from(gruposPrioritarios),
                gruposDivididos: Array.from(sistema.gruposDivididos.entries()), // Convert Map to Array for JSON
                salones: sistema.salones.map(salon => ({
                    id: salon.id,
                    edificio: salon.edificio,
                    piso: salon.piso,
                    capacidad: salon.capacidad,
                    accesible: salon.accesible,
                    horariosOcupados: salon.horariosOcupados,
                    grupoAsignadoFijo: salon.grupoAsignadoFijo
                })),
                filtros: {
                    currentFilter: currentFilter
                },
                timestamp: new Date().toISOString(),
                version: '1.1'
            };

            // 1. Guardar localmente para acceso rápido
            try {
                localStorage.setItem('datosAsignacionSalones', JSON.stringify(datosAGuardar));
                console.log('Datos de asignación guardados localmente');
            } catch (error) {
                console.error('Error al guardar datos localmente:', error);
            }

            // 2. Sincronizar con la vista de edificios inmediatamente
            sincronizarVistaEdificiosDesdeSistema();

            // 3. Guardar en el servidor para persistencia compartida
            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success) {
                        console.log('Datos de asignación sincronizados con el servidor');
                        showNotification('Progreso guardado en el sistema correctamente', 'success');
                    } else {
                        console.error('Error en el servidor:', response.message);
                        showNotification('Guardado localmente, pero falló la sincronización con el sistema', 'warning');
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error de red al guardar en servidor:', error);
                    showNotification('Guardado localmente. Error de conexión con el sistema.', 'warning');
                })
                .guardarEstadoAsignacion(datosAGuardar);
        }


        // Función para cargar datos de asignación desde localStorage
        function cargarDatosAsignacion() {
            try {
                const datosGuardados = localStorage.getItem('datosAsignacionSalones');
                if (!datosGuardados) return null;

                const datos = JSON.parse(datosGuardados);

                // Validar versión (Aceptar 1.0 y 1.1 por transición)
                if (!datos.version || !['1.0', '1.1'].includes(datos.version)) {
                    console.warn('Versión de datos incompatible, ignorando datos guardados');
                    return null;
                }

                return datos;
            } catch (error) {
                console.error('Error al cargar datos:', error);
                return null;
            }
        }

        // Función para sincronizar datos desde el servidor al iniciar
        function sincronizarDesdeServidor() {
            console.log('Iniciando sincronización con el servidor...');

            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success && response.datos) {
                        console.log('Datos recuperados del servidor exitosamente');

                        // Verificar si los datos del servidor son más recientes que los locales
                        const datosLocales = cargarDatosAsignacion();
                        const serverTimestamp = new Date(response.datos.timestamp).getTime();
                        const localTimestamp = datosLocales ? new Date(datosLocales.timestamp).getTime() : 0;

                        if (serverTimestamp > localTimestamp) {
                            localStorage.setItem('datosAsignacionSalones', JSON.stringify(response.datos));
                            console.log('LocalStorage actualizado con datos más recientes del servidor');

                            // Si estamos en la página de inicio, recargar estadísticas
                            loadStatistics();

                            showNotification('Información actualizada desde el servidor', 'info');
                        }
                    } else {
                        console.log('No hay datos más recientes en el servidor o el servidor no respondió correctamente');
                    }
                })
                .withFailureHandler(function (error) {
                    console.error('Error al intentar sincronizar con el servidor:', error);
                })
                .obtenerEstadoAsignacion();
        }

        // Función para sincronizar el objeto salonData con los resultados reales
        function sincronizarVistaEdificiosDesdeSistema() {
            if (!sistema || !sistema.salones) return;

            console.log('Sincronizando vista de edificios con datos reales...');

            sistema.salones.forEach(salon => {
                const tieneOcupacion = salon.horariosOcupados && salon.horariosOcupados.length > 0;

                // Actualizar salonData (el objeto que usa la vista de edificios)
                salonData[salon.id] = {
                    id: salon.id,
                    status: tieneOcupacion ? "ocupado" : (salon.accesible ? "accesible" : "disponible"),
                    groups: salon.horariosOcupados.map(h => {
                        // Normalize day for indexDia and display
                        const diaNorm = h.dia ? h.dia.trim().toLowerCase() : "";

                        // Intentar encontrar la clase completa en sistema.asignaciones para tener más detalles
                        const asignacion = sistema.asignaciones.find(a =>
                            a.clase && a.clase.grupoId === h.grupoId &&
                            (a.clase.diaSemana || "").trim().toLowerCase() === diaNorm &&
                            a.clase.horaInicio === h.horario.horaInicio
                        );

                        return {
                            name: asignacion ? asignacion.clase.nombreAsignatura : "Clase Asignada",
                            code: h.grupoId,
                            schedule: `${h.dia} ${h.horario.horaInicio}-${h.horario.horaFin}`,
                            teacher: asignacion ? (asignacion.clase.maestro || "No especificado") : "Consultar administrador"
                        };
                    }),
                    schedule: generarEstructuraHorarioParaVista(salon.horariosOcupados)
                };
            });
        }

        // Función auxiliar para convertir el formato de horarios ocupados al que espera la vista de edificios
        function generarEstructuraHorarioParaVista(horariosOcupados) {
            const estructura = {
                "07:00-09:00": ["", "", "", "", ""],
                "09:00-11:00": ["", "", "", "", ""],
                "11:00-13:00": ["", "", "", "", ""],
                "13:00-14:00": ["Comida", "Comida", "Comida", "Comida", "Comida"],
                "14:00-16:00": ["", "", "", "", ""],
                "16:00-18:00": ["", "", "", "", ""],
                "18:00-20:00": ["", "", "", "", ""],
                "20:00-22:00": ["", "", "", "", ""]
            };

            const indexDia = { "lunes": 0, "martes": 1, "miércoles": 2, "miercoles": 2, "jueves": 3, "viernes": 4 };
            horariosOcupados.forEach(h => {
                const diaNormalizado = (h.dia || "").trim().toLowerCase();
                const col = indexDia[diaNormalizado];
                const slot = `${h.horario.horaInicio}-${h.horario.horaFin}`;

                if (estructura[slot]) {
                    // Buscar nombre de materia si es posible
                    const asignacion = sistema.asignaciones.find(a =>
                        a.clase && a.clase.grupoId === h.grupoId &&
                        a.clase.diaSemana === h.dia &&
                        a.clase.horaInicio === h.horario.horaInicio
                    );
                    estructura[slot][col] = asignacion ? asignacion.clase.nombreAsignatura : h.grupoId;
                }
            });

            return estructura;
        }

        // Función para verificar si hay datos guardados
        function hayDatosGuardados() {
            return localStorage.getItem('datosAsignacionSalones') !== null;
        }



        // Función para limpieza profunda (Reiniciar todo)
        function limpiarTodoYReiniciar() {
            Swal.fire({
                title: '¿Reiniciar todo el sistema?',
                text: "Se borrarán todas las asignaciones actuales de la memoria y del almacenamiento local. Los datos en Google Sheets no se verán afectados.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, reiniciar todo',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('datosAsignacionSalones');
                    sistema = new SistemaAsignacion();
                    sincronizarVistaEdificiosDesdeSistema();
                    loadAsignacionContent();

                    Swal.fire(
                        'Reiniciado',
                        'El sistema ha sido limpiado correctamente.',
                        'success'
                    );
                }
            });
        }

        // Función para limpiar datos guardados
        function limpiarDatosGuardados() {
            localStorage.removeItem('datosAsignacionSalones');
            showNotification('Datos locales eliminados. Al recargar se recuperarán los del servidor.', 'info');
        }

        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================

        // Verificar sesión al cargar la página
        if (!localStorage.getItem('sessionToken')) {
            window.location.href = 'Index.html';
        }

        // Configurar logout
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function () {
                localStorage.removeItem('sessionToken');
                localStorage.removeItem('userName');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userIsAdmin');
                window.location.href = 'Index.html';
            });
        }

        // Inicializar la página cuando se carga
        document.addEventListener("DOMContentLoaded", function () {
            if (!isInitialized) {
                initializePage();
                isInitialized = true;
            }
        });

        // Inicializar la página
        function initializePage() {
            // Inicializar datos de salones
            initializeSalonData();

            // Intentar restaurar visualización desde datos locales para rapidez
            if (hayDatosGuardados()) {
                restaurarVisualizacionDesdeGuardados();
            }

            // Sincronizar con el servidor para obtener datos más recientes
            sincronizarDesdeServidor();

            // Configurar eventos básicos
            setupBasicEvents();

            // Configurar el menú lateral
            setupMenuToggle();

            // Iniciar con sidebar colapsado
            document.body.classList.add('sidebar-collapsed');

            // Establecer ícono inicial del menú
            const menuToggle = document.getElementById('menuToggle');
            if (menuToggle) {
                const icon = menuToggle.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            }

            // Mostrar contenido inicial
            loadHomeContent();

            // Aplicar permisos de usuario
            applyUserPermissions();
        }

        // Configurar el toggle del menú
        function setupMenuToggle() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (menuToggle && sidebar && sidebarOverlay) {
                menuToggle.addEventListener('click', function () {
                    if (window.innerWidth <= 768) {
                        // Comportamiento móvil
                        sidebar.classList.toggle('active');
                        sidebarOverlay.classList.toggle('active');
                    } else {
                        // Comportamiento desktop - menú hamburguesa
                        document.body.classList.toggle('sidebar-collapsed');
                    }

                    // Cambiar el ícono del botón
                    const icon = menuToggle.querySelector('i');
                    if ((window.innerWidth <= 768 && sidebar.classList.contains('active')) ||
                        (window.innerWidth > 768 && !document.body.classList.contains('sidebar-collapsed'))) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });

                // Cerrar menú al hacer clic en el overlay (solo móvil)
                if (sidebarOverlay) {
                    sidebarOverlay.addEventListener('click', function () {
                        sidebar.classList.remove('active');
                        sidebarOverlay.classList.remove('active');

                        // Restaurar ícono
                        const icon = menuToggle.querySelector('i');
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    });
                }

                // Cerrar menú al hacer clic en un enlace del menú (solo móvil)
                document.querySelectorAll('.sidebar-link').forEach(link => {
                    link.addEventListener('click', function () {
                        if (window.innerWidth <= 768) {
                            sidebar.classList.remove('active');
                            sidebarOverlay.classList.remove('active');

                            // Restaurar ícono
                            const icon = menuToggle.querySelector('i');
                            icon.classList.remove('fa-times');
                            icon.classList.add('fa-bars');
                        }
                    });
                });
            }
        }

        // Inicializar datos de salones que no están en salonData
        function initializeSalonData() {
            const salonCards = document.querySelectorAll('.salon-card');
            salonCards.forEach(card => {
                const salonId = card.textContent.trim();
                if (!salonData[salonId]) {
                    // Determinar estado basado en las clases del elemento
                    let status = "disponible";
                    if (card.classList.contains('ocupado')) {
                        status = "ocupado";
                    } else if (card.classList.contains('accesible')) {
                        status = "accesible";
                    }

                    salonData[salonId] = {
                        status: status,
                        groups: []
                    };
                }
            });
        }

        // Configurar eventos básicos
        function setupBasicEvents() {
            // Manejo del input de búsqueda
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter' && typeof searchSalons === 'function') {
                        searchSalons();
                    }
                });
            }
        }

        // ============================================
        // FUNCIONES DE CARGA DE CONTENIDO
        // ============================================

        // Función principal para cargar contenido según la sección
        function loadContent(section) {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;

            // Set active link
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar-link[onclick*="loadContent('${section}')"]`);
            if (activeLink) activeLink.classList.add('active');

            if (section === 'inicio') {
                loadHomeContent();
            } else if (section === 'horarios') {
                loadHorariosContent();
            } else if (section === 'grupos') {
                loadGruposContent();
            } else if (section === 'edificios') {
                loadSalonesContent();
            } else if (section === 'asignacion') {
                loadAsignacionContent();
            } else if (section === 'reportes') {
                loadReportesContent();
            } else if (section === 'usuarios') {
                loadUsersContent();
            }

            // Cerrar sidebar en móviles
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const sidebarOverlay = document.getElementById('sidebarOverlay');
                const menuToggle = document.getElementById('menuToggle');

                if (sidebar && sidebarOverlay && menuToggle) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');

                    const icon = menuToggle.querySelector('i');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            }
        }

        // Función para cargar el contenido de inicio
        function loadHomeContent() {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;

            contentSection.innerHTML = `
                <div class="home-dashboard">
                    <!-- Tarjetas de Estadísticas -->
                    <div class="home-stat-cards">
                        <div class="home-stat-card">
                            <div class="home-stat-icon-wrapper icon-blue">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="home-stat-value" id="statTotalSessions">0</div>
                            <div class="home-stat-label">Total de Sesiones</div>
                        </div>
                        <div class="home-stat-card">
                            <div class="home-stat-icon-wrapper icon-green">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="home-stat-value" id="statPresencialGroups">0</div>
                            <div class="home-stat-label">Grupos Presenciales</div>
                        </div>
                        <div class="home-stat-card">
                            <div class="home-stat-icon-wrapper icon-orange">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="home-stat-value" id="statAssignments">0</div>
                            <div class="home-stat-label">Asignaciones Realizadas</div>
                        </div>
                        <div class="home-stat-card">
                            <div class="home-stat-icon-wrapper icon-purple">
                                <i class="fas fa-door-open"></i>
                            </div>
                            <div class="home-stat-value" id="statUsedSalons">0</div>
                            <div class="home-stat-label">Salones Utilizados</div>
                        </div>
                    </div>

                    <!-- Acciones Rápidas -->
                    <div class="home-section-title">
                        <i class="fas fa-rocket"></i> Acciones Rápidas
                    </div>
                    <div class="quick-actions-grid">
                        <div class="quick-action-box action-green" onclick="loadContent('asignacion')">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h3>Cargar Horarios CSV</h3>
                            <p>Arrastra o haz clic para subir</p>
                        </div>
                        <div class="quick-action-box action-yellow" onclick="loadContent('asignacion')">
                            <i class="fas fa-magic"></i>
                            <h3>Ejecutar Asignación Automática</h3>
                            <p>Asignar salones a todos los grupos</p>
                        </div>
                        <div class="quick-action-box action-blue" onclick="loadContent('reportes')">
                            <i class="fas fa-chart-pie"></i>
                            <h3>Ver Reportes</h3>
                            <p>Estadísticas y desplazamientos</p>
                        </div>
                        <div class="quick-action-box action-red" onclick="limpiarTodoYReiniciar()" style="background: rgba(229, 115, 115, 0.1); border-color: #e57373;">
                            <i class="fas fa-trash-alt" style="color: #e57373;"></i>
                            <h3 style="color: #e57373;">Reiniciar Todo</h3>
                            <p>Limpiar horarios y asignaciones</p>
                        </div>
                    </div>

                    <!-- Acerca del Algoritmo -->
                    <div class="home-section-title">
                        <i class="fas fa-info-circle"></i> Acerca del Algoritmo
                    </div>
                    <div class="algorithm-info-card">
                        <p class="algorithm-text">
                            El sistema asigna salones priorizando que cada grupo permanezca en el mismo salón durante todo el día. 
                            Si hay conflictos, los grupos de <b>turno intermedio</b> son los primeros en ser desplazados, 
                            seguidos por los grupos matutinos y vespertinos cuando es estrictamente necesario.
                        </p>
                    </div>
                </div>
            `;

            // Aplicar permisos de usuario después de cargar el contenido
            setTimeout(() => {
                applyUserPermissions();
            }, 100);

            // Cargar estadísticas
            loadStatistics();
        }

        // Función para cargar contenido de Horarios
        function loadHorariosContent() {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;

            contentSection.innerHTML = `
                <div class="section-header">
                    <h1><i class="fas fa-clock"></i> Horarios</h1>
                    <p>Gestión y consulta de todos los horarios cargados</p>
                </div>

                <div class="horarios-filters">
                    <div class="filter-group">
                        <label>Turno</label>
                        <select id="filterTurno">
                            <option value="todos">Todos</option>
                            <option value="matutino">Matutino</option>
                            <option value="vespertino">Vespertino</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Día</label>
                        <select id="filterDia">
                            <option value="todos">Todos los días</option>
                            <option value="Lunes">Lunes</option>
                            <option value="Martes">Martes</option>
                            <option value="Miércoles">Miércoles</option>
                            <option value="Jueves">Jueves</option>
                            <option value="Viernes">Viernes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Buscar Grupo</label>
                        <input type="text" id="filterGrupoBusqueda" placeholder="Ej. 231...">
                    </div>
                    <button class="btn-upload-csv" onclick="loadContent('asignacion')">
                        <i class="fas fa-upload"></i> Cargar CSV
                    </button>
                </div>

                <div class="table-container">
                    <table class="table-lide">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Grupo</th>
                                <th>Asignatura</th>
                                <th>Maestro</th>
                                <th>Día</th>
                                <th>Hora</th>
                                <th>Turno</th>
                                <th>Modalidad</th>
                            </tr>
                        </thead>
                        <tbody id="horariosTableBody">
                            <!-- Los datos se cargarán dinámicamente -->
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px; color: var(--gris-texto);">
                                    Cargando horarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Cargar datos reales
            renderHorariosTable();
        }

        // Función para cargar contenido de Grupos
        function loadGruposContent() {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;

            contentSection.innerHTML = `
                <div class="section-header">
                    <h1><i class="fas fa-users-class"></i> Grupos</h1>
                    <p>Relación de grupos y sus esquemas de horarios</p>
                </div>

                <div class="table-container">
                    <table class="table-lide">
                        <thead>
                            <tr>
                                <th>Grupo</th>
                                <th>Turno Principal</th>
                                <th>Sesiones</th>
                                <th>Capacidad</th>
                                <th>Días</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="gruposTableBody">
                            <!-- Los datos se cargarán dinámicamente -->
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 40px; color: var(--gris-texto);">
                                    Cargando grupos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Cargar datos reales
            renderGruposTable();
        }

        // Función para cargar contenido de Reportes
        function loadReportesContent() {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;

            contentSection.innerHTML = `
                <div class="section-header">
                    <h1><i class="fas fa-chart-bar"></i> Reportes y Estadísticas</h1>
                    <p>Métricas detalladas sobre la asignación actual</p>
                </div>

                <div class="report-stats-grid">
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="reportStatAsignaciones">0</div>
                        <div class="report-stat-label">Total Asignaciones</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="reportStatDesplazamientos">0</div>
                        <div class="report-stat-label">Con Desplazamiento</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="reportStatTasaPorcentaje">0%</div>
                        <div class="report-stat-label">Tasa Desplazamiento</div>
                    </div>
                    <div class="report-stat-card">
                        <div class="report-stat-value" id="reportStatSalones">0</div>
                        <div class="report-stat-label">Salones Usados</div>
                    </div>
                </div>

                <div class="empty-state">
                    <i class="fas fa-info-circle"></i>
                    <h3>No hay asignación activa</h3>
                    <p>Ejecuta una asignación para ver reportes detallados</p>
                </div>
            `;

            // Cargar estadísticas si existen
            updateReportStats();
        }

        // Función para cargar contenido de salones (anteriormente edificios)
        function loadSalonesContent() {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;

            contentSection.innerHTML = `
                <div class="welcome-section">
                    <h1 class="welcome-title">Gestión de Salones</h1>
                    <p class="welcome-subtitle">Monitoreo de ocupación y horarios por edificio</p>
                </div>

                <div class="controls">
                    <div class="search-bar">
                        <input type="text" id="searchInput" placeholder="Buscar salón o grupo...">
                        <button onclick="searchSalons()">Buscar</button>
                    </div>
                    <div class="filters">
                        <button class="filter-btn active" onclick="showAllSalons()">Ver todos</button>
                        <button class="filter-btn" onclick="limpiarTodoYReiniciar()">Reiniciar Vista</button>
                    </div>
                </div>

                <div class="buildings-container" id="buildingsContainer">
                    <div class="loading-buildings">
                        <div class="spinner"></div>
                        <p>Cargando información de salones...</p>
                    </div>
                </div>
            `;

            // Cargar edificios
            loadBuildings();
        }

        // Función para cargar contenido de usuarios
        function loadUsersContent() {
            // Verificar permisos de administrador
            const userIsAdmin = localStorage.getItem('userIsAdmin') === 'true';
            const userRole = localStorage.getItem('userRole');

            if (!userIsAdmin && userRole !== 'admin') {
                if (typeof showNotification === 'function') {
                    showNotification('No tienes permisos para acceder a la gestión de usuarios', 'error');
                }
                return;
            }

            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;

            contentSection.innerHTML = `
                <div class="section-header">
                    <h1>Gestión de Usuarios</h1>
                    <p>Administra los usuarios del sistema</p>
                </div>

                <div class="users-controls">
                    <button class="btn-primary" onclick="showAddUserForm()">
                        <i class="fas fa-user-plus"></i> Nuevo Usuario
                    </button>
                </div>

                <div class="users-list-container" id="usersListContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando usuarios...</p>
                    </div>
                </div>
            `;

            // Cargar lista de usuarios
            loadUsersList();
        }

        // ============================================
        // FUNCIONES DE RENDERIZADO DE TABLAS (NUEVAS)
        // ============================================

        function renderHorariosTable() {
            const tbody = document.getElementById('horariosTableBody');
            if (!tbody) return;

            const datos = cargarDatosAsignacion();
            const clases = (datos && datos.clases) ? datos.clases : (sistema ? sistema.clases : []);
            const virtuales = (datos && datos.virtuales) ? datos.virtuales : (sistema ? sistema.clasesVirtuales : []);
            const laboratorios = (datos && datos.laboratorio) ? datos.laboratorio : (sistema ? sistema.clasesLaboratorio : []);

            // Combinar todas las clases
            let todas = [...clases];
            virtuales.forEach(v => todas.push(v.clase || v));
            laboratorios.forEach(l => todas.push(l.clase || l));

            if (todas.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--gris-texto);">No hay horarios cargados.</td></tr>`;
                return;
            }

            // Aplicar filtros
            const filterTurno = document.getElementById('filterTurno')?.value || 'todos';
            const filterDia = document.getElementById('filterDia')?.value || 'todos';
            const filterBusqueda = document.getElementById('filterGrupoBusqueda')?.value.toLowerCase() || '';

            let filtradas = todas.filter(c => {
                const hInicio = c.horaInicio || "";
                const matchTurno = filterTurno === 'todos' ||
                    (filterTurno === 'matutino' && parseInt(hInicio.split(':')[0]) < 12) ||
                    (filterTurno === 'vespertino' && parseInt(hInicio.split(':')[0]) >= 12);
                const matchDia = filterDia === 'todos' || (c.diaSemana === filterDia);
                const matchBusqueda = (c.grupoId || '').toLowerCase().includes(filterBusqueda) ||
                    (c.nombreAsignatura || '').toLowerCase().includes(filterBusqueda);
                return matchTurno && matchDia && matchBusqueda;
            });

            tbody.innerHTML = filtradas.map((c, idx) => {
                const hInicio = c.horaInicio || "";
                const isMatutino = parseInt(hInicio.split(':')[0]) < 12;
                return `
                <tr>
                    <td>${idx + 1}</td>
                    <td><b>${c.grupoId || ''}</b></td>
                    <td>${c.nombreAsignatura || ''}</td>
                    <td>${c.maestro || ''}</td>
                    <td>${c.diaSemana || ''}</td>
                    <td>${c.horaInicio || ''} - ${c.horaFin || ''}</td>
                    <td><span class="badge-turno ${isMatutino ? 'badge-matutino' : 'badge-vespertino'}">${isMatutino ? 'Matutino' : 'Vespertino'}</span></td>
                    <td>${c.modalidad || 'Presencial'}</td>
                </tr>
            `}).join('');

            // Agregar eventos a los filtros si existen
            ['filterTurno', 'filterDia', 'filterGrupoBusqueda'].forEach(id => {
                const el = document.getElementById(id);
                if (el && !el.dataset.hasEvent) {
                    el.addEventListener('change', renderHorariosTable);
                    if (id === 'filterGrupoBusqueda') el.addEventListener('input', renderHorariosTable);
                    el.dataset.hasEvent = 'true';
                }
            });
        }

        function renderGruposTable() {
            const tbody = document.getElementById('gruposTableBody');
            if (!tbody) return;

            const datos = cargarDatosAsignacion();
            if (!datos || !datos.clases) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--gris-texto);">No hay datos de grupos disponibles.</td></tr>`;
                return;
            }

            // Agrupar clases por grupo
            const gruposMap = new Map();
            datos.clases.forEach(c => {
                const hInicio = c.horaInicio || "";
                if (!gruposMap.has(c.grupoId)) {
                    gruposMap.set(c.grupoId, {
                        id: c.grupoId,
                        sesiones: 0,
                        capacidad: c.capacidadRequerida || 0,
                        dias: new Set(),
                        turno: parseInt(hInicio.split(':')[0]) < 12 ? 'Matutino' : 'Vespertino'
                    });
                }
                const g = gruposMap.get(c.grupoId);
                g.sesiones++;
                g.dias.add(c.diaSemana);
            });

            const grupos = Array.from(gruposMap.values()).sort((a, b) => a.id.localeCompare(b.id));

            tbody.innerHTML = grupos.map(g => `
                <tr>
                    <td><b>${g.id}</b></td>
                    <td><span class="badge-turno ${g.turno === 'Matutino' ? 'badge-matutino' : 'badge-vespertino'}">${g.turno}</span></td>
                    <td>${g.sesiones}</td>
                    <td>${g.capacidad}</td>
                    <td>${Array.from(g.dias).join(', ')}</td>
                    <td>
                        <button class="btn-action-small" onclick="showHorarioGrupo('${g.id}')">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateReportStats() {
            const datos = cargarDatosAsignacion();
            if (!datos || !datos.resumen) return;

            const emptyState = document.querySelector('.empty-state');
            if (emptyState && datos.asignaciones && datos.asignaciones.length > 0) {
                emptyState.style.display = 'none';
            }

            const rAsignaciones = document.getElementById('reportStatAsignaciones');
            const rDesplazamientos = document.getElementById('reportStatDesplazamientos');
            const rTasaPorcentaje = document.getElementById('reportStatTasaPorcentaje');
            const rSalones = document.getElementById('reportStatSalones');

            if (rAsignaciones) rAsignaciones.textContent = datos.resumen.asignadas || 0;
            if (rDesplazamientos) rDesplazamientos.textContent = datos.resumen.gruposDivididos || 0;

            if (rTasaPorcentaje) {
                const tasa = datos.resumen.asignadas > 0 ?
                    Math.round((datos.resumen.gruposDivididos / datos.resumen.asignadas) * 100) : 0;
                rTasaPorcentaje.textContent = tasa + '%';
            }

            if (rSalones) {
                const salonesUsados = new Set(datos.asignaciones.filter(a => a.salonId).map(a => a.salonId)).size;
                rSalones.textContent = salonesUsados;
            }
        }

        function showHorarioGrupo(grupoId) {
            const datos = cargarDatosAsignacion();
            if (!datos) return;

            const clasesGrupo = (datos.clases || []).filter(c => c.grupoId === grupoId);
            const asignacionesGrupo = (datos.asignaciones || []).filter(a => (a.clase && a.clase.grupoId === grupoId) || a.grupoId === grupoId);
            const salonesUnicos = new Set(asignacionesGrupo.filter(a => a.salonId).map(a => a.salonId)).size;

            Swal.fire({
                title: `<span style="color: var(--verde-claro)">Horario del Grupo ${grupoId}</span>`,
                html: `
                    <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                        <span class="badge-turno badge-matutino" style="padding: 8px 15px; font-size: 13px;">${clasesGrupo.length} sesiones</span>
                        <span class="badge-turno badge-vespertino" style="padding: 8px 15px; font-size: 13px; background-color: rgba(255, 193, 7, 0.2); color: #FFC107; border-color: rgba(255, 193, 7, 0.3);">${salonesUnicos} salones</span>
                    </div>
                `,
                confirmButtonText: 'Cerrar',
                confirmButtonColor: '#4CAF50',
                background: '#1a1a1a',
                color: '#fff',
                width: '600px'
            });
        }

        // Función para cargar el contenido de asignación
        function loadAsignacionContent() {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;

            // Mostrar indicador de carga
            contentSection.innerHTML = `
                <div class="loading-indicator">
                    <div class="spinner"></div>
                    <p>Cargando módulo de asignación...</p>
                </div>
            `;

            // Cargar el contenido del sistema de asignación
            setTimeout(() => {
                contentSection.innerHTML = `
                    <div class="container">
                        <h1>🏫 Sistema de Asignación de Salones</h1>

                        <!-- Sección 1: Carga de Archivos -->
                        <div class="process-section" id="uploadSection" style="${sistema && sistema.asignaciones && sistema.asignaciones.length > 0 ? 'display: none;' : ''}">
                            <div class="section-title">
                                <i class="fas fa-file-upload"></i>
                                <span>1. Carga de Archivos CSV</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <p style="margin: 0;">Selecciona el archivo CSV que contiene la información de las carreras o haz clic en "Procesar Archivos" para usar los archivos predeterminados</p>
                                <button class="btn-danger" onclick="limpiarTodoYReiniciar()" style="padding: 5px 10px; font-size: 12px; border-radius: 4px; background: rgba(229,115,115,0.1); border: 1px solid #e57373; color: #e57373;">
                                    <i class="fas fa-sync-alt"></i> Limpiar Todo
                                </button>
                            </div>
                            
                            <div class="file-upload-area" id="dropArea">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 48px; margin-bottom: 15px;"></i>
                                <p>Arrastra y suelta el archivo aquí o haz clic para seleccionarlo</p>
                                <input type="file" id="fileInput" accept=".csv" multiple style="display: none;">
                            </div>

                            <div class="file-list" id="fileList"></div>

                            <button class="btn-primary" id="processBtn" onclick="iniciarProcesamiento()" disabled>
                                <i class="fas fa-cogs"></i>
                                Procesar Archivos y Asignar Salones
                            </button>
                        </div>

                        <!-- Sección 2: Progreso -->
                        <div class="process-section" id="progressSection" style="display: none;">
                            <div class="section-title">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Procesando...</span>
                            </div>
                            <div class="progress-container" style="display: block;">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <p class="progress-text" id="progressText">Iniciando procesamiento...</p>
                            </div>
                            <div class="log-container" id="logContainer"></div>
                        </div>

                        <!-- Sección 3: Resultados -->
                        <div class="process-section" id="resultsSection" style="${sistema && sistema.asignaciones && sistema.asignaciones.length > 0 ? '' : 'display: none;'}">
                            <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <i class="fas fa-chart-bar"></i>
                                    <span>Resultados del Procesamiento</span>
                                </div>
                                <button class="btn-secondary" onclick="document.getElementById('uploadSection').style.display='block'; document.getElementById('resultsSection').style.display='none';" style="padding: 5px 10px; font-size: 12px;">
                                    <i class="fas fa-upload"></i> Nueva Carga
                                </button>
                            </div>

                            <div class="stats-grid" id="statsGrid">
                                <div class="stat-card presencial">
                                    <div class="stat-value" id="statPresencial">0</div>
                                    <div class="stat-label">Clases Presenciales</div>
                                </div>
                                <div class="stat-card virtual">
                                    <div class="stat-value" id="statVirtual">0</div>
                                    <div class="stat-label">Clases Virtuales</div>
                                </div>
                                <div class="stat-card laboratorio">
                                    <div class="stat-value" id="statLaboratorio">0</div>
                                    <div class="stat-label">Clases de Laboratorio</div>
                                </div>
                                <div class="stat-card asignada">
                                    <div class="stat-value" id="statAsignadas">0</div>
                                    <div class="stat-label">Clases Asignadas</div>
                                </div>
                                <div class="stat-card error">
                                    <div class="stat-value" id="statErrores">0</div>
                                    <div class="stat-label">Errores</div>
                                </div>
                            </div>

                            <div class="tabs">
                                <button class="tab-btn active" onclick="showTab('asignaciones')">Asignaciones</button>
                                <button class="tab-btn" onclick="showTab('laboratorios')">Laboratorios</button>
                                <button class="tab-btn" onclick="showTab('virtuales')">Virtuales</button>
                                <button class="tab-btn" onclick="showTab('errores')">Errores</button>
                                <button class="tab-btn" onclick="showTab('visualizacion')">Visualización</button>
                            </div>

                            <div id="asignaciones" class="tab-content active">
                                <div id="asignacionesContent"></div>
                            </div>
                            <div id="laboratorios" class="tab-content">
                                <div id="laboratoriosContent"></div>
                            </div>
                            <div id="virtuales" class="tab-content">
                                <div id="virtualesContent"></div>
                            </div>
                            <div id="errores" class="tab-content">
                                <div id="erroresContent"></div>
                            </div>
                            <div id="visualizacion" class="tab-content">
                                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                                    <button class="btn-secondary" onclick="reiniciarVisualizador()" style="display: flex; align-items: center; gap: 8px;">
                                        <i class="fas fa-undo"></i>
                                        Reiniciar Visualizador
                                    </button>
                                    <small style="color: var(--gris-texto);">Limpia la vista actual pero mantiene los datos guardados</small>
                                </div>
                                <div class="visualization-grid" id="visualizationGrid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal de Grupos Prioritarios -->
                    <div id="priorityModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>⭐ Seleccionar Grupos Prioritarios</h2>
                                <span class="close-modal" onclick="closePriorityModal()">&times;</span>
                            </div>
                            
                            <p>Seleccione los grupos que tendrán <strong style="color: var(--amarillo-medio);">OBLIGATORIA</strong> asignación en los salones del 1er piso (cerca del elevador)</p>
                            
                            <div class="priority-tags" id="priorityTags">
                                <span style="color: var(--gris-texto); font-style: italic;">No hay grupos prioritarios seleccionados</span>
                            </div>
                            
                            <div class="group-search">
                                <input type="text" id="groupSearchInput" placeholder="Buscar grupo..." oninput="filterGroups()">
                            </div>
                            
                            <h3 style="color: var(--verde-claro); margin-top: 15px;">Grupos Disponibles:</h3>
                            <div class="groups-grid" id="groupsGrid">
                                <!-- Los grupos se generarán dinámicamente -->
                            </div>
                            
                            <div class="modal-footer">
                                <button class="btn-secondary" onclick="closePriorityModal()">Cancelar</button>
                                <button class="btn-primary" onclick="savePriorityGroupsAndProcess()">
                                    <i class="fas fa-save"></i>
                                    Guardar Grupos Prioritarios y Asignar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Modal para Salones del Piso -->
                    <div id="floorModal" class="modal">
                        <div class="modal-content">
                            <span class="close" onclick="closeFloorModal()">&times;</span>
                            <h2 class="floor-modal-title" id="floorModalTitle">Salones del Piso</h2>
                            <div id="floorSalonsContainer" class="salon-grid-modal">
                                <!-- Los salones se cargarán aquí dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Modal para Detalles del Salón -->
                    <div id="salonModal" class="modal">
                        <div class="modal-content">
                            <span class="close" onclick="closeSalonModal()">&times;</span>
                            <h2 id="salonName">Nombre del Salón</h2>
                            <div id="salonStatus"></div>
                            <div id="salonDetails" class="salon-details">
                                <h3>Grupos Asignados</h3>
                                <div id="groupsList" class="groups-list">
                                    <!-- Los grupos se cargarán aquí -->
                                </div>

                                <h3 style="margin-top: 25px;">Horario del Salón</h3>
                                <table class="schedule-table" id="scheduleTable">
                                    <thead>
                                        <tr>
                                            <th>Hora</th>
                                            <th>Lunes</th>
                                            <th>Martes</th>
                                            <th>Miércoles</th>
                                            <th>Jueves</th>
                                            <th>Viernes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleBody">
                                        <!-- Los horarios se cargarán aquí -->
                                    </tbody>
                                </table>
                                <div id="currentStatus"
                                    style="margin-top: 20px; padding: 15px; border-radius: 8px; background-color: rgba(0,0,0,0.2);">
                                    <h4>Estado actual:</h4>
                                    <p id="currentStatusText"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Inicializar eventos del sistema de asignación
                inicializarSistemaAsignacion();

                // AUTO-RENDERIZAR: Si ya hay una asignación en memoria, mostrar los resultados inmediatamente
                if (sistema && sistema.asignaciones && sistema.asignaciones.length > 0) {
                    console.log("Detectados resultados previos al cargar sección, renderizando...");
                    mostrarResultados(true);
                }
            }, 100);
        }

        // Función para cargar contenido de configuración
        function loadSettingsContent() {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;

            contentSection.innerHTML = `
                <div class="section-header">
                    <h1>Configuración del Sistema</h1>
                    <p>Configura las opciones del sistema</p>
                </div>

                <div class="settings-container">
                    <div class="settings-card">
                        <h3><i class="fas fa-info-circle"></i> Información del Sistema</h3>
                        <div class="settings-info">
                            <p><strong>Versión:</strong> 2.0</p>
                            <p><strong>Desarrollado por:</strong> LIDE - UABC</p>
                            <p><strong>Última actualización:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-database"></i> Base de Datos</h3>
                        <div class="settings-info">
                            <p id="dbStatus">Verificando conexión...</p>
                            <button class="btn-secondary" onclick="testDatabase()">Probar Conexión</button>
                        </div>
                    </div>
                </div>
            `;

            // Probar conexión a la base de datos
            testDatabase();
        }

        // ============================================
        // FUNCIONES DEL SISTEMA DE ASIGNACIÓN
        // ============================================

        function inicializarSistemaAsignacion() {
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('fileInput');

            if (dropArea && fileInput) {
                dropArea.addEventListener('click', () => fileInput.click());
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.classList.add('dragover');
                });
                dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.classList.remove('dragover');
                    manejarArchivos(e.dataTransfer.files);
                });
                fileInput.addEventListener('change', (e) => manejarArchivos(e.target.files));
            }

            // Restaurar automáticamente si hay datos guardados
            if (hayDatosGuardados()) {
                console.log('Detectados datos guardados, restaurando visualización automáticamente...');
                setTimeout(() => {
                    if (restaurarVisualizacionDesdeGuardados()) {
                        // Si se restauró con éxito, mostrar los resultados inmediatamente
                        if (sistema && sistema.asignaciones && sistema.asignaciones.length > 0) {
                            mostrarResultados();
                        }
                    }
                }, 100);
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // Encontrar el botón correspondiente y activarlo
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const btnText = btn.textContent.toLowerCase().trim();
                if (tabName === 'asignaciones' && btnText.includes('asignaciones')) {
                    btn.classList.add('active');
                } else if (tabName === 'laboratorios' && btnText.includes('laboratorios')) {
                    btn.classList.add('active');
                } else if (tabName === 'virtuales' && btnText.includes('virtuales')) {
                    btn.classList.add('active');
                } else if (tabName === 'errores' && btnText.includes('errores')) {
                    btn.classList.add('active');
                } else if (tabName === 'visualizacion' && btnText.includes('visualizacion')) {
                    btn.classList.add('active');
                }
            });
        }

        function manejarArchivos(files) {
            archivosSeleccionados = Array.from(files);
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            if (archivosSeleccionados.length === 0) {
                fileList.innerHTML = '<p style="color: var(--gris-texto);">No se seleccionaron archivos. Se usarán los archivos predeterminados.</p>';
                document.getElementById('processBtn').disabled = false;
                return;
            }

            if (archivosSeleccionados.length > 5) {
                fileList.innerHTML = `<p style="color: var(--error);">Se permite un máximo de 5 archivos. Seleccionados: ${archivosSeleccionados.length}.</p>`;
                document.getElementById('processBtn').disabled = true;
                return;
            }

            archivosSeleccionados.forEach((archivo, index) => {
                const div = document.createElement('div');
                div.className = 'file-item processing';
                div.innerHTML = `
                    <span><i class="fas fa-file-csv"></i> ${archivo.name}</span>
                    <span class="status-badge processing" id="status-${index}">Pendiente</span>
                `;
                fileList.appendChild(div);
            });

            document.getElementById('processBtn').disabled = false;
        }

        async function iniciarProcesamiento() {
            document.getElementById('processBtn').disabled = true;

            try {
                sistema = new SistemaAsignacion();
                gruposDetectados = [];
                rawCSVData = []; // Resetear datos crudos

                // Si no hay archivos seleccionados, cargar los archivos por defecto
                let archivosACargar = archivosSeleccionados;
                if (archivosSeleccionados.length === 0) {
                    archivosACargar = [
                        'archivos/Horarios_Normalizados_Completo_LAE (1).csv',
                        'archivos/Horarios_Normalizados_Completo_LC.csv',
                        'archivos/Horarios_Normalizados_Completo_LIN.csv',
                        'archivos/Horarios_Normalizados_Completo_LNI.csv',
                        'archivos/Horarios_Normalizados_Completo_TC (2).csv'
                    ];
                }

                // Procesar archivos para detectar grupos
                for (const archivo of archivosACargar) {
                    let contenido;
                    if (typeof archivo === 'string') {
                        // Cargar desde URL/path
                        const response = await fetch(archivo);
                        if (!response.ok) {
                            throw new Error(`No se pudo cargar ${archivo}`);
                        }
                        contenido = await response.text();
                    } else {
                        // Archivo subido
                        contenido = await leerArchivo(archivo);
                    }
                    const datos = parsearCSV(contenido);

                    // Almacenar datos crudos para el servidor
                    rawCSVData = rawCSVData.concat(datos);

                    datos.forEach(fila => {
                        const clase = new Clase(fila);
                        sistema.procesarClase(clase);
                        if (clase.grupoId && !gruposDetectados.includes(clase.grupoId) && clase.grupoId !== 'VIR') {
                            gruposDetectados.push(clase.grupoId);
                        }
                    });
                }

                // Ordenar grupos
                gruposDetectados.sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

                // GUARDAR EN GOOGLE SHEETS INMEDIATAMENTE AL CARGAR
                if (rawCSVData.length > 0) {
                    Swal.fire({
                        title: 'Guardando datos en Google Sheets...',
                        text: 'Se están respaldando los horarios cargados para el Dashboard.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    google.script.run
                        .withSuccessHandler(function (response) {
                            console.log('CSV guardado en Sheet:', response.message);
                            // Cerrar el loading y mostrar el modal de prioridades
                            Swal.close();
                            mostrarModalGruposPrioritarios();
                        })
                        .withFailureHandler(function (error) {
                            console.error('Error al guardar CSV en Sheet:', error);
                            Swal.fire('Atención', 'Se cargaron los datos localmente pero no se pudieron respaldar en Google Sheets: ' + error, 'warning')
                                .then(() => {
                                    mostrarModalGruposPrioritarios();
                                });
                        })
                        .guardarHorariosEnSheet(rawCSVData);
                } else {
                    // Si por alguna razón no hay datos crudos, proceeder normalmente
                    mostrarModalGruposPrioritarios();
                }

            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', error.message, 'error');
                document.getElementById('processBtn').disabled = false;
            }
        }

        function mostrarModalGruposPrioritarios() {
            const modal = document.getElementById('priorityModal');
            const groupsGrid = document.getElementById('groupsGrid');
            const priorityTags = document.getElementById('priorityTags');

            // Generar botones de grupos
            groupsGrid.innerHTML = '';
            gruposDetectados.forEach(grupo => {
                const btn = document.createElement('button');
                btn.className = 'group-btn';
                btn.textContent = grupo;
                btn.onclick = () => toggleGrupoPrioritario(grupo, btn);
                groupsGrid.appendChild(btn);
            });

            // Mostrar tags de prioridad
            actualizarTagsPrioritarios();

            modal.style.display = 'block';
        }

        function toggleGrupoPrioritario(grupo, boton) {
            if (gruposPrioritarios.has(grupo)) {
                gruposPrioritarios.delete(grupo);
                boton.classList.remove('selected');
            } else {
                gruposPrioritarios.add(grupo);
                boton.classList.add('selected');
            }
            actualizarTagsPrioritarios();
        }

        function actualizarTagsPrioritarios() {
            const priorityTags = document.getElementById('priorityTags');
            if (gruposPrioritarios.size === 0) {
                priorityTags.innerHTML = '<span style="color: var(--gris-texto); font-style: italic;">No hay grupos prioritarios seleccionados</span>';
            } else {
                priorityTags.innerHTML = '';
                gruposPrioritarios.forEach(grupo => {
                    const tag = document.createElement('span');
                    tag.className = 'priority-tag';
                    tag.innerHTML = `${grupo} <button onclick="removerGrupoPrioritario('${grupo}')">&times;</button>`;
                    priorityTags.appendChild(tag);
                });
            }
        }

        function removerGrupoPrioritario(grupo) {
            gruposPrioritarios.delete(grupo);

            // Actualizar botón correspondiente
            const buttons = document.querySelectorAll('.group-btn');
            buttons.forEach(btn => {
                if (btn.textContent === grupo) {
                    btn.classList.remove('selected');
                }
            });

            actualizarTagsPrioritarios();
        }

        function filterGroups() {
            const searchTerm = document.getElementById('groupSearchInput').value.toLowerCase();
            const buttons = document.querySelectorAll('.group-btn');
            buttons.forEach(btn => {
                const visible = btn.textContent.toLowerCase().includes(searchTerm);
                btn.style.display = visible ? 'block' : 'none';
            });
        }

        function closePriorityModal() {
            document.getElementById('priorityModal').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
        }

        async function savePriorityGroupsAndProcess() {
            closePriorityModal();

            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';

            function addLog(mensaje, tipo = 'info') {
                const div = document.createElement('div');
                div.className = `log-entry ${tipo}`;
                div.textContent = `[${new Date().toLocaleTimeString()}] ${mensaje}`;
                logContainer.appendChild(div);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            function updateProgress(porcentaje, texto) {
                document.getElementById('progressFill').style.width = `${porcentaje}%`;
                document.getElementById('progressText').textContent = texto;
            }

            try {
                addLog('Inicializando sistema de asignación...', 'info');
                updateProgress(5, 'Sistema inicializado');

                addLog(`Total de salones: ${sistema.salones.length}`, 'info');
                addLog(`Grupos detectados: ${gruposDetectados.length}`, 'info');
                addLog(`Grupos prioritarios: ${Array.from(gruposPrioritarios).join(', ') || 'Ninguno'}`, 'warning');

                updateProgress(30, 'Iniciando asignación de salones...');

                const asignador = new AsignadorAutomatico(sistema, Array.from(gruposPrioritarios));
                asignador.asignarSalones();

                addLog('✅ Asignación de salones completada', 'success');
                updateProgress(60, 'Sincronizando datos...');

                // 🔄 CORRECCIÓN: Sincronizar salonData inmediatamente después de la asignación
                sincronizarVistaEdificiosDesdeSistema();
                addLog('✅ Datos sincronizados con vista de edificios', 'success');

                updateProgress(70, 'Generando reporte...');

                addLog('=== RESULTADOS ===', 'info');
                addLog(`   Asignaciones realizadas: ${sistema.asignaciones.length}`, 'success');
                addLog(`   Errores: ${sistema.errores.length}`, sistema.errores.length > 0 ? 'error' : 'success');
                if (sistema.gruposDivididos.size > 0) {
                    addLog(`   Grupos divididos: ${sistema.gruposDivididos.size}`, 'warning');
                }

                updateProgress(90, 'Generando visualización...');

                setTimeout(() => {
                    mostrarResultados();
                    // Guardar datos automáticamente después del procesamiento
                    guardarDatosAsignacion();

                    updateProgress(100, 'Completado');
                    addLog('Procesamiento completado exitosamente', 'success');
                    addLog('Datos guardados automáticamente', 'info');
                }, 500);

            } catch (error) {
                addLog(`Error: ${error.message}`, 'error');
                Swal.fire('Error', error.message, 'error');
                document.getElementById('processBtn').disabled = false;
            }
        }

        function leerArchivo(archivo) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('No se pudo leer el archivo'));
                reader.readAsText(archivo);
            });
        }

        function parsearCSV(contenido) {
            const lineas = contenido.split('\n').filter(linea => linea.trim() !== '');
            const encabezados = lineas[0].split(',').map(h => h.trim());
            const datos = [];

            for (let i = 1; i < lineas.length; i++) {
                const valores = lineas[i].split(',').map(v => v.trim());
                const fila = {};
                encabezados.forEach((encabezado, index) => {
                    fila[encabezado] = valores[index];
                });
                datos.push(fila);
            }
            return datos;
        }

        function mostrarResultados(skipSave = false) {
            const uploadSection = document.getElementById('uploadSection');
            const progressSection = document.getElementById('progressSection');
            const resultsSection = document.getElementById('resultsSection');

            if (uploadSection) uploadSection.style.display = 'none';
            if (progressSection) progressSection.style.display = 'none';
            if (resultsSection) resultsSection.style.display = 'block';

            const reporte = sistema.generarReporte();

            // GUARDAR RESULTADOS EN SHEET AUTOMÁTICAMENTE
            if (!skipSave && sistema && sistema.asignaciones && sistema.asignaciones.length > 0) {
                console.log("Iniciando guardado de resultados en Sheet...");
                google.script.run
                    .withSuccessHandler(function (response) {
                        console.log("Respuesta de guardado:", response);
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Datos Respaldados',
                                text: 'Se ha creado la hoja "Resultados_Acomodo" con la asignación final.',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        }
                    })
                    .withFailureHandler(function (error) {
                        console.error("Error al guardar resultados:", error);
                    })
                    .guardarResultadosAsignacion(sistema.asignaciones);
            }

            const elPresencial = document.getElementById('statPresencial');
            const elVirtual = document.getElementById('statVirtual');
            const elLaboratorio = document.getElementById('statLaboratorio');
            const elAsignadas = document.getElementById('statAsignadas');
            const elErrores = document.getElementById('statErrores');

            if (elPresencial) elPresencial.textContent = reporte.resumen.clasesPresenciales;
            if (elVirtual) elVirtual.textContent = reporte.resumen.clasesVirtuales;
            if (elLaboratorio) elLaboratorio.textContent = reporte.resumen.clasesLaboratorio;
            if (elAsignadas) elAsignadas.textContent = reporte.resumen.asignadas;
            if (elErrores) elErrores.textContent = reporte.resumen.errores;

            // Asignaciones
            let asignacionesHTML = `
                <table class="results-table">
                    <thead><tr><th>Grupo</th><th>Asignatura</th><th>Día</th><th>Horario</th><th>Salón</th><th>Edificio</th><th>Estado</th></tr></thead><tbody>
            `;
            reporte.asignaciones.forEach(asignacion => {
                if (asignacion.clase) {
                    const estado = asignacion.salon ? 'asignado' : 'no-asignado';
                    const salon = asignacion.salon ? asignacion.salon.id : 'No asignado';
                    const edificio = asignacion.salon ? asignacion.salon.edificio : '-';
                    asignacionesHTML += `<tr><td>${asignacion.clase.grupoId}</td><td>${asignacion.clase.nombreAsignatura}</td><td>${asignacion.clase.diaSemana}</td><td>${asignacion.clase.horaInicio} - ${asignacion.clase.horaFin}</td><td>${salon}</td><td>${edificio}</td><td><span class="status-badge ${estado}">${estado === 'asignado' ? 'Asignado' : 'No Asignado'}</span></td></tr>`;
                }
            });
            asignacionesHTML += '</tbody></table>';
            const elAsigContent = document.getElementById('asignacionesContent');
            if (elAsigContent) elAsigContent.innerHTML = asignacionesHTML;

            // Laboratorios
            let laboratoriosHTML = `
                <table class="results-table">
                    <thead><tr><th>Grupo</th><th>Asignatura</th><th>Tipo</th><th>Día</th><th>Horario</th></tr></thead><tbody>
            `;
            reporte.laboratorio.forEach(item => {
                laboratoriosHTML += `<tr><td>${item.clase.grupoId}</td><td>${item.clase.nombreAsignatura}</td><td><span class="status-badge laboratorio">${item.tipo}</span></td><td>${item.clase.diaSemana}</td><td>${item.clase.horaInicio} - ${item.clase.horaFin}</td></tr>`;
            });
            laboratoriosHTML += '</tbody></table>';
            const elLabContent = document.getElementById('laboratoriosContent');
            if (elLabContent) elLabContent.innerHTML = laboratoriosHTML;

            // Virtuales
            let virtualesHTML = `
                <table class="results-table">
                    <thead><tr><th>Grupo</th><th>Asignatura</th><th>Día</th><th>Horario</th></tr></thead><tbody>
            `;
            reporte.virtuales.forEach(item => {
                virtualesHTML += `<tr><td>${item.clase.grupoId}</td><td>${item.clase.nombreAsignatura}</td><td>${item.clase.diaSemana}</td><td>${item.clase.horaInicio} - ${item.clase.horaFin}</td></tr>`;
            });
            virtuallesHTML += '</tbody></table>';
            const elVirtContent = document.getElementById('virtualesContent');
            if (elVirtContent) elVirtContent.innerHTML = virtualesHTML;

            // Errores
            const elErrContent = document.getElementById('erroresContent');
            if (elErrContent) {
                if (reporte.errores.length > 0) {
                    let erroresHTML = '<div class="error-message">';
                    reporte.errores.forEach((error, index) => {
                        erroresHTML += `<p>${index + 1}. ${error.clase?.nombreAsignatura || 'Desconocida'}: ${error.mensaje}</p>`;
                    });
                    erroresHTML += '</div>';
                    elErrContent.innerHTML = erroresHTML;
                } else {
                    elErrContent.innerHTML = '<p style="color: var(--disponible);">No hay errores registrados.</p>';
                }
            }

            // 🔧 CORRECCIÓN: Crear contenedor para visualización si no existe
            let visualizationContainer = document.getElementById('visualizationGrid');
            if (!visualizationContainer) {
                // Buscar el contenedor de resultados para agregar la visualización
                const resultsSection = document.getElementById('resultsSection');
                if (resultsSection) {
                    // Crear una nueva sección para la visualización de horarios
                    const visualizationSection = document.createElement('div');
                    visualizationSection.style.marginTop = '30px';
                    visualizationSection.innerHTML = `
                        <h2 style="color: var(--verde-claro); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-calendar-alt"></i>
                            Visualización de Horarios por Salón
                        </h2>
                        <div id="visualizationGrid"></div>
                    `;
                    resultsSection.appendChild(visualizationSection);
                    console.log('✅ Contenedor visualizationGrid creado dinámicamente');
                }
            }

            // Visualización mejorada: Matriz semanal (Flujo Estricto)
            mostrarSalonesEnInterfaz();

            // Sincronizar con vista de edificios
            sincronizarGlobalSalonDataDesdeSistema();

            const elProcessBtn = document.getElementById('processBtn');
            if (elProcessBtn) elProcessBtn.disabled = false;

            if (!skipSave) Swal.fire('Éxito', 'Procesamiento completado correctamente', 'success');
        }

        // Función para reiniciar el visualizador
        function reiniciarVisualizador() {
            Swal.fire({
                title: '¿Reiniciar Visualizador?',
                text: 'Esto limpiará la visualización actual y restablecerá los filtros, pero mantendrá los datos guardados. ¿Deseas continuar?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4CAF50',
                cancelButtonColor: '#757575',
                confirmButtonText: 'Sí, reiniciar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Limpiar visualización actual
                    const elVisGrid = document.getElementById('visualizationGrid');
                    if (elVisGrid) elVisGrid.innerHTML = '';

                    // Restablecer filtros
                    currentFilter = 'all';
                    const filterButtons = document.querySelectorAll('.filter-btn');
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    const allBtn = document.querySelector('.filter-btn[onclick*="showAllSalons"]');
                    if (allBtn) allBtn.classList.add('active');

                    // Limpiar resultados de pestañas
                    const elAsigC = document.getElementById('asignacionesContent');
                    if (elAsigC) elAsigC.innerHTML = '';
                    const elLabC = document.getElementById('laboratoriosContent');
                    if (elLabC) elLabC.innerHTML = '';
                    const elVirtC = document.getElementById('virtualesContent');
                    if (elVirtC) elVirtC.innerHTML = '';
                    const elErrC = document.getElementById('erroresContent');
                    if (elErrC) elErrC.innerHTML = '';

                    // Limpiar estadísticas
                    const e1 = document.getElementById('statPresencial');
                    if (e1) e1.textContent = '0';
                    const e2 = document.getElementById('statVirtual');
                    if (e2) e2.textContent = '0';
                    const e3 = document.getElementById('statLaboratorio');
                    if (e3) e3.textContent = '0';
                    const e4 = document.getElementById('statAsignadas');
                    if (e4) e4.textContent = '0';
                    const e5 = document.getElementById('statErrores');
                    if (e5) e5.textContent = '0';

                    // Ocultar secciones de resultados
                    const uploadSection = document.getElementById('uploadSection');
                    const resultsSection = document.getElementById('resultsSection');
                    const progressSection = document.getElementById('progressSection');

                    if (resultsSection) resultsSection.style.display = 'none';
                    if (progressSection) progressSection.style.display = 'none';
                    if (uploadSection) uploadSection.style.display = 'block';

                    // Resetear variables globales pero mantener datos guardados
                    sistema = null;
                    gruposDetectados = [];
                    gruposPrioritarios.clear();

                    // Habilitar botón de procesar
                    const elProcBtn = document.getElementById('processBtn');
                    if (elProcBtn) elProcBtn.disabled = false;

                    showNotification('Visualizador reiniciado. Los datos guardados permanecen intactos.', 'success');

                    // Ofrecer restaurar desde datos guardados
                    setTimeout(() => {
                        if (hayDatosGuardados()) {
                            Swal.fire({
                                title: 'Datos Guardados Disponibles',
                                text: '¿Deseas restaurar la visualización desde los datos guardados?',
                                icon: 'info',
                                showCancelButton: true,
                                confirmButtonColor: '#4CAF50',
                                cancelButtonColor: '#757575',
                                confirmButtonText: 'Sí, restaurar',
                                cancelButtonText: 'No, gracias'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    restaurarVisualizacionDesdeGuardados();
                                }
                            });
                        }
                    }, 1000);
                }
            });
        }

        // Función para restaurar visualización desde datos guardados
        function restaurarVisualizacionDesdeGuardados() {
            const datos = cargarDatosAsignacion();
            if (!datos) {
                showNotification('No se pudieron cargar los datos guardados', 'error');
                return;
            }

            try {
                // Recrear sistema desde datos guardados
                sistema = new SistemaAsignacion();
                sistema.asignaciones = datos.asignaciones || [];
                sistema.errores = datos.errores || [];
                sistema.gruposDivididos = new Map(datos.gruposDivididos || []);

                // Recrear salones con datos guardados
                if (datos.salones) {
                    sistema.salones = datos.salones.map(salonData => {
                        const salon = new Salon(
                            salonData.id,
                            salonData.edificio,
                            salonData.piso,
                            salonData.capacidad,
                            salonData.accesible
                        );
                        salon.horariosOcupados = salonData.horariosOcupados || [];
                        salon.grupoAsignadoFijo = salonData.grupoAsignadoFijo;
                        return salon;
                    });
                }

                // Restaurar grupos prioritarios
                if (datos.gruposPrioritarios) {
                    gruposPrioritarios = new Set(datos.gruposPrioritarios);
                }

                // Restaurar filtros
                if (datos.filtros) {
                    currentFilter = datos.filtros.currentFilter || 'all';
                }

                // Mostrar resultados restaurados (saltando el guardado automático)
                mostrarResultados(true);

                // Sincronizar con la vista de edificios
                sincronizarGlobalSalonDataDesdeSistema();

                // Asegurar que la matriz se muestre (Flujo Estricto)
                mostrarSalonesEnInterfaz();

                showNotification('Visualización restaurada exitosamente desde datos guardados', 'success');

            } catch (error) {
                console.error('Error al restaurar visualización:', error);
                showNotification('Error al restaurar visualización', 'error');
            }
        }

        // Función Principal de Visualización: Genera la matriz semanal (Flujo Estricto)
        function mostrarSalonesEnInterfaz() {
            const container = document.getElementById('visualizationGrid');
            if (!container) {
                console.error('❌ Container visualizationGrid no encontrado');
                return;
            }

            // 🔍 VALIDACIÓN: Verificar que sistema existe y tiene datos
            if (!sistema || !sistema.salones || sistema.salones.length === 0) {
                console.error('❌ Sistema no inicializado o sin salones');
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--amarillo-medio);">⚠️ No hay datos de asignación disponibles. Por favor, procesa los archivos CSV primero.</div>';
                return;
            }

            console.log('✅ Iniciando visualización de salones');
            console.log(`📊 Total salones: ${sistema.salones.length}`);
            console.log(`📊 Total asignaciones: ${sistema.asignaciones.length}`);

            // Verificar cuántos salones tienen ocupación
            const salonesConOcupacion = sistema.salones.filter(s => s.horariosOcupados && s.horariosOcupados.length > 0);
            console.log(`📊 Salones con ocupación: ${salonesConOcupacion.length}`);

            let matrizHTML = `
                <div class="salon-matrix-section">
                    <div class="salon-matrix-header">
                        <div class="salon-matrix-title">📊 Resumen Operativo de Salones</div>
                        <div class="salon-matrix-info">
                            <span><i class="fas fa-door-open"></i> Salones: ${sistema.salones.length}</span>
                            <span><i class="fas fa-users"></i> Asignaciones: ${sistema.asignaciones.length}</span>
                            <span><i class="fas fa-check-circle"></i> Ocupados: ${salonesConOcupacion.length}</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn-danger" onclick="limpiarTodoYReiniciar()" style="display: flex; align-items: center; gap: 8px; background: #e57373; font-size: 0.9em;">
                            <i class="fas fa-trash-alt"></i>
                            Reiniciar Todo el Sistema
                        </button>
                    </div>
            `;

            const dias = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];
            const template = [
                { start: "07:00", end: "08:00" },
                { start: "08:00", end: "09:00" },
                { start: "09:00", end: "11:00" },
                { start: "11:00", end: "13:00" },
                { start: "13:00", end: "14:00" },
                { start: "14:00", end: "15:00" },
                { start: "15:00", end: "16:00" },
                { start: "16:00", end: "17:00" },
                { start: "17:00", end: "18:00" },
                { start: "18:00", end: "20:00" },
                { start: "20:00", end: "22:00" }
            ];

            // 🏗️ AGRUPACIÓN POR EDIFICIO
            for (const [edificioId, config] of Object.entries(CONFIG_EDIFICIOS)) {
                const salonesEdificio = sistema.salones.filter(s => s.edificio === edificioId);

                if (salonesEdificio.length === 0) continue;

                matrizHTML += `
                    <div class="building-group-section" style="margin-top: 40px; border-top: 2px solid var(--verde-medio); padding-top: 20px;">
                        <h2 style="color: var(--amarillo-medio); text-shadow: 0 0 10px rgba(255,179,71,0.3); margin-bottom: 25px; display: flex; align-items: center; gap: 15px;">
                            <i class="fas fa-building"></i>
                            Edificio ${edificioId} 
                            <span style="font-size: 0.6em; font-weight: normal; opacity: 0.7; color: var(--blanco);">(${salonesEdificio.length} salones)</span>
                        </h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px;">
                `;

                salonesEdificio.forEach((salon, salonIdx) => {
                    const tieneOcupacion = (salon.horariosOcupados || []).length > 0;

                    // 🔍 DEBUG: Log para cada salón con ocupación (solo unos pocos)
                    if (tieneOcupacion && salonIdx < 2 && (edificioId === 'D')) {
                        console.log(`🏢 Edificio ${edificioId} - Salón ${salon.id}:`, {
                            ocupaciones: salon.horariosOcupados.length,
                            detalles: salon.horariosOcupados.map(h => `${h.dia} ${h.horario.horaInicio}-${h.horario.horaFin} (${h.grupoId})`)
                        });
                    }

                    matrizHTML += `
                        <div class="salon-matrix-item" style="background: ${tieneOcupacion ? 'rgba(76, 175, 80, 0.08)' : 'rgba(255,255,255,0.02)'}; border: 1px solid ${tieneOcupacion ? 'var(--verde-medio)' : 'rgba(255,255,255,0.1)'}; border-radius: 12px; padding: 15px; transition: all 0.3s ease;">
                            <div class="salon-header-new" style="font-size: 1.1em; cursor: pointer; border: none; margin-bottom: 10px; padding: 0;" onclick="showSalonDetails('${salon.id}')">
                                <span style="color: var(--verde-claro); font-weight: bold; background: rgba(102,187,106,0.1); padding: 2px 8px; border-radius: 4px;">${salon.id}</span>
                                <span style="font-size: 0.8em; color: var(--gris-texto);">Cap: ${salon.capacidad} ${salon.accesible ? '♿' : ''}</span>
                                ${tieneOcupacion ? '<span class="pulse-indicator"></span>' : ''}
                            </div>
                            
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                    `;

                    dias.forEach((dia) => {
                        const ocupacionDia = (salon.horariosOcupados || [])
                            .filter(h => h.dia && h.dia.trim().toLowerCase() === dia.trim().toLowerCase());

                        // Siempre mostrar el día para que se vea la estructura del horario
                        matrizHTML += `
                            <div style="font-size: 0.85em; color: var(--amarillo-claro); margin: 8px 0 4px 0; display: flex; align-items: center; gap: 5px;">
                                <i class="far fa-calendar-alt"></i> ${dia}
                            </div>
                            <table class="daily-table" style="width: 100%; border-collapse: separate; border-spacing: 0 2px;">
                        `;

                        template.forEach(slot => {
                            const match = ocupacionDia.find(o => isTimeOverlap(o.horario.horaInicio, o.horario.horaFin, slot.start, slot.end));
                            const grupo = match ? match.grupoId : "";

                            const estado = grupo ? "🟥 Asignado" : "🟩 Libre";
                            const rowBg = grupo ? 'rgba(255,82,82,0.05)' : 'transparent';
                            const opacity = grupo ? '1' : '0.5';

                            matrizHTML += `
                                <tr style="background: ${rowBg}; opacity: ${opacity};">
                                    <td style="width: 85px; font-size: 11px; padding: 4px;">${slot.start}–${slot.end}</td>
                                    <td style="padding: 4px;">
                                        <div style="display: flex; align-items: center; gap: 5px; font-size: 11px;">
                                            <span style="color: ${grupo ? '#FF5252' : '#4CAF50'}">${estado.split(' ')[0]}</span>
                                            <span style="font-weight: 500;">${estado.split(' ')[1]}</span>
                                        </div>
                                    </td>
                                    <td style="font-weight: 700; color: var(--amarillo-claro); font-size: 11px; padding: 4px;">${grupo || "—"}</td>
                                </tr>
                            `;
                        });

                        matrizHTML += `</table>`;
                    });

                    matrizHTML += `
                            </div>
                        </div>
                    `;
                });

                matrizHTML += `
                        </div>
                    </div>
                `;
            }

            matrizHTML += `</div>`;

            // Generar línea de tiempo por grupo (para grupos divididos)
            if (sistema.gruposDivididos.size > 0) {
                matrizHTML += `
                    <div style="margin-top: 30px;">
                        <h3 style="color: var(--amarillo-medio); margin-bottom: 15px;">⚠️ Grupos Divididos en Múltiples Salones</h3>
                        <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid var(--amarillo-medio); border-radius: 8px; padding: 15px;">
                `;

                sistema.gruposDivididos.forEach((info, grupoId) => {
                    matrizHTML += `
                        <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <div style="color: var(--amarillo-claro); font-weight: 600; margin-bottom: 10px;">
                                Grupo: ${grupoId}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    `;

                    info.salones.forEach((salon, idx) => {
                        const diasAsignados = info.dias[salon.id] || [];
                        matrizHTML += `
                            <div style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 10px;">
                                <div style="color: var(--verde-claro); font-weight: 500; margin-bottom: 5px;">
                                    ${salon.id} (${salon.piso}° piso)
                                </div>
                                <div style="color: var(--gris-texto); font-size: 12px;">
                                    Días: ${diasAsignados.join(', ')}
                                </div>
                            </div>
                        `;
                    });

                    matrizHTML += `
                            </div>
                        </div>
                    `;
                });

                matrizHTML += `
                        </div>
                    </div>
                `;
            }

            matrizHTML += '</div>';
            document.getElementById('visualizationGrid').innerHTML = matrizHTML;
        }

        // ============================================
        // FUNCIONES DE EDIFICIOS Y SALONES
        // ============================================

        // Función para procesar datos y renderizar edificios
        function procesarYRenderizar(datosAsignacion) {
            console.log("Iniciando procesarYRenderizar...");

            // Estructura base de edificios
            const edificios = {
                'D': { nombre: 'Edificio D', totalSalones: 24, pisos: 4, salones: {} },
                'E': { nombre: 'Edificio E', totalSalones: 23, pisos: 4, salones: {} },
                'F': { nombre: 'Edificio F', totalSalones: 16, pisos: 4, salones: {} }
            };

            // Inicializar variables globales necesarias para la vista
            salonData = {};
            floorSalons = {};

            // Generar lista base de salones por edificio/piso
            const configEdificiosLocal = {
                'D': { pisos: 4, salonesPorPiso: [6, 6, 6, 6] },
                'E': { pisos: 4, salonesPorPiso: [6, 6, 6, 5] },
                'F': { pisos: 4, salonesPorPiso: [4, 4, 4, 4] }
            };

            for (const [letra, config] of Object.entries(configEdificiosLocal)) {
                for (let p = 1; p <= config.pisos; p++) {
                    edificios[letra].salones[p] = [];
                    const cantidad = config.salonesPorPiso[p - 1];
                    const floorKey = `${letra}${p}`;
                    floorSalons[floorKey] = [];

                    for (let s = 1; s <= cantidad; s++) {
                        const formattedSalonId = `${letra}-${p}${s < 10 ? '0' + s : s}`;

                        edificios[letra].salones[p].push(formattedSalonId);
                        floorSalons[floorKey].push(formattedSalonId);

                        // Generar slots de horario estándar
                        const schedule = {};
                        for (let h = 7; h < 22; h++) {
                            const start = h.toString().padStart(2, '0') + ":00";
                            const end = (h + 1).toString().padStart(2, '0') + ":00";
                            schedule[`${start}-${end}`] = ["", "", "", "", ""];
                        }

                        salonData[formattedSalonId] = {
                            id: formattedSalonId,
                            status: 'disponible',
                            groups: [],
                            schedule: schedule
                        };
                    }
                }
            }

            if (datosAsignacion) {
                const asignacionesRaw = Array.isArray(datosAsignacion) ? datosAsignacion : (datosAsignacion.asignaciones || []);
                console.log(`Procesando ${asignacionesRaw.length} asignaciones para edificios`);

                asignacionesRaw.forEach(asignacion => {
                    const sId = asignacion.salonId || (asignacion.salon ? asignacion.salon.id : null);
                    if (!sId || !salonData[sId]) return;

                    salonData[sId].status = 'ocupado';

                    const gId = asignacion.grupoId || (asignacion.clase ? asignacion.clase.grupoId : 'Desconocido');
                    const materia = asignacion.materia || (asignacion.clase ? asignacion.clase.nombreAsignatura : 'Asignatura');
                    const maestro = asignacion.maestro || (asignacion.clase ? asignacion.clase.maestro : 'Por asignar');
                    const dia = asignacion.dia || (asignacion.clase ? asignacion.clase.diaSemana : '');
                    const horario = asignacion.horario || (asignacion.clase ? { horaInicio: asignacion.clase.horaInicio, horaFin: asignacion.clase.horaFin } : null);

                    if (!horario) return;

                    const existeGrupo = salonData[sId].groups.find(g => g.name === gId);
                    if (!existeGrupo) {
                        salonData[sId].groups.push({
                            name: gId,
                            code: materia,
                            teacher: maestro,
                            schedule: `${dia}: ${horario.horaInicio}-${horario.horaFin}`
                        });
                    }

                    // Mapeo horario robusto
                    const startHour = parseInt(horario.horaInicio.split(':')[0]);
                    const endHour = parseInt(horario.horaFin.split(':')[0]);
                    const diaNorm = (dia || "").trim().toLowerCase();
                    const diasMap = ["lunes", "martes", "miércoles", "miercoles", "jueves", "viernes"];
                    let dIdx = diasMap.indexOf(diaNorm);
                    if (dIdx === 3) dIdx = 2; // Normalizar miercoles
                    const targetIdx = dIdx > 3 ? dIdx - 1 : dIdx;

                    if (dIdx !== -1) {
                        for (let h = startHour; h < endHour; h++) {
                            const slotKey = `${h.toString().padStart(2, '0')}:00-${(h + 1).toString().padStart(2, '0')}:00`;
                            if (salonData[sId].schedule[slotKey]) {
                                salonData[sId].schedule[slotKey][targetIdx] = gId;
                            }
                        }
                    }
                });
            }

            renderBuildings(edificios);
        }

        // Función para cargar edificios desde el servidor o memoria local
        function loadBuildings() {
            const container = document.getElementById('buildingsContainer');
            if (!container) return;

            // PRIORIDAD 1: Memoria actual
            if (sistema && sistema.asignaciones && sistema.asignaciones.length > 0) {
                console.log("Cargando edificios desde memoria");
                procesarYRenderizar(sistema);
                return;
            }

            // PRIORIDAD 2: Recurso Local
            if (hayDatosGuardados()) {
                console.log("Cargando edificios desde localStorage");
                restaurarVisualizacionDesdeGuardados();
                if (sistema && sistema.asignaciones && sistema.asignaciones.length > 0) {
                    procesarYRenderizar(sistema);
                    return;
                }
            }

            // PRIORIDAD 3: Servidor
            console.log("Cargando edificios desde servidor...");
            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success && response.asignaciones && response.asignaciones.length > 0) {
                        if (!sistema || !sistema.asignaciones || sistema.asignaciones.length === 0) {
                            localStorage.setItem('datosAsignacionSalones', JSON.stringify({ asignaciones: response.asignaciones, timestamp: response.timestamp, version: '1.1' }));
                            restaurarVisualizacionDesdeGuardados();
                        }
                        procesarYRenderizar(sistema || { asignaciones: response.asignaciones });
                    } else {
                        procesarYRenderizar(null);
                    }
                })
                .withFailureHandler(function (error) {
                    console.error("Error servidor edificios:", error);
                    procesarYRenderizar(null);
                })
                .obtenerResultadosAsignacion();
        }

        function renderBuildings(edificios) {
            console.log("Iniciando renderBuildings...");
            const container = document.getElementById('buildingsContainer');
            if (!container) return;

            let html = '';
            for (const [key, edificio] of Object.entries(edificios)) {
                let ocupados = 0;
                let total = 0;

                Object.values(edificio.salones).forEach(floor => {
                    floor.forEach(sId => {
                        total++;
                        if (salonData[sId] && salonData[sId].status === 'ocupado') ocupados++;
                    });
                });

                const pct = total > 0 ? Math.round((ocupados / total) * 100) : 0;

                html += `
                    <div class="building-card">
                        <div class="building-header">
                            <div class="building-icon">${key}</div>
                            <div class="building-info">
                                <h3>${edificio.nombre}</h3>
                                <p>Ocupación: ${ocupados}/${total} (${pct}%)</p>
                            </div>
                        </div>
                        <div class="building-floors">
                `;

                for (const [piso, salones] of Object.entries(edificio.salones)) {
                    html += `
                        <button class="floor-toggle" onclick="showFloorModal('${key}', ${piso})">
                            <span>Piso ${piso}</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    `;
                }

                html += `</div></div>`;
            }

            container.innerHTML = html || '<div class="no-data">No hay información de edificios disponible</div>';
            console.log("Renderizado de edificios completo.");
        }

        // Mostrar detalles del salón (VERSIÓN PLANTILLA ESTRICTA)
        function showSalonDetails(salonId) {
            const modal = document.getElementById("salonModal");
            const modalContent = modal.querySelector('.modal-content');

            const data = salonData[salonId] || {
                id: salonId,
                status: 'disponible',
                groups: [],
                schedule: {},
                capacidad: 40,
                accesible: true
            };

            modalContent.innerHTML = `
                <span class="close" onclick="closeSalonModal()">&times;</span>
                <div class="salon-header-new">
                    <span style="color: var(--verde-claro); font-weight: bold;">${data.id}</span>
                    <span style="opacity: 0.5;">—</span>
                    <span>Cap: ${data.capacidad || 40}</span>
                    <span style="opacity: 0.5;">—</span>
                    <span>${data.accesible ? '♿' : '🚶'}</span>
                </div>
                <div id="salonDailySchedule" class="salon-details"></div>
            `;

            const container = document.getElementById('salonDailySchedule');
            const dias = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];

            // Plantilla horaria específica solicitada por el usuario
            const template = [
                { start: "07:00", end: "08:00" },
                { start: "08:00", end: "09:00" },
                { start: "09:00", end: "11:00" },
                { start: "11:00", end: "13:00" },
                { start: "13:00", end: "14:00" },
                { start: "14:00", end: "15:00" },
                { start: "15:00", end: "16:00" },
                { start: "16:00", end: "17:00" },
                { start: "17:00", end: "18:00" },
                { start: "18:00", end: "20:00" },
                { start: "20:00", end: "22:00" }
            ];

            dias.forEach((dia, diaIdx) => {
                const daySection = document.createElement('div');
                daySection.className = 'daily-schedule-section';

                let html = `
                    <div class="day-header">
                        <span>🗓️ ${dia.toUpperCase()}</span>
                    </div>
                    <table class="daily-table">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Estado</th>
                                <th>Grupo</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                template.forEach(slot => {
                    // Verificar si el slot está ocupado.
                    // Buscamos overlap en el schedule del objeto data (que ya tiene los grupos)
                    let grupo = "";
                    const diasMap = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];

                    if (data.schedule) {
                        // El schedule de salonData está en slots de 1 hora
                        // Revisamos todos los slots de 1 hora que caen dentro del slot de la plantilla
                        const startH = parseInt(slot.start.split(':')[0]);
                        const endH = parseInt(slot.end.split(':')[0]);

                        for (let h = startH; h < endH; h++) {
                            const k = `${h.toString().padStart(2, '0')}:00-${(h + 1).toString().padStart(2, '0')}:00`;
                            if (data.schedule[k] && data.schedule[k][diaIdx]) {
                                grupo = data.schedule[k][diaIdx];
                                break;
                            }
                        }
                    }

                    const estado = grupo ? "🟥 Asignado" : "🟩 Libre";
                    const estadoClass = grupo ? "status-icon-asignado" : "status-icon-libre";
                    const displayGrupo = grupo || "—";

                    html += `
                        <tr>
                            <td class="hora-cell">${slot.start}–${slot.end}</td>
                            <td>
                                <div class="status-cell">
                                    <span class="${estadoClass}">${estado.split(' ')[0]}</span>
                                    <span>${estado.split(' ')[1]}</span>
                                </div>
                            </td>
                            <td class="grupo-cell">${displayGrupo}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table>`;
                daySection.innerHTML = html;
                container.appendChild(daySection);
            });

            modal.style.display = "block";
        }

        // Función auxiliar para renderizar fila de horario
        function renderScheduleRow(block) {
            return `
                <tr>
                    <td class="hora-cell">${block.start}–${block.end}</td>
                    <td>
                        <div class="status-cell">
                            <span class="${block.estadoClass}">${block.estado.split(' ')[0]}</span>
                            <span>${block.estado.split(' ')[1]}</span>
                        </div>
                    </td>
                    <td class="grupo-cell">${block.grupo || '—'}</td>
                </tr>
            `;
        }

        function closeSalonModal() {
            const modal = document.getElementById("salonModal");
            if (modal) modal.style.display = "none";
        }

        // Cerrar modal al hacer clic fuera de él
        window.onclick = function (event) {
            const salonModal = document.getElementById("salonModal");
            const floorModal = document.getElementById("floorModal");

            if (event.target == salonModal) {
                closeSalonModal();
            }

            if (event.target == floorModal) {
                closeFloorModal();
            }
        }

        // Mostrar modal del piso con sus salones
        function showFloorModal(building, floor) {
            const floorKey = `${building}${floor}`;
            const salons = floorSalons[floorKey];

            if (!salons) {
                showNotification(`No hay datos para el piso ${floor} del edificio ${building}`, 'warning');
                return;
            }

            // Actualizar título del modal
            document.getElementById('floorModalTitle').textContent = `Edificio ${building} - Piso ${floor}`;

            // Obtener contenedor y limpiarlo
            const container = document.getElementById('floorSalonsContainer');
            container.innerHTML = '';

            // Agregar cada salón al modal
            salons.forEach(salonId => {
                const salonInfo = salonData[salonId] || { status: "disponible" };
                const salonCard = document.createElement('div');
                salonCard.className = `salon-card-modal ${salonInfo.status}`;
                salonCard.textContent = salonId;
                salonCard.onclick = () => {
                    closeFloorModal();
                    setTimeout(() => showSalonDetails(salonId), 300);
                };

                // Agregar indicador de estado
                const statusIndicator = document.createElement('div');
                statusIndicator.className = 'status-badge';
                statusIndicator.textContent = salonInfo.status === 'ocupado' ? 'Ocupado' :
                    salonInfo.status === 'disponible' ? 'Disponible' : 'Accesible';
                statusIndicator.style.cssText = 'position: absolute; top: 5px; right: 5px; font-size: 10px; padding: 2px 6px;';

                salonCard.appendChild(statusIndicator);
                container.appendChild(salonCard);
            });

            // Mostrar modal
            document.getElementById('floorModal').style.display = 'block';
        }

        // Cerrar modal del piso
        function closeFloorModal() {
            document.getElementById('floorModal').style.display = 'none';
        }

        // Mostrar todos los salones (abrir primer piso del primer edificio)
        function showAllSalons() {
            showFloorModal('D', 1);
            showNotification('Mostrando todos los salones. Selecciona un piso para ver los salones.', 'info');
        }

        // Función auxiliar para verificar si una hora está en un rango
        function isTimeInRange(time, start, end) {
            const timeToMinutes = t => {
                const [h, m] = t.split(":").map(Number);
                return h * 60 + m;
            };

            const t = timeToMinutes(time);
            const s = timeToMinutes(start);
            const e = timeToMinutes(end);

            return t >= s && t <= e;
        }

        // Cerrar modal del salón
        function closeSalonModal() {
            document.getElementById("salonModal").style.display = "none";
        }

        // Funciones para edificios y salones (versión simplificada)
        function toggleFloor(floorId) {
            const floorGrid = document.getElementById(floorId);
            if (floorGrid) {
                floorGrid.classList.toggle('active');
                const toggleButton = floorGrid.previousElementSibling;
                if (toggleButton) toggleButton.classList.toggle('active');
            }
        }

        function searchSalons() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            if (searchTerm === '') {
                showNotification('Ingresa un término de búsqueda', 'warning');
                return;
            }

            // Buscar salón por nombre
            let foundSalon = null;
            for (const floorKey in floorSalons) {
                const salons = floorSalons[floorKey];
                foundSalon = salons.find(salon => salon.toLowerCase().includes(searchTerm));
                if (foundSalon) break;
            }

            // Si no encontró por nombre de salón, buscar por grupo
            if (!foundSalon) {
                for (const salonId in salonData) {
                    const salon = salonData[salonId];
                    if (salon.groups && salon.groups.length > 0) {
                        const foundGroup = salon.groups.find(group =>
                            group.name.toLowerCase().includes(searchTerm) ||
                            group.code.toLowerCase().includes(searchTerm)
                        );
                        if (foundGroup) {
                            foundSalon = salonId;
                            break;
                        }
                    }
                }
            }

            if (foundSalon) {
                // Extraer edificio y piso del salón encontrado (formato D-101)
                const parts = foundSalon.split('-');
                const building = parts[0];
                const floor = parseInt(parts[1].charAt(0));

                // Mostrar modal del piso
                showFloorModal(building, floor);

                setTimeout(() => {
                    // Resaltar el salón encontrado en el modal
                    const salonCards = document.querySelectorAll('.salon-card-modal');
                    salonCards.forEach(card => {
                        if (card.textContent.includes(foundSalon)) {
                            card.style.animation = 'pulse 1s infinite';
                            card.style.boxShadow = '0 0 10px var(--amarillo-medio)';
                            card.style.transform = 'scale(1.1)';
                            setTimeout(() => {
                                card.style.animation = '';
                                card.style.boxShadow = '';
                                card.style.transform = '';
                            }, 3000);

                            // Mostrar detalles después de un breve retraso
                            setTimeout(() => {
                                card.click();
                            }, 1000);
                        }
                    });

                    showNotification(`Resultado encontrado: ${foundSalon}`, 'success');
                }, 500);
            } else {
                showNotification(`No se encontraron resultados para: "${searchTerm}"`, 'warning');
            }
        }

        // ============================================
        // FUNCIONES DE USUARIOS
        // ============================================

        // Función para cargar lista de usuarios
        function loadUsersList() {
            // Datos mock para entorno local
            setTimeout(() => {
                const mockUsers = [
                    { id: '1', nombre: 'Admin Local', email: 'admin@local.com', rol: 'admin', activo: true },
                    { id: '2', nombre: 'Usuario 1', email: 'user1@local.com', rol: 'user', activo: true },
                    { id: '3', nombre: 'Usuario 2', email: 'user2@local.com', rol: 'user', activo: false }
                ];
                renderUsersList(mockUsers);
            }, 500);
        }

        // Función para renderizar lista de usuarios
        function renderUsersList(users) {
            const container = document.getElementById('usersListContainer');
            if (!container) return;

            if (users.length === 0) {
                container.innerHTML = '<p>No hay usuarios registrados.</p>';
                return;
            }

            let html = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.nombre}</td>
                        <td>${user.email}</td>
                        <td>${user.rol}</td>
                        <td>${user.activo ? '<span class="status-active">Activo</span>' : '<span class="status-inactive">Inactivo</span>'}</td>
                        <td>
                            <div class="user-actions">
                                <button class="btn-small btn-edit" onclick="editUser('${user.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-small btn-reset" onclick="resetUserPassword('${user.id}', '${user.nombre}')">
                                    <i class="fas fa-key"></i>
                                </button>
                                ${user.activo ?
                        `<button class="btn-small btn-deactivate" onclick="deactivateUser('${user.id}', '${user.nombre}')">
                                        <i class="fas fa-user-times"></i>
                                    </button>` :
                        `<button class="btn-small btn-activate" onclick="activateUser('${user.id}', '${user.nombre}')">
                                        <i class="fas fa-user-check"></i>
                                    </button>`
                    }
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Función para cargar estadísticas
        function loadStatistics() {
            const stats = {
                totalSessions: document.getElementById('statTotalSessions'),
                presencialGroups: document.getElementById('statPresencialGroups'),
                assignments: document.getElementById('statAssignments'),
                usedSalons: document.getElementById('statUsedSalons')
            };

            // 1. Intentar cargar desde el servidor (datos más fiables del Sheet)
            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success && response.datos) {
                        const d = response.datos;
                        if (stats.totalSessions) stats.totalSessions.textContent = d.totalClases || '0';
                        if (stats.presencialGroups) stats.presencialGroups.textContent = d.clasesPresenciales || '0';
                        if (stats.assignments) stats.assignments.textContent = d.asignadas || '0';
                        if (stats.usedSalons) stats.usedSalons.textContent = d.totalSalones || '0';
                    } else {
                        // 2. Fallback: Datos locales si el servidor no tiene o falla
                        const datosLocales = cargarDatosAsignacion();
                        if (datosLocales && datosLocales.resumen) {
                            if (stats.totalSessions) stats.totalSessions.textContent = datosLocales.resumen.totalClases || '0';
                            if (stats.presencialGroups) stats.presencialGroups.textContent = datosLocales.resumen.clasesPresenciales || '0';
                            if (stats.assignments) stats.assignments.textContent = datosLocales.resumen.asignadas || '0';

                            const salonesUsados = datosLocales.salones ? datosLocales.salones.filter(s => s.horariosOcupados && s.horariosOcupados.length > 0).length : 0;
                            if (stats.usedSalons) stats.usedSalons.textContent = salonesUsados;
                        }
                    }
                })
                .withFailureHandler(function () {
                    // Fallback local en caso de error de red
                    const datosLocales = cargarDatosAsignacion();
                    if (datosLocales && datosLocales.resumen) {
                        if (stats.totalSessions) stats.totalSessions.textContent = datosLocales.resumen.totalClases || '0';
                    }
                })
                .obtenerEstadisticasDashboard();
        }

        // Función para cargar contenido de configuración
        function loadSettingsContent() {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;

            contentSection.innerHTML = `
                <div class="section-header">
                    <h1>Configuración del Sistema</h1>
                    <p>Configura las opciones del sistema</p>
                </div>

                <div class="settings-container">
                    <div class="settings-card">
                        <h3><i class="fas fa-info-circle"></i> Información del Sistema</h3>
                        <div class="settings-info">
                            <p><strong>Versión:</strong> 2.0</p>
                            <p><strong>Desarrollado por:</strong> LIDE - UABC</p>
                            <p><strong>Última actualización:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3><i class="fas fa-database"></i> Base de Datos</h3>
                        <div class="settings-info">
                            <p id="dbStatus">Verificando conexión...</p>
                            <button class="btn-secondary" onclick="testDatabase()">Probar Conexión</button>
                        </div>
                    </div>
                </div>
            `;

            // Probar conexión a la base de datos
            testDatabase();
        }

        function testDatabase() {
            // Simular test de conexión local
            setTimeout(() => {
                document.getElementById('dbStatus').innerHTML = `
                    <span style="color: #4CAF50;">✓ Conexión local - OK</span>
                `;
            }, 500);
        }

        // ============================================
        // FUNCIONES DE GESTIÓN DE USUARIOS
        // ============================================

        function showAddUserForm() {
            // Verificar permisos
            Swal.fire({
                background: '#1a1a1a',
                color: '#fff',
                width: 550,
                showConfirmButton: false,
                showCloseButton: true,
                scrollbarPadding: false,
                html: `
                    <div class="new-user-header">
                        <i class="fas fa-user-plus"></i>
                        <h2>Nuevo Usuario</h2>
                    </div>

                    <div class="edit-form-container">
                        <div class="edit-group">
                            <label class="new-user-label"><i class="fas fa-id-card"></i> ID o Matrícula *</label>
                            <input type="text" id="new-user-id" class="edit-input" placeholder="Ej: 12345678 o Juan.Perez">
                            <span class="edit-hint">Identificador único del usuario en el sistema escolar</span>
                        </div>

                        <div class="edit-group">
                            <label class="new-user-label"><i class="fas fa-user"></i> Nombre Completo *</label>
                            <input type="text" id="new-user-nombre" class="edit-input" placeholder="Ej: Juan Pérez López">
                        </div>

                        <div class="edit-group">
                            <label class="new-user-label"><i class="fas fa-envelope"></i> Correo Electrónico *</label>
                            <input type="email" id="new-user-email" class="edit-input" placeholder="ejemplo@uabc.edu.mx">
                        </div>

                        <div class="edit-group">
                            <label class="new-user-label"><i class="fas fa-user-shield"></i> Rol del Usuario *</label>
                            <select id="new-user-rol" class="edit-select">
                                <option value="">-- Selecciona un rol --</option>
                                <option value="admin">Administrador</option>
                                <option value="usuario">Usuario Regular</option>
                            </select>
                            <span class="edit-hint">Los administradores pueden gestionar usuarios y configuración</span>
                        </div>

                        <p class="edit-footer-hint" style="color: #FFB347;">* Campos obligatorios</p>

                        <div class="edit-modal-buttons">
                            <button class="btn-create-final" onclick="recolectarYCrearUsuario()">
                                <i class="fas fa-check"></i> Crear Usuario
                            </button>
                            <button class="btn-cancel-final" onclick="Swal.close()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </div>
                `
            });
        }

        function recolectarYCrearUsuario() {
            const id = document.getElementById('new-user-id').value.trim();
            const nombre = document.getElementById('new-user-nombre').value.trim();
            const email = document.getElementById('new-user-email').value.trim();
            const rol = document.getElementById('new-user-rol').value;

            if (!id || !nombre || !email || !rol) {
                showNotification('Por favor completa todos los campos obligatorios', 'warning');
                return;
            }

            if (!email.includes('@')) {
                showNotification('Ingresa un correo electrónico válido', 'warning');
                return;
            }

            agregarUsuario({ id, nombre, email, rol });
        }

        function agregarUsuario(userData) {
            Swal.fire({
                title: 'Creando usuario...',
                background: '#1a1a1a',
                color: '#fff',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '¡Usuario Creado!',
                            text: response.message,
                            background: '#1a1a1a',
                            color: '#fff',
                            timer: 2500,
                            showConfirmButton: false
                        });
                        loadUsersList();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message,
                            background: '#1a1a1a',
                            color: '#fff'
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de conexión',
                        text: error.message,
                        background: '#1a1a1a',
                        color: '#fff'
                    });
                })
                .crearUsuario(userData);
        }

        // Función para cargar y mostrar la lista de usuarios desde el servidor
        function loadUsersList() {
            const container = document.getElementById('usersListContainer');
            if (!container) return;

            // Mostrar indicador de carga
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Obteniendo usuarios desde el servidor...</p>
                </div>
            `;

            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success) {
                        renderUsersTable(response.usuarios);
                    } else {
                        container.innerHTML = `
                            <div class="error-container">
                                <i class="fas fa-exclamation-circle"></i>
                                <p>Error al cargar usuarios: ${response.message}</p>
                                <button class="btn-primary" onclick="loadUsersList()">Reintentar</button>
                            </div>
                        `;
                    }
                })
                .withFailureHandler(function (error) {
                    container.innerHTML = `
                        <div class="error-container">
                            <i class="fas fa-wifi-slash"></i>
                            <p>Error de conexión: ${error.message}</p>
                            <button class="btn-primary" onclick="loadUsersList()">Reintentar</button>
                        </div>
                    `;
                })
                .obtenerUsuarios();
        }

        // Función para renderizar la tabla de usuarios
        function renderUsersTable(usuarios) {
            const container = document.getElementById('usersListContainer');
            if (!container) return;

            if (!usuarios || usuarios.length === 0) {
                container.innerHTML = '<p class="no-data">No hay usuarios registrados en el sistema.</p>';
                return;
            }

            let html = `
                <p class="hint-text"><i class="fas fa-mouse-pointer"></i> Haz clic en un usuario para ver sus detalles</p>
                <div class="table-responsive">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-user-circle"></i> Nombre</th>
                                <th><i class="fas fa-envelope"></i> Email</th>
                                <th><i class="fas fa-user-shield"></i> Rol</th>
                                <th><i class="fas fa-toggle-on"></i> Estado</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            usuarios.forEach(user => {
                const statusClass = user.activo ? 'status-active' : 'status-inactive';
                const statusText = user.activo ? 'Activo' : 'Inactivo';
                const statusIcon = user.activo ? 'fa-check-circle' : 'fa-times-circle';

                const isUserRole = user.rol.toLowerCase() === 'user' || user.rol.toLowerCase() === 'usuario';
                const roleIcon = isUserRole ? 'fa-user' : 'fa-crown';
                const roleLabel = isUserRole ? 'Usuario' : 'Admin';

                html += `
                    <tr onclick='showUserDetails(${JSON.stringify(user).replace(/'/g, "&apos;")})'>
                        <td class="user-name">
                            <i class="fas fa-user-circle user-icon"></i>
                            ${user.nombre}
                        </td>
                        <td class="user-email">${user.email}</td>
                        <td>
                            <span class="role-badge ${user.rol.toLowerCase()}">
                                <i class="fas ${roleIcon}"></i> ${roleLabel}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                <i class="fas ${statusIcon}"></i> ${statusText}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = html;
        }

        // Función para mostrar el modal de detalles de usuario
        function showUserDetails(user) {
            const isUserRole = user.rol.toLowerCase() === 'user' || user.rol.toLowerCase() === 'usuario';
            const roleLabel = isUserRole ? 'Usuario' : 'Administrador';
            const roleClass = isUserRole ? 'role-user' : 'role-admin';
            const roleIcon = isUserRole ? 'fa-user' : 'fa-crown';
            const statusClass = user.activo ? 'status-active' : 'status-inactive';
            const statusText = user.activo ? 'Activo' : 'Inactivo';
            const statusIcon = user.activo ? 'fa-check-circle' : 'fa-times-circle';
            const toggleStatusText = user.activo ? 'Desactivar' : 'Activar';
            const toggleStatusIcon = user.activo ? 'fa-user-slash' : 'fa-user-check';

            Swal.fire({
                background: '#1a1a1a',
                color: '#fff',
                width: 500,
                showConfirmButton: false,
                showCloseButton: true,
                scrollbarPadding: false,
                customClass: {
                    container: 'user-details-modal-container',
                    popup: 'user-detail-modal-custom'
                },
                html: `
                    <div class="user-details-header" style="margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 12px;">
                        <i class="fas fa-user-circle" style="font-size: 32px; color: #66BB6A;"></i>
                        <h2 style="margin: 0; font-size: 28px; color: #81C784;">${user.nombre}</h2>
                    </div>

                    <div class="user-details-body">
                        <div class="detail-row">
                            <div class="detail-icon-box"><i class="fas fa-id-card"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">ID / Matrícula</div>
                                <div class="detail-value">${user.id}</div>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-icon-box"><i class="fas fa-envelope"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">Correo Electrónico</div>
                                <div class="detail-value">${user.email}</div>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-icon-box"><i class="fas fa-user-tag"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">Rol</div>
                                <div class="detail-value ${roleClass}"><i class="fas ${roleIcon}"></i> ${roleLabel}</div>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-icon-box"><i class="fas fa-toggle-on"></i></div>
                            <div class="detail-content">
                                <div class="detail-label">Estado</div>
                                <div class="detail-value ${statusClass}"><i class="fas ${statusIcon}"></i> ${statusText}</div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-action-buttons">
                        <button class="modal-btn btn-edit-modal" onclick="Swal.close(); editUser('${user.id}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="modal-btn btn-pass-modal" onclick="Swal.close(); resetUserPassword('${user.id}', '${user.nombre}')">
                            <i class="fas fa-key"></i> Nueva Contraseña
                        </button>
                        <button class="modal-btn btn-status-modal" onclick="Swal.close(); ${user.activo ? 'deactivateUser' : 'activateUser'}('${user.id}', '${user.nombre}')">
                            <i class="fas ${toggleStatusIcon}"></i> ${toggleStatusText}
                        </button>
                    </div>
                `
            });
        }

        function agregarUsuario(userData) {
            // Simular agregar usuario localmente
            setTimeout(() => {
                const tempPassword = userData.nombre.substring(0, 4).toLowerCase() + "123";
                const generatedId = userData.id || 'user_' + Date.now();

                Swal.fire({
                    title: '¡Usuario creado!',
                    html: `
                        <p>Usuario creado exitosamente.</p>
                        <div style="text-align: left; margin: 20px 0;">
                            <p><strong>ID:</strong> ${generatedId} ${userData.id ? '(Personalizado)' : '(Auto-generado)'}</p>
                            <p><strong>Nombre:</strong> ${userData.nombre}</p>
                            <p><strong>Email:</strong> ${userData.email}</p>
                            <p><strong>Rol:</strong> ${userData.rol}</p>
                            <p><strong>Contraseña temporal:</strong> ${tempPassword}</p>
                        </div>
                        <small>La contraseña temporal ha sido enviada al email del usuario.</small>
                    `,
                    icon: 'success',
                    confirmButtonText: 'Aceptar'
                });

                // Recargar lista de usuarios
                setTimeout(() => {
                    if (typeof loadUsersList === 'function') {
                        loadUsersList();
                    }
                }, 1000);
            }, 1000);
        }

        // Función para editar usuario
        function editUser(id) {
            const container = document.getElementById('usersListContainer');
            // Buscamos los datos en la tabla (o podríamos pedir al servidor)
            // Para ser más rápidos, buscaremos en el DOM o usaremos una variable global si existiera
            // Como no hay variable global de usuarios, haremos una llamada rápida al servidor o buscaremos el objeto

            showNotification('Cargando formulario de edición...', 'info');

            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success) {
                        const user = response.usuarios.find(u => String(u.id).toLowerCase().trim() === String(id).toLowerCase().trim());
                        if (!user) {
                            showNotification('No se encontró el usuario', 'error');
                            return;
                        }

                        mostrarModalEdicion(user);
                    }
                })
                .obtenerUsuarios();
        }

        function mostrarModalEdicion(user) {
            Swal.fire({
                title: '<h2 style="color: #81C784; margin-top: 10px;">Editar Usuario</h2>',
                background: '#1a1a1a',
                color: '#fff',
                width: 550,
                showConfirmButton: false,
                showCloseButton: true,
                scrollbarPadding: false,
                html: `
                    <div class="edit-form-container">
                        <div class="edit-group">
                            <label class="edit-label">ID o Matrícula</label>
                            <div class="edit-input-wrapper">
                                <input type="text" class="edit-input" value="${user.id}" disabled>
                                <span class="edit-hint">Identificador único del usuario (no modificable)</span>
                            </div>
                        </div>

                        <div class="edit-group">
                            <label class="edit-label">Nombre Completo *</label>
                            <input type="text" id="edit-nombre" class="edit-input" value="${user.nombre}" placeholder="Ej. Camila Sanchez">
                        </div>

                        <div class="edit-group">
                            <label class="edit-label">Email *</label>
                            <input type="email" id="edit-email" class="edit-input" value="${user.email}" placeholder="correo@uabc.edu.mx">
                        </div>

                        <div class="edit-group">
                            <label class="edit-label">Rol *</label>
                            <select id="edit-rol" class="edit-select">
                                <option value="admin" ${user.rol === 'admin' ? 'selected' : ''}>Administrador</option>
                                <option value="usuario" ${user.rol === 'usuario' ? 'selected' : ''}>Usuario</option>
                            </select>
                        </div>

                        <p class="edit-footer-hint">* Campos obligatorios</p>

                        <div class="edit-modal-buttons">
                            <button class="btn-save-changes" onclick="guardarCambiosUsuario('${user.id}')">
                                Guardar Cambios
                            </button>
                            <button class="btn-cancel-edit" onclick="Swal.close()">
                                Cancelar
                            </button>
                        </div>
                    </div>
                `
            });
        }

        function guardarCambiosUsuario(id) {
            const nombre = document.getElementById('edit-nombre').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const rol = document.getElementById('edit-rol').value;

            if (!nombre || !email) {
                showNotification('Por favor completa todos los campos obligatorios', 'warning');
                return;
            }

            // Validar formato de email básico
            if (!email.includes('@')) {
                showNotification('Ingresa un correo electrónico válido', 'warning');
                return;
            }

            Swal.fire({
                title: 'Guardando cambios...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '¡Actualizado!',
                            text: response.message,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        loadUsersList();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de conexión',
                        text: error.message
                    });
                })
                .actualizarUsuario({
                    id: id,
                    nombre: nombre,
                    email: email,
                    rol: rol
                });
        }

        function resetUserPassword(id, nombre) {
            Swal.fire({
                title: '<h2 style="color: #FFB347; margin-top: 10px;">¿Restablecer contraseña?</h2>',
                background: '#1a1a1a',
                color: '#fff',
                html: `
                    <div style="padding: 10px; text-align: center;">
                        <p style="font-size: 16px; margin-bottom: 15px;">¿Deseas restablecer la contraseña de <strong style="color: #66BB6A;">${nombre}</strong>?</p>
                        <p style="font-size: 13px; color: #888; font-style: italic;">Se generará una nueva contraseña temporal que se mostrará una sola vez.</p>
                    </div>
                `,
                icon: 'question',
                iconColor: '#FFB347',
                showCancelButton: true,
                confirmButtonColor: '#388E3C',
                cancelButtonColor: '#1A1A1A',
                confirmButtonText: 'Sí, restablecer',
                cancelButtonText: 'Cancelar',
                scrollbarPadding: false,
                customClass: {
                    confirmButton: 'btn-save-changes',
                    cancelButton: 'btn-cancel-edit'
                },
                buttonsStyling: false
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Restableciendo...',
                        background: '#1a1a1a',
                        color: '#fff',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Simular restablecimiento (en una App real esto llamaría a google.script.run)
                    const tempPassword = 'TempPass' + Math.floor(Math.random() * 1000);

                    setTimeout(() => {
                        Swal.fire({
                            title: '<h2 style="color: #81C784;">Contraseña Restablecida</h2>',
                            background: '#1a1a1a',
                            color: '#fff',
                            scrollbarPadding: false,
                            html: `
                                <div style="padding: 10px; text-align: center;">
                                    <p style="margin-bottom: 20px;">Contraseña temporal generada para <strong>${nombre}</strong>:</p>
                                    <div style="background: #121212; border: 2px dashed #4CAF50; padding: 20px; border-radius: 12px; margin: 15px 0; position: relative;">
                                        <code style="font-size: 24px; font-weight: bold; color: #4CAF50; letter-spacing: 2px;">${tempPassword}</code>
                                        <button onclick="navigator.clipboard.writeText('${tempPassword}'); showNotification('Copiado al portapapeles', 'success');" 
                                                style="position: absolute; right: 10px; top: 10px; background: none; border: none; color: #666; cursor: pointer;">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                    <p style="color: #FFB347; font-size: 12px; margin-top: 15px;"><i class="fas fa-exclamation-triangle"></i> ¡Guarda esta contraseña! No se volverá a mostrar.</p>
                                </div>
                            `,
                            icon: 'success',
                            confirmButtonText: 'He guardado la contraseña',
                            confirmButtonColor: '#388E3C',
                            customClass: {
                                confirmButton: 'btn-save-changes'
                            },
                            buttonsStyling: false
                        });
                    }, 1000);
                }
            });
        }

        function deactivateUser(id, nombre) {
            Swal.fire({
                title: '<h2 style="color: #e57373; margin-top: 10px;">¿Desactivar usuario?</h2>',
                background: '#1a1a1a',
                color: '#fff',
                html: `
                    <div style="padding: 10px; text-align: center;">
                        <p style="font-size: 16px;">¿Estás seguro de desactivar a <strong style="color: #ef5350;">${nombre}</strong>?</p>
                        <p style="font-size: 13px; color: #888; margin-top: 15px; font-style: italic;">El usuario no podrá acceder al sistema hasta que sea reactivado.</p>
                    </div>
                `,
                icon: 'warning',
                iconColor: '#ef5350',
                showCancelButton: true,
                confirmButtonColor: '#d32f2f',
                cancelButtonColor: '#1A1A1A',
                confirmButtonText: 'Sí, desactivar',
                cancelButtonText: 'Cancelar',
                reverseButtons: true,
                scrollbarPadding: false,
                customClass: {
                    confirmButton: 'btn-save-changes', // Reutilizamos pero el color se pisa por confirmButtonColor o estilo inline
                    cancelButton: 'btn-cancel-edit'
                },
                buttonsStyling: false
            }).then((result) => {
                if (result.isConfirmed) {
                    procesarCambioEstado(id, false);
                }
            });
        }

        function activateUser(id, nombre) {
            Swal.fire({
                title: '<h2 style="color: #81C784; margin-top: 10px;">¿Activar usuario?</h2>',
                background: '#1a1a1a',
                color: '#fff',
                html: `
                    <div style="padding: 10px; text-align: center;">
                        <p style="font-size: 16px;">¿Deseas activar el acceso para <strong style="color: #66BB6A;">${nombre}</strong>?</p>
                    </div>
                `,
                icon: 'question',
                iconColor: '#66BB6A',
                showCancelButton: true,
                confirmButtonColor: '#388E3C',
                cancelButtonColor: '#1A1A1A',
                confirmButtonText: 'Sí, activar',
                cancelButtonText: 'Cancelar',
                scrollbarPadding: false,
                customClass: {
                    confirmButton: 'btn-save-changes',
                    cancelButton: 'btn-cancel-edit'
                },
                buttonsStyling: false
            }).then((result) => {
                if (result.isConfirmed) {
                    procesarCambioEstado(id, true);
                }
            });
        }

        function procesarCambioEstado(id, nuevoEstado) {
            Swal.fire({
                title: 'Procesando...',
                background: '#1a1a1a',
                color: '#fff',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            google.script.run
                .withSuccessHandler(function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: '¡Operación exitosa!',
                            text: response.message,
                            background: '#1a1a1a',
                            color: '#fff',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        loadUsersList();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message,
                            background: '#1a1a1a',
                            color: '#fff'
                        });
                    }
                })
                .withFailureHandler(function (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de conexión',
                        text: error.message,
                        background: '#1a1a1a',
                        color: '#fff'
                    });
                })
                .cambiarEstadoUsuario(id, nuevoEstado);
        }

        // ============================================
        // FUNCIONES AUXILIARES
        // ============================================

        // Notificaciones push - Esquina inferior derecha con estilos del sistema
        function showNotification(message, type = 'info') {
            // Eliminar notificaciones existentes
            document.querySelectorAll('.notification').forEach(notification => {
                notification.remove();
            });

            // Mapeo de íconos según el tipo
            const iconMap = {
                'success': 'fa-check-circle',
                'info': 'fa-info-circle',
                'warning': 'fa-exclamation-triangle',
                'error': 'fa-times-circle'
            };

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;

            // Crear estructura con ícono
            notification.innerHTML = `
                <i class="fas ${iconMap[type] || iconMap['info']}"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            // Mostrar con animación
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            // Ocultar después de 3 segundos
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 400);
            }, 3000);
        }

        function filterByStatus(status) {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }

            if (typeof showNotification === 'function') {
                showNotification(`Filtrado por: ${status}`, 'info');
            }
        }

        function showReports() {
            const datos = cargarDatosAsignacion();
            if (!datos || !datos.resumen) {
                Swal.fire({
                    title: 'Sin Datos para Reporte',
                    text: 'No hay datos de procesamiento disponibles. Realiza una asignación primero.',
                    icon: 'info',
                    background: '#1a1a1a',
                    color: '#fff'
                });
                return;
            }

            const r = datos.resumen;

            // Construir el reporte en HTML
            let html = `
                <div class="report-container" style="text-align: left; color: #fff; font-family: 'Inter', sans-serif;">
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="color: #4facfe; margin-top: 0;"><i class="fas fa-chart-line"></i> Resumen Ejecutivo</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div><strong>Total Sesiones:</strong> ${r.totalClases}</div>
                            <div><strong>Asignadas:</strong> <span style="color: #00f2fe">${r.asignadas} (${r.porcentajeCumplimiento}%)</span></div>
                            <div><strong>No Asignadas:</strong> <span style="color: #ff4b2b">${r.noAsignadas}</span></div>
                            <div><strong>Salones Usados:</strong> ${datos.salones.filter(s => s.horariosOcupados && s.horariosOcupados.length > 0).length}</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
                            <h4 style="color: #f9d423; margin-top: 0;"><i class="fas fa-flask"></i> Laboratorios</h4>
                            <p>Asignados: ${r.laboratoriosAsignados || 0}</p>
                        </div>
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
                            <h4 style="color: #a8edea; margin-top: 0;"><i class="fas fa-cut"></i> Grupos Divididos</h4>
                            <p>Total: ${datos.gruposDivididos ? datos.gruposDivididos.length : 0}</p>
                        </div>
                    </div>

                    ${r.noAsignadas > 0 ? `
                    <div style="margin-top: 20px; background: rgba(255,75,43,0.1); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,75,43,0.3);">
                        <h4 style="color: #ff4b2b; margin-top: 0;"><i class="fas fa-exclamation-triangle"></i> Pendientes de Asignación</h4>
                        <div style="max-height: 150px; overflow-y: auto; font-size: 0.85em;">
                            <ul style="padding-left: 20px;">
                                ${datos.errores.slice(0, 20).map(e => `<li>${e}</li>`).join('')}
                                ${datos.errores.length > 20 ? `<li>... y ${datos.errores.length - 20} errores más</li>` : ''}
                            </ul>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px; font-size: 0.8em; opacity: 0.6; text-align: right;">
                        Generado: ${new Date(datos.timestamp).toLocaleString()}
                    </div>
                </div>
            `;

            Swal.fire({
                title: 'Reporte de Asignación',
                html: html,
                width: '600px',
                background: '#1a1a1a',
                color: '#fff',
                confirmButtonText: 'Cerrar',
                confirmButtonColor: '#4facfe'
            });
        }

        // Función para aplicar permisos de usuario
        function applyUserPermissions() {
            const userIsAdmin = localStorage.getItem('userIsAdmin') === 'true';
            const userRole = localStorage.getItem('userRole');

            if (!userIsAdmin && userRole !== 'admin') {
                // Ocultar la sección de usuarios para usuarios regulares
                const usersLink = document.querySelector('.sidebar-link[onclick*="loadContent(\'usuarios\')"]');
                if (usersLink) {
                    usersLink.style.display = 'none';
                    console.log('Sección Usuarios oculta para usuario regular');
                }

                // También ocultar botón de gestionar usuarios en dashboard
                const manageUsersBtn = document.getElementById('manageUsersBtn');
                if (manageUsersBtn) {
                    manageUsersBtn.style.display = 'none';
                    console.log('Botón Gestionar Usuarios oculto para usuario regular');
                }
            } else {
                console.log('Usuario administrador - todas las opciones visibles');
            }
        }

        // ============================================
        // VISUALIZACIÓN DE HORARIOS GUARDADOS
        // ============================================

        // Función principal para mostrar horarios guardados estructurados por edificio
        function mostrarHorariosGuardados() {
            const datos = cargarDatosAsignacion();
            if (!datos || !datos.asignaciones || datos.asignaciones.length === 0) {
                Swal.fire({
                    title: 'Sin Datos Guardados',
                    text: 'No hay horarios guardados para mostrar. Procesa primero los horarios.',
                    icon: 'warning',
                    confirmButtonText: 'Entendido'
                });
                return;
            }

            // Organizar asignaciones por edificio, piso, salón, día y hora
            const horariosPorEdificio = {};

            datos.asignaciones.forEach(asignacion => {
                if (!asignacion.clase || !asignacion.salon) return;

                const edificio = asignacion.clase.edificioActual || asignacion.salon.edificio;
                const piso = asignacion.salon.piso;
                const salonId = asignacion.salon.id;
                const dia = asignacion.clase.diaSemana;
                const horaInicio = asignacion.clase.horaInicio;
                const horaFin = asignacion.clase.horaFin;
                const materia = asignacion.clase.nombreAsignatura;
                const grupo = asignacion.clase.grupoId;
                const maestro = asignacion.clase.maestro || 'No especificado';

                // Crear estructura anidada
                if (!horariosPorEdificio[edificio]) {
                    horariosPorEdificio[edificio] = {
                        nombre: `Edificio ${edificio}`,
                        pisos: {}
                    };
                }

                const edificioData = horariosPorEdificio[edificio];
                const pisoKey = `Piso ${piso}`;

                if (!edificioData.pisos[pisoKey]) {
                    edificioData.pisos[pisoKey] = {
                        numero: piso,
                        salones: {}
                    };
                }

                const pisoData = edificioData.pisos[pisoKey];

                if (!pisoData.salones[salonId]) {
                    pisoData.salones[salonId] = {
                        id: salonId,
                        capacidad: asignacion.salon.capacidad,
                        accesible: asignacion.salon.accesible,
                        dias: {}
                    };
                }

                const salonData = pisoData.salones[salonId];

                if (!salonData.dias[dia]) {
                    salonData.dias[dia] = [];
                }

                salonData.dias[dia].push({
                    horaInicio,
                    horaFin,
                    materia,
                    grupo,
                    maestro
                });
            });

            // Generar HTML estructurado
            let contenidoHTML = `<div style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">`;

            const diasOrden = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];

            for (const [edificioKey, edificioData] of Object.entries(horariosPorEdificio)) {
                contenidoHTML += `
                    <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid var(--verde-medio); border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: var(--verde-claro); margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-building"></i>
                            ${edificioData.nombre}
                        </h3>
                `;

                for (const [pisoKey, pisoData] of Object.entries(edificioData.pisos)) {
                    contenidoHTML += `
                        <div style="margin-left: 15px; margin-bottom: 15px;">
                            <h4 style="color: var(--amarillo-claro); margin: 0 0 10px 0;">${pisoKey}</h4>
                    `;

                    for (const [salonId, salonInfo] of Object.entries(pisoData.salones)) {
                        contenidoHTML += `
                            <div style="background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 10px; margin-left: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <strong style="color: var(--blanco);">${salonId}</strong>
                                    <span style="color: var(--gris-texto); font-size: 12px;">
                                        Cap: ${salonInfo.capacidad}${salonInfo.accesible ? ' ♿ Accesible' : ''}
                                    </span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                        `;

                        diasOrden.forEach(dia => {
                            const clasesDia = salonInfo.dias[dia] || [];
                            contenidoHTML += `
                                <div style="background: rgba(0, 0, 0, 0.4); border-radius: 6px; padding: 10px; min-height: 80px;">
                                    <div style="color: var(--verde-claro); font-size: 11px; font-weight: 600; text-align: center; margin-bottom: 5px;">
                                        ${dia.substring(0, 3)}
                                    </div>
                            `;

                            if (clasesDia.length > 0) {
                                clasesDia.forEach(clase => {
                                    contenidoHTML += `
                                        <div style="background: rgba(76, 175, 80, 0.2); border: 1px solid var(--verde-medio); border-radius: 4px; padding: 6px; margin-bottom: 4px; cursor: pointer; transition: transform 0.2s;"
                                             onmouseover="this.style.transform='scale(1.02)'" 
                                             onmouseout="this.style.transform='scale(1)'">
                                            <div style="font-size: 10px; font-weight: 600; color: var(--verde-claro); margin-bottom: 2px;">
                                                ${clase.horaInicio}-${clase.horaFin}
                                            </div>
                                            <div style="font-size: 9px; color: var(--amarillo-claro); margin-bottom: 2px;">
                                                ${clase.materia}
                                            </div>
                                            <div style="font-size: 8px; color: var(--gris-texto);">
                                                ${clase.grupo} | ${clase.maestro}
                                            </div>
                                        </div>
                                    `;
                                });
                            } else {
                                contenidoHTML += `
                                    <div style="text-align: center; color: rgba(255,255,255,0.15); font-size: 11px; padding: 15px 0;">
                                        -
                                    </div>
                                `;
                            }

                            contenidoHTML += `</div>`;
                        });

                        contenidoHTML += `</div></div>`;
                    }

                    contenidoHTML += `</div>`;
                }

                contenidoHTML += `</div>`;
            }

            contenidoHTML += `</div>`;

            // Agregar información del timestamp
            const fechaGuardado = new Date(datos.timestamp).toLocaleString('es-MX', {
                year: 'numeric', month: 'long', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });

            contenidoHTML += `
                <div style="margin-top: 20px; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
                    <p style="margin: 0; color: var(--gris-texto); font-size: 12px;">
                        <i class="fas fa-clock"></i> Datos guardados el: ${fechaGuardado}
                    </p>
                    <p style="margin: 5px 0 0 0; color: var(--gris-texto); font-size: 12px;">
                        <i class="fas fa-list"></i> Total de asignaciones: ${datos.asignaciones.length}
                    </p>
                </div>
            `;

            // Mostrar modal con SweetAlert2
            Swal.fire({
                title: '📅 Horarios Guardados por Edificio',
                html: contenidoHTML,
                icon: 'info',
                width: '90%',
                maxWidth: '1000px',
                confirmButtonText: '<i class="fas fa-sync-alt"></i> Restaurar Visualización',
                confirmButtonColor: '#4CAF50',
                showCancelButton: true,
                cancelButtonText: '<i class="fas fa-times"></i> Cerrar',
                cancelButtonColor: '#757575',
                footer: '<small style="color: var(--gris-texto);">Haz clic en una clase para ver detalles</small>'
            }).then((result) => {
                if (result.isConfirmed) {
                    restaurarVisualizacionCompleta();
                }
            });
        }

        // Función para cerrar modal de horarios guardados
        function cerrarHorariosGuardados() {
            // Esta función se mantiene por compatibilidad, el modal se cierra automáticamente con Swal
            console.log('Modal de horarios guardados cerrado');
        }

        // Función para restaurar visualización completa desde datos guardados
        function restaurarVisualizacionCompleta() {
            Swal.fire({
                title: 'Restaurar Visualización',
                text: 'Esto restaurará toda la información guardada y te llevará a la sección de asignación. ¿Deseas continuar?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#4CAF50',
                cancelButtonColor: '#757575',
                confirmButtonText: 'Sí, restaurar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Ir a la sección de asignación
                    loadContent('asignacion');

                    // Restaurar visualización después de cargar
                    setTimeout(() => {
                        if (hayDatosGuardados()) {
                            restaurarVisualizacionDesdeGuardados();
                        }
                    }, 500);
                }
            });
        }

        // ============================================
        // EXPONER FUNCIONES GLOBALMENTE
        // ============================================

        // Funciones principales
        window.loadContent = loadContent;
        window.loadHomeContent = loadHomeContent;
        window.loadBuildingsContent = loadBuildingsContent;
        window.loadUsersContent = loadUsersContent;
        window.loadAsignacionContent = loadAsignacionContent;
        window.loadSettingsContent = loadSettingsContent;
        window.initializePage = initializePage;
        window.applyUserPermissions = applyUserPermissions;

        // Funciones de edificios y salones
        window.toggleFloor = toggleFloor;
        window.showSalonDetails = showSalonDetails;
        window.searchSalons = searchSalons;
        window.filterByStatus = filterByStatus;
        window.showReports = showReports;
        window.closeModal = closeModal;
        window.loadBuildings = loadBuildings;
        window.loadUsersList = loadUsersList;
        window.loadStatistics = loadStatistics;
        window.testDatabase = testDatabase;
        window.showFloorModal = showFloorModal;
        window.closeFloorModal = closeFloorModal;
        window.showAllSalons = showAllSalons;
        window.closeSalonModal = closeSalonModal;
        window.isTimeInRange = isTimeInRange;

        // Funciones de gestión de usuarios
        window.showAddUserForm = showAddUserForm;
        window.agregarUsuario = agregarUsuario;
        window.editUser = editUser;
        window.guardarCambiosUsuario = guardarCambiosUsuario;
        window.mostrarModalEdicion = mostrarModalEdicion;
        window.resetUserPassword = resetUserPassword;
        window.deactivateUser = deactivateUser;
        window.activateUser = activateUser;

        // Funciones del sistema de asignación
        window.iniciarProcesamiento = iniciarProcesamiento;
        window.showTab = showTab;
        window.manejarArchivos = manejarArchivos;
        window.mostrarModalGruposPrioritarios = mostrarModalGruposPrioritarios;
        window.toggleGrupoPrioritario = toggleGrupoPrioritario;
        window.actualizarTagsPrioritarios = actualizarTagsPrioritarios;
        window.removerGrupoPrioritario = removerGrupoPrioritario;
        window.filterGroups = filterGroups;
        window.closePriorityModal = closePriorityModal;
        window.savePriorityGroupsAndProcess = savePriorityGroupsAndProcess;
        window.leerArchivo = leerArchivo;
        window.parsearCSV = parsearCSV;
        window.mostrarResultados = mostrarResultados;
        window.mostrarSalonesEnInterfaz = mostrarSalonesEnInterfaz;
        window.inicializarSistemaAsignacion = inicializarSistemaAsignacion;
        window.reiniciarVisualizador = reiniciarVisualizador;
        window.restaurarVisualizacionDesdeGuardados = restaurarVisualizacionDesdeGuardados;
        window.mostrarHorariosGuardados = mostrarHorariosGuardados;
        window.cerrarHorariosGuardados = cerrarHorariosGuardados;
        window.restaurarVisualizacionCompleta = restaurarVisualizacionCompleta;
        window.guardarDatosAsignacion = guardarDatosAsignacion;
        window.cargarDatosAsignacion = cargarDatosAsignacion;
        window.hayDatosGuardados = hayDatosGuardados;
        window.limpiarDatosGuardados = limpiarDatosGuardados;
        window.sincronizarGlobalSalonDataDesdeSistema = sincronizarGlobalSalonDataDesdeSistema;
        window.isTimeOverlap = isTimeOverlap;

        // ============================================
        // INICIALIZACIÓN AL CARGAR LA PÁGINA
        // ============================================
        (function () {
            // Mostrar mensaje de bienvenida si viene del login
            if (localStorage.getItem('showWelcome') === 'true') {
                localStorage.removeItem('showWelcome');

                const welcomeNotification = document.createElement('div');
                welcomeNotification.className = 'welcome-notification';
                welcomeNotification.innerHTML = `
                    <i class="fas fa-hand-sparkles" style="font-size: 20px; color: #81C784;"></i>
                    <span>Bienvenido al Sistema de Gestión de Edificios</span>
                `;
                document.body.appendChild(welcomeNotification);

                setTimeout(function () {
                    welcomeNotification.style.animation = 'slideOutRight 0.4s ease-out forwards';
                    setTimeout(function () {
                        if (welcomeNotification.parentNode) {
                            welcomeNotification.parentNode.removeChild(welcomeNotification);
                        }
                    }, 400);
                }, 3000);
            }

            // Cargar contenido inicial (página de inicio) solo si no se ha inicializado
            if (!isInitialized) {
                initializePage();
                isInitialized = true;
            }
        })();
    </script>
</body>

</html>