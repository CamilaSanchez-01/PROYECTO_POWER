// Variables globales
let aulas = [];
let cursos = [];
let profesores = [];
let asignaciones = [];
let usuarios = [];
let permisos = [];
let grupos = [];
let materias = [];
let horarios = [];
let currentUser = null;
let sessionId = null;

// Configuración de edificios
const buildingConfig = {
    'D': { pisos: [6, 6, 6, 6] }, // 24 aulas
    'E': { pisos: [6, 6, 6, 5] }, // 23 aulas
    'F': { pisos: [4, 4, 4, 4] }  // 16 aulas
};

// Función para inicializar el dashboard
function initializeDashboardEvents() {
    // Obtener ID de sesión de sessionStorage
    sessionId = sessionStorage.getItem('sessionId');
    
    if (!sessionId) {
        // Si no hay sesión, redirigir al login
        window.location.reload();
        return;
    }
    
    // Verificar sesión y obtener usuario actual
    google.script.run
        .withSuccessHandler(function(user) {
            if (!user) {
                // Si no hay usuario, redirigir al login
                window.location.reload();
                return;
            }
            
            currentUser = user;
            const userInfoElement = document.getElementById('userInfo');
            if (userInfoElement) {
                userInfoElement.textContent = `Bienvenido, ${user.email} (${user.role})`;
            }
            
            // Cargar datos iniciales
            cargarDatos();
            
            // Configurar event listeners
            configurarEventListeners();
            
            // Mostrar u ocultar sección de administración según rol
            if (user.role === 'admin') {
                const adminSection = document.getElementById('adminSection');
                if (adminSection) {
                    adminSection.style.display = 'block';
                }
                cargarDatosAdministracion();
            }
        })
        .getCurrentUser(sessionId);
}

// Función para configurar los event listeners
function configurarEventListeners() {
    // Botón de cerrar sesión - Usar event delegation
    document.addEventListener('click', function(event) {
        if (event.target && event.target.id === 'logoutBtn') {
            event.preventDefault();
            if (confirm('¿Está seguro de cerrar sesión?')) {
                google.script.run
                    .withSuccessHandler(function() {
                        sessionStorage.removeItem('sessionId');
                        window.location.reload();
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error al cerrar sesión:', error);
                        mostrarMensaje('Error al cerrar sesión', 'error');
                    })
                    .logout(sessionId);
            }
        }
    });
    
    // Resto de los event listeners...
    configurarEventListenersFormularios();
    configurarEventListenersAsignaciones();
}

// Función para mostrar mensajes
function mostrarMensaje(mensaje, tipo) {
    // Crear elemento de mensaje
    const messageElement = document.createElement('div');
    messageElement.className = `alert alert-${tipo === 'error' ? 'danger' : tipo === 'info' ? 'info' : 'success'} alert-dismissible fade show`;
    messageElement.setAttribute('role', 'alert');
    messageElement.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Insertar al principio del contenedor principal
    const container = document.querySelector('.container');
    if (container) {
        container.insertBefore(messageElement, container.firstChild);
    }
    
    // Auto-eliminar después de 5 segundos
    setTimeout(() => {
        if (messageElement && messageElement.parentNode) {
            messageElement.remove();
        }
    }, 5000);
}

// Función para cargar datos iniciales
function cargarDatos() {
    google.script.run
        .withSuccessHandler(function(data) {
            aulas = data.aulas || [];
            cursos = data.cursos || [];
            profesores = data.profesores || [];
            asignaciones = data.asignaciones || [];
            usuarios = data.usuarios || [];
            permisos = data.permisos || [];
            grupos = data.grupos || [];
            materias = data.materias || [];
            horarios = data.horarios || [];
            
            // Si no hay aulas, inicializar el sistema
            if (aulas.length <= 1) { // Solo encabezado
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            cargarDatos(); // Recargar datos después de inicializar
                        } else {
                            mostrarMensaje('Error al inicializar el sistema: ' + result.message, 'error');
                        }
                    })
                    .initializeSheets();
                return;
            }
            
            // Actualizar interfaz
            actualizarInterfaz();
        })
        .getAllData();
}

// Función para actualizar la interfaz
function actualizarInterfaz() {
    // Actualizar tarjetas de edificios
    actualizarTarjetasEdificios();
    
    // Actualizar tablas
    actualizarTablaAulas();
    actualizarTablaCursos();
    actualizarTablaProfesores();
    actualizarTablaGrupos();
    actualizarTablaMaterias();
    actualizarTablaAsignaciones();
    
    // Actualizar dropdowns
    actualizarDropdowns();
}

// Función para actualizar las tarjetas de edificios
function actualizarTarjetasEdificios() {
    const edificios = ['D', 'E', 'F'];
    
    edificios.forEach(edificio => {
        const accordionId = `accordion${edificio}`;
        const accordion = document.getElementById(accordionId);
        
        if (!accordion) return;
        
        // Limpiar contenido existente
        accordion.innerHTML = '';
        
        // Obtener pisos del edificio
        const pisos = buildingConfig[edificio].pisos;
        
        // Crear un accordion item para cada piso
        pisos.forEach((aulasPiso, indicePiso) => {
            const piso = indicePiso + 1;
            const collapseId = `collapse${edificio}${piso}`;
            const classroomsId = `classrooms${edificio}${piso}`;
            
            // Crear accordion item
            const accordionItem = document.createElement('div');
            accordionItem.className = 'accordion-item';
            
            accordionItem.innerHTML = `
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                        Piso ${piso}
                    </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#${accordionId}">
                    <div class="accordion-body classroom-grid" id="${classroomsId}">
                        <!-- Las aulas se agregarán dinámicamente -->
                    </div>
                </div>
            `;
            
            accordion.appendChild(accordionItem);
            
            // Agregar aulas al piso
            const classroomsContainer = document.getElementById(classroomsId);
            const aulasPisoActual = aulas.filter(aula => 
                aula[1] === edificio && aula[2] === piso
            );
            
            aulasPisoActual.forEach(aula => {
                const classroomBox = document.createElement('div');
                classroomBox.className = 'classroom-box';
                
                // Añadir icono según tipo de aula
                let icono = '';
                if (aula[7] === 'Accesible') {
                    icono = '<i class="fas fa-wheelchair"></i> ';
                } else if (aula[7] === 'Laboratorio') {
                    icono = '<i class="fas fa-flask"></i> ';
                }
                
                classroomBox.innerHTML = `${icono}${aula[3]}`;
                classroomsContainer.appendChild(classroomBox);
            });
        });
    });
}

// Función para actualizar la tabla de aulas
function actualizarTablaAulas() {
    const tbody = document.querySelector('#classroomsTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Saltar encabezado
    for (let i = 1; i < aulas.length; i++) {
        const aula = aulas[i];
        const autoAsignableText = (aula[5] === true || aula[5] === 'TRUE') ? 'Sí' : 'No';
        const accesibleText = (aula[6] === true || aula[6] === 'TRUE') ? 'Sí' : 'No';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${aula[1]}</td>
            <td>${aula[2]}</td>
            <td>${aula[3]}</td>
            <td>${aula[4]}</td>
            <td>${aula[7]}</td>
            <td>${autoAsignableText}</td>
            <td>${accesibleText}</td>
        `;
        tbody.appendChild(row);
    }
}

// Función para actualizar la tabla de cursos
function actualizarTablaCursos() {
    const tbody = document.querySelector('#coursesTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Saltar encabezado
    for (let i = 1; i < cursos.length; i++) {
        const curso = cursos[i];
        const profesor = profesores.find(p => p[0] === curso[3]);
        const profesorNombre = profesor ? profesor[1] : 'No asignado';
        
        const materia = materias.find(m => m[0] === curso[4]);
        const materiaNombre = materia ? materia[1] : 'No asignada';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${curso[1]}</td>
            <td>${curso[2]}</td>
            <td>${profesorNombre}</td>
            <td>${curso[5]}</td>
            <td>${curso[6]}</td>
            <td>${materiaNombre}</td>
        `;
        tbody.appendChild(row);
    }
}

// Función para actualizar la tabla de profesores
function actualizarTablaProfesores() {
    const tbody = document.querySelector('#teachersTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Saltar encabezado
    for (let i = 1; i < profesores.length; i++) {
        const profesor = profesores[i];
        const discapacidadText = (profesor[3] === true || profesor[3] === 'TRUE') ? 'Sí' : 'No';
        const pisoPreferido = profesor[4] || 'Ninguno';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${profesor[1]}</td>
            <td>${profesor[2]}</td>
            <td>${discapacidadText}</td>
            <td>${pisoPreferido}</td>
        `;
        tbody.appendChild(row);
    }
}

// Función para actualizar la tabla de grupos
function actualizarTablaGrupos() {
    const tbody = document.querySelector('#groupsTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Saltar encabezado
    for (let i = 1; i < grupos.length; i++) {
        const grupo = grupos[i];
        const discapacidadText = (grupo[5] === true || grupo[5] === 'TRUE') ? 'Sí' : 'No';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${grupo[1]}</td>
            <td>${grupo[2]}</td>
            <td>${grupo[3]}</td>
            <td>${grupo[4]}</td>
            <td>${discapacidadText}</td>
        `;
        tbody.appendChild(row);
    }
}

// Función para actualizar la tabla de materias
function actualizarTablaMaterias() {
    const tbody = document.querySelector('#subjectsTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Saltar encabezado
    for (let i = 1; i < materias.length; i++) {
        const materia = materias[i];
        const obligatoriaText = (materia[3] === true || materia[3] === 'TRUE') ? 'Sí' : 'No';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${materia[1]}</td>
            <td>${materia[2]}</td>
            <td>${materia[4]}</td>
            <td>${obligatoriaText}</td>
        `;
        tbody.appendChild(row);
    }
}

// Función para actualizar la tabla de asignaciones
function actualizarTablaAsignaciones(fechaFiltro = null) {
    const tbody = document.querySelector('#assignmentsTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Filtrar asignaciones por fecha si se proporciona
    let asignacionesFiltradas = asignaciones;
    if (fechaFiltro) {
        asignacionesFiltradas = asignaciones.filter(a => a[3] === fechaFiltro);
    }
    
    // Saltar encabezado
    for (let i = 1; i < asignacionesFiltradas.length; i++) {
        const asignacion = asignacionesFiltradas[i];
        const curso = cursos.find(c => c[0] === asignacion[1]);
        const aula = aulas.find(a => a[0] === asignacion[2]);
        const profesor = profesores.find(p => p[0] === asignacion[6]);
        const grupo = grupos.find(g => g[0] === asignacion[7]);
        
        const cursoNombre = curso ? curso[1] : 'Curso no encontrado';
        const aulaNombre = aula ? `${aula[1]}${aula[2]}-${aula[3]}` : 'Aula no encontrada';
        const profesorNombre = profesor ? profesor[1] : 'Profesor no encontrado';
        const grupoNombre = grupo ? grupo[1] : 'Sin grupo';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${cursoNombre}</td>
            <td>${aulaNombre}</td>
            <td>${asignacion[3]}</td>
            <td>${asignacion[4]} - ${asignacion[5]}</td>
            <td>${profesorNombre}</td>
            <td>${grupoNombre}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="eliminarAsignacion('${asignacion[0]}')">Eliminar</button>
            </td>
        `;
        tbody.appendChild(row);
    }
}

// Función para actualizar los dropdowns
function actualizarDropdowns() {
    // Actualizar dropdown de profesores para cursos
    const teacherSelect = document.getElementById('courseTeacher');
    if (teacherSelect) {
        teacherSelect.innerHTML = '<option value="">Seleccionar Profesor</option>';
        
        // Saltar encabezado
        for (let i = 1; i < profesores.length; i++) {
            const profesor = profesores[i];
            teacherSelect.innerHTML += `<option value="${profesor[0]}">${profesor[1]}</option>`;
        }
    }
    
    // Actualizar dropdown de materias para cursos
    const subjectSelect = document.getElementById('courseSubject');
    if (subjectSelect) {
        subjectSelect.innerHTML = '<option value="">Seleccionar Materia</option>';
        
        // Saltar encabezado
        for (let i = 1; i < materias.length; i++) {
            const materia = materias[i];
            subjectSelect.innerHTML += `<option value="${materia[0]}">${materia[1]}</option>`;
        }
    }
    
    // Actualizar dropdown de cursos para asignaciones
    const courseSelect = document.getElementById('assignCourse');
    if (courseSelect) {
        courseSelect.innerHTML = '<option value="">Seleccionar Curso</option>';
        
        // Saltar encabezado
        for (let i = 1; i < cursos.length; i++) {
            const curso = cursos[i];
            courseSelect.innerHTML += `<option value="${curso[0]}">${curso[1]} (${curso[2]})</option>`;
        }
    }
    
    // Actualizar dropdown de cursos para auto-asignación
    const autoAssignCourseSelect = document.getElementById('autoAssignCourse');
    if (autoAssignCourseSelect) {
        autoAssignCourseSelect.innerHTML = '<option value="">Seleccionar Curso</option>';
        
        // Saltar encabezado
        for (let i = 1; i < cursos.length; i++) {
            const curso = cursos[i];
            autoAssignCourseSelect.innerHTML += `<option value="${curso[0]}">${curso[1]} (${curso[2]})</option>`;
        }
    }
    
    // Actualizar dropdown de grupos para asignaciones
    const groupSelect = document.getElementById('assignGroup');
    if (groupSelect) {
        groupSelect.innerHTML = '<option value="">Seleccionar Grupo (opcional)</option>';
        
        // Saltar encabezado
        for (let i = 1; i < grupos.length; i++) {
            const grupo = grupos[i];
            groupSelect.innerHTML += `<option value="${grupo[0]}">${grupo[1]} - ${grupo[2]}</option>`;
        }
    }
    
    // Actualizar dropdown de edificios
    const buildingSelect = document.getElementById('assignBuilding');
    if (buildingSelect) {
        const edificios = [...new Set(aulas.map(a => a[1]))];
        buildingSelect.innerHTML = '<option value="">Edificio</option>';
        
        edificios.forEach(edificio => {
            buildingSelect.innerHTML += `<option value="${edificio}">${edificio}</option>`;
        });
    }
}

// Función para configurar event listeners de formularios
function configurarEventListenersFormularios() {
    // Formulario de agregar aula
    const classroomForm = document.getElementById('classroomForm');
    if (classroomForm) {
        classroomForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const edificio = document.getElementById('building').value;
            const piso = document.getElementById('floor').value;
            const numero = document.getElementById('roomNumber').value;
            const capacidad = document.getElementById('capacity').value;
            const tipo = document.getElementById('roomType').value;
            const autoAsignable = document.getElementById('autoAssignable').checked;
            const accesible = document.getElementById('accessible').checked;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        mostrarMensaje('Aula agregada correctamente', 'success');
                        classroomForm.reset();
                        cargarDatos();
                    } else {
                        mostrarMensaje(result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarMensaje('Error al agregar aula: ' + error.message, 'error');
                })
                .addAula(sessionId, edificio, piso, numero, capacidad, autoAsignable, accesible, tipo);
        });
    }
    
    // Formulario de agregar curso
    const courseForm = document.getElementById('courseForm');
    if (courseForm) {
        courseForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nombre = document.getElementById('courseName').value;
            const codigo = document.getElementById('courseCode').value;
            const idProfesor = document.getElementById('courseTeacher').value;
            const carrera = document.getElementById('courseCareer').value;
            const semestre = document.getElementById('courseSemester').value;
            const idMateria = document.getElementById('courseSubject').value;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        mostrarMensaje('Curso agregado correctamente', 'success');
                        courseForm.reset();
                        cargarDatos();
                    } else {
                        mostrarMensaje(result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarMensaje('Error al agregar curso: ' + error.message, 'error');
                })
                .addCurso(sessionId, nombre, codigo, idProfesor, idMateria, carrera, semestre);
        });
    }
    
    // Formulario de agregar profesor
    const teacherForm = document.getElementById('teacherForm');
    if (teacherForm) {
        teacherForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nombre = document.getElementById('teacherName').value;
            const email = document.getElementById('teacherEmail').value;
            const discapacidad = document.getElementById('teacherDisability').checked;
            const pisoPreferido = document.getElementById('teacherPreferredFloor').value;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        mostrarMensaje('Profesor agregado correctamente', 'success');
                        teacherForm.reset();
                        cargarDatos();
                    } else {
                        mostrarMensaje(result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarMensaje('Error al agregar profesor: ' + error.message, 'error');
                })
                .addProfesor(sessionId, nombre, email, discapacidad, pisoPreferido);
        });
    }
    
    // Formulario de agregar grupo
    const groupForm = document.getElementById('groupForm');
    if (groupForm) {
        groupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const numero = document.getElementById('groupNumber').value;
            const carrera = document.getElementById('groupCareer').value;
            const semestre = document.getElementById('groupSemester').value;
            const tamaño = document.getElementById('groupSize').value;
            const discapacidad = document.getElementById('groupDisability').checked;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        mostrarMensaje('Grupo agregado correctamente', 'success');
                        groupForm.reset();
                        cargarDatos();
                    } else {
                        mostrarMensaje(result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarMensaje('Error al agregar grupo: ' + error.message, 'error');
                })
                .addGrupo(sessionId, numero, carrera, semestre, tamaño, discapacidad);
        });
    }
    
    // Formulario de agregar materia
    const subjectForm = document.getElementById('subjectForm');
    if (subjectForm) {
        subjectForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nombre = document.getElementById('subjectName').value;
            const codigo = document.getElementById('subjectCode').value;
            const semestre = document.getElementById('subjectSemester').value;
            const obligatoria = document.getElementById('subjectRequired').checked;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        mostrarMensaje('Materia agregada correctamente', 'success');
                        subjectForm.reset();
                        cargarDatos();
                    } else {
                        mostrarMensaje(result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarMensaje('Error al agregar materia: ' + error.message, 'error');
                })
                .addMateria(sessionId, nombre, codigo, obligatoria, semestre);
        });
    }
}

// Función para configurar event listeners de asignaciones
function configurarEventListenersAsignaciones() {
    // Cambio en el selector de edificio
    const buildingSelect = document.getElementById('assignBuilding');
    if (buildingSelect) {
        buildingSelect.addEventListener('change', function() {
            const edificio = this.value;
            const floorSelect = document.getElementById('assignFloor');
            
            if (!edificio) {
                floorSelect.innerHTML = '<option value="">Piso</option>';
                return;
            }
            
            const pisos = [...new Set(aulas.filter(a => a[1] === edificio).map(a => a[2]))];
            floorSelect.innerHTML = '<option value="">Piso</option>';
            
            pisos.forEach(piso => {
                floorSelect.innerHTML += `<option value="${piso}">${piso}</option>`;
            });
        });
    }
    
    // Cambio en el selector de piso
    const floorSelect = document.getElementById('assignFloor');
    if (floorSelect) {
        floorSelect.addEventListener('change', function() {
            const edificio = document.getElementById('assignBuilding').value;
            const piso = this.value;
            const classroomSelect = document.getElementById('assignClassroom');
            
            if (!edificio || !piso) {
                classroomSelect.innerHTML = '<option value="">Aula</option>';
                return;
            }
            
            const aulasPiso = aulas.filter(a => a[1] === edificio && a[2] == piso);
            classroomSelect.innerHTML = '<option value="">Aula</option>';
            
            aulasPiso.forEach(aula => {
                classroomSelect.innerHTML += `<option value="${aula[0]}">${aula[3]}</option>`;
            });
        });
    }
    
    // Formulario de crear asignación
    const assignmentForm = document.getElementById('assignmentForm');
    if (assignmentForm) {
        assignmentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const idCurso = document.getElementById('assignCourse').value;
            const idAula = document.getElementById('assignClassroom').value;
            const fecha = document.getElementById('assignDate').value;
            const horaInicio = document.getElementById('assignStart').value;
            const horaFin = document.getElementById('assignEnd').value;
            const idGrupo = document.getElementById('assignGroup').value;
            
            // Obtener ID del profesor del curso
            const curso = cursos.find(c => c[0] === idCurso);
            const idProfesor = curso ? curso[3] : '';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        mostrarMensaje('Asignación creada correctamente', 'success');
                        assignmentForm.reset();
                        cargarDatos();
                    } else {
                        mostrarMensaje(result.message, 'error');
                        
                        // Si hay alternativas, mostrarlas
                        if (result.alternativas && result.alternativas.length > 0) {
                            const alternativasText = result.alternativas.map(a => 
                                `${a.edificio}${a.piso}-${a.numero} (Prioridad: ${a.prioridad})`
                            ).join(', ');
                            mostrarMensaje(`Alternativas disponibles: ${alternativasText}`, 'info');
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarMensaje('Error al crear asignación: ' + error.message, 'error');
                })
                .createAssignment(sessionId, idCurso, idAula, fecha, horaInicio, horaFin, idProfesor, idGrupo);
        });
    }
    
    // Formulario de auto-asignar aula
    const autoAssignForm = document.getElementById('autoAssignForm');
    if (autoAssignForm) {
        autoAssignForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const idCurso = document.getElementById('autoAssignCourse').value;
            const fecha = document.getElementById('autoAssignDate').value;
            const horaInicio = document.getElementById('autoAssignStart').value;
            const horaFin = document.getElementById('autoAssignEnd').value;
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        mostrarMensaje('Aula auto-asignada correctamente', 'success');
                        autoAssignForm.reset();
                        cargarDatos();
                    } else {
                        mostrarMensaje(result.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarMensaje('Error al auto-asignar aula: ' + error.message, 'error');
                })
                .autoAssignClassroom(sessionId, idCurso, fecha, horaInicio, horaFin);
        });
    }
    
    // Botón de filtrar asignaciones por fecha
    const filterBtn = document.getElementById('filterBtn');
    if (filterBtn) {
        filterBtn.addEventListener('click', function() {
            const fecha = document.getElementById('filterDate').value;
            actualizarTablaAsignaciones(fecha);
        });
    }
}

// Función para eliminar una asignación
function eliminarAsignacion(id) {
    if (confirm('¿Está seguro de eliminar esta asignación?')) {
        google.script.run
            .withSuccessHandler(function() {
                mostrarMensaje('Asignación eliminada correctamente', 'success');
                cargarDatos();
            })
            .withFailureHandler(function(error) {
                mostrarMensaje('Error al eliminar asignación: ' + error.message, 'error');
            })
            .deleteAssignment(sessionId, id);
    }
}

// Función para cargar datos de administración
function cargarDatosAdministracion() {
    // Cargar usuarios
    google.script.run
        .withSuccessHandler(function(users) {
            const usersTable = document.getElementById('usersTable');
            if (!usersTable) return;
            
            const tbody = usersTable.querySelector('tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Saltar encabezado
            for (let i = 1; i < users.length; i++) {
                const user = users[i];
                const activeText = user[5] ? 'Sí' : 'No';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user[1]}</td>
                    <td>${user[2]}</td>
                    <td>${user[4]}</td>
                    <td>${activeText}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="toggleUserStatus('${user[0]}', ${user[5]})">
                            ${user[5] ? 'Desactivar' : 'Activar'}
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="resetPassword('${user[0]}')">Resetear Contraseña</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
            
            // Actualizar el select de usuarios en el formulario de permisos
            const permissionUserSelect = document.getElementById('permissionUser');
            if (permissionUserSelect) {
                permissionUserSelect.innerHTML = '<option value="">Seleccionar Usuario</option>';
                
                // Saltar encabezado
                for (let i = 1; i < users.length; i++) {
                    const user = users[i];
                    permissionUserSelect.innerHTML += `<option value="${user[0]}">${user[1]} (${user[2]})</option>`;
                }
            }
        })
        .getUsuarios();
    
    // Cargar permisos
    google.script.run
        .withSuccessHandler(function(permissions) {
            const permissionsTable = document.getElementById('permissionsTable');
            if (!permissionsTable) return;
            
            const tbody = permissionsTable.querySelector('tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Saltar encabezado
            for (let i = 1; i < permissions.length; i++) {
                const permission = permissions[i];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${permission[1]}</td>
                    <td>${permission[2]}</td>
                    <td>${permission[3]}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deletePermission('${permission[0]}')">Eliminar</button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        })
        .getPermissions();
    
    // Configurar event listeners para administración
    configurarEventListenersAdministracion();
}

// Función para configurar event listeners de administración
function configurarEventListenersAdministracion() {
    // Formulario de agregar usuario
    const userForm = document.getElementById('userForm');
    if (userForm) {
        userForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nombre = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        mostrarMensaje('Usuario creado exitosamente', 'success');
                        userForm.reset();
                        cargarDatosAdministracion();
                    } else {
                        mostrarMensaje(response.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarMensaje('Error al crear usuario: ' + error.message, 'error');
                })
                .addUsuario(sessionId, nombre, email, password, role);
        });
    }
    
    // Formulario de asignar permisos
    const permissionForm = document.getElementById('permissionForm');
    if (permissionForm) {
        permissionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userId = document.getElementById('permissionUser').value;
            const module = document.getElementById('permissionModule').value;
            const level = document.getElementById('permissionLevel').value;
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        mostrarMensaje('Permiso asignado exitosamente', 'success');
                        permissionForm.reset();
                        cargarDatosAdministracion();
                    } else {
                        mostrarMensaje(response.message, 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    mostrarMensaje('Error al asignar permiso: ' + error.message, 'error');
                })
                .addPermission(sessionId, userId, module, level);
        });
    }
}

// Función para cambiar el estado de un usuario
function toggleUserStatus(userId, currentStatus) {
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                cargarDatosAdministracion();
            } else {
                mostrarMensaje(response.message, 'error');
            }
        })
        .withFailureHandler(function(error) {
            mostrarMensaje('Error al cambiar estado de usuario: ' + error.message, 'error');
        })
        .toggleUserStatus(sessionId, userId, !currentStatus);
}

// Función para resetear contraseña
function resetPassword(userId) {
    const newPassword = prompt('Ingresa la nueva contraseña:');
    
    if (newPassword) {
        google.script.run
            .withSuccessHandler(function(response) {
                if (response.success) {
                    mostrarMensaje('Contraseña reseteada exitosamente', 'success');
                } else {
                    mostrarMensaje(response.message, 'error');
                }
            })
            .withFailureHandler(function(error) {
                mostrarMensaje('Error al resetear contraseña: ' + error.message, 'error');
            })
            .resetPassword(sessionId, userId, newPassword);
    }
}

// Función para eliminar un permiso
function deletePermission(permissionId) {
    if (confirm('¿Estás seguro de eliminar este permiso?')) {
        google.script.run
            .withSuccessHandler(function(response) {
                if (response.success) {
                    cargarDatosAdministracion();
                } else {
                    mostrarMensaje(response.message, 'error');
                }
            })
            .withFailureHandler(function(error) {
                mostrarMensaje('Error al eliminar permiso: ' + error.message, 'error');
            })
            .deletePermission(sessionId, permissionId);
    }
}