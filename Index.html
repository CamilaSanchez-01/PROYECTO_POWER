<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<<<<<<< Updated upstream
    <title>Sistema de Asignación de Salones</title>
<<<<<<< HEAD
    <link rel="stylesheet" href="css/estilos.css">
=======
    <title>Sistema de Gestión de Edificios Escolares - UABC</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Estilos principales -->
    <style>
      /* ============================================
         VARIABLES CSS - SISTEMA COMPLETO
      ============================================ */
      :root {
          /* Paleta Principal */
          --negro: #121212;
          --negro-claro: #1E1E1E;
          --verde-oscuro: #2E7D32;
          --verde-medio: #4CAF50;
          --verde-claro: #81C784;
          --amarillo-oscuro: #F57F17;
          --amarillo-medio: #FFC107;
          --amarillo-claro: #FFE082;
          --gris-claro: #E0E0E0;
          --gris-texto: #BDBDBD;
          --disponible: #4CAF50;
          --ocupado: #FFC107;
          --accesible: #FF9800;

          /* Paleta Login */
          --negro-login: #000000;
          --verde-oscuro-login: #006633;
          --oro-dorado: #D4AF37;
          --blanco: #FFFFFF;
      }

      /*
      ============================================
          ESTILOS GLOBALES Y RESET
      ============================================
      */
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
          background: linear-gradient(135deg, var(--negro) 0%, var(--verde-oscuro) 100%);
          min-height: 100vh;
          color: var(--blanco);
          overflow-x: hidden;
      }

      /*
      ============================================
          LAYOUT DE LA APLICACIÓN
      ============================================
      */
      #app {
          min-height: 100vh;
          display: flex;
          flex-direction: column;
      }

      .app-loader {
          flex: 1;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          gap: 20px;
      }

      .app-content {
          flex: 1;
          display: flex;
          flex-direction: column;
      }

      .loader {
          border: 5px solid var(--negro-claro);
          border-top: 5px solid var(--verde-medio);
          border-radius: 50%;
          width: 60px;
          height: 60px;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .loading-text {
          color: var(--gris-claro);
          font-size: 18px;
      }

      .error-container {
          text-align: center;
          padding: 40px;
          background: rgba(0, 0, 0, 0.7);
          border-radius: 10px;
          margin: 20px;
      }

      /*
      ============================================
          ESTILOS PARA EL LOGIN
      ============================================
      */
      .login-wrapper {
          display: flex;
          flex-direction: column;
          min-height: 100vh;
      }

      .login-header {
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 20px;
          background-color: rgba(0, 0, 0, 0.7);
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .logo-container {
          display: flex;
          align-items: center;
          gap: 15px;
          margin-bottom: 15px;
      }

      .uabc-logo {
          height: 60px;
          width: auto;
      }

      .institution-info {
          display: flex;
          flex-direction: column;
      }

      .university-name {
          font-size: 18px;
          font-weight: 600;
          color: var(--blanco);
          margin-bottom: 5px;
      }

      .faculty-name {
          font-size: 14px;
          color: var(--oro-dorado);
      }

      .system-title {
          text-align: center;
          font-size: 22px;
          font-weight: 700;
          color: var(--blanco);
          text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
      }

      .login-main-container {
          flex: 1;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 20px;
      }

      .login-container {
          background-color: rgba(0, 0, 0, 0.7);
          border-radius: 15px;
          padding: 40px;
          width: 100%;
          max-width: 400px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
          border: 1px solid rgba(212, 175, 55, 0.3);
          position: relative;
          overflow: hidden;
      }

      .login-container::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 5px;
          background: linear-gradient(90deg, var(--verde-oscuro-login), var(--oro-dorado));
      }

      .form-title {
          text-align: center;
          color: var(--blanco);
          margin-bottom: 30px;
          font-size: 28px;
          font-weight: 600;
          text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-group label {
          display: block;
          margin-bottom: 8px;
          color: var(--oro-dorado);
          font-weight: 500;
      }

      .form-group input {
          width: 100%;
          padding: 12px 15px;
          border: 2px solid rgba(212, 175, 55, 0.3);
          border-radius: 8px;
          font-size: 16px;
          transition: all 0.3s;
          background-color: rgba(0, 0, 0, 0.5);
          color: var(--blanco);
      }

      .form-group input::placeholder {
          color: rgba(255, 255, 255, 0.6);
      }

      .form-group input:focus {
          border-color: var(--oro-dorado);
          outline: none;
          background-color: rgba(0, 0, 0, 0.7);
          box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
      }

      .login-btn {
          width: 100%;
          padding: 14px;
          background: linear-gradient(90deg, var(--verde-oscuro-login), var(--negro-login));
          color: var(--blanco);
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          margin-top: 10px;
          position: relative;
          overflow: hidden;
          z-index: 1;
      }

      .login-btn::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, var(--negro-login), var(--oro-dorado));
          z-index: -1;
          transition: opacity 0.3s;
          opacity: 0;
      }

      .login-btn:hover::before {
          opacity: 1;
      }

      .login-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
      }

      .login-help {
          margin-top: 20px;
          text-align: center;
      }

      .login-help p {
          color: var(--gris-texto);
          font-size: 14px;
          font-style: italic;
      }

      .login-footer {
          background-color: rgba(0, 0, 0, 0.7);
          padding: 20px;
          display: flex;
          justify-content: center;
          align-items: center;
          border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .credits {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 10px;
          color: var(--oro-dorado);
          font-weight: 500;
      }

      .credits-text {
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .lide-logo {
          height: 40px;
          width: auto;
      }

      .lide-description {
          font-size: 12px;
          color: var(--blanco);
          font-style: italic;
      }

      /*
      ============================================
          ESTILOS PARA LA PÁGINA PRINCIPAL
      ============================================
      */
      .principal-wrapper {
          display: flex;
          flex-direction: column;
          min-height: 100vh;
      }

      .principal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 15px 30px;
          background-color: rgba(0, 0, 0, 0.7);
          backdrop-filter: blur(5px);
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .header-left {
          display: flex;
          align-items: center;
          gap: 20px;
      }

      .menu-toggle {
          background: none;
          border: none;
          color: var(--gris-claro);
          font-size: 24px;
          cursor: pointer;
          padding: 5px;
          border-radius: 5px;
          transition: all 0.3s;
          display: none;
      }

      .menu-toggle:hover {
          color: var(--verde-claro);
          background-color: rgba(76, 175, 80, 0.1);
      }

      .header-logos {
          display: flex;
          align-items: center;
      }

      .logo-uabc-fca {
          height: 50px;
          width: auto;
      }

      .header-info {
          display: flex;
          flex-direction: column;
      }

      .system-title {
          font-size: 18px;
          font-weight: 700;
          color: var(--blanco);
      }

      .faculty-name {
          font-size: 12px;
          color: var(--gris-texto);
      }

      .user-info {
          display: flex;
          align-items: center;
          gap: 15px;
      }

      .user-avatar {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background-color: var(--verde-medio);
          display: flex;
          justify-content: center;
          align-items: center;
          font-weight: bold;
          color: white;
          font-size: 18px;
      }

      .logout-btn {
          padding: 8px 16px;
          background: rgba(79, 209, 197, 0.3);
          border: 1px solid var(--verde-medio);
          border-radius: 5px;
          color: var(--gris-claro);
          cursor: pointer;
          transition: all 0.3s;
          font-weight: 500;
      }

      .logout-btn:hover {
          background: var(--verde-medio);
          color: white;
      }

      .main-layout {
          flex: 1;
          display: flex;
          position: relative;
      }

      /* Sidebar */
      .sidebar {
          width: 250px;
          background-color: rgba(30, 30, 30, 0.95);
          backdrop-filter: blur(10px);
          border-right: 1px solid rgba(255, 255, 255, 0.1);
          display: flex;
          flex-direction: column;
          transition: all 0.3s ease;
          position: fixed;
          height: calc(100vh - 80px);
          z-index: 1000;
          left: 0;
      }

      .sidebar-header {
          padding: 25px 20px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 15px;
      }

      .sidebar-logo {
          width: 120px;
          height: auto;
      }

      .sidebar-title {
          font-size: 20px;
          font-weight: 600;
          color: var(--verde-claro);
          text-align: center;
      }

      .sidebar-nav {
          flex: 1;
          padding: 20px 0;
          overflow-y: auto;
      }

      .sidebar-link {
          display: flex;
          align-items: center;
          padding: 15px 20px;
          color: var(--gris-texto);
          text-decoration: none;
          transition: all 0.3s;
          border-left: 4px solid transparent;
          cursor: pointer;
      }

      .sidebar-link:hover {
          background-color: rgba(76, 175, 80, 0.1);
          color: var(--gris-claro);
          border-left-color: var(--verde-medio);
      }

      .sidebar-link.active {
          background-color: rgba(76, 175, 80, 0.2);
          color: var(--verde-claro);
          border-left-color: var(--verde-medio);
      }

      .sidebar-link i {
          width: 24px;
          font-size: 18px;
          margin-right: 15px;
      }

      .sidebar-link span {
          font-size: 16px;
          font-weight: 500;
      }

      .sidebar-footer {
          padding: 20px;
          border-top: 1px solid rgba(255, 255, 255, 0.1);
          display: flex;
          justify-content: center;
      }

      /* Overlay */
      .sidebar-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          z-index: 999;
          display: none;
      }

      /* Contenido principal */
      .main-content {
          flex: 1;
          margin-left: 250px;
          padding: 30px;
          max-width: calc(100% - 250px);
          transition: all 0.3s ease;
      }

      #content-section {
          min-height: 400px;
      }

      /* Contenido de secciones */
      .welcome-section {
          text-align: center;
          margin-bottom: 40px;
      }

      .welcome-title {
          font-size: 32px;
          font-weight: 500;
          margin-bottom: 10px;
          color: var(--gris-claro);
          text-shadow: 0 0 10px rgba(3, 169, 244, 0.3);
      }

      .welcome-subtitle {
          font-size: 16px;
          color: var(--gris-texto);
          max-width: 600px;
          margin: 0 auto;
      }

      .section-header {
          margin-bottom: 30px;
      }

      .section-header h1 {
          font-size: 28px;
          color: var(--verde-claro);
          margin-bottom: 10px;
      }

      .section-header p {
          color: var(--gris-texto);
      }

      /* Dashboard */
      .dashboard-cards {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 40px;
      }

      .dashboard-card {
          background-color: rgba(30, 30, 30, 0.7);
          border-radius: 12px;
          padding: 25px;
          display: flex;
          align-items: center;
          gap: 20px;
          transition: all 0.3s;
          border: 1px solid rgba(79, 209, 197, 0.2);
      }

      .dashboard-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      }

      .card-icon {
          width: 60px;
          height: 60px;
          background: linear-gradient(135deg, var(--verde-oscuro), var(--verde-medio));
          border-radius: 10px;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 24px;
      }

      .card-content h3 {
          font-size: 24px;
          margin-bottom: 5px;
          color: var(--verde-claro);
      }

      .card-content p {
          color: var(--gris-texto);
          font-size: 14px;
      }

      /* Controles */
      .controls {
          display: flex;
          gap: 15px;
          margin-bottom: 30px;
          flex-wrap: wrap;
      }

      .search-bar {
          display: flex;
          gap: 10px;
          flex: 1;
          min-width: 250px;
      }

      .search-bar input {
          flex: 1;
          padding: 10px 15px;
          border: 1px solid var(--gris-texto);
          border-radius: 5px;
          background-color: var(--negro-claro);
          color: var(--gris-claro);
          font-size: 14px;
      }

      .search-bar button {
          padding: 10px 20px;
          background: var(--verde-medio);
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-weight: 600;
          transition: all 0.3s;
      }

      .search-bar button:hover {
          background: var(--verde-claro);
      }

      .filters {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
      }

      .filter-btn {
          padding: 8px 16px;
          background: rgba(255, 193, 7, 0.2);
          border: 1px solid var(--amarillo-medio);
          border-radius: 5px;
          color: var(--amarillo-medio);
          cursor: pointer;
          transition: all 0.3s;
          font-weight: 500;
      }

      .filter-btn:hover, .filter-btn.active {
          background: var(--amarillo-medio);
          color: var(--negro);
      }

      /* Edificios */
      .buildings-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
          gap: 25px;
      }

      .loading-buildings {
          grid-column: 1 / -1;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 40px;
          gap: 15px;
          color: var(--gris-texto);
      }

      .building-card {
          background-color: rgba(30, 30, 30, 0.7);
          border-radius: 12px;
          padding: 25px;
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(79, 209, 197, 0.2);
          transition: all 0.3s ease;
      }

      .building-header {
          display: flex;
          align-items: center;
          margin-bottom: 20px;
      }

      .building-icon {
          width: 50px;
          height: 50px;
          background-color: var(--verde-medio);
          border-radius: 8px;
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 24px;
          font-weight: bold;
          color: white;
          margin-right: 15px;
      }

      .building-info h3 {
          font-size: 24px;
          font-weight: 500;
          color: var(--verde-claro);
          margin-bottom: 5px;
      }

      .building-info p {
          color: var(--gris-texto);
          font-size: 14px;
      }

      .floor-toggle {
          width: 100%;
          padding: 15px;
          background: linear-gradient(90deg, var(--verde-oscuro), var(--verde-medio));
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: space-between;
          margin-bottom: 15px;
          transition: all 0.3s;
      }

      .floor-toggle:hover {
          background: linear-gradient(90deg, var(--verde-medio), var(--verde-claro));
          transform: translateY(-2px);
      }

      .floor-toggle i {
          margin-left: auto;
          transition: transform 0.3s;
      }

      .floor-toggle.active i {
          transform: rotate(180deg);
      }

      .salon-grid {
          display: flex;
          flex-wrap: nowrap;
          gap: 15px;
          margin-top: 10px;
          max-height: 0;
          overflow-x: auto;
          overflow-y: hidden;
          transition: all 0.5s ease;
          padding-bottom: 5px;
      }

      .salon-grid.active {
          max-height: 500px;
      }

      .salon-card {
          flex: 0 0 auto;
          width: 150px;
          background-color: var(--negro-claro);
          border: 2px solid var(--verde-medio);
          border-radius: 8px;
          padding: 15px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 600;
          color: white;
          transition: all 0.3s;
          cursor: pointer;
          min-height: 70px;
          font-size: 16px;
      }

      .salon-card:hover {
          transform: scale(1.05) rotate(1deg);
      }

      .salon-card.disponible {
          border-color: var(--disponible);
          background-color: rgba(76, 175, 80, 0.1);
      }

      .salon-card.ocupado {
          border-color: var(--ocupado);
          background-color: rgba(255, 193, 7, 0.1);
      }

      .salon-card.accesible {
          border-color: var(--accesible);
      }

      /* Gestión de Usuarios */
      .users-controls {
          margin-bottom: 20px;
      }

      .btn-primary {
          padding: 10px 20px;
          background: var(--verde-medio);
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.3s;
      }

      .btn-primary:hover {
          background: var(--verde-claro);
      }

      .btn-secondary {
          padding: 10px 20px;
          background: transparent;
          color: var(--gris-claro);
          border: 1px solid var(--gris-texto);
          border-radius: 5px;
          cursor: pointer;
          transition: all 0.3s;
      }

      .btn-secondary:hover {
          background: rgba(255, 255, 255, 0.1);
      }

      .users-list-container {
          background: rgba(30, 30, 30, 0.7);
          border-radius: 10px;
          padding: 20px;
          overflow-x: auto;
      }

      .users-table {
          width: 100%;
          border-collapse: collapse;
      }

      .users-table th {
          background-color: var(--negro);
          color: var(--verde-claro);
          padding: 12px;
          text-align: left;
          border-bottom: 2px solid var(--verde-medio);
      }

      .users-table td {
          padding: 12px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .status-active {
          color: var(--disponible);
          font-weight: 600;
      }

      .status-inactive {
          color: #f44336;
          font-weight: 600;
      }

      .user-actions {
          display: flex;
          gap: 5px;
      }

      .btn-small {
          padding: 5px 10px;
          border: none;
          border-radius: 3px;
          cursor: pointer;
          font-size: 12px;
          transition: all 0.3s;
      }

      .btn-edit {
          background-color: var(--amarillo-medio);
          color: var(--negro);
      }

      .btn-reset {
          background-color: var(--verde-medio);
          color: white;
      }

      .btn-deactivate {
          background-color: #f44336;
          color: white;
      }

      .btn-activate {
          background-color: var(--verde-claro);
          color: white;
      }

      /* Configuración */
      .settings-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
          gap: 20px;
      }

      .settings-card {
          background: rgba(30, 30, 30, 0.7);
          border-radius: 10px;
          padding: 20px;
          border: 1px solid rgba(79, 209, 197, 0.2);
      }

      .settings-card h3 {
          color: var(--verde-claro);
          margin-bottom: 15px;
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .settings-info {
          display: flex;
          flex-direction: column;
          gap: 10px;
      }

      /* Notificaciones */
      .notification {
          position: fixed;
          bottom: 20px;
          right: 20px;
          padding: 15px 20px;
          border-radius: 5px;
          color: white;
          font-weight: 500;
          z-index: 1002;
          opacity: 0;
          transform: translateX(100%);
          transition: all 0.3s ease;
          max-width: 400px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .notification.show {
          opacity: 1;
          transform: translateX(0);
      }

      .notification.success {
          background-color: var(--disponible);
      }

      .notification.info {
          background-color: var(--verde-medio);
      }

      .notification.warning {
          background-color: var(--amarillo-medio);
          color: var(--negro);
      }

      .notification.error {
          background-color: #f44336;
      }

      /* Footer */
      .principal-footer {
          background-color: rgba(0, 0, 0, 0.7);
          padding: 15px;
          display: flex;
          justify-content: center;
          align-items: center;
          border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .credits {
          display: flex;
          align-items: center;
          gap: 15px;
          color: var(--gris-texto);
          font-weight: 500;
      }

      .lide-logo-footer {
          height: 30px;
          width: auto;
      }

      .lide-text {
          font-size: 12px;
          color: var(--gris-texto);
          font-style: italic;
      }

      /*
      ============================================
          RESPONSIVE DESIGN
      ============================================
      */
      @media (max-width: 768px) {
          .principal-header {
              padding: 10px 15px;
          }

          .menu-toggle {
              display: block;
          }

          .header-info {
              display: none;
          }

          .sidebar {
              left: -250px;
              height: 100vh;
          }

          .sidebar.active {
              left: 0;
          }

          .main-content {
              margin-left: 0;
              max-width: 100%;
              padding: 20px;
          }

          .sidebar-overlay.active {
              display: block;
          }

          .user-info span {
              display: none;
          }

          .login-header {
              padding: 15px;
          }

          .logo-container {
              flex-direction: column;
              text-align: center;
          }

          .system-title {
              font-size: 18px;
          }

          .login-container {
              padding: 30px 20px;
          }

          .form-title {
              font-size: 24px;
          }

          .dashboard-cards {
              grid-template-columns: 1fr;
          }

          .buildings-container {
              grid-template-columns: 1fr;
          }

          .controls {
              flex-direction: column;
          }

          .search-bar {
              min-width: 100%;
          }

          .users-table {
              font-size: 12px;
          }

          .user-actions {
              flex-direction: column;
          }

          .btn-small {
              padding: 3px 6px;
              font-size: 10px;
          }
      }

      /* --- ADICIONES: seguridad de visualización y responsividad global --- */
      .main-content, .login-main-container, .app-content {
          max-height: 100vh;
          overflow: auto;
          -webkit-overflow-scrolling: touch;
      }

      /* Aplique las mismas reglas de botón para cuando Login.html se inyecte */
      .login-container {
          max-width: 420px;
          width: calc(100% - 40px);
          max-height: calc(100vh - 120px);
          overflow: auto;
      }

      /* Asegura que el botón de login no se recorte por zoom */
      .login-btn {
          font-size: clamp(14px, 1.6vw, 16px);
          min-height: 44px;
      }

      /* Responsive general */
      @media (max-width: 768px) {
          .main-content { padding: 16px; margin-left: 0; max-width: 100%; }
          .login-container { padding: 20px; }
      }
    </style>
>>>>>>> Stashed changes
=======
    <base target="_top">
    <?!= include('Estilos.html'); ?>
>>>>>>> d9feaf4ee6633431209033f3f5ac8d99446cacf9
</head>
<body>
    <div id="appContainer">
        <!-- El contenido se cargará dinámicamente aquí -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
<<<<<<< HEAD
<<<<<<< Updated upstream
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
=======
        document.addEventListener('DOMContentLoaded', function() {
            const appContainer = document.getElementById('appContainer');
>>>>>>> d9feaf4ee6633431209033f3f5ac8d99446cacf9
            
            // Verificar si hay una sesión activa
            const sessionId = sessionStorage.getItem('sessionId');
            
            if (sessionId) {
                // Verificar si la sesión es válida
                google.script.run
                    .withSuccessHandler(function(user) {
                        if (user) {
                            // Sesión válida, cargar dashboard
                            loadDashboard();
                        } else {
                            // Sesión inválida, cargar login
                            loadLogin();
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error al verificar sesión:', error);
                        loadLogin();
                    })
                    .getCurrentUser(sessionId);
            } else {
                // No hay sesión, cargar login
                loadLogin();
            }
            
            function loadLogin() {
                google.script.run
                    .withSuccessHandler(function(html) {
                        appContainer.innerHTML = html;
                        // Inicializar eventos del login
                        initializeLoginEvents();
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error al cargar login:', error);
                        appContainer.innerHTML = '<div class="error-message">Error al cargar la página de login</div>';
                    })
                    .loadLogin();
            }
            
            function loadDashboard() {
                google.script.run
                    .withSuccessHandler(function(html) {
                        appContainer.innerHTML = html;
                        // Inicializar eventos del dashboard
                        initializeDashboardEvents();
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error al cargar dashboard:', error);
                        appContainer.innerHTML = '<div class="error-message">Error al cargar el dashboard</div>';
                    })
                    .loadDashboard();
            }
            
            function initializeLoginEvents() {
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const email = document.getElementById('email').value;
                        const password = document.getElementById('password').value;
                        const errorElement = document.getElementById('loginError');
                        
                        // Ocultar mensaje de error anterior
                        errorElement.style.display = 'none';
                        
                        // Mostrar mensaje de carga
                        mostrarMensaje('Iniciando sesión, por favor espere...', 'info');
                        
                        google.script.run
                            .withSuccessHandler(function(response) {
                                if (response.success) {
                                    // Guardar ID de sesión en sessionStorage
                                    sessionStorage.setItem('sessionId', response.sessionId);
                                    
                                    // Mostrar mensaje de éxito
                                    mostrarMensaje('¡Inicio de sesión exitoso! Redirigiendo...', 'success');
                                    
                                    // Pequeña pausa antes de redirigir
                                    setTimeout(() => {
                                        loadDashboard();
                                    }, 1500);
                                } else {
                                    errorElement.textContent = response.message;
                                    errorElement.style.display = 'block';
                                }
                            })
                            .withFailureHandler(function(error) {
                                errorElement.textContent = 'Error de conexión. Intente nuevamente.';
                                errorElement.style.display = 'block';
                                console.error('Error en login:', error);
                            })
                            .login(email, password);
                    });
                }
            }
            
            function initializeDashboardEvents() {
                // Obtener ID de sesión de sessionStorage
                const sessionId = sessionStorage.getItem('sessionId');
                
                if (!sessionId) {
                    // Si no hay sesión, redirigir al login
                    window.location.reload();
                    return;
                }
                
                // Verificar sesión y obtener usuario actual
                google.script.run
                    .withSuccessHandler(function(user) {
                        if (!user) {
                            // Si no hay usuario, redirigir al login
                            window.location.reload();
                            return;
                        }
                        
                        currentUser = user;
                        const userInfoElement = document.getElementById('userInfo');
                        if (userInfoElement) {
                            userInfoElement.textContent = `Bienvenido, ${user.email}`;
                        }
                        
                        // Cargar datos iniciales
                        cargarDatos();
                        
                        // Configurar event listeners
                        configurarEventListeners();
                        
                        // No se muestra la sección de administración para ningún usuario
                    })
                    .getCurrentUser(sessionId);
            }
            
            // Variables globales
            let aulas = [];
            let cursos = [];
            let profesores = [];
            let asignaciones = [];
            let usuarios = [];
            let permisos = [];
            let grupos = [];
            let materias = [];
            let horarios = [];
            let currentUser = null;
            
            // Configuración de edificios
            const buildingConfig = {
                'D': { pisos: [6, 6, 6, 6] }, // 24 aulas
                'E': { pisos: [6, 6, 6, 5] }, // 23 aulas
                'F': { pisos: [4, 4, 4, 4] }  // 16 aulas
            };
            
            // Función para cargar datos iniciales
            function cargarDatos() {
                google.script.run
                    .withSuccessHandler(function(data) {
                        aulas = data.aulas || [];
                        cursos = data.cursos || [];
                        profesores = data.profesores || [];
                        asignaciones = data.asignaciones || [];
                        usuarios = data.usuarios || [];
                        permisos = data.permisos || [];
                        grupos = data.grupos || [];
                        materias = data.materias || [];
                        horarios = data.horarios || [];
                        
                        // Si no hay aulas, inicializar el sistema
                        if (aulas.length <= 1) { // Solo encabezado
                            google.script.run
                                .withSuccessHandler(function(result) {
                                    if (result.success) {
                                        cargarDatos(); // Recargar datos después de inicializar
                                    } else {
                                        mostrarMensaje('Error al inicializar el sistema: ' + result.message, 'error');
                                    }
                                })
                                .initializeSheets();
                            return;
                        }
                        
                        // Actualizar interfaz
                        actualizarInterfaz();
                    })
                    .getAllData();
            }
            
            // Función para actualizar la interfaz
            function actualizarInterfaz() {
                // Actualizar tarjetas de edificios
                actualizarTarjetasEdificios();
                
                // Actualizar tablas
                actualizarTablaAulas();
                actualizarTablaCursos();
                actualizarTablaProfesores();
                actualizarTablaGrupos();
                actualizarTablaMaterias();
                actualizarTablaAsignaciones();
                
                // Actualizar dropdowns
                actualizarDropdowns();
            }
            
            // Función para actualizar las tarjetas de edificios
            function actualizarTarjetasEdificios() {
                const edificios = ['D', 'E', 'F'];
                
                edificios.forEach(edificio => {
                    const accordionId = `accordion${edificio}`;
                    const accordion = document.getElementById(accordionId);
                    
                    if (!accordion) return;
                    
                    // Limpiar contenido existente
                    accordion.innerHTML = '';
                    
                    // Obtener pisos del edificio
                    const pisos = buildingConfig[edificio].pisos;
                    
                    // Crear un accordion item para cada piso
                    pisos.forEach((aulasPiso, indicePiso) => {
                        const piso = indicePiso + 1;
                        const collapseId = `collapse${edificio}${piso}`;
                        const classroomsId = `classrooms${edificio}${piso}`;
                        
                        // Crear accordion item
                        const accordionItem = document.createElement('div');
                        accordionItem.className = 'accordion-item';
                        
                        accordionItem.innerHTML = `
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                    Piso ${piso}
                                </button>
                            </h2>
                            <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#${accordionId}">
                                <div class="accordion-body classroom-grid" id="${classroomsId}">
                                    <!-- Las aulas se agregarán dinámicamente -->
                                </div>
                            </div>
                        `;
                        
                        accordion.appendChild(accordionItem);
                        
                        // Agregar aulas al piso
                        const classroomsContainer = document.getElementById(classroomsId);
                        const aulasPisoActual = aulas.filter(aula => 
                            aula[1] === edificio && aula[2] === piso
                        );
                        
                        aulasPisoActual.forEach(aula => {
                            const classroomBox = document.createElement('div');
                            classroomBox.className = 'classroom-box';
                            
                            // Añadir icono según tipo de aula
                            let icono = '';
                            if (aula[7] === 'Accesible') {
                                icono = '<i class="fas fa-wheelchair"></i> ';
                            } else if (aula[7] === 'Laboratorio') {
                                icono = '<i class="fas fa-flask"></i> ';
                            }
                            
                            classroomBox.innerHTML = `${icono}${aula[3]}`;
                            classroomsContainer.appendChild(classroomBox);
                        });
                    });
                });
            }
            
            // Función para actualizar la tabla de aulas
            function actualizarTablaAulas() {
                const tbody = document.querySelector('#classroomsTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Saltar encabezado
                for (let i = 1; i < aulas.length; i++) {
                    const aula = aulas[i];
                    const autoAsignableText = (aula[5] === true || aula[5] === 'TRUE') ? 'Sí' : 'No';
                    const accesibleText = (aula[6] === true || aula[6] === 'TRUE') ? 'Sí' : 'No';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${aula[1]}</td>
                        <td>${aula[2]}</td>
                        <td>${aula[3]}</td>
                        <td>${aula[4]}</td>
                        <td>${aula[7]}</td>
                        <td>${autoAsignableText}</td>
                        <td>${accesibleText}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar la tabla de cursos
            function actualizarTablaCursos() {
                const tbody = document.querySelector('#coursesTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Saltar encabezado
                for (let i = 1; i < cursos.length; i++) {
                    const curso = cursos[i];
                    const profesor = profesores.find(p => p[0] === curso[3]);
                    const profesorNombre = profesor ? profesor[1] : 'No asignado';
                    
                    const materia = materias.find(m => m[0] === curso[4]);
                    const materiaNombre = materia ? materia[1] : 'No asignada';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${curso[1]}</td>
                        <td>${curso[2]}</td>
                        <td>${profesorNombre}</td>
                        <td>${curso[5]}</td>
                        <td>${curso[6]}</td>
                        <td>${materiaNombre}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar la tabla de profesores
            function actualizarTablaProfesores() {
                const tbody = document.querySelector('#teachersTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Saltar encabezado
                for (let i = 1; i < profesores.length; i++) {
                    const profesor = profesores[i];
                    const discapacidadText = (profesor[3] === true || profesor[3] === 'TRUE') ? 'Sí' : 'No';
                    const pisoPreferido = profesor[4] || 'Ninguno';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${profesor[1]}</td>
                        <td>${profesor[2]}</td>
                        <td>${discapacidadText}</td>
                        <td>${pisoPreferido}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar la tabla de grupos
            function actualizarTablaGrupos() {
                const tbody = document.querySelector('#groupsTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Saltar encabezado
                for (let i = 1; i < grupos.length; i++) {
                    const grupo = grupos[i];
                    const discapacidadText = (grupo[5] === true || grupo[5] === 'TRUE') ? 'Sí' : 'No';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${grupo[1]}</td>
                        <td>${grupo[2]}</td>
                        <td>${grupo[3]}</td>
                        <td>${grupo[4]}</td>
                        <td>${discapacidadText}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar la tabla de materias
            function actualizarTablaMaterias() {
                const tbody = document.querySelector('#subjectsTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Saltar encabezado
                for (let i = 1; i < materias.length; i++) {
                    const materia = materias[i];
                    const obligatoriaText = (materia[3] === true || materia[3] === 'TRUE') ? 'Sí' : 'No';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${materia[1]}</td>
                        <td>${materia[2]}</td>
                        <td>${materia[4]}</td>
                        <td>${obligatoriaText}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar la tabla de asignaciones
            function actualizarTablaAsignaciones(fechaFiltro = null) {
                const tbody = document.querySelector('#assignmentsTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Filtrar asignaciones por fecha si se proporciona
                let asignacionesFiltradas = asignaciones;
                if (fechaFiltro) {
                    asignacionesFiltradas = asignaciones.filter(a => a[3] === fechaFiltro);
                }
                
                // Saltar encabezado
                for (let i = 1; i < asignacionesFiltradas.length; i++) {
                    const asignacion = asignacionesFiltradas[i];
                    const curso = cursos.find(c => c[0] === asignacion[1]);
                    const aula = aulas.find(a => a[0] === asignacion[2]);
                    const profesor = profesores.find(p => p[0] === asignacion[6]);
                    const grupo = grupos.find(g => g[0] === asignacion[7]);
                    
                    const cursoNombre = curso ? curso[1] : 'Curso no encontrado';
                    const aulaNombre = aula ? `${aula[1]}${aula[2]}-${aula[3]}` : 'Aula no encontrada';
                    const profesorNombre = profesor ? profesor[1] : 'Profesor no encontrado';
                    const grupoNombre = grupo ? grupo[1] : 'Sin grupo';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${cursoNombre}</td>
                        <td>${aulaNombre}</td>
                        <td>${asignacion[3]}</td>
                        <td>${asignacion[4]} - ${asignacion[5]}</td>
                        <td>${profesorNombre}</td>
                        <td>${grupoNombre}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="eliminarAsignacion('${asignacion[0]}')">Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar los dropdowns
            function actualizarDropdowns() {
                // Actualizar dropdown de profesores para cursos
                const teacherSelect = document.getElementById('courseTeacher');
                if (teacherSelect) {
                    teacherSelect.innerHTML = '<option value="">Seleccionar Profesor</option>';
                    
                    // Saltar encabezado
                    for (let i = 1; i < profesores.length; i++) {
                        const profesor = profesores[i];
                        teacherSelect.innerHTML += `<option value="${profesor[0]}">${profesor[1]}</option>`;
                    }
                }
                
                // Actualizar dropdown de materias para cursos
                const subjectSelect = document.getElementById('courseSubject');
                if (subjectSelect) {
                    subjectSelect.innerHTML = '<option value="">Seleccionar Materia</option>';
                    
                    // Saltar encabezado
                    for (let i = 1; i < materias.length; i++) {
                        const materia = materias[i];
                        subjectSelect.innerHTML += `<option value="${materia[0]}">${materia[1]}</option>`;
                    }
                }
                
                // Actualizar dropdown de cursos para asignaciones
                const courseSelect = document.getElementById('assignCourse');
                if (courseSelect) {
                    courseSelect.innerHTML = '<option value="">Seleccionar Curso</option>';
                    
                    // Saltar encabezado
                    for (let i = 1; i < cursos.length; i++) {
                        const curso = cursos[i];
                        courseSelect.innerHTML += `<option value="${curso[0]}">${curso[1]} (${curso[2]})</option>`;
                    }
                }
                
                // Actualizar dropdown de cursos para auto-asignación
                const autoAssignCourseSelect = document.getElementById('autoAssignCourse');
                if (autoAssignCourseSelect) {
                    autoAssignCourseSelect.innerHTML = '<option value="">Seleccionar Curso</option>';
                    
                    // Saltar encabezado
                    for (let i = 1; i < cursos.length; i++) {
                        const curso = cursos[i];
                        autoAssignCourseSelect.innerHTML += `<option value="${curso[0]}">${curso[1]} (${curso[2]})</option>`;
                    }
                }
                
                // Actualizar dropdown de grupos para asignaciones
                const groupSelect = document.getElementById('assignGroup');
                if (groupSelect) {
                    groupSelect.innerHTML = '<option value="">Seleccionar Grupo (opcional)</option>';
                    
                    // Saltar encabezado
                    for (let i = 1; i < grupos.length; i++) {
                        const grupo = grupos[i];
                        groupSelect.innerHTML += `<option value="${grupo[0]}">${grupo[1]} - ${grupo[2]}</option>`;
                    }
                }
                
                // Actualizar dropdown de edificios
                const buildingSelect = document.getElementById('assignBuilding');
                if (buildingSelect) {
                    const edificios = [...new Set(aulas.map(a => a[1]))];
                    buildingSelect.innerHTML = '<option value="">Edificio</option>';
                    
                    edificios.forEach(edificio => {
                        buildingSelect.innerHTML += `<option value="${edificio}">${edificio}</option>`;
                    });
                }
            }
            
            // Función para configurar los event listeners
            function configurarEventListeners() {
                // Botón de cerrar sesión - Usar event delegation
                document.addEventListener('click', function(event) {
                    if (event.target && event.target.id === 'logoutBtn') {
                        event.preventDefault();
                        
                        // Mostrar mensaje de confirmación más claro
                        if (confirm('¿Está seguro de que desea cerrar su sesión actual?')) {
                            // Mostrar mensaje informativo
                            mostrarMensaje('Cerrando sesión, espere un momento...', 'info');
                            
                            // Pequeña pausa para que el usuario vea el mensaje
                            setTimeout(() => {
                                google.script.run
                                    .withSuccessHandler(function() {
                                        // Limpiar sessionStorage
                                        sessionStorage.removeItem('sessionId');
                                        
                                        // Mostrar mensaje de despedida
                                        mostrarMensaje('Sesión cerrada correctamente. Redirigiendo...', 'success');
                                        
                                        // Redirigir al login después de un momento
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 1500);
                                    })
                                    .withFailureHandler(function(error) {
                                        console.error('Error al cerrar sesión:', error);
                                        mostrarMensaje('Error al cerrar sesión. Por favor, intente nuevamente.', 'error');
                                    })
                                    .logout(sessionId);
                            }, 1000);
                        }
                    }
                });
                
                // Formulario de agregar aula
                const classroomForm = document.getElementById('classroomForm');
                if (classroomForm) {
                    classroomForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const edificio = document.getElementById('building').value;
                        const piso = document.getElementById('floor').value;
                        const numero = document.getElementById('roomNumber').value;
                        const capacidad = document.getElementById('capacity').value;
                        const tipo = document.getElementById('roomType').value;
                        const autoAsignable = document.getElementById('autoAssignable').checked;
                        const accesible = document.getElementById('accessible').checked;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Aula agregada correctamente', 'success');
                                    classroomForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al agregar aula: ' + error.message, 'error');
                            })
                            .addAula(sessionId, edificio, piso, numero, capacidad, autoAsignable, accesible, tipo);
                    });
                }
                
                // Formulario de agregar curso
                const courseForm = document.getElementById('courseForm');
                if (courseForm) {
                    courseForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const nombre = document.getElementById('courseName').value;
                        const codigo = document.getElementById('courseCode').value;
                        const idProfesor = document.getElementById('courseTeacher').value;
                        const carrera = document.getElementById('courseCareer').value;
                        const semestre = document.getElementById('courseSemester').value;
                        const idMateria = document.getElementById('courseSubject').value;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Curso agregado correctamente', 'success');
                                    courseForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al agregar curso: ' + error.message, 'error');
                            })
                            .addCurso(sessionId, nombre, codigo, idProfesor, idMateria, carrera, semestre);
                    });
                }
                
                // Formulario de agregar profesor
                const teacherForm = document.getElementById('teacherForm');
                if (teacherForm) {
                    teacherForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const nombre = document.getElementById('teacherName').value;
                        const email = document.getElementById('teacherEmail').value;
                        const discapacidad = document.getElementById('teacherDisability').checked;
                        const pisoPreferido = document.getElementById('teacherPreferredFloor').value;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Profesor agregado correctamente', 'success');
                                    teacherForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al agregar profesor: ' + error.message, 'error');
                            })
                            .addProfesor(sessionId, nombre, email, discapacidad, pisoPreferido);
                    });
                }
                
                // Formulario de agregar grupo
                const groupForm = document.getElementById('groupForm');
                if (groupForm) {
                    groupForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const numero = document.getElementById('groupNumber').value;
                        const carrera = document.getElementById('groupCareer').value;
                        const semestre = document.getElementById('groupSemester').value;
                        const tamaño = document.getElementById('groupSize').value;
                        const discapacidad = document.getElementById('groupDisability').checked;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Grupo agregado correctamente', 'success');
                                    groupForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al agregar grupo: ' + error.message, 'error');
                            })
                            .addGrupo(sessionId, numero, carrera, semestre, tamaño, discapacidad);
                    });
                }
                
                // Formulario de agregar materia
                const subjectForm = document.getElementById('subjectForm');
                if (subjectForm) {
                    subjectForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const nombre = document.getElementById('subjectName').value;
                        const codigo = document.getElementById('subjectCode').value;
                        const semestre = document.getElementById('subjectSemester').value;
                        const obligatoria = document.getElementById('subjectRequired').checked;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Materia agregada correctamente', 'success');
                                    subjectForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al agregar materia: ' + error.message, 'error');
                            })
                            .addMateria(sessionId, nombre, codigo, obligatoria, semestre);
                    });
                }
                
                // Cambio en el selector de edificio
                const buildingSelect = document.getElementById('assignBuilding');
                if (buildingSelect) {
                    buildingSelect.addEventListener('change', function() {
                        const edificio = this.value;
                        const floorSelect = document.getElementById('assignFloor');
                        
                        if (!edificio) {
                            floorSelect.innerHTML = '<option value="">Piso</option>';
                            return;
                        }
                        
                        const pisos = [...new Set(aulas.filter(a => a[1] === edificio).map(a => a[2]))];
                        floorSelect.innerHTML = '<option value="">Piso</option>';
                        
                        pisos.forEach(piso => {
                            floorSelect.innerHTML += `<option value="${piso}">${piso}</option>`;
                        });
                    });
                }
                
                // Cambio en el selector de piso
                const floorSelect = document.getElementById('assignFloor');
                if (floorSelect) {
                    floorSelect.addEventListener('change', function() {
                        const edificio = document.getElementById('assignBuilding').value;
                        const piso = this.value;
                        const classroomSelect = document.getElementById('assignClassroom');
                        
                        if (!edificio || !piso) {
                            classroomSelect.innerHTML = '<option value="">Aula</option>';
                            return;
                        }
                        
                        const aulasPiso = aulas.filter(a => a[1] === edificio && a[2] == piso);
                        classroomSelect.innerHTML = '<option value="">Aula</option>';
                        
                        aulasPiso.forEach(aula => {
                            classroomSelect.innerHTML += `<option value="${aula[0]}">${aula[3]}</option>`;
                        });
                    });
                }
                
                // Formulario de crear asignación
                const assignmentForm = document.getElementById('assignmentForm');
                if (assignmentForm) {
                    assignmentForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const idCurso = document.getElementById('assignCourse').value;
                        const idAula = document.getElementById('assignClassroom').value;
                        const fecha = document.getElementById('assignDate').value;
                        const horaInicio = document.getElementById('assignStart').value;
                        const horaFin = document.getElementById('assignEnd').value;
                        const idGrupo = document.getElementById('assignGroup').value;
                        
                        // Obtener ID del profesor del curso
                        const curso = cursos.find(c => c[0] === idCurso);
                        const idProfesor = curso ? curso[3] : '';
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Asignación creada correctamente', 'success');
                                    assignmentForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                    
                                    // Si hay alternativas, mostrarlas
                                    if (result.alternativas && result.alternativas.length > 0) {
                                        const alternativasText = result.alternativas.map(a => 
                                            `${a.edificio}${a.piso}-${a.numero} (Prioridad: ${a.prioridad})`
                                        ).join(', ');
                                        mostrarMensaje(`Alternativas disponibles: ${alternativasText}`, 'info');
                                    }
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al crear asignación: ' + error.message, 'error');
                            })
                            .createAssignment(sessionId, idCurso, idAula, fecha, horaInicio, horaFin, idProfesor, idGrupo);
                    });
                }
                
                // Formulario de auto-asignar aula
                const autoAssignForm = document.getElementById('autoAssignForm');
                if (autoAssignForm) {
                    autoAssignForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const idCurso = document.getElementById('autoAssignCourse').value;
                        const fecha = document.getElementById('autoAssignDate').value;
                        const horaInicio = document.getElementById('autoAssignStart').value;
                        const horaFin = document.getElementById('autoAssignEnd').value;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Aula auto-asignada correctamente', 'success');
                                    autoAssignForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al auto-asignar aula: ' + error.message, 'error');
                            })
                            .autoAssignClassroom(sessionId, idCurso, fecha, horaInicio, horaFin);
                    });
                }
                
                // Botón de filtrar asignaciones por fecha
                const filterBtn = document.getElementById('filterBtn');
                if (filterBtn) {
                    filterBtn.addEventListener('click', function() {
                        const fecha = document.getElementById('filterDate').value;
                        actualizarTablaAsignaciones(fecha);
                    });
                }
            }
            
            // Función para mostrar mensajes
            function mostrarMensaje(mensaje, tipo) {
                // Crear elemento de mensaje
                const messageElement = document.createElement('div');
                messageElement.className = `alert alert-${tipo === 'error' ? 'danger' : tipo === 'info' ? 'info' : 'success'} alert-dismissible fade show`;
                messageElement.setAttribute('role', 'alert');
                messageElement.innerHTML = `
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Insertar al principio del contenedor principal
                const container = document.querySelector('.container');
                if (container) {
                    container.insertBefore(messageElement, container.firstChild);
                }
                
                // Auto-eliminar después de 5 segundos
                setTimeout(() => {
                    if (messageElement && messageElement.parentNode) {
                        messageElement.remove();
                    }
                }, 5000);
            }
            
            // Función para eliminar una asignación
            function eliminarAsignacion(id) {
                if (confirm('¿Está seguro de eliminar esta asignación?')) {
                    google.script.run
                        .withSuccessHandler(function() {
                            mostrarMensaje('Asignación eliminada correctamente', 'success');
                            cargarDatos();
                        })
                        .withFailureHandler(function(error) {
                            mostrarMensaje('Error al eliminar asignación: ' + error.message, 'error');
                        })
                        .deleteAssignment(sessionId, id);
                }
            }
        });
=======
        // Configuración global
        const AppConfig = {
            baseUrl: '<?!= getBaseUrl() ?>',
            debug: true,
            version: '2.0'
        };
        
        // Variables globales
        let currentUser = null;
        let sessionToken = localStorage.getItem('sessionToken');
        let currentPage = null;
        
        // Función para cargar una página
        function loadPage(pageName) {
            const appContent = document.getElementById('app-content');
            const appLoader = document.getElementById('app-loader');

            appContent.style.display = 'none';
            appLoader.style.display = 'flex';
            document.querySelector('.loading-text').textContent = `Cargando ${pageName}...`;

            const startTime = Date.now();

            if (pageName === 'login') {
                loadLoginPage().then(() => {
                    const loadTime = Date.now() - startTime;
                    console.log(`Página cargada en ${loadTime}ms`);

                    appLoader.style.display = 'none';
                    appContent.style.display = 'block';
                    currentPage = pageName;
                }).catch(error => {
                    console.error('Error loading page:', error);
                    appLoader.style.display = 'none';
                    appContent.style.display = 'block';
                });
            } else if (pageName === 'principal') {
                loadPrincipalPage().then(() => {
                    const loadTime = Date.now() - startTime;
                    console.log(`Página cargada en ${loadTime}ms`);

                    appLoader.style.display = 'none';
                    appContent.style.display = 'block';
                    currentPage = pageName;
                }).catch(error => {
                    console.error('Error loading page:', error);
                    appLoader.style.display = 'none';
                    appContent.style.display = 'block';
                });
            }
        }
        
        // Función para cargar la página de login
        function loadLoginPage() {
            return new Promise((resolve, reject) => {
                const appContent = document.getElementById('app-content');

                // Timeout para evitar que se quede cargando
                const timeout = setTimeout(() => {
                    appContent.innerHTML = `
                        <div class="error-container">
                            <h2>Error de tiempo de espera</h2>
                            <p>La carga de la página tomó demasiado tiempo.</p>
                            <button onclick="loadLoginPage()">Reintentar</button>
                        </div>
                    `;
                    reject(new Error('Timeout'));
                }, 10000); // 10 segundos

                // Verificar si estamos en entorno local
                if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                    // Cargar contenido localmente
                    fetch('Login.html')
                        .then(response => response.text())
                        .then(htmlContent => {
                            clearTimeout(timeout);
                            appContent.innerHTML = htmlContent;

                            // Configurar eventos del login
                            setTimeout(() => {
                                setupLoginEvents();
                                resolve();
                            }, 100);
                        })
                        .catch(error => {
                            clearTimeout(timeout);
                            appContent.innerHTML = `
                                <div class="error-container">
                                    <h2>Error al cargar la página</h2>
                                    <p>${error.message}</p>
                                    <button onclick="loadLoginPage()">Reintentar</button>
                                </div>
                            `;
                            reject(error);
                        });
                } else {
                    // Obtener contenido del servidor
                    google.script.run
                        .withSuccessHandler(function(htmlContent) {
                            clearTimeout(timeout);
                            appContent.innerHTML = htmlContent;

                            // Configurar eventos del login
                            setTimeout(() => {
                                setupLoginEvents();
                                resolve();
                            }, 100);
                        })
                        .withFailureHandler(function(error) {
                            clearTimeout(timeout);
                            appContent.innerHTML = `
                                <div class="error-container">
                                    <h2>Error al cargar la página</h2>
                                    <p>${error.message}</p>
                                    <button onclick="loadLoginPage()">Reintentar</button>
                                </div>
                            `;
                            reject(error);
                        })
                        .include('Login');
                }
            });
        }
        
        // Función para cargar la página principal
        function loadPrincipalPage() {
            return new Promise((resolve, reject) => {
                const appContent = document.getElementById('app-content');

                // Timeout para evitar que se quede cargando
                const timeout = setTimeout(() => {
                    appContent.innerHTML = `
                        <div class="error-container">
                            <h2>Error de tiempo de espera</h2>
                            <p>La carga de la página tomó demasiado tiempo.</p>
                            <button onclick="loadPrincipalPage()">Reintentar</button>
                        </div>
                    `;
                    reject(new Error('Timeout'));
                }, 10000); // 10 segundos

                // Verificar si estamos en entorno local
                if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                    // Cargar contenido localmente
                    fetch('Principal.html')
                        .then(response => response.text())
                        .then(htmlContent => {
                            clearTimeout(timeout);
                            appContent.innerHTML = htmlContent;

                            // Configurar eventos de la página principal con versión mejorada
                            setTimeout(() => {
                                setupPrincipalEventsImproved();
                                resolve();
                            }, 300);
                        })
                        .catch(error => {
                            clearTimeout(timeout);
                            appContent.innerHTML = `
                                <div class="error-container">
                                    <h2>Error al cargar la página</h2>
                                    <p>${error.message}</p>
                                    <button onclick="loadPrincipalPage()">Reintentar</button>
                                </div>
                            `;
                            reject(error);
                        });
                } else {
                    // Obtener contenido del servidor
                    google.script.run
                        .withSuccessHandler(function(htmlContent) {
                            clearTimeout(timeout);
                            appContent.innerHTML = htmlContent;

                            // Configurar eventos de la página principal con versión mejorada
                            setTimeout(() => {
                                setupPrincipalEventsImproved();
                                resolve();
                            }, 300);
                        })
                        .withFailureHandler(function(error) {
                            clearTimeout(timeout);
                            appContent.innerHTML = `
                                <div class="error-container">
                                    <h2>Error al cargar la página</h2>
                                    <p>${error.message}</p>
                                    <button onclick="loadPrincipalPage()">Reintentar</button>
                                </div>
                            `;
                            reject(error);
                        })
                        .include('Principal');
                }
            });
        }
        
        // Configurar eventos del login
        function setupLoginEvents() {
            const loginForm = document.getElementById('loginForm');
            
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const userId = document.getElementById('userId').value.trim();
                    const password = document.getElementById('password').value.trim();
                    
                    if (!userId || !password) {
                        showNotification('Por favor completa todos los campos', 'warning');
                        return;
                    }
                    
                    const submitBtn = loginForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Autenticando...';
                    submitBtn.disabled = true;
                    
                    // Verificar si estamos en entorno local
                    if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                        // Simular autenticación local
                        setTimeout(() => {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;

                            // Simular login exitoso con datos de prueba
                            if (userId && password) {
                                sessionToken = 'local-token-' + Date.now();
                                currentUser = {
                                    nombre: 'Usuario Local',
                                    rol: 'admin',
                                    esAdmin: true
                                };

                                localStorage.setItem('sessionToken', sessionToken);
                                localStorage.setItem('userName', currentUser.nombre);
                                localStorage.setItem('userRole', currentUser.rol);
                                localStorage.setItem('userIsAdmin', currentUser.esAdmin);

                                showNotification(`¡Bienvenido, ${currentUser.nombre}!`, 'success');

                            // Redirigir a la página principal
                            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                                window.location.href = 'Principal.html';
                            } else {
                                loadPage('principal');
                            }
                            } else {
                                showNotification('Credenciales inválidas', 'error');
                            }
                        }, 1000); // Simular delay de red
                    } else {
                        google.script.run
                            .withSuccessHandler(function(result) {
                                submitBtn.textContent = originalText;
                                submitBtn.disabled = false;

                                if (result.success) {
                                    // Guardar token y usuario
                                    sessionToken = result.token;
                                    currentUser = result.user;

                                    localStorage.setItem('sessionToken', sessionToken);
                                    localStorage.setItem('userName', result.user.nombre);
                                    localStorage.setItem('userRole', result.user.rol);
                                    localStorage.setItem('userIsAdmin', result.user.esAdmin);

                                    showNotification(`¡Bienvenido, ${result.user.nombre}!`, 'success');

                                    // Redirigir a la página principal
                                    loadPage('principal');
                                } else {
                                    showNotification(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                submitBtn.textContent = originalText;
                                submitBtn.disabled = false;
                                showNotification('Error de conexión: ' + error.message, 'error');
                            })
                            .autenticarUsuario(userId, password);
                    }
                });
            }
        }
        
        // Configurar eventos de la página principal
        function setupPrincipalEvents() {
            // Configurar logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    Swal.fire({
                        title: '¿Cerrar sesión?',
                        text: '¿Estás seguro de que quieres salir del sistema?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#4CAF50',
                        cancelButtonColor: '#f44336',
                        confirmButtonText: 'Sí, cerrar sesión',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            if (sessionToken) {
                                google.script.run
                                    .withSuccessHandler(function(result) {
                                        // Limpiar datos
                                        localStorage.removeItem('sessionToken');
                                        localStorage.removeItem('userName');
                                        localStorage.removeItem('userRole');
                                        localStorage.removeItem('userIsAdmin');
                                        sessionToken = null;
                                        currentUser = null;
                                        
                                        // Volver al login
                                        loadPage('login');
                                        showNotification('Sesión cerrada exitosamente', 'info');
                                    })
                                    .withFailureHandler(function(error) {
                                        console.error('Error cerrando sesión:', error);
                                        // Limpiar datos de todos modos
                                        localStorage.removeItem('sessionToken');
                                        localStorage.removeItem('userName');
                                        localStorage.removeItem('userRole');
                                        localStorage.removeItem('userIsAdmin');
                                        sessionToken = null;
                                        currentUser = null;
                                        loadPage('login');
                                    })
                                    .cerrarSesion(sessionToken);
                            } else {
                                localStorage.removeItem('sessionToken');
                                localStorage.removeItem('userName');
                                localStorage.removeItem('userRole');
                                localStorage.removeItem('userIsAdmin');
                                sessionToken = null;
                                currentUser = null;
                                loadPage('login');
                            }
                        }
                    });
                });
            }
            
            // Configurar menú sidebar
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (menuToggle && sidebar && sidebarOverlay) {
                menuToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                    
                    // Cambiar ícono
                    const icon = menuToggle.querySelector('i');
                    if (sidebar.classList.contains('active')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });
                
                // Cerrar sidebar al hacer clic en overlay
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    
                    const icon = menuToggle.querySelector('i');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                });
            }
            
            // Configurar navegación del sidebar
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Quitar clase active de todos los enlaces
                    sidebarLinks.forEach(l => l.classList.remove('active'));
                    
                    // Agregar clase active al enlace actual
                    this.classList.add('active');
                    
                    // Obtener la página
                    const page = this.getAttribute('data-page');
                    
                    // Cargar contenido según la página
                    if (page === 'inicio') {
                        loadHomeContent();
                    } else if (page === 'edificios') {
                        loadBuildingsContent();
                    } else if (page === 'usuarios') {
                        loadUsersContent();
                    } else if (page === 'configuracion') {
                        loadSettingsContent();
                    }
                    
                    // Cerrar sidebar en móviles
                    if (window.innerWidth <= 768) {
                        if (sidebar && sidebarOverlay && menuToggle) {
                            sidebar.classList.remove('active');
                            sidebarOverlay.classList.remove('active');
                            
                            const icon = menuToggle.querySelector('i');
                            icon.classList.remove('fa-times');
                            icon.classList.add('fa-bars');
                        }
                    }
                });
            });
            
            // Cargar contenido inicial
            loadHomeContent();
            
            // Actualizar información del usuario
            const userName = localStorage.getItem('userName');
            const userAvatar = document.getElementById('userAvatar');
            const userNameElement = document.getElementById('userName');
            
            if (userName && userAvatar) {
                userAvatar.textContent = userName.charAt(0).toUpperCase();
            }
            
            if (userName && userNameElement) {
                userNameElement.textContent = userName;
            }
            
            // Aplicar permisos de usuario (ocultar Users section para no-admins)
            applyUserPermissions();
        }
        
        // Función para aplicar permisos de usuario
        function applyUserPermissions() {
            const userIsAdmin = localStorage.getItem('userIsAdmin') === 'true';
            const userRole = localStorage.getItem('userRole');
            
            if (!userIsAdmin && userRole !== 'admin') {
                // Ocultar la sección de usuarios para usuarios regulares
                const usersLink = document.querySelector('.sidebar-link[data-page="usuarios"]');
                if (usersLink) {
                    usersLink.style.display = 'none';
                    console.log('Sección Usuarios oculta para usuario regular');
                }
                
                // También ocultar botón de gestionar usuarios en dashboard
                const manageUsersBtn = document.querySelector('.action-btn[onclick="loadUsersContent()"]');
                if (manageUsersBtn) {
                    manageUsersBtn.style.display = 'none';
                    console.log('Botón Gestionar Usuarios oculto para usuario regular');
                }
            } else {
                console.log('Usuario administrador - todas las opciones visibles');
            }
        }
        
        // Función para cargar contenido de inicio
        function loadHomeContent() {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;
            
            contentSection.innerHTML = `
                <div class="welcome-section">
                    <h1 class="welcome-title">Bienvenido al Sistema de Gestión</h1>
                    <p class="welcome-subtitle">Universidad Autónoma de Baja California</p>
                </div>
                
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <div class="card-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="card-content">
                            <h3>3 Edificios</h3>
                            <p>Disponibles para gestión</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-icon">
                            <i class="fas fa-door-open"></i>
                        </div>
                        <div class="card-content">
                            <h3>63 Salones</h3>
                            <p>Total en el sistema</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="card-content">
                            <h3 id="totalUsers">Cargando...</h3>
                            <p>Usuarios registrados</p>
                        </div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <h2>Acciones Rápidas</h2>
                    <div class="actions-grid">
                        <button class="action-btn" onclick="loadBuildingsContent()">
                            <i class="fas fa-search"></i>
                            <span>Buscar Salón</span>
                        </button>
                        <button class="action-btn" onclick="loadUsersContent()" id="manageUsersBtn">
                            <i class="fas fa-user-plus"></i>
                            <span>Gestionar Usuarios</span>
                        </button>
                        <button class="action-btn" onclick="showReports()">
                            <i class="fas fa-chart-bar"></i>
                            <span>Ver Reportes</span>
                        </button>
                    </div>
                </div>
            `;

            // Aplicar permisos de usuario después de cargar el contenido
            setTimeout(() => {
                applyUserPermissions();
            }, 100);

            // Cargar estadísticas
            loadStatistics();
        }
        
        // Función para cargar contenido de edificios
        function loadBuildingsContent() {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;
            
            contentSection.innerHTML = `
                <div class="welcome-section">
                    <h1 class="welcome-title">Gestión de Edificios Escolares</h1>
                    <p class="welcome-subtitle">Haz clic en cada piso para ver los salones disponibles</p>
                </div>
                
                <div class="controls">
                    <div class="search-bar">
                        <input type="text" id="searchInput" placeholder="Buscar salón o grupo...">
                        <button onclick="searchSalons()">Buscar</button>
                    </div>
                    <div class="filters">
                        <button class="filter-btn active" onclick="showAllSalons()">Ver todos</button>
                    </div>
                </div>
                
                <div class="buildings-container" id="buildingsContainer">
                    <div class="loading-buildings">
                        <div class="loader"></div>
                        <p>Cargando edificios...</p>
                    </div>
                </div>
            `;
            
            // Cargar edificios
            loadBuildings();
        }
        
        // Función para cargar edificios desde el servidor
        function loadBuildings() {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                // Datos mock para entorno local
                setTimeout(() => {
                    const mockEdificios = {
                        'D': {
                            nombre: 'Edificio D',
                            totalSalones: 24,
                            pisos: 4,
                            salones: {
                                '1': ['D101', 'D102', 'D103', 'D104', 'D105', 'D106'],
                                '2': ['D201', 'D202', 'D203', 'D204', 'D205', 'D206'],
                                '3': ['D301', 'D302', 'D303', 'D304', 'D305', 'D306'],
                                '4': ['D401', 'D402', 'D403', 'D404', 'D405', 'D406']
                            }
                        },
                        'E': {
                            nombre: 'Edificio E',
                            totalSalones: 23,
                            pisos: 4,
                            salones: {
                                '1': ['E101', 'E102', 'E103', 'E104', 'E105', 'E106'],
                                '2': ['E201', 'E202', 'E203', 'E204', 'E205', 'E206'],
                                '3': ['E301', 'E302', 'E303', 'E304', 'E305', 'E306'],
                                '4': ['E401', 'E402', 'E403', 'E404', 'E405']
                            }
                        },
                        'F': {
                            nombre: 'Edificio F',
                            totalSalones: 16,
                            pisos: 4,
                            salones: {
                                '1': ['F101', 'F102', 'F103', 'F104'],
                                '2': ['F201', 'F202', 'F203', 'F204'],
                                '3': ['F301', 'F302', 'F303', 'F304'],
                                '4': ['F401', 'F402', 'F403', 'F404']
                            }
                        }
                    };
                    renderBuildings(mockEdificios);
                }, 500);
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            renderBuildings(result.edificios);
                        } else {
                            document.getElementById('buildingsContainer').innerHTML = `
                                <div class="error-message">
                                    <p>Error: ${result.message}</p>
                                    <button onclick="loadBuildings()">Reintentar</button>
                                </div>
                            `;
                        }
                    })
                    .withFailureHandler(function(error) {
                        document.getElementById('buildingsContainer').innerHTML = `
                            <div class="error-message">
                                <p>Error de conexión</p>
                                <button onclick="loadBuildings()">Reintentar</button>
                            </div>
                        `;
                    })
                    .obtenerEdificios();
            }
        }
        
        // Función para renderizar edificios
        function renderBuildings(edificios) {
            const container = document.getElementById('buildingsContainer');
            if (!container) return;
            
            let html = '';
            
            for (const [key, edificio] of Object.entries(edificios)) {
                html += `
                    <div class="building-card">
                        <div class="building-header">
                            <div class="building-icon">${key}</div>
                            <div class="building-info">
                                <h3>${edificio.nombre}</h3>
                                <p>Total: ${edificio.totalSalones} salones | ${edificio.pisos} pisos</p>
                            </div>
                        </div>
                `;
                
                // Agregar pisos
                for (const [piso, salones] of Object.entries(edificio.salones)) {
                    const floorId = `floor-${key.toLowerCase()}-${piso}`;
                    html += `
                        <button class="floor-toggle" onclick="showFloorModal('${key}', ${piso})">
                            <span>Piso ${piso}</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    `;
                }
                
                html += `</div>`;
            }
            
            container.innerHTML = html;
        }
        
        // Función para cargar contenido de usuarios
        function loadUsersContent() {
            // Verificar permisos de administrador
            const userIsAdmin = localStorage.getItem('userIsAdmin') === 'true';
            const userRole = localStorage.getItem('userRole');
            
            if (!userIsAdmin && userRole !== 'admin') {
                if (typeof showNotification === 'function') {
                    showNotification('No tienes permisos para acceder a la gestión de usuarios', 'error');
                }
                return;
            }
            
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;
            
            contentSection.innerHTML = `
                <div class="section-header">
                    <h1>Gestión de Usuarios</h1>
                    <p>Administra los usuarios del sistema</p>
                </div>
                
                <div class="users-controls">
                    <button class="btn-primary" onclick="showAddUserForm()">
                        <i class="fas fa-user-plus"></i> Nuevo Usuario
                    </button>
                </div>
                
                <div class="users-list-container" id="usersListContainer">
                    <div class="loading">
                        <div class="loader"></div>
                        <p>Cargando usuarios...</p>
                    </div>
                </div>
            `;
            
            // Cargar lista de usuarios
            loadUsersList();
        }
        
        // Función para cargar lista de usuarios
        function loadUsersList() {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                // Datos mock para entorno local
                setTimeout(() => {
                    const mockUsers = [
                        { id: '1', nombre: 'Admin Local', email: 'admin@local.com', rol: 'admin', activo: true },
                        { id: '2', nombre: 'Usuario 1', email: 'user1@local.com', rol: 'user', activo: true },
                        { id: '3', nombre: 'Usuario 2', email: 'user2@local.com', rol: 'user', activo: false }
                    ];
                    renderUsersList(mockUsers);
                }, 500);
            } else {
                google.script.run
                    .withSuccessHandler(function(users) {
                        renderUsersList(users);
                    })
                    .withFailureHandler(function(error) {
                        document.getElementById('usersListContainer').innerHTML = `
                            <div class="error-message">
                                <p>Error al cargar usuarios</p>
                                <button onclick="loadUsersList()">Reintentar</button>
                            </div>
                        `;
                    })
                    .obtenerUsuarios();
            }
        }
        
        // Función para renderizar lista de usuarios
        function renderUsersList(users) {
            const container = document.getElementById('usersListContainer');
            if (!container) return;
            
            if (users.length === 0) {
                container.innerHTML = '<p>No hay usuarios registrados.</p>';
                return;
            }
            
            let html = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.nombre}</td>
                        <td>${user.email}</td>
                        <td>${user.rol}</td>
                        <td>${user.activo ? '<span class="status-active">Activo</span>' : '<span class="status-inactive">Inactivo</span>'}</td>
                        <td>
                            <div class="user-actions">
                                <button class="btn-small btn-edit" onclick="editUser('${user.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-small btn-reset" onclick="resetUserPassword('${user.id}', '${user.nombre}')">
                                    <i class="fas fa-key"></i>
                                </button>
                                ${user.activo ? 
                                    `<button class="btn-small btn-deactivate" onclick="deactivateUser('${user.id}', '${user.nombre}')">
                                        <i class="fas fa-user-times"></i>
                                    </button>` :
                                    `<button class="btn-small btn-activate" onclick="activateUser('${user.id}', '${user.nombre}')">
                                        <i class="fas fa-user-check"></i>
                                    </button>`
                                }
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        // Función para cargar estadísticas
        function loadStatistics() {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                // Datos mock para entorno local
                setTimeout(() => {
                    const totalUsersElement = document.getElementById('totalUsers');
                    if (totalUsersElement) {
                        totalUsersElement.textContent = '5'; // Mock data
                    }
                }, 300);
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            const totalUsersElement = document.getElementById('totalUsers');
                            if (totalUsersElement) {
                                totalUsersElement.textContent = result.estadisticas.usuariosActivos;
                            }
                        }
                    })
                    .obtenerEstadisticas();
            }
        }
        
        // Función para mostrar notificaciones
        function showNotification(message, type = 'info') {
            // Eliminar notificaciones existentes
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Funciones públicas para uso en HTML
        window.toggleFloor = function(floorId) {
            const floorGrid = document.getElementById(floorId);
            if (floorGrid) {
                floorGrid.classList.toggle('active');
                const toggleButton = floorGrid.previousElementSibling;
                if (toggleButton) toggleButton.classList.toggle('active');
            }
        };
        
        window.showSalonDetails = function(salonId) {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                // Datos mock para entorno local
                const mockData = {
                    success: true,
                    salon: salonId,
                    estado: {
                        estado: salonId.includes('101') || salonId.includes('102') ? 'Ocupado' : 'Disponible',
                        grupos: salonId.includes('101') || salonId.includes('102') ? [
                            { nombre: 'Grupo A', horario: '8:00 - 10:00' },
                            { nombre: 'Grupo B', horario: '10:00 - 12:00' }
                        ] : []
                    }
                };

                Swal.fire({
                    title: `Salón ${mockData.salon}`,
                    html: `
                        <div class="salon-details">
                            <p><strong>Estado:</strong> ${mockData.estado.estado}</p>
                            ${mockData.estado.grupos.length > 0 ?
                                `<p><strong>Grupos:</strong></p>
                                  <ul>${mockData.estado.grupos.map(g => `<li>${g.nombre} - ${g.horario}</li>`).join('')}</ul>` :
                                '<p>No hay grupos asignados</p>'
                            }
                        </div>
                    `,
                    icon: 'info'
                });
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            Swal.fire({
                                title: `Salón ${result.salon}`,
                                html: `
                                    <div class="salon-details">
                                        <p><strong>Estado:</strong> ${result.estado.estado}</p>
                                        ${result.estado.grupos.length > 0 ?
                                            `<p><strong>Grupos:</strong></p>
                                              <ul>${result.estado.grupos.map(g => `<li>${g.nombre} - ${g.horario}</li>`).join('')}</ul>` :
                                            '<p>No hay grupos asignados</p>'
                                        }
                                    </div>
                                `,
                                icon: 'info'
                            });
                        }
                    })
                    .obtenerEstadoSalon(salonId);
            }
        };
        
        window.searchSalons = function() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            const term = searchInput.value.trim();
            if (!term) {
                showNotification('Ingresa un término de búsqueda', 'warning');
                return;
            }
            
            showNotification(`Buscando salones con: "${term}"`, 'info');
        };
        
        window.filterByStatus = function(status, button) {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');

            showNotification(`Filtrado por: ${status}`, 'info');
        };
        
        window.showAddUserForm = function() {
            Swal.fire({
                title: 'Nuevo Usuario',
                html: `
                    <form id="addUserForm">
                        <div class="form-group">
                            <label>ID Personalizado (Opcional)</label>
                            <input type="text" id="newUserId" class="swal2-input" placeholder="Dejar vacío para auto-generar">
                        </div>
                        <div class="form-group">
                            <label>Nombre Completo *</label>
                            <input type="text" id="newUserName" class="swal2-input" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="newUserEmail" class="swal2-input" required>
                        </div>
                        <div class="form-group">
                            <label>Rol *</label>
                            <select id="newUserRole" class="swal2-input" required>
                                <option value="admin">Administrador</option>
                                <option value="user">Usuario</option>
                            </select>
                        </div>
                        <small style="color: #666;">* Si no proporcionas un ID, se generará automáticamente</small>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const id = document.getElementById('newUserId').value.trim();
                    const nombre = document.getElementById('newUserName').value.trim();
                    const email = document.getElementById('newUserEmail').value.trim();
                    const rol = document.getElementById('newUserRole').value;
                    
                    if (!nombre || !email || !rol) {
                        Swal.showValidationMessage('Nombre, email y rol son obligatorios');
                        return false;
                    }
                    
                    // Si se proporciona ID, validarlo
                    if (id) {
                        if (id.trim().length < 1) {
                            Swal.showValidationMessage('El ID no puede estar vacío');
                            return false;
                        }
                        if (id.trim().length > 50) {
                            Swal.showValidationMessage('El ID no puede tener más de 50 caracteres');
                            return false;
                        }
                        // Permitir letras, números, guiones, guiones bajos y espacios
                        if (!/^[a-zA-Z0-9_\-\s]+$/.test(id.trim())) {
                            Swal.showValidationMessage('El ID solo puede contener letras, números, guiones, guiones bajos y espacios');
                            return false;
                        }
                    }
                    
                    const userData = { nombre, email, rol };
                    if (id) {
                        userData.id = id;
                    }
                    
                    return userData;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    agregarUsuario(result.value);
                }
            });
        };
        
        window.agregarUsuario = function(userData) {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                // Simular agregar usuario localmente
                setTimeout(() => {
                    const isCustomId = userData.id && userData.id.length > 0;
                    const mockResult = {
                        success: true,
                        id: userData.id || ('user_' + Date.now()),
                        contrasenaTemporal: 'TempPass123'
                    };

                    Swal.fire({
                        title: '¡Usuario agregado!',
                        html: `
                            <p>Usuario creado exitosamente.</p>
                            <p><strong>ID:</strong> ${mockResult.id} ${isCustomId ? '(Personalizado)' : '(Auto-generado)'}</p>
                            <p><strong>Contraseña temporal:</strong> ${mockResult.contrasenaTemporal}</p>
                            <small>Esta contraseña ha sido enviada al email del usuario.</small>
                        `,
                        icon: 'success'
                    });
                    loadUsersList();
                }, 1000);
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            const isCustomId = userData.id && userData.id.length > 0;
                            Swal.fire({
                                title: '¡Usuario agregado!',
                                html: `
                                    <p>Usuario creado exitosamente.</p>
                                    <p><strong>ID:</strong> ${result.id} ${isCustomId ? '(Personalizado)' : '(Auto-generado)'}</p>
                                    <p><strong>Contraseña temporal:</strong> ${result.contrasenaTemporal}</p>
                                    <small>Esta contraseña ha sido enviada al email del usuario.</small>
                                `,
                                icon: 'success'
                            });
                            loadUsersList();
                        } else {
                            Swal.fire('Error', result.message, 'error');
                        }
                    })
                    .agregarUsuario(userData);
            }
        };
        
        window.resetUserPassword = function(id, nombre) {
            Swal.fire({
                title: '¿Restablecer contraseña?',
                html: `¿Restablecer contraseña de <strong>${nombre}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, restablecer',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                        // Simular reset local
                        setTimeout(() => {
                            Swal.fire({
                                title: 'Contraseña restablecida',
                                html: `Nueva contraseña: <strong>TempPass${Date.now()}</strong>`,
                                icon: 'success'
                            });
                        }, 500);
                    } else {
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    Swal.fire({
                                        title: 'Contraseña restablecida',
                                        html: `Nueva contraseña: <strong>${result.contrasenaTemporal}</strong>`,
                                        icon: 'success'
                                    });
                                } else {
                                    Swal.fire('Error', result.message, 'error');
                                }
                            })
                            .restablecerContrasena(id);
                    }
                }
            });
        };
        
        window.deactivateUser = function(id, nombre) {
            Swal.fire({
                title: '¿Desactivar usuario?',
                html: `¿Desactivar a <strong>${nombre}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, desactivar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                        // Simular desactivación local
                        setTimeout(() => {
                            showNotification('Usuario desactivado', 'success');
                            loadUsersList();
                        }, 500);
                    } else {
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    showNotification('Usuario desactivado', 'success');
                                    loadUsersList();
                                } else {
                                    showNotification(result.message, 'error');
                                }
                            })
                            .eliminarUsuario(id);
                    }
                }
            });
        };

        window.activateUser = function(id, nombre) {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                // Simular activación local
                setTimeout(() => {
                    showNotification('Usuario activado', 'success');
                    loadUsersList();
                }, 500);
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            showNotification('Usuario activado', 'success');
                            loadUsersList();
                        } else {
                            showNotification(result.message, 'error');
                        }
                    })
                    .actualizarUsuario(id, { activo: true });
            }
        };

        window.editUser = function(id) {
            showNotification('Función de editar usuario en desarrollo', 'info');
        };
        
        // Función para mostrar configuración
        function loadSettingsContent() {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;
            
            contentSection.innerHTML = `
                <div class="section-header">
                    <h1>Configuración del Sistema</h1>
                    <p>Configura las opciones del sistema</p>
                </div>
                
                <div class="settings-container">
                    <div class="settings-card">
                        <h3><i class="fas fa-info-circle"></i> Información del Sistema</h3>
                        <div class="settings-info">
                            <p><strong>Versión:</strong> 2.0</p>
                            <p><strong>Desarrollado por:</strong> LIDE - UABC</p>
                            <p><strong>Última actualización:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                    
                    <div class="settings-card">
                        <h3><i class="fas fa-database"></i> Base de Datos</h3>
                        <div class="settings-info">
                            <p id="dbStatus">Verificando conexión...</p>
                            <button class="btn-secondary" onclick="testDatabase()">Probar Conexión</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Probar conexión a la base de datos
            testDatabase();
        }
        
        window.testDatabase = function() {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                // Simular test de conexión local
                setTimeout(() => {
                    document.getElementById('dbStatus').innerHTML = `
                        <span style="color: #4CAF50;">✓ Conexión local - OK</span>
                    `;
                }, 500);
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        document.getElementById('dbStatus').innerHTML = `
                            <span style="color: #4CAF50;">✓ ${result}</span>
                        `;
                    })
                    .withFailureHandler(function(error) {
                        document.getElementById('dbStatus').innerHTML = `
                            <span style="color: #f44336;">✗ Error: ${error}</span>
                        `;
                    })
                    .testConexion();
            }
        };
        
        window.showReports = function() {
            showNotification('Módulo de reportes en desarrollo', 'info');
        };
        
        // Mostrar detalles del salón con GRUPOS
        function showSalonDetails(salonId) {
            const modal = document.getElementById("salonModal");
            const salonName = document.getElementById("salonName");
            const salonStatus = document.getElementById("salonStatus");
            const groupsList = document.getElementById("groupsList");
            const scheduleBody = document.getElementById("scheduleBody");
            const currentStatusText = document.getElementById("currentStatusText");

            // Obtener datos del salón
            const data = salonData[salonId];

            if (!data) {
                // Si no hay datos específicos, mostrar información básica
                salonName.textContent = salonId;
                salonStatus.innerHTML = '<div class="status-badge available">Disponible</div>';
                groupsList.innerHTML = '<div class="group-item">No hay grupos asignados actualmente.</div>';
                currentStatusText.textContent = "Este salón está disponible todo el día.";
            } else {
                // Actualizar contenido del modal
                salonName.textContent = salonId;

                // Mostrar estado
                let statusHTML = '';
                let currentStatus = "";
                switch(data.status) {
                    case "disponible":
                        statusHTML = '<div class="status-badge available">Disponible</div>';
                        currentStatus = "Este salón está disponible actualmente.";
                        break;
                    case "ocupado":
                        statusHTML = '<div class="status-badge occupied">Ocupado</div>';
                        currentStatus = "Este salón está ocupado actualmente.";
                        break;
                    case "accesible":
                        statusHTML = '<div class="status-badge accessible">Accesible</div>';
                        currentStatus = "Este salón es accesible para personas con discapacidad.";
                        break;
                    default:
                        statusHTML = '<div class="status-badge available">Disponible</div>';
                        currentStatus = "Este salón está disponible actualmente.";
                }
                salonStatus.innerHTML = statusHTML;
                currentStatusText.textContent = currentStatus;

                // Mostrar lista de GRUPOS
                let groupsHTML = '';
                if (data.groups && data.groups.length > 0) {
                    data.groups.forEach(group => {
                        groupsHTML += `
                            <div class="group-item">
                                <div class="group-name">${group.name} - ${group.code}</div>
                                <div class="group-schedule">${group.schedule} | Profesor: ${group.teacher}</div>
                            </div>
                        `;
                    });
                } else {
                    groupsHTML = '<div class="group-item">No hay grupos asignados actualmente.</div>';
                }
                groupsList.innerHTML = groupsHTML;

                // Mostrar horario
                scheduleBody.innerHTML = '';
                const days = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];

                // Obtener hora actual para resaltar
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                const currentTime = currentHour + ":" + (currentMinute < 10 ? "0" : "") + currentMinute;

                for (const [timeSlot, daySchedule] of Object.entries(data.schedule)) {
                    const [startTime, endTime] = timeSlot.split("-");

                    // Verificar si la hora actual está en este intervalo
                    const isCurrentTimeSlot = isTimeInRange(currentTime, startTime, endTime);

                    const row = document.createElement('tr');
                    if (isCurrentTimeSlot) {
                        row.className = 'current-time';
                    }

                    // Celda de hora
                    const timeCell = document.createElement('td');
                    timeCell.className = 'time-slot';
                    timeCell.textContent = timeSlot;
                    row.appendChild(timeCell);

                    // Celdas para cada día
                    for (let i = 0; i < 5; i++) {
                        const dayCell = document.createElement('td');
                        dayCell.textContent = daySchedule[i] || "";

                        // Resaltar si está ocupado
                        if (daySchedule[i] && daySchedule[i] !== "Libre" && daySchedule[i] !== "") {
                            dayCell.style.color = "var(--ocupado)";
                            dayCell.style.fontWeight = "bold";
                        }

                        row.appendChild(dayCell);
                    }

                    scheduleBody.appendChild(row);
                }
            }

            // Mostrar modal
            modal.style.display = "block";
        }

        function closeModal() {
            const modal = document.getElementById("salonModal");
            if (modal) {
                modal.style.display = "none";
            }
        }

        // Cerrar modal al hacer clic fuera de él
        window.onclick = function(event) {
            const salonModal = document.getElementById("salonModal");
            const floorModal = document.getElementById("floorModal");

            if (event.target == salonModal) {
                closeSalonModal();
            }

            if (event.target == floorModal) {
                closeFloorModal();
            }
        }

        // Mostrar modal del piso con sus salones
        function showFloorModal(building, floor) {
            const floorKey = `${building}${floor}`;
            const salons = floorSalons[floorKey];

            if (!salons) {
                showNotification(`No hay datos para el piso ${floor} del edificio ${building}`, 'warning');
                return;
            }

            // Actualizar título del modal
            document.getElementById('floorModalTitle').textContent = `Edificio ${building} - Piso ${floor}`;

            // Obtener contenedor y limpiarlo
            const container = document.getElementById('floorSalonsContainer');
            container.innerHTML = '';

            // Agregar cada salón al modal
            salons.forEach(salonId => {
                const salonInfo = salonData[salonId] || { status: "disponible" };
                const salonCard = document.createElement('div');
                salonCard.className = `salon-card-modal ${salonInfo.status}`;
                salonCard.textContent = salonId;
                salonCard.onclick = () => {
                    closeFloorModal();
                    setTimeout(() => showSalonDetails(salonId), 300);
                };

                // Agregar indicador de estado
                const statusIndicator = document.createElement('div');
                statusIndicator.className = 'status-badge';
                statusIndicator.textContent = salonInfo.status === 'ocupado' ? 'Ocupado' :
                                            salonInfo.status === 'disponible' ? 'Disponible' : 'Accesible';
                statusIndicator.style.cssText = 'position: absolute; top: 5px; right: 5px; font-size: 10px; padding: 2px 6px;';

                salonCard.appendChild(statusIndicator);
                container.appendChild(salonCard);
            });

            // Mostrar modal
            document.getElementById('floorModal').style.display = 'block';
        }

        // Cerrar modal del piso
        function closeFloorModal() {
            document.getElementById('floorModal').style.display = 'none';
        }

        // Mostrar todos los salones (abrir primer piso del primer edificio)
        function showAllSalons() {
            showFloorModal('D', 1);
            showNotification('Mostrando todos los salones. Selecciona un piso para ver los salones.', 'info');
        }

        // Función auxiliar para verificar si una hora está en un rango
        function isTimeInRange(time, start, end) {
            const timeToMinutes = t => {
                const [h, m] = t.split(":").map(Number);
                return h * 60 + m;
            };

            const t = timeToMinutes(time);
            const s = timeToMinutes(start);
            const e = timeToMinutes(end);

            return t >= s && t <= e;
        }

        // Cerrar modal del salón
        function closeSalonModal() {
            document.getElementById("salonModal").style.display = "none";
        }

        // Funciones para edificios y salones (versión simplificada)
        function toggleFloor(floorId) {
            const floorGrid = document.getElementById(floorId);
            if (floorGrid) {
                floorGrid.classList.toggle('active');
                const toggleButton = floorGrid.previousElementSibling;
                if (toggleButton) toggleButton.classList.toggle('active');
            }
        }

        function searchSalons() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();

            if (searchTerm === '') {
                showNotification('Ingresa un término de búsqueda', 'warning');
                return;
            }

            // Buscar salón por nombre
            let foundSalon = null;
            for (const floorKey in floorSalons) {
                const salons = floorSalons[floorKey];
                foundSalon = salons.find(salon => salon.toLowerCase().includes(searchTerm));
                if (foundSalon) break;
            }

            // Si no encontró por nombre de salón, buscar por grupo
            if (!foundSalon) {
                for (const salonId in salonData) {
                    const salon = salonData[salonId];
                    if (salon.groups && salon.groups.length > 0) {
                        const foundGroup = salon.groups.find(group =>
                            group.name.toLowerCase().includes(searchTerm) ||
                            group.code.toLowerCase().includes(searchTerm)
                        );
                        if (foundGroup) {
                            foundSalon = salonId;
                            break;
                        }
                    }
                }
            }

            if (foundSalon) {
                // Extraer edificio y piso del salón encontrado
                const building = foundSalon.charAt(0);
                const floor = parseInt(foundSalon.charAt(1));

                // Mostrar modal del piso
                showFloorModal(building, floor);

                setTimeout(() => {
                    // Resaltar el salón encontrado en el modal
                    const salonCards = document.querySelectorAll('.salon-card-modal');
                    salonCards.forEach(card => {
                        if (card.textContent.includes(foundSalon)) {
                            card.style.animation = 'pulse 1s infinite';
                            card.style.boxShadow = '0 0 10px var(--amarillo-medio)';
                            card.style.transform = 'scale(1.1)';
                            setTimeout(() => {
                                card.style.animation = '';
                                card.style.boxShadow = '';
                                card.style.transform = '';
                            }, 3000);

                            // Mostrar detalles después de un breve retraso
                            setTimeout(() => {
                                card.click();
                            }, 1000);
                        }
                    });

                    showNotification(`Resultado encontrado: ${foundSalon}`, 'success');
                }, 500);
            } else {
                showNotification(`No se encontraron resultados para: "${searchTerm}"`, 'warning');
            }
        }

        // Notificaciones push
        function showNotification(message, type = 'info') {
            // Eliminar notificaciones existentes
            document.querySelectorAll('.notification').forEach(notification => {
                notification.remove();
            });

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        function filterByStatus(status) {
            const filterButtons = document.querySelectorAll('.filter-btn');
            filterButtons.forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }

            if (typeof showNotification === 'function') {
                showNotification(`Filtrado por: ${status}`, 'info');
            }
        }

        function showReports() {
            if (typeof showNotification === 'function') {
                showNotification('Módulo de reportes en desarrollo', 'info');
            }
        }

        function showAddUserForm() {
            Swal.fire({
                title: 'Nuevo Usuario',
                html: `
                    <form id="addUserForm">
                        <div class="form-group">
                            <label>ID Personalizado (Opcional)</label>
                            <input type="text" id="newUserId" class="swal2-input" placeholder="Dejar vacío para auto-generar">
                        </div>
                        <div class="form-group">
                            <label>Nombre Completo *</label>
                            <input type="text" id="newUserName" class="swal2-input" required>
                        </div>
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="newUserEmail" class="swal2-input" required>
                        </div>
                        <div class="form-group">
                            <label>Rol *</label>
                            <select id="newUserRole" class="swal2-input" required>
                                <option value="admin">Administrador</option>
                                <option value="user">Usuario</option>
                            </select>
                        </div>
                        <small style="color: #666;">* Si no proporcionas un ID, se generará automáticamente</small>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Guardar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    const id = document.getElementById('newUserId').value.trim();
                    const nombre = document.getElementById('newUserName').value.trim();
                    const email = document.getElementById('newUserEmail').value.trim();
                    const rol = document.getElementById('newUserRole').value;
                    
                    if (!nombre || !email || !rol) {
                        Swal.showValidationMessage('Nombre, email y rol son obligatorios');
                        return false;
                    }
                    
                    // Si se proporciona ID, validarlo
                    if (id) {
                        if (id.trim().length < 1) {
                            Swal.showValidationMessage('El ID no puede estar vacío');
                            return false;
                        }
                        if (id.trim().length > 50) {
                            Swal.showValidationMessage('El ID no puede tener más de 50 caracteres');
                            return false;
                        }
                        // Permitir letras, números, guiones, guiones bajos y espacios
                        if (!/^[a-zA-Z0-9_\-\s]+$/.test(id.trim())) {
                            Swal.showValidationMessage('El ID solo puede contener letras, números, guiones, guiones bajos y espacios');
                            return false;
                        }
                    }
                    
                    const userData = { nombre, email, rol };
                    if (id) {
                        userData.id = id;
                    }
                    
                    return userData;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    agregarUsuario(result.value);
                }
            });
        }

        window.agregarUsuario = function(userData) {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                // Simular agregar usuario localmente
                setTimeout(() => {
                    const isCustomId = userData.id && userData.id.length > 0;
                    const mockResult = {
                        success: true,
                        id: userData.id || ('user_' + Date.now()),
                        contrasenaTemporal: 'TempPass123'
                    };

                    Swal.fire({
                        title: '¡Usuario agregado!',
                        html: `
                            <p>Usuario creado exitosamente.</p>
                            <p><strong>ID:</strong> ${mockResult.id} ${isCustomId ? '(Personalizado)' : '(Auto-generado)'}</p>
                            <p><strong>Contraseña temporal:</strong> ${mockResult.contrasenaTemporal}</p>
                            <small>Esta contraseña ha sido enviada al email del usuario.</small>
                        `,
                        icon: 'success'
                    });
                    loadUsersList();
                }, 1000);
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            const isCustomId = userData.id && userData.id.length > 0;
                            Swal.fire({
                                title: '¡Usuario agregado!',
                                html: `
                                    <p>Usuario creado exitosamente.</p>
                                    <p><strong>ID:</strong> ${result.id} ${isCustomId ? '(Personalizado)' : '(Auto-generado)'}</p>
                                    <p><strong>Contraseña temporal:</strong> ${result.contrasenaTemporal}</p>
                                    <small>Esta contraseña ha sido enviada al email del usuario.</small>
                                `,
                                icon: 'success'
                            });
                            loadUsersList();
                        } else {
                            Swal.fire('Error', result.message, 'error');
                        }
                    })
                    .agregarUsuario(userData);
            }
        };
        
        window.resetUserPassword = function(id, nombre) {
            Swal.fire({
                title: '¿Restablecer contraseña?',
                html: `¿Restablecer contraseña de <strong>${nombre}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, restablecer',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                        // Simular reset local
                        setTimeout(() => {
                            Swal.fire({
                                title: 'Contraseña restablecida',
                                html: `Nueva contraseña: <strong>TempPass${Date.now()}</strong>`,
                                icon: 'success'
                            });
                        }, 500);
                    } else {
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    Swal.fire({
                                        title: 'Contraseña restablecida',
                                        html: `Nueva contraseña: <strong>${result.contrasenaTemporal}</strong>`,
                                        icon: 'success'
                                    });
                                } else {
                                    Swal.fire('Error', result.message, 'error');
                                }
                            })
                            .restablecerContrasena(id);
                    }
                }
            });
        };
        
        window.deactivateUser = function(id, nombre) {
            Swal.fire({
                title: '¿Desactivar usuario?',
                html: `¿Desactivar a <strong>${nombre}</strong>?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, desactivar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                        // Simular desactivación local
                        setTimeout(() => {
                            showNotification('Usuario desactivado', 'success');
                            loadUsersList();
                        }, 500);
                    } else {
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    showNotification('Usuario desactivado', 'success');
                                    loadUsersList();
                                } else {
                                    showNotification(result.message, 'error');
                                }
                            })
                            .eliminarUsuario(id);
                    }
                }
            });
        };

        window.activateUser = function(id, nombre) {
            if (typeof google === 'undefined' || typeof google.script === 'undefined') {
                // Simular activación local
                setTimeout(() => {
                    showNotification('Usuario activado', 'success');
                    loadUsersList();
                }, 500);
            } else {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            showNotification('Usuario activado', 'success');
                            loadUsersList();
                        } else {
                            showNotification(result.message, 'error');
                        }
                    })
                    .actualizarUsuario(id, { activo: true });
            }
        };

        window.editUser = function(id) {
            showNotification('Función de editar usuario en desarrollo', 'info');
        };

        // Función para inicializar la página (compatibilidad con Principal.html)
        function initializePage() {
            // Los datos ya están inicializados en Index.html
            loadHomeContent();
        }

        // Exponer funciones globalmente para compatibilidad con Index.html
        window.toggleFloor = toggleFloor;
        window.showSalonDetails = showSalonDetails;
        window.searchSalons = searchSalons;
        window.filterByStatus = filterByStatus;
        window.showReports = showReports;
        window.closeModal = closeModal;
        window.initializePage = initializePage;

        // Inicializar la aplicación cuando se carga la página
        document.addEventListener('DOMContentLoaded', initApp);
>>>>>>> Stashed changes
    </script>
</body>
</html>



