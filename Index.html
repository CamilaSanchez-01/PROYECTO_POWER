<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asignación de Salones</title>
    <base target="_top">
    <?!= include('Estilos.html'); ?>
</head>
<body>
    <div id="appContainer">
        <!-- El contenido se cargará dinámicamente aquí -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const appContainer = document.getElementById('appContainer');
            
            // Verificar si hay una sesión activa
            const sessionId = sessionStorage.getItem('sessionId');
            
            if (sessionId) {
                // Verificar si la sesión es válida
                google.script.run
                    .withSuccessHandler(function(user) {
                        if (user) {
                            // Sesión válida, cargar dashboard
                            loadDashboard();
                        } else {
                            // Sesión inválida, cargar login
                            loadLogin();
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error al verificar sesión:', error);
                        loadLogin();
                    })
                    .getCurrentUser(sessionId);
            } else {
                // No hay sesión, cargar login
                loadLogin();
            }
            
            function loadLogin() {
                // Limpiar cualquier sesión residual
                sessionStorage.removeItem('sessionId');
                
                // Mostrar indicador de carga
                appContainer.innerHTML = '<div class="loading-container"><div class="spinner"></div><p>Cargando...</p></div>';
                
                google.script.run
                    .withSuccessHandler(function(html) {
                        appContainer.innerHTML = html;
                        // Inicializar eventos del login
                        initializeLoginEvents();
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error al cargar login:', error);
                        appContainer.innerHTML = '<div class="error-message">Error al cargar la página de login</div>';
                    })
                    .loadLogin();
            }
            
            function loadDashboard() {
                // Mostrar indicador de carga
                appContainer.innerHTML = '<div class="loading-container"><div class="spinner"></div><p>Cargando...</p></div>';
                
                google.script.run
                    .withSuccessHandler(function(html) {
                        appContainer.innerHTML = html;
                        // El dashboard ahora tiene su propio script integrado
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error al cargar dashboard:', error);
                        appContainer.innerHTML = '<div class="error-message">Error al cargar el dashboard</div>';
                    })
                    .loadDashboard();
            }
            
            function initializeLoginEvents() {
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const email = document.getElementById('email').value;
                        const password = document.getElementById('password').value;
                        const errorElement = document.getElementById('loginError');
                        
                        // Ocultar mensaje de error anterior
                        errorElement.style.display = 'none';
                        
                        // Mostrar mensaje de carga
                        mostrarMensaje('Iniciando sesión, por favor espere...', 'info');
                        
                        google.script.run
                            .withSuccessHandler(function(response) {
                                if (response.success) {
                                    // Guardar ID de sesión en sessionStorage
                                    sessionStorage.setItem('sessionId', response.sessionId);
                                    
                                    // Mostrar mensaje de éxito
                                    mostrarMensaje('¡Inicio de sesión exitoso! Redirigiendo...', 'success');
                                    
                                    // Pequeña pausa antes de redirigir
                                    setTimeout(function() {
                                        loadDashboard();
                                    }, 1500);
                                } else {
                                    errorElement.textContent = response.message;
                                    errorElement.style.display = 'block';
                                }
                            })
                            .withFailureHandler(function(error) {
                                errorElement.textContent = 'Error de conexión. Intente nuevamente.';
                                errorElement.style.display = 'block';
                                console.error('Error en login:', error);
                            })
                            .login(email, password);
                    });
                }
            }
            
            // Función para mostrar mensajes
            function mostrarMensaje(mensaje, tipo) {
                // Crear elemento de mensaje
                const messageElement = document.createElement('div');
                messageElement.className = `alert alert-${tipo === 'error' ? 'danger' : tipo === 'info' ? 'info' : 'success'} alert-dismissible fade show`;
                messageElement.setAttribute('role', 'alert');
                messageElement.innerHTML = `
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Insertar al principio del contenedor principal
                const container = document.querySelector('.container');
                if (container) {
                    container.insertBefore(messageElement, container.firstChild);
                } else {
                    // Si no hay contenedor, insertar en el body
                    document.body.insertBefore(messageElement, document.body.firstChild);
                }
                
                // Auto-eliminar después de 5 segundos
                setTimeout(function() {
                    if (messageElement && messageElement.parentNode) {
                        messageElement.remove();
                    }
                }, 5000);
            }
        });
    </script>
</body>
</html>


