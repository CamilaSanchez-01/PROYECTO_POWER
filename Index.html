<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asignación de Salones</title>
    <base target="_top">
    <?!= include('Estilos.html'); ?>
</head>
<body>
    <div id="appContainer">
        <!-- El contenido se cargará dinámicamente aquí -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const appContainer = document.getElementById('appContainer');
            
            // Verificar si hay una sesión activa
            const sessionId = sessionStorage.getItem('sessionId');
            
            if (sessionId) {
                // Verificar si la sesión es válida
                google.script.run
                    .withSuccessHandler(function(user) {
                        if (user) {
                            // Sesión válida, cargar dashboard
                            loadDashboard();
                        } else {
                            // Sesión inválida, cargar login
                            loadLogin();
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error al verificar sesión:', error);
                        loadLogin();
                    })
                    .getCurrentUser(sessionId);
            } else {
                // No hay sesión, cargar login
                loadLogin();
            }
            
            function loadLogin() {
                google.script.run
                    .withSuccessHandler(function(html) {
                        appContainer.innerHTML = html;
                        // Inicializar eventos del login
                        initializeLoginEvents();
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error al cargar login:', error);
                        appContainer.innerHTML = '<div class="error-message">Error al cargar la página de login</div>';
                    })
                    .loadLogin();
            }
            
            function loadDashboard() {
                google.script.run
                    .withSuccessHandler(function(html) {
                        appContainer.innerHTML = html;
                        // Inicializar eventos del dashboard
                        initializeDashboardEvents();
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error al cargar dashboard:', error);
                        appContainer.innerHTML = '<div class="error-message">Error al cargar el dashboard</div>';
                    })
                    .loadDashboard();
            }
            
            function initializeLoginEvents() {
                const loginForm = document.getElementById('loginForm');
                if (loginForm) {
                    loginForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const email = document.getElementById('email').value;
                        const password = document.getElementById('password').value;
                        const errorElement = document.getElementById('loginError');
                        
                        // Ocultar mensaje de error anterior
                        errorElement.style.display = 'none';
                        
                        // Mostrar mensaje de carga
                        mostrarMensaje('Iniciando sesión, por favor espere...', 'info');
                        
                        google.script.run
                            .withSuccessHandler(function(response) {
                                if (response.success) {
                                    // Guardar ID de sesión en sessionStorage
                                    sessionStorage.setItem('sessionId', response.sessionId);
                                    
                                    // Mostrar mensaje de éxito
                                    mostrarMensaje('¡Inicio de sesión exitoso! Redirigiendo...', 'success');
                                    
                                    // Pequeña pausa antes de redirigir
                                    setTimeout(() => {
                                        loadDashboard();
                                    }, 1500);
                                } else {
                                    errorElement.textContent = response.message;
                                    errorElement.style.display = 'block';
                                }
                            })
                            .withFailureHandler(function(error) {
                                errorElement.textContent = 'Error de conexión. Intente nuevamente.';
                                errorElement.style.display = 'block';
                                console.error('Error en login:', error);
                            })
                            .login(email, password);
                    });
                }
            }
            
            function initializeDashboardEvents() {
                // Obtener ID de sesión de sessionStorage
                const sessionId = sessionStorage.getItem('sessionId');
                
                if (!sessionId) {
                    // Si no hay sesión, redirigir al login
                    window.location.reload();
                    return;
                }
                
                // Verificar sesión y obtener usuario actual
                google.script.run
                    .withSuccessHandler(function(user) {
                        if (!user) {
                            // Si no hay usuario, redirigir al login
                            window.location.reload();
                            return;
                        }
                        
                        currentUser = user;
                        const userInfoElement = document.getElementById('userInfo');
                        if (userInfoElement) {
                            userInfoElement.textContent = `Bienvenido, ${user.email}`;
                        }
                        
                        // Cargar datos iniciales
                        cargarDatos();
                        
                        // Configurar event listeners
                        configurarEventListeners();
                        
                        // No se muestra la sección de administración para ningún usuario
                    })
                    .getCurrentUser(sessionId);
            }
            
            // Variables globales
            let aulas = [];
            let cursos = [];
            let profesores = [];
            let asignaciones = [];
            let usuarios = [];
            let permisos = [];
            let grupos = [];
            let materias = [];
            let horarios = [];
            let currentUser = null;
            
            // Configuración de edificios
            const buildingConfig = {
                'D': { pisos: [6, 6, 6, 6] }, // 24 aulas
                'E': { pisos: [6, 6, 6, 5] }, // 23 aulas
                'F': { pisos: [4, 4, 4, 4] }  // 16 aulas
            };
            
            // Función para cargar datos iniciales
            function cargarDatos() {
                google.script.run
                    .withSuccessHandler(function(data) {
                        aulas = data.aulas || [];
                        cursos = data.cursos || [];
                        profesores = data.profesores || [];
                        asignaciones = data.asignaciones || [];
                        usuarios = data.usuarios || [];
                        permisos = data.permisos || [];
                        grupos = data.grupos || [];
                        materias = data.materias || [];
                        horarios = data.horarios || [];
                        
                        // Si no hay aulas, inicializar el sistema
                        if (aulas.length <= 1) { // Solo encabezado
                            google.script.run
                                .withSuccessHandler(function(result) {
                                    if (result.success) {
                                        cargarDatos(); // Recargar datos después de inicializar
                                    } else {
                                        mostrarMensaje('Error al inicializar el sistema: ' + result.message, 'error');
                                    }
                                })
                                .initializeSheets();
                            return;
                        }
                        
                        // Actualizar interfaz
                        actualizarInterfaz();
                    })
                    .getAllData();
            }
            
            // Función para actualizar la interfaz
            function actualizarInterfaz() {
                // Actualizar tarjetas de edificios
                actualizarTarjetasEdificios();
                
                // Actualizar tablas
                actualizarTablaAulas();
                actualizarTablaCursos();
                actualizarTablaProfesores();
                actualizarTablaGrupos();
                actualizarTablaMaterias();
                actualizarTablaAsignaciones();
                
                // Actualizar dropdowns
                actualizarDropdowns();
            }
            
            // Función para actualizar las tarjetas de edificios
            function actualizarTarjetasEdificios() {
                const edificios = ['D', 'E', 'F'];
                
                edificios.forEach(edificio => {
                    const accordionId = `accordion${edificio}`;
                    const accordion = document.getElementById(accordionId);
                    
                    if (!accordion) return;
                    
                    // Limpiar contenido existente
                    accordion.innerHTML = '';
                    
                    // Obtener pisos del edificio
                    const pisos = buildingConfig[edificio].pisos;
                    
                    // Crear un accordion item para cada piso
                    pisos.forEach((aulasPiso, indicePiso) => {
                        const piso = indicePiso + 1;
                        const collapseId = `collapse${edificio}${piso}`;
                        const classroomsId = `classrooms${edificio}${piso}`;
                        
                        // Crear accordion item
                        const accordionItem = document.createElement('div');
                        accordionItem.className = 'accordion-item';
                        
                        accordionItem.innerHTML = `
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                    Piso ${piso}
                                </button>
                            </h2>
                            <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#${accordionId}">
                                <div class="accordion-body classroom-grid" id="${classroomsId}">
                                    <!-- Las aulas se agregarán dinámicamente -->
                                </div>
                            </div>
                        `;
                        
                        accordion.appendChild(accordionItem);
                        
                        // Agregar aulas al piso
                        const classroomsContainer = document.getElementById(classroomsId);
                        const aulasPisoActual = aulas.filter(aula => 
                            aula[1] === edificio && aula[2] === piso
                        );
                        
                        aulasPisoActual.forEach(aula => {
                            const classroomBox = document.createElement('div');
                            classroomBox.className = 'classroom-box';
                            
                            // Añadir icono según tipo de aula
                            let icono = '';
                            if (aula[7] === 'Accesible') {
                                icono = '<i class="fas fa-wheelchair"></i> ';
                            } else if (aula[7] === 'Laboratorio') {
                                icono = '<i class="fas fa-flask"></i> ';
                            }
                            
                            classroomBox.innerHTML = `${icono}${aula[3]}`;
                            classroomsContainer.appendChild(classroomBox);
                        });
                    });
                });
            }
            
            // Función para actualizar la tabla de aulas
            function actualizarTablaAulas() {
                const tbody = document.querySelector('#classroomsTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Saltar encabezado
                for (let i = 1; i < aulas.length; i++) {
                    const aula = aulas[i];
                    const autoAsignableText = (aula[5] === true || aula[5] === 'TRUE') ? 'Sí' : 'No';
                    const accesibleText = (aula[6] === true || aula[6] === 'TRUE') ? 'Sí' : 'No';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${aula[1]}</td>
                        <td>${aula[2]}</td>
                        <td>${aula[3]}</td>
                        <td>${aula[4]}</td>
                        <td>${aula[7]}</td>
                        <td>${autoAsignableText}</td>
                        <td>${accesibleText}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar la tabla de cursos
            function actualizarTablaCursos() {
                const tbody = document.querySelector('#coursesTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Saltar encabezado
                for (let i = 1; i < cursos.length; i++) {
                    const curso = cursos[i];
                    const profesor = profesores.find(p => p[0] === curso[3]);
                    const profesorNombre = profesor ? profesor[1] : 'No asignado';
                    
                    const materia = materias.find(m => m[0] === curso[4]);
                    const materiaNombre = materia ? materia[1] : 'No asignada';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${curso[1]}</td>
                        <td>${curso[2]}</td>
                        <td>${profesorNombre}</td>
                        <td>${curso[5]}</td>
                        <td>${curso[6]}</td>
                        <td>${materiaNombre}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar la tabla de profesores
            function actualizarTablaProfesores() {
                const tbody = document.querySelector('#teachersTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Saltar encabezado
                for (let i = 1; i < profesores.length; i++) {
                    const profesor = profesores[i];
                    const discapacidadText = (profesor[3] === true || profesor[3] === 'TRUE') ? 'Sí' : 'No';
                    const pisoPreferido = profesor[4] || 'Ninguno';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${profesor[1]}</td>
                        <td>${profesor[2]}</td>
                        <td>${discapacidadText}</td>
                        <td>${pisoPreferido}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar la tabla de grupos
            function actualizarTablaGrupos() {
                const tbody = document.querySelector('#groupsTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Saltar encabezado
                for (let i = 1; i < grupos.length; i++) {
                    const grupo = grupos[i];
                    const discapacidadText = (grupo[5] === true || grupo[5] === 'TRUE') ? 'Sí' : 'No';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${grupo[1]}</td>
                        <td>${grupo[2]}</td>
                        <td>${grupo[3]}</td>
                        <td>${grupo[4]}</td>
                        <td>${discapacidadText}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar la tabla de materias
            function actualizarTablaMaterias() {
                const tbody = document.querySelector('#subjectsTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Saltar encabezado
                for (let i = 1; i < materias.length; i++) {
                    const materia = materias[i];
                    const obligatoriaText = (materia[3] === true || materia[3] === 'TRUE') ? 'Sí' : 'No';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${materia[1]}</td>
                        <td>${materia[2]}</td>
                        <td>${materia[4]}</td>
                        <td>${obligatoriaText}</td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar la tabla de asignaciones
            function actualizarTablaAsignaciones(fechaFiltro = null) {
                const tbody = document.querySelector('#assignmentsTable tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                // Filtrar asignaciones por fecha si se proporciona
                let asignacionesFiltradas = asignaciones;
                if (fechaFiltro) {
                    asignacionesFiltradas = asignaciones.filter(a => a[3] === fechaFiltro);
                }
                
                // Saltar encabezado
                for (let i = 1; i < asignacionesFiltradas.length; i++) {
                    const asignacion = asignacionesFiltradas[i];
                    const curso = cursos.find(c => c[0] === asignacion[1]);
                    const aula = aulas.find(a => a[0] === asignacion[2]);
                    const profesor = profesores.find(p => p[0] === asignacion[6]);
                    const grupo = grupos.find(g => g[0] === asignacion[7]);
                    
                    const cursoNombre = curso ? curso[1] : 'Curso no encontrado';
                    const aulaNombre = aula ? `${aula[1]}${aula[2]}-${aula[3]}` : 'Aula no encontrada';
                    const profesorNombre = profesor ? profesor[1] : 'Profesor no encontrado';
                    const grupoNombre = grupo ? grupo[1] : 'Sin grupo';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${cursoNombre}</td>
                        <td>${aulaNombre}</td>
                        <td>${asignacion[3]}</td>
                        <td>${asignacion[4]} - ${asignacion[5]}</td>
                        <td>${profesorNombre}</td>
                        <td>${grupoNombre}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="eliminarAsignacion('${asignacion[0]}')">Eliminar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            }
            
            // Función para actualizar los dropdowns
            function actualizarDropdowns() {
                // Actualizar dropdown de profesores para cursos
                const teacherSelect = document.getElementById('courseTeacher');
                if (teacherSelect) {
                    teacherSelect.innerHTML = '<option value="">Seleccionar Profesor</option>';
                    
                    // Saltar encabezado
                    for (let i = 1; i < profesores.length; i++) {
                        const profesor = profesores[i];
                        teacherSelect.innerHTML += `<option value="${profesor[0]}">${profesor[1]}</option>`;
                    }
                }
                
                // Actualizar dropdown de materias para cursos
                const subjectSelect = document.getElementById('courseSubject');
                if (subjectSelect) {
                    subjectSelect.innerHTML = '<option value="">Seleccionar Materia</option>';
                    
                    // Saltar encabezado
                    for (let i = 1; i < materias.length; i++) {
                        const materia = materias[i];
                        subjectSelect.innerHTML += `<option value="${materia[0]}">${materia[1]}</option>`;
                    }
                }
                
                // Actualizar dropdown de cursos para asignaciones
                const courseSelect = document.getElementById('assignCourse');
                if (courseSelect) {
                    courseSelect.innerHTML = '<option value="">Seleccionar Curso</option>';
                    
                    // Saltar encabezado
                    for (let i = 1; i < cursos.length; i++) {
                        const curso = cursos[i];
                        courseSelect.innerHTML += `<option value="${curso[0]}">${curso[1]} (${curso[2]})</option>`;
                    }
                }
                
                // Actualizar dropdown de cursos para auto-asignación
                const autoAssignCourseSelect = document.getElementById('autoAssignCourse');
                if (autoAssignCourseSelect) {
                    autoAssignCourseSelect.innerHTML = '<option value="">Seleccionar Curso</option>';
                    
                    // Saltar encabezado
                    for (let i = 1; i < cursos.length; i++) {
                        const curso = cursos[i];
                        autoAssignCourseSelect.innerHTML += `<option value="${curso[0]}">${curso[1]} (${curso[2]})</option>`;
                    }
                }
                
                // Actualizar dropdown de grupos para asignaciones
                const groupSelect = document.getElementById('assignGroup');
                if (groupSelect) {
                    groupSelect.innerHTML = '<option value="">Seleccionar Grupo (opcional)</option>';
                    
                    // Saltar encabezado
                    for (let i = 1; i < grupos.length; i++) {
                        const grupo = grupos[i];
                        groupSelect.innerHTML += `<option value="${grupo[0]}">${grupo[1]} - ${grupo[2]}</option>`;
                    }
                }
                
                // Actualizar dropdown de edificios
                const buildingSelect = document.getElementById('assignBuilding');
                if (buildingSelect) {
                    const edificios = [...new Set(aulas.map(a => a[1]))];
                    buildingSelect.innerHTML = '<option value="">Edificio</option>';
                    
                    edificios.forEach(edificio => {
                        buildingSelect.innerHTML += `<option value="${edificio}">${edificio}</option>`;
                    });
                }
            }
            
            // Función para configurar los event listeners
            function configurarEventListeners() {
                // Botón de cerrar sesión - Usar event delegation
                document.addEventListener('click', function(event) {
                    if (event.target && event.target.id === 'logoutBtn') {
                        event.preventDefault();
                        
                        // Mostrar mensaje de confirmación más claro
                        if (confirm('¿Está seguro de que desea cerrar su sesión actual?')) {
                            // Mostrar mensaje informativo
                            mostrarMensaje('Cerrando sesión, espere un momento...', 'info');
                            
                            // Pequeña pausa para que el usuario vea el mensaje
                            setTimeout(() => {
                                google.script.run
                                    .withSuccessHandler(function() {
                                        // Limpiar sessionStorage
                                        sessionStorage.removeItem('sessionId');
                                        
                                        // Mostrar mensaje de despedida
                                        mostrarMensaje('Sesión cerrada correctamente. Redirigiendo...', 'success');
                                        
                                        // Redirigir al login después de un momento
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 1500);
                                    })
                                    .withFailureHandler(function(error) {
                                        console.error('Error al cerrar sesión:', error);
                                        mostrarMensaje('Error al cerrar sesión. Por favor, intente nuevamente.', 'error');
                                    })
                                    .logout(sessionId);
                            }, 1000);
                        }
                    }
                });
                
                // Formulario de agregar aula
                const classroomForm = document.getElementById('classroomForm');
                if (classroomForm) {
                    classroomForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const edificio = document.getElementById('building').value;
                        const piso = document.getElementById('floor').value;
                        const numero = document.getElementById('roomNumber').value;
                        const capacidad = document.getElementById('capacity').value;
                        const tipo = document.getElementById('roomType').value;
                        const autoAsignable = document.getElementById('autoAssignable').checked;
                        const accesible = document.getElementById('accessible').checked;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Aula agregada correctamente', 'success');
                                    classroomForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al agregar aula: ' + error.message, 'error');
                            })
                            .addAula(sessionId, edificio, piso, numero, capacidad, autoAsignable, accesible, tipo);
                    });
                }
                
                // Formulario de agregar curso
                const courseForm = document.getElementById('courseForm');
                if (courseForm) {
                    courseForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const nombre = document.getElementById('courseName').value;
                        const codigo = document.getElementById('courseCode').value;
                        const idProfesor = document.getElementById('courseTeacher').value;
                        const carrera = document.getElementById('courseCareer').value;
                        const semestre = document.getElementById('courseSemester').value;
                        const idMateria = document.getElementById('courseSubject').value;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Curso agregado correctamente', 'success');
                                    courseForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al agregar curso: ' + error.message, 'error');
                            })
                            .addCurso(sessionId, nombre, codigo, idProfesor, idMateria, carrera, semestre);
                    });
                }
                
                // Formulario de agregar profesor
                const teacherForm = document.getElementById('teacherForm');
                if (teacherForm) {
                    teacherForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const nombre = document.getElementById('teacherName').value;
                        const email = document.getElementById('teacherEmail').value;
                        const discapacidad = document.getElementById('teacherDisability').checked;
                        const pisoPreferido = document.getElementById('teacherPreferredFloor').value;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Profesor agregado correctamente', 'success');
                                    teacherForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al agregar profesor: ' + error.message, 'error');
                            })
                            .addProfesor(sessionId, nombre, email, discapacidad, pisoPreferido);
                    });
                }
                
                // Formulario de agregar grupo
                const groupForm = document.getElementById('groupForm');
                if (groupForm) {
                    groupForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const numero = document.getElementById('groupNumber').value;
                        const carrera = document.getElementById('groupCareer').value;
                        const semestre = document.getElementById('groupSemester').value;
                        const tamaño = document.getElementById('groupSize').value;
                        const discapacidad = document.getElementById('groupDisability').checked;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Grupo agregado correctamente', 'success');
                                    groupForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al agregar grupo: ' + error.message, 'error');
                            })
                            .addGrupo(sessionId, numero, carrera, semestre, tamaño, discapacidad);
                    });
                }
                
                // Formulario de agregar materia
                const subjectForm = document.getElementById('subjectForm');
                if (subjectForm) {
                    subjectForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const nombre = document.getElementById('subjectName').value;
                        const codigo = document.getElementById('subjectCode').value;
                        const semestre = document.getElementById('subjectSemester').value;
                        const obligatoria = document.getElementById('subjectRequired').checked;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Materia agregada correctamente', 'success');
                                    subjectForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al agregar materia: ' + error.message, 'error');
                            })
                            .addMateria(sessionId, nombre, codigo, obligatoria, semestre);
                    });
                }
                
                // Cambio en el selector de edificio
                const buildingSelect = document.getElementById('assignBuilding');
                if (buildingSelect) {
                    buildingSelect.addEventListener('change', function() {
                        const edificio = this.value;
                        const floorSelect = document.getElementById('assignFloor');
                        
                        if (!edificio) {
                            floorSelect.innerHTML = '<option value="">Piso</option>';
                            return;
                        }
                        
                        const pisos = [...new Set(aulas.filter(a => a[1] === edificio).map(a => a[2]))];
                        floorSelect.innerHTML = '<option value="">Piso</option>';
                        
                        pisos.forEach(piso => {
                            floorSelect.innerHTML += `<option value="${piso}">${piso}</option>`;
                        });
                    });
                }
                
                // Cambio en el selector de piso
                const floorSelect = document.getElementById('assignFloor');
                if (floorSelect) {
                    floorSelect.addEventListener('change', function() {
                        const edificio = document.getElementById('assignBuilding').value;
                        const piso = this.value;
                        const classroomSelect = document.getElementById('assignClassroom');
                        
                        if (!edificio || !piso) {
                            classroomSelect.innerHTML = '<option value="">Aula</option>';
                            return;
                        }
                        
                        const aulasPiso = aulas.filter(a => a[1] === edificio && a[2] == piso);
                        classroomSelect.innerHTML = '<option value="">Aula</option>';
                        
                        aulasPiso.forEach(aula => {
                            classroomSelect.innerHTML += `<option value="${aula[0]}">${aula[3]}</option>`;
                        });
                    });
                }
                
                // Formulario de crear asignación
                const assignmentForm = document.getElementById('assignmentForm');
                if (assignmentForm) {
                    assignmentForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const idCurso = document.getElementById('assignCourse').value;
                        const idAula = document.getElementById('assignClassroom').value;
                        const fecha = document.getElementById('assignDate').value;
                        const horaInicio = document.getElementById('assignStart').value;
                        const horaFin = document.getElementById('assignEnd').value;
                        const idGrupo = document.getElementById('assignGroup').value;
                        
                        // Obtener ID del profesor del curso
                        const curso = cursos.find(c => c[0] === idCurso);
                        const idProfesor = curso ? curso[3] : '';
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Asignación creada correctamente', 'success');
                                    assignmentForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                    
                                    // Si hay alternativas, mostrarlas
                                    if (result.alternativas && result.alternativas.length > 0) {
                                        const alternativasText = result.alternativas.map(a => 
                                            `${a.edificio}${a.piso}-${a.numero} (Prioridad: ${a.prioridad})`
                                        ).join(', ');
                                        mostrarMensaje(`Alternativas disponibles: ${alternativasText}`, 'info');
                                    }
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al crear asignación: ' + error.message, 'error');
                            })
                            .createAssignment(sessionId, idCurso, idAula, fecha, horaInicio, horaFin, idProfesor, idGrupo);
                    });
                }
                
                // Formulario de auto-asignar aula
                const autoAssignForm = document.getElementById('autoAssignForm');
                if (autoAssignForm) {
                    autoAssignForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        const idCurso = document.getElementById('autoAssignCourse').value;
                        const fecha = document.getElementById('autoAssignDate').value;
                        const horaInicio = document.getElementById('autoAssignStart').value;
                        const horaFin = document.getElementById('autoAssignEnd').value;
                        
                        google.script.run
                            .withSuccessHandler(function(result) {
                                if (result.success) {
                                    mostrarMensaje('Aula auto-asignada correctamente', 'success');
                                    autoAssignForm.reset();
                                    cargarDatos();
                                } else {
                                    mostrarMensaje(result.message, 'error');
                                }
                            })
                            .withFailureHandler(function(error) {
                                mostrarMensaje('Error al auto-asignar aula: ' + error.message, 'error');
                            })
                            .autoAssignClassroom(sessionId, idCurso, fecha, horaInicio, horaFin);
                    });
                }
                
                // Botón de filtrar asignaciones por fecha
                const filterBtn = document.getElementById('filterBtn');
                if (filterBtn) {
                    filterBtn.addEventListener('click', function() {
                        const fecha = document.getElementById('filterDate').value;
                        actualizarTablaAsignaciones(fecha);
                    });
                }
            }
            
            // Función para mostrar mensajes
            function mostrarMensaje(mensaje, tipo) {
                // Crear elemento de mensaje
                const messageElement = document.createElement('div');
                messageElement.className = `alert alert-${tipo === 'error' ? 'danger' : tipo === 'info' ? 'info' : 'success'} alert-dismissible fade show`;
                messageElement.setAttribute('role', 'alert');
                messageElement.innerHTML = `
                    ${mensaje}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Insertar al principio del contenedor principal
                const container = document.querySelector('.container');
                if (container) {
                    container.insertBefore(messageElement, container.firstChild);
                }
                
                // Auto-eliminar después de 5 segundos
                setTimeout(() => {
                    if (messageElement && messageElement.parentNode) {
                        messageElement.remove();
                    }
                }, 5000);
            }
            
            // Función para eliminar una asignación
            function eliminarAsignacion(id) {
                if (confirm('¿Está seguro de eliminar esta asignación?')) {
                    google.script.run
                        .withSuccessHandler(function() {
                            mostrarMensaje('Asignación eliminada correctamente', 'success');
                            cargarDatos();
                        })
                        .withFailureHandler(function(error) {
                            mostrarMensaje('Error al eliminar asignación: ' + error.message, 'error');
                        })
                        .deleteAssignment(sessionId, id);
                }
            }
        });
    </script>
</body>
</html>



