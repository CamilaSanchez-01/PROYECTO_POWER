<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { padding: 20px; }
    .section { margin-bottom: 30px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Classroom Assignment System</h1>

    <div class="section">
      <h2>Initialize System</h2>
      <button id="initBtn" class="btn btn-primary">Initialize Sheets</button>
    </div>

    <div class="section">
      <h2>Manage Data</h2>
      <ul class="nav nav-tabs" id="dataTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="classrooms-tab" data-bs-toggle="tab" data-bs-target="#classrooms" type="button" role="tab">Classrooms</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="courses-tab" data-bs-toggle="tab" data-bs-target="#courses" type="button" role="tab">Courses</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="teachers-tab" data-bs-toggle="tab" data-bs-target="#teachers" type="button" role="tab">Teachers</button>
        </li>
      </ul>
      <div class="tab-content" id="dataTabsContent">
        <div class="tab-pane fade show active" id="classrooms" role="tabpanel">
          <h3>Add Classroom</h3>
          <form id="classroomForm">
            <div class="row">
              <div class="col-md-3"><input type="text" class="form-control" id="building" placeholder="Building" required></div>
              <div class="col-md-3"><input type="number" class="form-control" id="floor" placeholder="Floor" required></div>
              <div class="col-md-3"><input type="text" class="form-control" id="roomNumber" placeholder="Room Number" required></div>
              <div class="col-md-3"><input type="number" class="form-control" id="capacity" placeholder="Capacity"></div>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="autoAssignable" checked>
              <label class="form-check-label" for="autoAssignable">
                Auto-assignable
              </label>
            </div>
            <button type="submit" class="btn btn-success mt-2">Add Classroom</button>
          </form>
          <h3>Classrooms List</h3>
          <table class="table" id="classroomsTable">
            <thead><tr><th>Building</th><th>Floor</th><th>Room</th><th>Capacity</th><th>Auto-Assignable</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tab-pane fade" id="courses" role="tabpanel">
          <h3>Add Course</h3>
          <form id="courseForm">
            <div class="row">
              <div class="col-md-4"><input type="text" class="form-control" id="courseName" placeholder="Course Name" required></div>
              <div class="col-md-4"><input type="text" class="form-control" id="courseCode" placeholder="Course Code" required></div>
              <div class="col-md-4"><select class="form-control" id="courseTeacher" required><option value="">Select Teacher</option></select></div>
            </div>
            <button type="submit" class="btn btn-success mt-2">Add Course</button>
          </form>
          <h3>Courses List</h3>
          <table class="table" id="coursesTable">
            <thead><tr><th>Name</th><th>Code</th><th>Teacher</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tab-pane fade" id="teachers" role="tabpanel">
          <h3>Add Teacher</h3>
          <form id="teacherForm">
            <div class="row">
              <div class="col-md-6"><input type="text" class="form-control" id="teacherName" placeholder="Name" required></div>
              <div class="col-md-6"><input type="email" class="form-control" id="teacherEmail" placeholder="Email" required></div>
            </div>
            <button type="submit" class="btn btn-success mt-2">Add Teacher</button>
          </form>
          <h3>Teachers List</h3>
          <table class="table" id="teachersTable">
            <thead><tr><th>Name</th><th>Email</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Assignments</h2>
      <div class="row">
        <div class="col-md-6">
          <h3>Create Assignment</h3>
          <form id="assignmentForm">
            <div class="mb-3">
              <select class="form-control" id="assignCourse" required><option value="">Select Course</option></select>
            </div>
            <div class="row mb-3">
              <div class="col-md-4"><select class="form-control" id="assignBuilding" required><option value="">Building</option></select></div>
              <div class="col-md-4"><select class="form-control" id="assignFloor"><option value="">Floor</option></select></div>
              <div class="col-md-4"><select class="form-control" id="assignClassroom" required><option value="">Classroom</option></select></div>
            </div>
            <div class="row mb-3">
              <div class="col-md-4"><input type="date" class="form-control" id="assignDate" required></div>
              <div class="col-md-4"><input type="time" class="form-control" id="assignStart" required></div>
              <div class="col-md-4"><input type="time" class="form-control" id="assignEnd" required></div>
            </div>
            <button type="submit" class="btn btn-primary">Create Assignment</button>
          </form>
          <h3>Auto-Assign Classroom</h3>
          <form id="autoAssignForm">
            <div class="mb-3">
              <select class="form-control" id="autoAssignCourse" required><option value="">Select Course</option></select>
            </div>
            <div class="row mb-3">
              <div class="col-md-4"><input type="date" class="form-control" id="autoAssignDate" required></div>
              <div class="col-md-4"><input type="time" class="form-control" id="autoAssignStart" required></div>
              <div class="col-md-4"><input type="time" class="form-control" id="autoAssignEnd" required></div>
            </div>
            <button type="submit" class="btn btn-success">Auto-Assign Classroom</button>
          </form>
        </div>
        <div class="col-md-6">
          <h3>View Assignments</h3>
          <div class="mb-3">
            <input type="date" class="form-control" id="filterDate">
            <button id="filterBtn" class="btn btn-secondary mt-2">Filter by Date</button>
          </div>
          <table class="table" id="assignmentsTable">
            <thead><tr><th>Course</th><th>Classroom</th><th>Date</th><th>Time</th><th>Teacher</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let classrooms = [];
    let courses = [];
    let teachers = [];
    let assignments = [];

    function loadData() {
      google.script.run.withSuccessHandler((data) => {
        classrooms = data.classrooms || [];
        courses = data.courses || [];
        teachers = data.teachers || [];
        assignments = data.assignments || [];
        populateDropdowns();
        populateTables();
      }).getAllData();
    }

    function populateDropdowns() {
      // Teachers for courses
      const teacherSelect = document.getElementById('courseTeacher');
      teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
      teachers.forEach(t => teacherSelect.innerHTML += `<option value="${t[0]}">${t[1]}</option>`);

      // Courses for assignments
      const courseSelect = document.getElementById('assignCourse');
      courseSelect.innerHTML = '<option value="">Select Course</option>';
      courses.forEach(c => courseSelect.innerHTML += `<option value="${c[0]}">${c[1]} (${c[2]})</option>`);

      // Courses for auto-assignment
      const autoAssignCourseSelect = document.getElementById('autoAssignCourse');
      autoAssignCourseSelect.innerHTML = '<option value="">Select Course</option>';
      courses.forEach(c => autoAssignCourseSelect.innerHTML += `<option value="${c[0]}">${c[1]} (${c[2]})</option>`);

      // Buildings
      const buildingSelect = document.getElementById('assignBuilding');
      const buildings = [...new Set(classrooms.map(c => c[1]))];
      buildingSelect.innerHTML = '<option value="">Building</option>';
      buildings.forEach(b => buildingSelect.innerHTML += `<option value="${b}">${b}</option>`);
    }

    function populateTables() {
      // Classrooms
      const classroomsTable = document.getElementById('classroomsTable').querySelector('tbody');
      classroomsTable.innerHTML = '';
      classrooms.forEach(c => {
        const autoAssignText = (c[5] === true || c[5] === 'TRUE') ? 'Yes' : 'No';
        classroomsTable.innerHTML += `<tr><td>${c[1]}</td><td>${c[2]}</td><td>${c[3]}</td><td>${c[4]}</td><td>${autoAssignText}</td></tr>`;
      });

      // Courses
      const coursesTable = document.getElementById('coursesTable').querySelector('tbody');
      coursesTable.innerHTML = '';
      courses.forEach(c => {
        const teacher = teachers.find(t => t[0] == c[3]);
        coursesTable.innerHTML += `<tr><td>${c[1]}</td><td>${c[2]}</td><td>${teacher ? teacher[1] : ''}</td></tr>`;
      });

      // Teachers
      const teachersTable = document.getElementById('teachersTable').querySelector('tbody');
      teachersTable.innerHTML = '';
      teachers.forEach(t => teachersTable.innerHTML += `<tr><td>${t[1]}</td><td>${t[2]}</td></tr>`);

      // Assignments
      populateAssignmentsTable();
    }

    function populateAssignmentsTable(filterDate = null) {
      const assignmentsTable = document.getElementById('assignmentsTable').querySelector('tbody');
      assignmentsTable.innerHTML = '';
      assignments.filter(a => !filterDate || a[3] == filterDate).forEach(a => {
        const course = courses.find(c => c[0] == a[1]);
        const classroom = classrooms.find(c => c[0] == a[2]);
        const teacher = teachers.find(t => t[0] == a[6]);
        assignmentsTable.innerHTML += `<tr><td>${course ? course[1] : ''}</td><td>${classroom ? `${classroom[1]} ${classroom[2]}-${classroom[3]}` : ''}</td><td>${a[3]}</td><td>${a[4]}-${a[5]}</td><td>${teacher ? teacher[1] : ''}</td><td><button class="btn btn-danger btn-sm" onclick="deleteAssignment('${a[0]}')">Delete</button></td></tr>`;
      });
    }

    // Event listeners
    document.getElementById('initBtn').addEventListener('click', () => {
      google.script.run.initializeSheets();
      alert('Sheets initialized');
      loadData();
    });

    document.getElementById('classroomForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const building = document.getElementById('building').value;
      const floor = document.getElementById('floor').value;
      const roomNumber = document.getElementById('roomNumber').value;
      const capacity = document.getElementById('capacity').value;
      const autoAssignable = document.getElementById('autoAssignable').checked;
      google.script.run.withSuccessHandler(() => loadData()).addClassroom(building, floor, roomNumber, capacity, autoAssignable);
    });

    document.getElementById('courseForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('courseName').value;
      const code = document.getElementById('courseCode').value;
      const teacherID = document.getElementById('courseTeacher').value;
      google.script.run.withSuccessHandler(() => loadData()).addCourse(name, code, teacherID);
    });

    document.getElementById('teacherForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('teacherName').value;
      const email = document.getElementById('teacherEmail').value;
      google.script.run.withSuccessHandler(() => loadData()).addTeacher(name, email);
    });

    document.getElementById('assignBuilding').addEventListener('change', () => {
      const building = document.getElementById('assignBuilding').value;
      const floorSelect = document.getElementById('assignFloor');
      const floors = [...new Set(classrooms.filter(c => c[1] == building).map(c => c[2]))];
      floorSelect.innerHTML = '<option value="">Floor</option>';
      floors.forEach(f => floorSelect.innerHTML += `<option value="${f}">${f}</option>`);
    });

    document.getElementById('assignFloor').addEventListener('change', () => {
      const building = document.getElementById('assignBuilding').value;
      const floor = document.getElementById('assignFloor').value;
      const classroomSelect = document.getElementById('assignClassroom');
      const rooms = classrooms.filter(c => c[1] == building && c[2] == floor);
      classroomSelect.innerHTML = '<option value="">Classroom</option>';
      rooms.forEach(r => classroomSelect.innerHTML += `<option value="${r[0]}">${r[3]}</option>`);
    });

    document.getElementById('assignmentForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const courseID = document.getElementById('assignCourse').value;
      const classroomID = document.getElementById('assignClassroom').value;
      const date = document.getElementById('assignDate').value;
      const start = document.getElementById('assignStart').value;
      const end = document.getElementById('assignEnd').value;
      const course = courses.find(c => c[0] == courseID);
      const teacherID = course ? course[3] : '';
      google.script.run.withSuccessHandler((result) => {
        if (result.success) {
          loadData();
        } else {
          alert(result.message);
        }
      }).createAssignment(courseID, classroomID, date, start, end, teacherID);
    });

    document.getElementById('autoAssignForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const courseID = document.getElementById('autoAssignCourse').value;
      const date = document.getElementById('autoAssignDate').value;
      const start = document.getElementById('autoAssignStart').value;
      const end = document.getElementById('autoAssignEnd').value;
      google.script.run.withSuccessHandler((result) => {
        if (result.success) {
          alert('Classroom auto-assigned successfully!');
          loadData();
        } else {
          alert(result.message);
        }
      }).autoAssignClassroom(courseID, date, start, end);
    });

    document.getElementById('filterBtn').addEventListener('click', () => {
      const date = document.getElementById('filterDate').value;
      populateAssignmentsTable(date);
    });

    function deleteAssignment(id) {
      google.script.run.withSuccessHandler(() => loadData()).deleteAssignment(id);
    }

    // Load data on page load
    window.onload = loadData;
  </script>
</body>
</html>