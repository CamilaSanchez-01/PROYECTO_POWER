<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Asignación de Salones</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        :root {
            --negro: #121212;
            --negro-claro: #1E1E1E;
            --verde-oscuro: #2E7D32;
            --verde-medio: #4CAF50;
            --verde-claro: #81C784;
            --amarillo-oscuro: #F57F17;
            --amarillo-medio: #FFC107;
            --amarillo-claro: #FFE082;
            --gris-claro: #E0E0E0;
            --gris-texto: #BDBDBD;
            --disponible: #4CAF50;
            --ocupado: #FFC107;
            --accesible: #FF9800;
            --negro-login: #000000;
            --verde-oscuro-login: #006633;
            --oro-dorado: #D4AF37;
            --blanco: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--negro) 0%, var(--verde-oscuro) 100%);
            min-height: 100vh;
            color: var(--blanco);
            overflow-x: hidden;
        }

        .principal-wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .principal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: var(--gris-claro);
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .menu-toggle:hover {
            color: var(--verde-claro);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .header-logos {
            display: flex;
            align-items: center;
        }

        .logo-uabc-fca {
            height: 50px;
            width: auto;
        }

        .header-info {
            display: flex;
            flex-direction: column;
        }

        .system-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--blanco);
        }

        .faculty-name {
            font-size: 12px;
            color: var(--gris-texto);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--verde-medio);
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: rgba(79, 209, 197, 0.3);
            border: 1px solid var(--verde-medio);
            border-radius: 5px;
            color: var(--gris-claro);
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: var(--verde-medio);
            color: white;
        }

        .main-layout {
            flex: 1;
            display: flex;
            position: relative;
        }

        .sidebar {
            width: 250px;
            background-color: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            left: 0;
            top: 0;
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .sidebar-logo {
            width: 120px;
            height: auto;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--verde-claro);
            text-align: center;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--gris-texto);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            cursor: pointer;
        }

        .sidebar-link:hover {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--gris-claro);
            border-left-color: var(--verde-medio);
        }

        .sidebar-link.active {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--verde-claro);
            border-left-color: var(--verde-medio);
        }

        .sidebar-link i {
            width: 24px;
            font-size: 18px;
            margin-right: 15px;
        }

        .sidebar-link span {
            font-size: 16px;
            font-weight: 500;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 30px;
            max-width: calc(100% - 250px);
            transition: all 0.3s ease;
        }

        .sidebar-collapsed .sidebar {
            left: -250px;
        }

        .sidebar-collapsed .main-content {
            margin-left: 0;
            max-width: 100%;
        }

        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 500;
            margin-bottom: 10px;
            color: var(--gris-claro);
            text-shadow: 0 0 10px rgba(3, 169, 244, 0.3);
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--gris-texto);
            max-width: 600px;
            margin: 0 auto;
        }

        .section-header {
            margin-bottom: 30px;
        }

        .section-header h1 {
            font-size: 28px;
            color: var(--verde-claro);
            margin-bottom: 10px;
        }

        .section-header p {
            color: var(--gris-texto);
        }

        .file-upload-section {
            background-color: rgba(30, 30, 30, 0.7);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 209, 197, 0.2);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-header h2 {
            color: var(--verde-claro);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-upload-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .file-upload-area {
            border: 2px dashed var(--gris-texto);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: rgba(0, 0, 0, 0.2);
        }

        .file-upload-area:hover {
            border-color: var(--verde-medio);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .file-upload-area i {
            font-size: 48px;
            color: var(--verde-medio);
            margin-bottom: 15px;
        }

        .file-upload-area p {
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 15px;
            text-align: left;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .file-item i {
            color: var(--verde-medio);
            margin-right: 10px;
        }

        .file-item button {
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            font-size: 16px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--verde-medio);
            color: white;
        }

        .btn-primary:hover {
            background: var(--verde-claro);
        }

        .btn-secondary {
            background: transparent;
            color: var(--gris-claro);
            border: 1px solid var(--gris-texto);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .help-text {
            font-size: 14px;
            color: var(--gris-texto);
            font-style: italic;
        }

        .loading-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading-indicator.active {
            display: flex;
        }

        .spinner {
            border: 5px solid var(--negro-claro);
            border-top: 5px solid var(--verde-medio);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .progress-bar {
            width: 300px;
            height: 10px;
            background-color: var(--negro-claro);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: var(--verde-medio);
            width: 0%;
            transition: width 0.3s;
        }

        .notifications-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
        }

        .notification {
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            margin-bottom: 10px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification-exito {
            background-color: var(--disponible);
        }

        .notification-error {
            background-color: #f44336;
        }

        .notification-advertencia {
            background-color: var(--amarillo-medio);
            color: var(--negro);
        }

        .notification-info {
            background-color: var(--verde-medio);
        }

        .visualization-section {
            background-color: rgba(30, 30, 30, 0.7);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 209, 197, 0.2);
        }

        .view-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            background-color: var(--negro-claro);
            color: var(--gris-claro);
            border: 1px solid var(--gris-texto);
            border-radius: 5px;
        }

        .search-salon-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-salon-input {
            padding: 8px 12px 8px 35px;
            background-color: var(--negro-claro);
            color: var(--gris-claro);
            border: 1px solid var(--gris-texto);
            border-radius: 5px;
            width: 250px;
        }

        .search-salon-icon {
            position: absolute;
            left: 10px;
            color: var(--gris-texto);
        }

        .floor-view-container {
            margin-top: 20px;
        }

        .floor-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .floor-btn {
            padding: 8px 16px;
            background-color: var(--negro-claro);
            color: var(--gris-claro);
            border: 1px solid var(--gris-texto);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .floor-btn.active {
            background-color: var(--verde-medio);
            color: white;
            border-color: var(--verde-medio);
        }

        .floor-map {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .salon {
            background-color: var(--negro-claro);
            border: 2px solid var(--verde-medio);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .salon:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .salon.ocupado {
            border-color: var(--ocupado);
            background-color: rgba(255, 193, 7, 0.1);
        }

        .salon.destacado {
            border-color: var(--amarillo-medio);
            box-shadow: 0 0 10px var(--amarillo-medio);
            transform: scale(1.05);
        }

        .salon.oculto {
            display: none;
        }

        .salon-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .salon-title {
            font-weight: 600;
            font-size: 18px;
        }

        .salon-capacity {
            font-size: 14px;
            color: var(--gris-texto);
        }

        .salon-content {
            max-height: 200px;
            overflow-y: auto;
        }

        .tabla-calendario {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .tabla-calendario th {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 5px;
            text-align: left;
            color: var(--verde-claro);
        }

        .tabla-calendario td {
            padding: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dia-calendario {
            margin-bottom: 15px;
        }

        .dia-calendario h4 {
            margin-bottom: 5px;
            color: var(--verde-claro);
        }

        .report-section {
            background-color: rgba(30, 30, 30, 0.7);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 209, 197, 0.2);
        }

        .report-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
        }

        .view-btn {
            padding: 8px 12px;
            background-color: var(--negro-claro);
            color: var(--gris-claro);
            border: 1px solid var(--gris-texto);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-btn.active {
            background-color: var(--verde-medio);
            color: white;
            border-color: var(--verde-medio);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background-color: var(--negro-claro);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--verde-oscuro), var(--verde-medio));
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }

        .card-content h3 {
            font-size: 24px;
            margin-bottom: 5px;
            color: var(--verde-claro);
        }

        .card-content p {
            color: var(--gris-texto);
            font-size: 14px;
        }

        .table-container {
            overflow-x: auto;
        }

        .assignment-table {
            width: 100%;
            border-collapse: collapse;
        }

        .assignment-table th {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 12px;
            text-align: left;
            color: var(--verde-claro);
            border-bottom: 2px solid var(--verde-medio);
        }

        .assignment-table td {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .estado-asignado {
            color: var(--disponible);
            font-weight: 600;
        }

        .estado-laboratorio {
            color: var(--amarillo-medio);
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--negro-claro);
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            color: var(--blanco);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gris-texto);
        }

        .modal-header h3 {
            color: var(--verde-claro);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            color: var(--gris-texto);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--blanco);
        }

        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid var(--gris-texto);
        }

        .grupos-guardados-section {
            margin-bottom: 20px;
        }

        .grupos-guardados-section h4 {
            color: var(--verde-claro);
            margin-bottom: 10px;
        }

        .grupos-guardados-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .grupo-guardado-tag {
            background-color: var(--verde-medio);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .grupo-guardado-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .search-container {
            margin-bottom: 15px;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            padding: 8px 12px 8px 35px;
            background-color: var(--negro);
            color: var(--gris-claro);
            border: 1px solid var(--gris-texto);
            border-radius: 5px;
            width: 100%;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            color: var(--gris-texto);
        }

        .grupos-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--gris-texto);
            border-radius: 5px;
            padding: 10px;
            background-color: var(--negro);
        }

        .grupo-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .grupo-checkbox-item:last-child {
            border-bottom: none;
        }

        .grupo-checkbox-item input {
            margin-right: 10px;
        }

        .grupos-divididos-section {
            background-color: rgba(30, 30, 30, 0.7);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 209, 197, 0.2);
        }

        .grupos-divididos-header {
            margin-bottom: 20px;
        }

        .grupos-divididos-header h3 {
            color: var(--verde-claro);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grupos-divididos-subtitle {
            color: var(--gris-texto);
            font-size: 14px;
        }

        .grupos-divididos-lista {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .grupo-dividido-item {
            background-color: var(--negro-claro);
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--amarillo-medio);
        }

        .grupo-dividido-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .grupo-id {
            font-weight: 600;
            color: var(--verde-claro);
        }

        .division-arrow {
            color: var(--amarillo-medio);
        }

        .salones-division {
            color: var(--gris-claro);
        }

        .grupo-dividido-detalles {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .salon-detalle {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .salon-nombre {
            font-weight: 600;
            color: var(--verde-claro);
        }

        .salon-dias {
            color: var(--gris-texto);
        }

        .sin-grupos-divididos {
            background-color: rgba(30, 30, 30, 0.7);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 209, 197, 0.2);
            text-align: center;
        }

        .mensaje-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .mensaje-content i {
            font-size: 48px;
            color: var(--verde-medio);
        }

        .mensaje-content h3 {
            color: var(--verde-claro);
        }

        .mensaje-content p {
            color: var(--gris-texto);
        }

        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                max-width: 100%;
                padding: 20px;
            }

            .sidebar {
                left: -250px;
            }

            .sidebar.active {
                left: 0;
            }

            .sidebar-overlay.active {
                display: block;
            }

            .view-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .search-salon-input {
                width: 100%;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
</head>

<body>
    <div class="principal-wrapper">
        <header class="principal-header">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-logos">
                    <img src="https://i.postimg.cc/905yLP2k/logo-uabc-fca.webp" alt="Logo UABC FCA"
                        class="logo-uabc-fca">
                </div>
                <div class="header-info">
                    <div class="system-title">Sistema de Asignación de Salones</div>
                    <div class="faculty-name">UABC</div>
                </div>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">Usuario</span>
                    <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
                </div>
            </div>
        </header>

        <div class="main-layout">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <img src="https://i.postimg.cc/Znt6wPm1/logo-lide.webp" alt="Logo LIDE" class="sidebar-logo">
                    <span class="sidebar-title">Sistema de Gestión</span>
                </div>
                <nav class="sidebar-nav">
                    <a href="#" class="sidebar-link active" onclick="loadSection('asignacion')">
                        <i class="fas fa-home"></i>
                        <span>Asignación</span>
                    </a>
                    <a href="#" class="sidebar-link" onclick="loadSection('visualizacion')">
                        <i class="fas fa-th"></i>
                        <span>Visualización</span>
                    </a>
                    <a href="#" class="sidebar-link" onclick="loadSection('reportes')">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reportes</span>
                    </a>
                    <a href="#" class="sidebar-link" onclick="loadSection('configuracion')">
                        <i class="fas fa-cog"></i>
                        <span>Configuración</span>
                    </a>
                </nav>
                <div class="sidebar-footer">
                    <small style="color: var(--gris-texto);">Versión 2.0</small>
                </div>
            </aside>

            <div class="sidebar-overlay" id="sidebarOverlay"></div>

            <main class="main-content">
                <div id="content-section">
                    <!-- Sección de carga de archivos -->
                    <section class="file-upload-section">
                        <div class="section-header">
                            <h2><i class="fas fa-file-csv"></i> Carga de Archivos CSV</h2>
                        </div>
                        <div class="file-upload-controls">
                            <div class="file-upload-area" id="file-drop-area">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Arrastra y suelta los archivos aquí o haz clic para seleccionar</p>
                                <input type="file" id="input-archivos" multiple accept=".csv" class="file-input">
                                <div id="file-list" class="file-list"></div>
                            </div>
                            <button id="btn-procesar" class="btn btn-primary">
                                <i class="fas fa-cogs"></i> Procesar Archivos y Asignar Salones
                            </button>
                            <p class="help-text">Después del procesamiento, podrá buscar y seleccionar grupos
                                prioritarios para asignación en el piso 1</p>
                        </div>
                    </section>

                    <!-- Indicador de carga -->
                    <div id="indicador-carga" class="loading-indicator">
                        <div class="spinner"></div>
                        <p>Procesando archivos y asignando salones...</p>
                        <div class="progress-bar">
                            <div class="progress"></div>
                        </div>
                    </div>

                    <!-- Contenedor de notificaciones -->
                    <div id="contenedor-notificaciones" class="notifications-container"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal para selección de grupo prioritario -->
    <div id="modal-grupo-prioritario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-star"></i> Seleccionar Grupos Prioritarios</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Seleccione los grupos que tendrán <strong>OBLIGATORIA</strong> asignación en los salones del 1er piso
                    (cerca del elevador)</p>

                <!-- Grupos prioritarios guardados -->
                <div id="grupos-guardados-section" class="grupos-guardados-section" style="display: none;">
                    <h4>Grupos Prioritarios Guardados:</h4>
                    <div id="grupos-guardados-list" class="grupos-guardados-list">
                        <!-- Los grupos guardados se mostrarán aquí -->
                    </div>
                </div>

                <div class="search-container">
                    <div class="search-input-wrapper">
                        <input type="text" id="buscador-grupos" class="search-input" placeholder="Buscar grupo...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                </div>
                <div id="grupos-prioritarios-container" class="grupos-container">
                    <!-- Los checkboxes se agregarán dinámicamente aquí -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="btn-confirmar-prioridad" class="btn btn-primary">
                    <i class="fas fa-save"></i> Guardar Grupos Prioritarios y Asignar
                </button>
                <button id="btn-cancelar-prioridad" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // ============================================
        // MODELOS DE DATOS
        // ============================================

        class Clase {
            constructor(datos) {
                this.idUnico = datos.id_unico;
                this.codigoAsignatura = datos.codigo_asignatura;
                this.nombreAsignatura = datos.nombre_asignatura;
                this.maestro = datos.maestro;
                this.edificioActual = datos.edificio;
                this.salonActual = datos.salon;
                this.capacidadRequerida = parseInt(datos.capacidad);
                this.grupoId = datos.grupo;
                this.diaSemana = datos.dia_semana;
                this.horaInicio = datos.hora_inicio;
                this.horaFin = datos.hora_fin;
                this.duracionMin = parseInt(datos.duracion_min);
                this.modalidad = datos.modalidad;
                this.tipo = datos.tipo;

                // Extraer información del grupo
                if (this.grupoId && this.grupoId !== 'VIR' && this.grupoId.length >= 3) {
                    const primerDigito = this.grupoId[0];
                    const mapaCarrera = {
                        '2': 200,
                        '3': 300,
                        '4': 400,
                        '5': 500,
                        '6': 600,
                        '9': 900
                    };

                    this.carrera = mapaCarrera[primerDigito] || parseInt(primerDigito) * 100;

                    const s = parseInt(this.grupoId[1]);
                    const n = parseInt(this.grupoId[2]);
                    this.semestre = Number.isInteger(s) ? s : null;
                    this.numeroGrupo = Number.isInteger(n) ? n : null;
                } else {
                    this.carrera = null;
                    this.semestre = null;
                    this.numeroGrupo = null;
                }
            }
        }

        class Grupo {
            constructor(id, carrera, semestre, numero, cantidadAlumnos, tieneDiscapacidad = false) {
                this.id = id;
                this.carrera = carrera;
                this.semestre = semestre;
                this.numero = numero;
                this.cantidadAlumnos = cantidadAlumnos;
                this.tieneDiscapacidad = tieneDiscapacidad;
                this.salonAsignado = null;
            }
        }

        class Horario {
            constructor(horaInicio, horaFin) {
                this.horaInicio = horaInicio;
                this.horaFin = horaFin;
            }
        }

        class Salon {
            constructor(id, edificio, piso, capacidad, accesible = false) {
                this.id = id;
                this.edificio = edificio;
                this.piso = piso;
                this.capacidad = capacidad;
                this.accesible = accesible;
                this.horariosOcupados = [];
                this.asignacionesBloques = [];
                this.grupoAsignadoFijo = null;
            }

            estaDisponible(horario, dia) {
                return !this.horariosOcupados.some(h =>
                    h.dia === dia && this.horariosSeSuperponen(h.horario, horario)
                );
            }

            horariosSeSuperponen(horario1, horario2) {
                const inicio1 = this.convertirHoraAMinutos(horario1.horaInicio);
                const fin1 = this.convertirHoraAMinutos(horario1.horaFin);
                const inicio2 = this.convertirHoraAMinutos(horario2.horaInicio);
                const fin2 = this.convertirHoraAMinutos(horario2.horaFin);

                return inicio1 < fin2 && fin1 > inicio2;
            }

            convertirHoraAMinutos(hora) {
                const [horas, minutos] = hora.split(':').map(Number);
                return horas * 60 + minutos;
            }

            ocupar(dia, horario, grupoId) {
                this.agregarHorarioOcupado(dia, horario, grupoId);
                this.agregarAsignacionBloque({
                    grupoId: grupoId,
                    dia: dia,
                    horario: horario,
                    bloque: 'Asignado'
                });
            }

            agregarHorarioOcupado(dia, horario, grupoId) {
                const existe = this.horariosOcupados.some(h =>
                    h.dia === dia &&
                    h.horario.horaInicio === horario.horaInicio &&
                    h.horario.horaFin === horario.horaFin
                );
                if (!existe) {
                    this.horariosOcupados.push({ dia, horario, grupoId });
                }
            }

            agregarAsignacionBloque(asignacion) {
                const existe = this.asignacionesBloques.some(asig =>
                    asig.grupoId === asignacion.grupoId &&
                    asig.dia === asignacion.dia &&
                    asig.bloque === asignacion.bloque &&
                    asig.horario.horaInicio === asignacion.horario.horaInicio &&
                    asig.horario.horaFin === asignacion.horario.horaFin
                );
                if (!existe) {
                    this.asignacionesBloques.push(asignacion);
                }
            }

            liberarHorarios(grupoId) {
                this.horariosOcupados = this.horariosOcupados.filter(h => h.grupoId !== grupoId);
                this.asignacionesBloques = this.asignacionesBloques.filter(asig => asig.grupoId !== grupoId);
                if (this.grupoAsignadoFijo === grupoId) {
                    this.grupoAsignadoFijo = null;
                }
            }
        }

        // ============================================
        // CONFIGURACIÓN
        // ============================================

        const CONFIG = {
            validaciones: {
                accesibilidad: {
                    habilitado: true,
                    pisoRequerido: 1,
                    mensaje: "ACCESIBILIDAD: El grupo {grupo} requiere un salón en primer piso"
                },
                capacidad: {
                    habilitado: true,
                    margenExceso: 0,
                    mensaje: "CAPACIDAD: El grupo excede la capacidad del salón. Alumnos: {alumnos}, Capacidad: {capacidad}"
                },
                prioridadPiso: {
                    habilitado: true,
                    reglas: [
                        { semestres: [1, 2], pisoPreferido: 4, obligatorio: true },
                        { semestres: [6, 7, 8], pisoMaximo: 2, obligatorio: true }
                    ],
                    mensaje: "PRIORIDAD_PISO: Los grupos de {semestre}° semestre deben asignarse al {piso} piso"
                },
                distanciaEdificios: {
                    habilitado: true,
                    edificioPreferido: 'F',
                    pesoDistancia: 0.1
                }
            },
            asignacion: {
                maxReintentos: 3,
                permitirReubicacion: true,
                estrategiaFallback: 'consistente',
                logDetallado: true
            },
            edificios: {
                F: { pisos: 4, salonesPorPiso: [4, 4, 4, 4] },
                E: { pisos: 4, salonesPorPiso: [6, 6, 6, 5] },
                D: { pisos: 4, salonesPorPiso: [6, 6, 6, 6] }
            },
            prioridades: {
                orden: ['prioritarios', 'semestre', 'tamano', 'dias'],
                semestre: { orden: 'ascendente' },
                tamano: { orden: 'descendente' }
            }
        };

        // ============================================
        // UTILIDADES
        // ============================================

        const ERRORES = {
            CHOQUE_HORARIO: "CHOQUE_HORARIO: El salón {salon} ya está ocupado en esta franja horaria",
            ACCESIBILIDAD: "ACCESIBILIDAD: El grupo {grupo} requiere un salón en primer piso",
            CAPACIDAD: "CAPACIDAD: El grupo excede la capacidad del salón. Alumnos: {alumnos}, Capacidad: {capacidad}",
            PRIORIDAD_PISO: "PRIORIDAD_PISO: Los grupos de {semestre}° semestre deben asignarse al {piso} piso",
            ARCHIVO_INVALIDO: "ARCHIVO_INVALIDO: El archivo debe ser CSV",
            CSV_INVALIDO: "CSV_INVALIDO: {motivo}",
            ARCHIVOS_INSUFICIENTES: "ARCHIVOS_INSUFICIENTES: Se requieren 5 archivos (uno por carrera)",
            ERROR_LECTURA: "ERROR_LECTURA: No se pudo leer el archivo",
            AUTENTICACION: "AUTENTICACION: Credenciales inválidas",
            PERMISO: "PERMISO: No tiene permisos para realizar esta acción"
        };

        function validarSalonParaGrupo(salon, grupo, horario) {
            // Verificar disponibilidad horaria
            if (!salon.estaDisponible(horario)) {
                throw new Error(ERRORES.CHOQUE_HORARIO.replace('{salon}', salon.id));
            }

            // Verificar accesibilidad
            if (grupo.tieneDiscapacidad && salon.piso !== 1) {
                throw new Error(ERRORES.ACCESIBILIDAD.replace('{grupo}', grupo.id));
            }

            // Verificar capacidad
            if (grupo.cantidadAlumnos > salon.capacidad) {
                throw new Error(ERRORES.CAPACIDAD
                    .replace('{alumnos}', grupo.cantidadAlumnos)
                    .replace('{capacidad}', salon.capacidad));
            }

            // Verificar prioridad de piso
            if ((grupo.semestre === 1 || grupo.semestre === 2) && salon.piso !== 4) {
                throw new Error(ERRORES.PRIORIDAD_PISO
                    .replace('{semestre}', grupo.semestre)
                    .replace('{piso}', '4to'));
            }

            if (grupo.semestre >= 6 && salon.piso > 2) {
                throw new Error(ERRORES.PRIORIDAD_PISO
                    .replace('{semestre}', grupo.semestre)
                    .replace('{piso}', 'primeros'));
            }
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            const contenedor = document.getElementById('contenedor-notificaciones');
            if (!contenedor) return;

            const notificacion = document.createElement('div');
            notificacion.className = `notification notification-${tipo}`;
            notificacion.textContent = mensaje;

            contenedor.appendChild(notificacion);

            // Auto-eliminar después de 5 segundos
            setTimeout(() => {
                notificacion.remove();
            }, 5000);
        }

        function mostrarIndicadorCarga(mostrar) {
            const indicador = document.getElementById('indicador-carga');
            if (mostrar) {
                indicador.style.display = 'flex';
                // Simular progreso
                let progreso = 0;
                const intervalo = setInterval(() => {
                    progreso += Math.random() * 10;
                    if (progreso >= 90) {
                        clearInterval(intervalo);
                        progreso = 90;
                    }
                    document.querySelector('.progress').style.width = `${progreso}%`;
                }, 500);
            } else {
                indicador.style.display = 'none';
                document.querySelector('.progress').style.width = '0%';
            }
        }

        function procesarArchivoCSV(archivo) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const contenido = e.target.result;
                        validarEstructuraCSV(contenido, archivo.name);
                        const datos = parsearCSV(contenido);
                        resolve(datos);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = () => reject(new Error('ERROR_LECTURA: No se pudo leer el archivo'));
                reader.readAsText(archivo);
            });
        }

        function validarEstructuraCSV(contenido, fileName) {
            const lineas = contenido.split('\n').filter(linea => linea.trim() !== '');
            if (lineas.length < 2) {
                throw new Error(`CSV_INVALIDO: El archivo "${fileName}" debe contener al menos una fila de datos`);
            }

            const encabezados = lineas[0].split(',').map(h => h.trim());
            const encabezadosRequeridos = [
                'id_unico', 'codigo_asignatura', 'nombre_asignatura', 'maestro',
                'edificio', 'salon', 'capacidad', 'grupo', 'dia_semana',
                'hora_inicio', 'hora_fin', 'duracion_min', 'modalidad', 'tipo'
            ];

            for (const encabezado of encabezadosRequeridos) {
                if (!encabezados.includes(encabezado)) {
                    throw new Error(`CSV_INVALIDO: Falta el encabezado requerido "${encabezado}" en el archivo "${fileName}"`);
                }
            }

            // Validar formato de cada fila
            for (let i = 1; i < lineas.length; i++) {
                const fila = lineas[i].split(',').map(c => c.trim());
                if (fila.length !== encabezados.length) {
                    throw new Error(`CSV_INVALIDO: La fila ${i} del archivo "${fileName}" tiene un número incorrecto de columnas`);
                }

                // Validar formato de id_unico (número)
                if (!fila[0].match(/^\d+$/)) {
                    throw new Error(`CSV_INVALIDO: Formato de id_unico inválido en fila ${i} del archivo "${fileName}"`);
                }

                // Validar formato de capacidad (número)
                if (!fila[6].match(/^\d+$/)) {
                    throw new Error(`CSV_INVALIDO: Formato de capacidad inválido en fila ${i} del archivo "${fileName}"`);
                }

                // Validar formato de grupo (número de 3 dígitos o "VIR")
                if (!fila[7].match(/^\d{3}$/) && fila[7] !== 'VIR') {
                    throw new Error(`CSV_INVALIDO: Formato de grupo inválido en fila ${i} del archivo "${fileName}"`);
                }

                // Validar formato de hora (HH:MM)
                if (!fila[9].match(/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/) ||
                    !fila[10].match(/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/)) {
                    throw new Error(`CSV_INVALIDO: Formato de hora inválido en fila ${i} del archivo "${fileName}"`);
                }

                // Validar modalidad (Presencial o Virtual)
                if (!['Presencial', 'Virtual'].includes(fila[12])) {
                    throw new Error(`CSV_INVALIDO: Modalidad inválida en fila ${i} del archivo "${fileName}"`);
                }
            }
        }

        function parsearCSV(contenido) {
            const lineas = contenido.split('\n').filter(linea => linea.trim() !== '');
            const encabezados = lineas[0].split(',').map(h => h.trim());
            const datos = [];

            for (let i = 1; i < lineas.length; i++) {
                const valores = lineas[i].split(',').map(v => v.trim());
                const fila = {};

                encabezados.forEach((encabezado, index) => {
                    fila[encabezado] = valores[index];
                });

                datos.push(fila);
            }

            return datos;
        }

        function radixSortClases(clases, gruposPrioritarios = []) {
            const gruposPrioritariosSet = new Set(gruposPrioritarios);

            clases.forEach(clase => {
                let prioridadBase = 3;

                if (gruposPrioritariosSet.has(clase.grupoId)) {
                    prioridadBase = 0;
                } else if (clase.semestre === 1 || clase.semestre === 2) {
                    prioridadBase = 1;
                } else if (clase.semestre >= 6) {
                    prioridadBase = 2;
                }

                clase.prioridad = prioridadBase;

                const diaNum = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo']
                    .indexOf(clase.diaSemana) + 1;
                const horaNum = parseInt(clase.horaInicio.replace(':', ''));

                clase.claveRadix =
                    clase.prioridad * 1000000000000 +
                    (1000000000 - clase.capacidadRequerida) * 1000000 +
                    diaNum * 10000 +
                    horaNum;
            });

            const maxClave = Math.max(...clases.map(c => c.claveRadix || 0));
            const maxDigitos = Math.floor(Math.log10(Math.max(maxClave, 1))) + 1;

            for (let digito = 0; digito < maxDigitos; digito++) {
                const buckets = Array.from({ length: 10 }, () => []);

                for (const clase of clases) {
                    const clave = clase.claveRadix || 0;
                    const digitoActual = Math.floor(clave / Math.pow(10, digito)) % 10;
                    buckets[digitoActual].push(clase);
                }

                clases = buckets.flat();
            }

            const prioritarios = clases.filter(c => gruposPrioritariosSet.has(c.grupoId));
            const noPrioritarios = clases.filter(c => !gruposPrioritariosSet.has(c.grupoId));

            return [...prioritarios, ...noPrioritarios];
        }

        // ============================================
        // SISTEMA DE ASIGNACIÓN
        // ============================================

        class SistemaAsignacion {
            constructor() {
                this.salones = [];
                this.grupos = new Map();
                this.clases = [];
                this.asignaciones = [];
                this.errores = [];
                this.clasesLaboratorio = [];
                this.clasesVirtuales = [];
                this.clasesPorGrupoDia = new Map();
                this.todasLasClasesPorGrupoDia = new Map();

                this.materiasLaboratorioTroncoComun = {
                    1: ["38973"],
                    2: ["38982"]
                };

                this.materiasLaboratorioLNI = {
                    3: ["38984", "39038", "39039", "39040", "39041", "39042"],
                    4: ["39043", "39044", "39047", "50600", "50601"],
                    5: ["39048", "39049", "39050", "39051", "39058"],
                    6: ["39056", "39052", "13595"],
                    7: ["39060", "39062", "39061", "39063", "50602"],
                    8: ["39067", "39068", "39076", "39083", "39088"]
                };

                this.materiasLaboratorioLC = {
                    6: ["39025"],
                    7: ["39009"],
                    8: ["39014"]
                };

                this.materiasLaboratorioLAE = {
                    4: ["40309"]
                };
            }

            inicializarSalones() {
                for (const [edificio, config] of Object.entries(CONFIG.edificios)) {
                    const { pisos, salonesPorPiso } = config;
                    for (let piso = 1; piso <= pisos; piso++) {
                        const cantidad = salonesPorPiso[piso - 1];
                        this.crearSalonesPorPiso(edificio, piso, cantidad);
                    }
                }
            }

            crearSalonesPorPiso(edificio, piso, cantidad) {
                for (let i = 1; i <= cantidad; i++) {
                    const id = `${edificio}-${piso}${i.toString().padStart(2, '0')}`;
                    const accesible = piso === 1;
                    this.salones.push(new Salon(id, edificio, piso, 40, accesible));
                }
            }

            async procesarMultiplesArchivos(archivos) {
                try {
                    const archivosArray = Array.from(archivos);

                    if (archivosArray.length !== 5) {
                        throw new Error('ARCHIVOS_INSUFICIENTES: Se requieren 5 archivos (uno por carrera)');
                    }

                    await Promise.all(archivosArray.map(archivo => this.procesarArchivoIndividual(archivo)));

                    return {
                        exito: true,
                        mensaje: `Procesamiento completado. ${this.clases.length} clases procesadas.`,
                        clases: this.clases
                    };
                } catch (error) {
                    return {
                        exito: false,
                        mensaje: error.message
                    };
                }
            }

            async procesarArchivoIndividual(archivo) {
                const datosCSV = await procesarArchivoCSV(archivo);

                for (const fila of datosCSV) {
                    try {
                        const clase = new Clase(fila);
                        this.procesarClase(clase);
                    } catch (error) {
                        this.errores.push({
                            clase: fila,
                            mensaje: `Error procesando fila: ${error.message}`
                        });
                    }
                }
            }

            procesarClase(clase) {
                const tipoLaboratorio = this.esMateriaLaboratorio(clase);

                if (tipoLaboratorio) {
                    this.procesarClaseLaboratorio(clase, tipoLaboratorio);
                } else if (clase.modalidad === 'Virtual') {
                    this.procesarClaseVirtual(clase);
                } else {
                    this.procesarClasePresencial(clase);
                }

                this.agregarClaseATodasLasClasesPorGrupoDia(clase);
            }

            procesarClaseLaboratorio(clase, tipoLaboratorio) {
                this.clasesLaboratorio.push({
                    clase,
                    tipo: tipoLaboratorio,
                    motivo: clase._motivoLaboratorio || 'codigo',
                    mensaje: `${clase.diaSemana} ${clase.horaInicio} - ${clase.horaFin}`
                });
            }

            procesarClaseVirtual(clase) {
                this.clasesVirtuales.push({
                    clase,
                    mensaje: 'Clase virtual - no requiere salón'
                });
            }

            procesarClasePresencial(clase) {
                this.clases.push(clase);

                if (!this.grupos.has(clase.grupoId)) {
                    this.grupos.set(clase.grupoId, new Grupo(
                        clase.grupoId,
                        clase.carrera,
                        clase.semestre,
                        clase.numeroGrupo,
                        clase.capacidadRequerida
                    ));
                } else {
                    const grupo = this.grupos.get(clase.grupoId);
                    if (clase.capacidadRequerida > grupo.cantidadAlumnos) {
                        grupo.cantidadAlumnos = clase.capacidadRequerida;
                    }
                }

                const clave = `${clase.grupoId}-${clase.diaSemana}`;
                if (!this.clasesPorGrupoDia.has(clave)) {
                    this.clasesPorGrupoDia.set(clave, []);
                }
                this.clasesPorGrupoDia.get(clave).push(clase);
            }

            agregarClaseATodasLasClasesPorGrupoDia(clase) {
                const clave = `${clase.grupoId}-${clase.diaSemana}`;

                if (!this.todasLasClasesPorGrupoDia.has(clave)) {
                    this.todasLasClasesPorGrupoDia.set(clave, []);
                }

                this.todasLasClasesPorGrupoDia.get(clave).push(clase);
            }

            esMateriaLaboratorio(clase) {
                if (!clase.semestre) return null;

                if (this.materiasLaboratorioTroncoComun[clase.semestre]?.includes(clase.codigoAsignatura)) {
                    clase._motivoLaboratorio = 'carrera';
                    return 'Tronco Común';
                }

                if (this.materiasLaboratorioLNI[clase.semestre]?.includes(clase.codigoAsignatura)) {
                    clase._motivoLaboratorio = 'codigo';
                    return 'LIN';
                }

                if (this.materiasLaboratorioLC[clase.semestre]?.includes(clase.codigoAsignatura)) {
                    clase._motivoLaboratorio = 'codigo';
                    return 'LC';
                }

                if (this.materiasLaboratorioLAE[clase.semestre]?.includes(clase.codigoAsignatura)) {
                    clase._motivoLaboratorio = 'codigo';
                    return 'LAE';
                }

                return null;
            }

            ordenarClasesConPrioridades(gruposPrioritarios = []) {
                this.clases = radixSortClases(this.clases, gruposPrioritarios);
                this.reconstruirClasesPorGrupoDia();
                return this.clases;
            }

            reconstruirClasesPorGrupoDia() {
                this.clasesPorGrupoDia = new Map();

                this.clases.forEach(clase => {
                    const clave = `${clase.grupoId}-${clase.diaSemana}`;

                    if (!this.clasesPorGrupoDia.has(clave)) {
                        this.clasesPorGrupoDia.set(clave, []);
                    }

                    this.clasesPorGrupoDia.get(clave).push(clase);
                });
            }

            generarReporte(gruposDivididos = null) {
                return {
                    resumen: {
                        totalClases: this.clases.length + this.clasesVirtuales.length + this.clasesLaboratorio.length,
                        clasesPresenciales: this.clases.length,
                        clasesVirtuales: this.clasesVirtuales.length,
                        clasesLaboratorio: this.clasesLaboratorio.length,
                        asignadas: this.asignaciones.length,
                        errores: this.errores.length,
                        gruposDivididos: gruposDivididos ? gruposDivididos.size : 0
                    },
                    detalleAsignacionesBloques: this.generarDetalleAsignacionesBloques(),
                    detalleAsignaciones: this.asignaciones.map(a => ({
                        clase: a.clase.nombreAsignatura,
                        grupo: a.clase.grupoId,
                        salon: a.salon ? a.salon.id : 'Virtual',
                        dia: a.clase.diaSemana,
                        horario: `${a.clase.horaInicio} - ${a.clase.horaFin}`
                    })),
                    detalleErrores: this.errores.map(e => ({
                        clase: e.clase.nombreAsignatura,
                        grupo: e.clase.grupoId,
                        error: e.mensaje
                    })),
                    detalleLaboratorio: this.clasesLaboratorio.map(c => ({
                        clase: c.clase.nombreAsignatura,
                        grupo: c.clase.grupoId,
                        tipo: c.tipo,
                        motivo: c.motivo || (c.clase && c.clase._motivoLaboratorio) || 'desconocido',
                        semestre: c.clase.semestre,
                        carrera: c.clase.carrera,
                        salon: c.clase.salonActual || 'No asignado',
                        mensaje: c.mensaje
                    })),
                    detalleVirtuales: this.clasesVirtuales.map(c => ({
                        clase: c.clase.nombreAsignatura,
                        grupo: c.clase.grupoId,
                        mensaje: c.mensaje
                    })),
                    detalleGruposDivididos: gruposDivididos ? this.generarDetalleGruposDivididos(gruposDivididos) : []
                };
            }

            generarDetalleAsignacionesBloques() {
                const detalle = [];

                this.salones.forEach(salon => {
                    if (salon.asignacionesBloques) {
                        salon.asignacionesBloques.forEach(asig => {
                            const clave = `${asig.grupoId}-${asig.dia}`;
                            const clasesGrupoDia = this.clasesPorGrupoDia.get(clave) || [];
                            const asignaturas = clasesGrupoDia.map(c => c.nombreAsignatura).join(', ');

                            detalle.push({
                                salon: salon.id,
                                dia: asig.dia,
                                horario: `${asig.horario.horaInicio} - ${asig.horario.horaFin}`,
                                grupo: asig.grupoId,
                                asignaturas
                            });
                        });
                    }
                });

                return detalle;
            }

            generarDetalleGruposDivididos(gruposDivididos) {
                const detalle = [];

                for (const [grupoId, info] of gruposDivididos) {
                    const salon1 = info.salones[0];
                    const salon2 = info.salones[1];
                    const dias1 = info.dias[salon1.id].join(', ');
                    const dias2 = info.dias[salon2.id].join(', ');

                    detalle.push({
                        grupo: grupoId,
                        salon1: salon1.id,
                        salon2: salon2.id,
                        edificio1: salon1.edificio,
                        edificio2: salon2.edificio,
                        piso1: salon1.piso,
                        piso2: salon2.piso,
                        dias1: dias1,
                        dias2: dias2,
                        distancia: this.calcularDistanciaSalones(salon1, salon2)
                    });
                }

                return detalle;
            }

            calcularDistanciaSalones(salon1, salon2) {
                if (salon1.edificio !== salon2.edificio) {
                    return `Edificios diferentes (${salon1.edificio} ↔ ${salon2.edificio})`;
                }

                if (salon1.piso !== salon2.piso) {
                    const diffPiso = Math.abs(salon1.piso - salon2.piso);
                    return `Mismo edificio, ${diffPiso} piso(s) de diferencia`;
                }

                const num1 = parseInt(salon1.id.replace(/^\w-/, ''));
                const num2 = parseInt(salon2.id.replace(/^\w-/, ''));
                const diffNum = Math.abs(num1 - num2);

                if (diffNum === 0) {
                    return 'Mismo salón';
                } else if (diffNum <= 2) {
                    return 'Muy cercano (≤2 salones)';
                } else if (diffNum <= 5) {
                    return 'Cercano (≤5 salones)';
                } else {
                    return 'Distante (>5 salones)';
                }
            }

            reservarSalonParaGrupo(salon, grupo) {
                if (!this.grupos.has(grupo.id)) {
                    throw new Error(`Grupo ${grupo.id} no encontrado`);
                }

                salon.grupoAsignadoFijo = grupo.id;

                const diasGrupo = this.obtenerDiasGrupo(grupo.id);

                diasGrupo.forEach(dia => {
                    const bloque = this.obtenerBloqueGrupoDia(grupo.id, dia);
                    if (bloque) {
                        const horario = new Horario(bloque.inicio, bloque.fin);
                        salon.ocupar(dia, horario, grupo.id);
                    }
                });
            }

            obtenerDiasGrupo(grupoId) {
                const dias = new Set();
                for (const [clave] of this.clasesPorGrupoDia.entries()) {
                    if (clave.startsWith(`${grupoId}-`)) {
                        const dia = clave.split('-')[1];
                        dias.add(dia);
                    }
                }
                return dias;
            }

            obtenerBloqueGrupoDia(grupoId, dia) {
                const clave = `${grupoId}-${dia}`;
                const clases = this.clasesPorGrupoDia.get(clave) || [];

                if (clases.length === 0) return null;

                let horaInicioMin = '23:59';
                let horaFinMax = '00:00';

                clases.forEach(clase => {
                    if (clase.horaInicio < horaInicioMin) horaInicioMin = clase.horaInicio;
                    if (clase.horaFin > horaFinMax) horaFinMax = clase.horaFin;
                });

                return {
                    nombre: 'Horario Grupo',
                    inicio: horaInicioMin,
                    fin: horaFinMax,
                    bloqueOriginal: null
                };
            }

            salonDisponibleParaTodasLasClases(salon, grupo) {
                const diasGrupo = this.obtenerDiasGrupo(grupo.id);

                for (const dia of diasGrupo) {
                    const bloque = this.obtenerBloqueGrupoDia(grupo.id, dia);
                    if (bloque) {
                        const horario = new Horario(bloque.inicio, bloque.fin);
                        try {
                            validarSalonParaGrupo(salon, grupo, horario);
                        } catch (error) {
                            return false;
                        }
                    }
                }

                return true;
            }

            liberarSalonParaGrupo(salon, grupoId) {
                if (salon.grupoAsignadoFijo === grupoId) {
                    salon.grupoAsignadoFijo = null;
                }

                salon.horariosOcupados = salon.horariosOcupados.filter(h => h.grupoId !== grupoId);
                salon.asignacionesBloques = salon.asignacionesBloques.filter(asig => asig.grupoId !== grupoId);
            }
        }

        class AsignadorAutomatico {
            constructor(sistema, gruposPrioritarios = []) {
                this.sistema = sistema;
                this.gruposPrioritarios = Array.isArray(gruposPrioritarios) ? gruposPrioritarios : [gruposPrioritarios].filter(g => g);
                this.gruposDivididos = new Map();
            }

            asignarSalones() {
                console.log("Iniciando asignación de salones por grupo...");
                console.log(`Total de clases a asignar: ${this.sistema.clases.length}`);

                const gruposUnicos = this.obtenerGruposOrdenadosPorPrioridad();
                console.log(`Grupos únicos ordenados: ${gruposUnicos.join(', ')}`);

                for (const grupoId of gruposUnicos) {
                    const grupo = this.sistema.grupos.get(grupoId);

                    console.log(`Asignando salón para grupo ${grupoId}`);

                    try {
                        const horariosOcupados = this.calcularHorariosOcupadosPorGrupo(grupoId);

                        if (horariosOcupados.length === 0) {
                            console.log(`Grupo ${grupoId} no tiene clases presenciales`);
                            continue;
                        }

                        let salon = this.buscarSalonDisponibleParaHorarios(grupo, horariosOcupados);

                        if (salon) {
                            console.log(`Asignando salón ${salon.id} al grupo ${grupoId} para toda la semana`);
                            this.asignarSalonAGrupo(grupo, salon, horariosOcupados);
                        } else {
                            console.log(`No hay salón disponible para toda la semana para grupo ${grupoId}, intentando dividir en dos salones`);
                            const asignacionDividida = this.intentarAsignacionDividida(grupo, horariosOcupados);

                            if (asignacionDividida) {
                                console.log(`Grupo ${grupoId} dividido exitosamente en dos salones`);
                            } else {
                                console.log(`No se pudo asignar salón para grupo ${grupoId} ni dividido`);
                                const clasesGrupo = this.sistema.clases.filter(c => c.grupoId === grupoId);
                                clasesGrupo.forEach(clase => {
                                    this.sistema.errores.push({
                                        clase,
                                        mensaje: `No hay salones disponibles para el grupo`
                                    });
                                });
                            }
                        }

                    } catch (error) {
                        console.error(`Error al asignar salón para grupo ${grupoId}:`, error.message);
                        const clasesGrupo = this.sistema.clases.filter(c => c.grupoId === grupoId);
                        clasesGrupo.forEach(clase => {
                            this.sistema.errores.push({
                                clase,
                                mensaje: error.message
                            });
                        });
                    }
                }

                this.asignarSalonesALaboratorios();

                this.ajustarGruposMananaAPisoBajo();

                console.log("Asignación de salones por grupo completada");
                console.log(`Total de asignaciones: ${this.sistema.asignaciones.length}`);
                console.log(`Total de errores: ${this.sistema.errores.length}`);
                console.log(`Grupos divididos en dos salones: ${this.gruposDivididos.size}`);

                if (this.gruposDivididos.size > 0) {
                    console.log("=== GRUPOS DIVIDIDOS EN DOS SALONES ===");
                    for (const [grupoId, info] of this.gruposDivididos) {
                        const salon1 = info.salones[0].id;
                        const salon2 = info.salones[1].id;
                        const dias1 = info.dias[salon1.id].join(', ');
                        const dias2 = info.dias[salon2.id].join(', ');
                        console.log(`Grupo ${grupoId}: ${salon1} (${dias1}) / ${salon2} (${dias2})`);
                    }
                }
            }

            get salonesCercaElevador() {
                return this.sistema.salones.filter(salon => salon.piso === 1);
            }

            grupoTieneHorarioTemprano(grupoId) {
                const clasesGrupo = this.sistema.clases.filter(c => c.grupoId === grupoId);
                const horasTempranas = ['07:00', '08:00', '09:00'];

                return clasesGrupo.some(clase => horasTempranas.includes(clase.horaInicio));
            }

            obtenerGruposOrdenadosPorPrioridad() {
                const gruposUnicos = Array.from(new Set(this.sistema.clases.map(clase => clase.grupoId)));

                return gruposUnicos.sort((a, b) => {
                    const grupoA = this.sistema.grupos.get(a);
                    const grupoB = this.sistema.grupos.get(b);

                    const aTemprano = this.grupoTieneHorarioTemprano(a);
                    const bTemprano = this.grupoTieneHorarioTemprano(b);
                    if (aTemprano && !bTemprano) return -1;
                    if (!aTemprano && bTemprano) return 1;

                    const aEsPrioritario = this.gruposPrioritarios.includes(a);
                    const bEsPrioritario = this.gruposPrioritarios.includes(b);
                    if (aEsPrioritario && !bEsPrioritario) return -1;
                    if (!aEsPrioritario && bEsPrioritario) return 1;

                    if (grupoA && grupoB && grupoA.semestre !== grupoB.semestre) {
                        return grupoA.semestre - grupoB.semestre;
                    }

                    if (grupoA && grupoB) {
                        return grupoB.cantidadAlumnos - grupoA.cantidadAlumnos;
                    }

                    return a.localeCompare(b);
                });
            }

            calcularHorariosOcupadosPorGrupo(grupoId) {
                const clasesPresenciales = this.sistema.clases.filter(c => c.grupoId === grupoId);
                const horariosOcupados = [];

                clasesPresenciales.forEach(clase => {
                    horariosOcupados.push({
                        dia: clase.diaSemana,
                        horario: new Horario(clase.horaInicio, clase.horaFin)
                    });
                });

                return horariosOcupados;
            }

            buscarSalonDisponibleParaHorarios(grupo, horariosOcupados) {
                let salonesCandidatos = this.sistema.salones.filter(salon => {
                    try {
                        for (const horarioInfo of horariosOcupados) {
                            if (!this.salonDisponibleEnBloque(salon, grupo, horarioInfo.horario, horarioInfo.dia)) {
                                return false;
                            }
                        }
                        return true;
                    } catch (error) {
                        return false;
                    }
                });

                if (salonesCandidatos.length === 0) {
                    return null;
                }

                if (this.gruposPrioritarios.includes(grupo.id)) {
                    const salonesElevadorDisponibles = salonesCandidatos.filter(salon =>
                        this.salonesCercaElevador.some(salonElevador => salonElevador.id === salon.id)
                    );

                    if (salonesElevadorDisponibles.length > 0) {
                        salonesCandidatos = salonesElevadorDisponibles;
                    } else {
                        console.warn(`Grupo prioritario ${grupo.id} no pudo asignarse: no hay salones disponibles cerca del elevador`);
                        return null;
                    }
                }

                salonesCandidatos.sort((a, b) => {
                    const aLibre = !a.grupoAsignadoFijo;
                    const bLibre = !b.grupoAsignadoFijo;

                    if (aLibre && !bLibre) return -1;
                    if (!aLibre && bLibre) return 1;
                    return 0;
                });

                salonesCandidatos.sort((a, b) => {
                    const aLibre = !a.grupoAsignadoFijo;
                    const bLibre = !b.grupoAsignadoFijo;

                    if (aLibre === bLibre) {
                        const ajusteA = Math.abs(a.capacidad - grupo.cantidadAlumnos);
                        const ajusteB = Math.abs(b.capacidad - grupo.cantidadAlumnos);
                        return ajusteA - ajusteB;
                    }
                    return 0;
                });

                salonesCandidatos.sort((a, b) => {
                    const aLibre = !a.grupoAsignadoFijo;
                    const bLibre = !b.grupoAsignadoFijo;
                    const ajusteA = Math.abs(a.capacidad - grupo.cantidadAlumnos);
                    const ajusteB = Math.abs(b.capacidad - grupo.cantidadAlumnos);

                    if (aLibre === bLibre && ajusteA === ajusteB) {
                        return a.piso - b.piso;
                    }
                    return 0;
                });

                return salonesCandidatos[0];
            }

            asignarSalonAGrupo(grupo, salon, horariosOcupados, esAsignacionCompleta = true) {
                const diasHorarios = new Set(horariosOcupados.map(h => h.dia));
                const clasesGrupo = this.sistema.clases.filter(c => c.grupoId === grupo.id && diasHorarios.has(c.diaSemana));

                clasesGrupo.forEach(clase => {
                    const horarioClase = horariosOcupados.find(h => h.dia === clase.diaSemana &&
                        h.horario.horaInicio === clase.horaInicio && h.horario.horaFin === clase.horaFin);
                    if (horarioClase) {
                        clase.salonActual = salon.id;
                        clase.edificioActual = salon.edificio;

                        this.sistema.asignaciones.push({
                            clase,
                            salon,
                            bloque: 'Horario Específico',
                            mensaje: `Asignado: ${clase.nombreAsignatura} en ${salon.id} (${clase.horaInicio}-${clase.horaFin})`
                        });
                    }
                });

                horariosOcupados.forEach(horarioInfo => {
                    salon.ocupar(horarioInfo.dia, horarioInfo.horario, grupo.id);
                    console.log(`Salón ${salon.id} ocupado el ${horarioInfo.dia} de ${horarioInfo.horario.horaInicio} a ${horarioInfo.horario.horaFin}`);
                });

                if (esAsignacionCompleta) {
                    salon.grupoAsignadoFijo = grupo.id;
                }
            }

            asignarSalonesALaboratorios() {
                console.log("Procesando clases de laboratorio...");

                this.sistema.clasesLaboratorio.forEach(item => {
                    const clase = item.clase;
                    clase.salonActual = 'Laboratorio';
                    clase.edificioActual = 'N/A';

                    this.sistema.asignaciones.push({
                        clase,
                        salon: null,
                        bloque: 'Laboratorio',
                        mensaje: `Laboratorio: ${clase.nombreAsignatura} (${clase.horaInicio}-${clase.horaFin}) - No requiere salón`
                    });

                    console.log(`Clase de laboratorio registrada: ${clase.nombreAsignatura} del grupo ${clase.grupoId} (${item.tipo})`);
                });

                console.log(`Procesamiento de ${this.sistema.clasesLaboratorio.length} clases de laboratorio completado`);
            }

            intentarAsignacionDividida(grupo, horariosOcupados) {
                const diasUnicos = [...new Set(horariosOcupados.map(h => h.dia))].sort();

                if (diasUnicos.length < 2) {
                    return false;
                }

                const divisionesPosibles = this.generarDivisionesConsecutivas(diasUnicos);

                for (const { diasPrimeraParte, diasSegundaParte } of divisionesPosibles) {
                    const horariosPrimeraParte = horariosOcupados.filter(h => diasPrimeraParte.includes(h.dia));
                    const horariosSegundaParte = horariosOcupados.filter(h => diasSegundaParte.includes(h.dia));

                    const salonesDivididos = this.buscarSalonesCercanosParaDivision(grupo, horariosPrimeraParte, horariosSegundaParte);

                    if (salonesDivididos) {
                        const { salonPrimera, salonSegunda } = salonesDivididos;

                        this.asignarSalonAGrupo(grupo, salonPrimera, horariosPrimeraParte, false);
                        this.asignarSalonAGrupo(grupo, salonSegunda, horariosSegundaParte, false);

                        this.gruposDivididos.set(grupo.id, {
                            salones: [salonPrimera, salonSegunda],
                            dias: {
                                [salonPrimera.id]: diasPrimeraParte,
                                [salonSegunda.id]: diasSegundaParte
                            }
                        });

                        console.log(`Grupo ${grupo.id} dividido: ${diasPrimeraParte.join(',')} en ${salonPrimera.id}, ${diasSegundaParte.join(',')} en ${salonSegunda.id}`);

                        return true;
                    }
                }

                return false;
            }

            generarDivisionesConsecutivas(diasUnicos) {
                const divisiones = [];

                for (let i = 1; i < diasUnicos.length; i++) {
                    const diasPrimeraParte = diasUnicos.slice(0, i);
                    const diasSegundaParte = diasUnicos.slice(i);

                    if (this.sonDiasConsecutivos(diasPrimeraParte) && this.sonDiasConsecutivos(diasSegundaParte)) {
                        divisiones.push({ diasPrimeraParte, diasSegundaParte });
                    }
                }

                return divisiones;
            }

            sonDiasConsecutivos(dias) {
                if (dias.length <= 1) return true;

                const ordenDias = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                const indices = dias.map(dia => ordenDias.indexOf(dia)).sort((a, b) => a - b);

                for (let i = 1; i < indices.length; i++) {
                    if (indices[i] !== indices[i - 1] + 1) {
                        return false;
                    }
                }

                return true;
            }

            buscarSalonesCercanosParaDivision(grupo, horariosPrimeraParte, horariosSegundaParte) {
                const salonesPrimera = this.sistema.salones.filter(salon => {
                    try {
                        for (const horarioInfo of horariosPrimeraParte) {
                            if (!this.salonDisponibleEnBloque(salon, grupo, horarioInfo.horario, horarioInfo.dia)) {
                                return false;
                            }
                        }
                        return true;
                    } catch (error) {
                        return false;
                    }
                });

                const salonesSegunda = this.sistema.salones.filter(salon => {
                    try {
                        for (const horarioInfo of horariosSegundaParte) {
                            if (!this.salonDisponibleEnBloque(salon, grupo, horarioInfo.horario, horarioInfo.dia)) {
                                return false;
                            }
                        }
                        return true;
                    } catch (error) {
                        return false;
                    }
                });

                if (salonesPrimera.length === 0 || salonesSegunda.length === 0) {
                    return null;
                }

                let mejorCombinacion = null;
                let mejorPuntuacion = Infinity;

                for (const salonPrimero of salonesPrimera) {
                    for (const salonSegundo of salonesSegunda) {
                        const puntuacion = this.calcularPuntuacionProximidad(salonPrimero, salonSegundo);

                        if (puntuacion < mejorPuntuacion) {
                            if (salonPrimero.id === salonSegundo.id) {
                                const diasComunes = horariosPrimeraParte
                                    .map(h => h.dia)
                                    .filter(d => horariosSegundaParte.some(h2 => h2.dia === d));

                                if (diasComunes.length > 0) {
                                    let hayConflicto = false;
                                    for (const dia of diasComunes) {
                                        const horarioPrimera = horariosPrimeraParte.find(h => h.dia === dia);
                                        const horarioSegunda = horariosSegundaParte.find(h => h.dia === dia);
                                        if (horarioPrimera && horarioSegunda) {
                                            if (this.horariosSeSolapan(horarioPrimera.horario, horarioSegunda.horario)) {
                                                hayConflicto = true;
                                                break;
                                            }
                                        }
                                    }
                                    if (hayConflicto) continue;
                                }
                            }

                            mejorPuntuacion = puntuacion;
                            mejorCombinacion = { salonPrimera: salonPrimero, salonSegunda: salonSegundo };
                        }
                    }
                }

                return mejorCombinacion;
            }

            calcularPuntuacionProximidad(salon1, salon2) {
                let puntuacion = 0;

                if (salon1.edificio !== salon2.edificio) {
                    puntuacion += 1000;
                }

                if (salon1.piso !== salon2.piso) {
                    puntuacion += 100;
                }

                if (salon1.edificio === salon2.edificio) {
                    puntuacion += Math.abs(salon1.piso - salon2.piso) * 10;
                }

                if (salon1.edificio === salon2.edificio && salon1.piso === salon2.piso) {
                    const num1 = parseInt(salon1.id.replace(/^\w-/, ''));
                    const num2 = parseInt(salon2.id.replace(/^\w-/, ''));
                    puntuacion += Math.abs(num1 - num2);
                }

                return puntuacion;
            }

            horariosSeSolapan(horario1, horario2) {
                return horario1.horaInicio < horario2.horaFin && horario2.horaInicio < horario1.horaFin;
            }

            salonDisponibleEnBloque(salon, grupo, horario, dia) {
                if (salon.capacidad < grupo.cantidadAlumnos) {
                    return false;
                }

                return salon.estaDisponible(horario, dia);
            }

            ajustarGruposMananaAPisoBajo() {
                console.log("Realizando ajuste especial para grupos de mañana en pisos altos...");

                let intercambiosRealizados = 0;

                const gruposMananaPisosAltos = [];

                for (const grupoId of this.sistema.grupos.keys()) {
                    if (this.grupoTieneHorarioTemprano(grupoId)) {
                        const salonAsignado = this.encontrarSalonAsignadoAGrupo(grupoId);
                        if (salonAsignado && salonAsignado.piso >= 2 && salonAsignado.piso <= 4) {
                            gruposMananaPisosAltos.push({ grupoId, salon: salonAsignado });
                        }
                    }
                }

                console.log(`Encontrados ${gruposMananaPisosAltos.length} grupos de mañana en pisos altos`);

                for (const { grupoId: grupoMananaId, salon: salonAlto } of gruposMananaPisosAltos) {
                    const grupoManana = this.sistema.grupos.get(grupoMananaId);
                    const intercambioExitoso = this.intentarIntercambioConGrupoPisoBajo(grupoManana, salonAlto);

                    if (intercambioExitoso) {
                        intercambiosRealizados++;
                        console.log(`Intercambio exitoso para grupo ${grupoMananaId}: movido de piso ${salonAlto.piso} a piso bajo`);
                    }
                }

                console.log(`Ajuste especial completado: ${intercambiosRealizados} intercambios realizados`);
            }

            encontrarSalonAsignadoAGrupo(grupoId) {
                for (const salon of this.sistema.salones) {
                    if (salon.grupoAsignadoFijo === grupoId) {
                        return salon;
                    }
                }
                return null;
            }

            intentarIntercambioConGrupoPisoBajo(grupoManana, salonAlto) {
                for (const salonBajo of this.sistema.salones) {
                    if (salonBajo.piso === 1 && salonBajo.grupoAsignadoFijo) {
                        const grupoBajoId = salonBajo.grupoAsignadoFijo;
                        const grupoBajo = this.sistema.grupos.get(grupoBajoId);

                        if (this.puedeIntercambiarGrupos(grupoManana, salonAlto, grupoBajo, salonBajo)) {
                            this.realizarIntercambioGrupos(grupoManana, salonAlto, grupoBajo, salonBajo);
                            return true;
                        }
                    }
                }
                return false;
            }

            puedeIntercambiarGrupos(grupoA, salonA, grupoB, salonB) {
                if (salonA.capacidad < grupoB.cantidadAlumnos || salonB.capacidad < grupoA.cantidadAlumnos) {
                    return false;
                }

                const horariosA = this.calcularHorariosOcupadosPorGrupo(grupoA.id);
                const horariosB = this.calcularHorariosOcupadosPorGrupo(grupoB.id);

                for (const horario of horariosA) {
                    if (!this.salonDisponibleEnBloque(salonB, grupoA, horario.horario, horario.dia)) {
                        return false;
                    }
                }

                for (const horario of horariosB) {
                    if (!this.salonDisponibleEnBloque(salonA, grupoB, horario.horario, horario.dia)) {
                        return false;
                    }
                }

                return true;
            }

            realizarIntercambioGrupos(grupoA, salonA, grupoB, salonB) {
                salonA.liberarHorarios(grupoA.id);
                salonB.liberarHorarios(grupoB.id);

                salonA.grupoAsignadoFijo = null;
                salonB.grupoAsignadoFijo = null;

                const horariosA = this.calcularHorariosOcupadosPorGrupo(grupoA.id);
                this.asignarSalonAGrupo(grupoA, salonB, horariosA, true);

                const horariosB = this.calcularHorariosOcupadosPorGrupo(grupoB.id);
                this.asignarSalonAGrupo(grupoB, salonA, horariosB, true);

                this.actualizarAsignacionesClases(grupoA.id, salonB);
                this.actualizarAsignacionesClases(grupoB.id, salonA);
            }

            actualizarAsignacionesClases(grupoId, nuevoSalon) {
                this.sistema.clases
                    .filter(clase => clase.grupoId === grupoId)
                    .forEach(clase => {
                        clase.salonActual = nuevoSalon.id;
                        clase.edificioActual = nuevoSalon.edificio;
                    });
            }
        }

        class AssignmentOptimizer {
            constructor(sistema) {
                this.sistema = sistema;
                this.config = CONFIG.asignacion;
            }

            optimize() {
                console.log('Iniciando optimización post-asignación');

                let mejoras = 0;
                const maxIteraciones = this.config.maxReintentos || 3;

                for (let iteracion = 0; iteracion < maxIteraciones; iteracion++) {
                    console.log(`Iteración de optimización ${iteracion + 1}/${maxIteraciones}`);

                    const reasignados = this.reasignarGruposSinSalon();
                    mejoras += reasignados;

                    if (mejoras === 0) {
                        console.log('No se encontraron mejoras en esta iteración');
                        break;
                    }
                }

                console.log('Optimización completada. Mejoras realizadas: ' + mejoras);
                return mejoras;
            }

            reasignarGruposSinSalon() {
                let reasignados = 0;
                const errores = [...this.sistema.errores];

                for (const error of errores) {
                    if (error.grupoId && error.mensaje.includes('No se pudo asignar')) {
                        const grupo = this.sistema.grupos.get(error.grupoId);
                        if (!grupo) continue;

                        const salonDisponible = this.encontrarSlotDisponibleParaGrupo(grupo);
                        if (salonDisponible) {
                            this.asignarGrupoASalon(grupo, salonDisponible);
                            this.sistema.errores = this.sistema.errores.filter(e => e !== error);
                            reasignados++;
                            console.log(`Reasignado grupo ${error.grupoId} a salón ${salonDisponible.id}`);
                        }
                    }
                }

                return reasignados;
            }

            encontrarSlotDisponibleParaGrupo(grupo) {
                for (const salon of this.sistema.salones) {
                    if (salon.grupoAsignadoFijo) continue;

                    try {
                        if (this.sistema.salonDisponibleParaTodasLasClases(salon, grupo)) {
                            return salon;
                        }
                    } catch (error) {
                        // Ignorar
                    }
                }
                return null;
            }

            asignarGrupoASalon(grupo, salon) {
                this.sistema.reservarSalonParaGrupo(salon, grupo);
            }
        }

        // ============================================
        // VARIABLES GLOBALES
        // ============================================

        let sistemaProcesado = null;
        const GRUPOS_PRIORITARIOS_KEY = 'grupos_prioritarios_guardados';

        // ============================================
        // FUNCIONES DE PERSISTENCIA
        // ============================================

        function guardarGruposPrioritarios(grupos) {
            localStorage.setItem(GRUPOS_PRIORITARIOS_KEY, JSON.stringify(grupos));
        }

        function cargarGruposPrioritarios() {
            const guardados = localStorage.getItem(GRUPOS_PRIORITARIOS_KEY);
            return guardados ? JSON.parse(guardados) : [];
        }

        function agregarGrupoPrioritario(grupoId) {
            const grupos = cargarGruposPrioritarios();
            if (!grupos.includes(grupoId)) {
                grupos.push(grupoId);
                guardarGruposPrioritarios(grupos);
            }
        }

        function quitarGrupoPrioritario(grupoId) {
            const grupos = cargarGruposPrioritarios();
            const index = grupos.indexOf(grupoId);
            if (index > -1) {
                grupos.splice(index, 1);
                guardarGruposPrioritarios(grupos);
            }
        }

        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================

        async function cargarArchivosYAsignar() {
            const inputArchivos = document.getElementById('input-archivos');
            const archivos = inputArchivos.files;

            if (archivos.length !== 5) {
                mostrarNotificacion('ERROR: Debe seleccionar exactamente 5 archivos CSV', 'error');
                return;
            }

            mostrarIndicadorCarga(true);

            try {
                const sistema = new SistemaAsignacion();
                sistema.inicializarSalones();

                const resultadoProcesamiento = await sistema.procesarMultiplesArchivos(archivos);

                if (!resultadoProcesamiento.exito) {
                    mostrarNotificacion(resultadoProcesamiento.mensaje, 'error');
                    return;
                }

                sistemaProcesado = sistema;

                mostrarModalGrupoPrioritario();

            } catch (error) {
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                mostrarIndicadorCarga(false);
            }
        }

        function mostrarModalGrupoPrioritario() {
            const modal = document.getElementById('modal-grupo-prioritario');
            const container = document.getElementById('grupos-prioritarios-container');
            const buscador = document.getElementById('buscador-grupos');
            const btnConfirmar = document.getElementById('btn-confirmar-prioridad');
            const btnCancelar = document.getElementById('btn-cancelar-prioridad');
            const modalClose = document.querySelector('.modal-close');
            const gruposGuardadosSection = document.getElementById('grupos-guardados-section');
            const gruposGuardadosList = document.getElementById('grupos-guardados-list');

            // Limpiar búsqueda y checkboxes anteriores
            buscador.value = '';
            container.innerHTML = '';
            gruposGuardadosList.innerHTML = '';

            // Mostrar grupos prioritarios guardados
            const gruposGuardados = cargarGruposPrioritarios();
            if (gruposGuardados.length > 0) {
                gruposGuardadosSection.style.display = 'block';
                gruposGuardados.forEach(grupoId => {
                    const tag = document.createElement('div');
                    tag.className = 'grupo-guardado-tag';

                    const span = document.createElement('span');
                    span.textContent = grupoId;

                    const btnQuitar = document.createElement('button');
                    btnQuitar.textContent = '×';
                    btnQuitar.title = `Quitar ${grupoId} de grupos prioritarios`;
                    btnQuitar.addEventListener('click', () => {
                        quitarGrupoPrioritario(grupoId);
                        mostrarModalGrupoPrioritario();
                        mostrarNotificacion(`Grupo ${grupoId} removido de prioridades`, 'info');
                    });

                    tag.appendChild(span);
                    tag.appendChild(btnQuitar);
                    gruposGuardadosList.appendChild(tag);
                });
            } else {
                gruposGuardadosSection.style.display = 'none';
            }

            // Agregar todos los grupos disponibles como checkboxes
            if (sistemaProcesado && sistemaProcesado.grupos) {
                const gruposOrdenados = Array.from(sistemaProcesado.grupos.keys()).sort();
                gruposOrdenados.forEach(grupoId => {
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = 'grupo-checkbox-item';
                    checkboxItem.dataset.grupoId = grupoId;

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `checkbox-${grupoId}`;
                    checkbox.value = grupoId;

                    if (gruposGuardados.includes(grupoId)) {
                        checkbox.checked = true;
                    }

                    const label = document.createElement('label');
                    label.htmlFor = `checkbox-${grupoId}`;
                    label.textContent = grupoId;

                    checkboxItem.appendChild(checkbox);
                    checkboxItem.appendChild(label);
                    container.appendChild(checkboxItem);
                });
            }

            // Función para filtrar grupos
            const filtrarGrupos = () => {
                const textoBusqueda = buscador.value.toLowerCase();
                const checkboxItems = container.querySelectorAll('.grupo-checkbox-item');

                checkboxItems.forEach(item => {
                    const grupoId = item.dataset.grupoId.toLowerCase();
                    if (grupoId.includes(textoBusqueda)) {
                        item.style.display = 'flex';
                    } else {
                        item.style.display = 'none';
                    }
                });
            };

            // Event listener para el buscador
            buscador.addEventListener('input', filtrarGrupos);

            // Función para continuar con la asignación
            const continuarAsignacion = () => {
                const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
                const gruposPrioritarios = Array.from(checkboxes).map(cb => cb.value);

                guardarGruposPrioritarios(gruposPrioritarios);

                ocultarModal();

                if (!sistemaProcesado) {
                    mostrarNotificacion('Error: Sistema no inicializado', 'error');
                    return;
                }

                mostrarIndicadorCarga(true);

                try {
                    sistemaProcesado.ordenarClasesConPrioridades(gruposPrioritarios);

                    const asignador = new AsignadorAutomatico(sistemaProcesado, gruposPrioritarios);
                    asignador.asignarSalones();

                    const mensajePrioritarios = gruposPrioritarios.length > 0
                        ? ` Grupos prioritarios (1er piso obligatorio): ${gruposPrioritarios.join(', ')}.`
                        : '';
                    const mensajeDivididos = asignador.gruposDivididos.size > 0
                        ? ` ${asignador.gruposDivididos.size} grupo(s) dividido(s) en dos salones.`
                        : '';
                    mostrarNotificacion(`Procesamiento completado. ${sistemaProcesado.asignaciones.length} clases asignadas. ${sistemaProcesado.clasesLaboratorio.length} clases de laboratorio excluidas.${mensajePrioritarios}${mensajeDivididos}`, 'exito');

                    // Optimización post-asignación
                    const optimizer = new AssignmentOptimizer(sistemaProcesado);
                    const mejoras = optimizer.optimize();

                    // Guardar resultados en Google Sheets
                    if (sistemaProcesado.asignaciones.length > 0) {
                        mostrarNotificacion('Guardando resultados en Google Sheets...', 'info');
                        google.script.run
                            .withSuccessHandler((response) => {
                                if (response && response.success) {
                                    mostrarNotificacion('Resultados guardados correctamente en la hoja "Resultados_Acomodo"', 'exito');
                                } else {
                                    console.error('Error al guardar:', response);
                                    mostrarNotificacion('Error al guardar en hoja: ' + (response ? response.message : 'Desconocido'), 'error');
                                }
                            })
                            .withFailureHandler((error) => {
                                console.error('Fallo de red al guardar:', error);
                                mostrarNotificacion('Error de conexión al guardar en Google Sheets', 'error');
                            })
                            .guardarResultadosAsignacion(sistemaProcesado.asignaciones);
                    }

                    // Generar y mostrar reporte
                    const reporte = sistemaProcesado.generarReporte(asignador.gruposDivididos);
                    mostrarReporte(reporte);

                    // Actualizar visualización de salones
                    mostrarSalonesEnInterfaz(sistemaProcesado.salones, asignador.gruposDivididos);

                    // Poblar tabla de asignación
                    poblarTablaAsignacion(sistemaProcesado.asignaciones);

                } catch (error) {
                    mostrarNotificacion(`Error en asignación: ${error.message}`, 'error');
                } finally {
                    mostrarIndicadorCarga(false);
                }
            };

            // Función para ocultar modal y limpiar event listeners
            const ocultarModal = () => {
                modal.classList.remove('show');
                btnConfirmar.removeEventListener('click', confirmarHandler);
                btnCancelar.removeEventListener('click', cancelarHandler);
                modalClose.removeEventListener('click', closeHandler);
                modal.removeEventListener('click', modalClickHandler);
                buscador.removeEventListener('input', filtrarGrupos);
            };

            // Event handlers
            const confirmarHandler = () => {
                const checkboxesMarcados = container.querySelectorAll('input[type="checkbox"]:checked');
                if (checkboxesMarcados.length === 0) {
                    mostrarNotificacion('Por favor seleccione al menos un grupo prioritario', 'advertencia');
                    return;
                }
                continuarAsignacion();
            };

            const cancelarHandler = () => {
                ocultarModal();
                mostrarNotificacion('Asignación cancelada por el usuario', 'info');
            };

            const closeHandler = () => {
                ocultarModal();
            };

            const modalClickHandler = (e) => {
                if (e.target === modal) {
                    ocultarModal();
                }
            };

            // Agregar event listeners
            btnConfirmar.addEventListener('click', confirmarHandler);
            btnCancelar.addEventListener('click', cancelarHandler);
            modalClose.addEventListener('click', closeHandler);
            modal.addEventListener('click', modalClickHandler);

            // Mostrar modal
            modal.classList.add('show');
        }

        function ocultarModal() {
            const modal = document.getElementById('modal-grupo-prioritario');
            modal.classList.remove('show');
        }

        function mostrarSalonesEnInterfaz(salones, gruposDivididos = null) {
            const contenedor = document.getElementById('content-section');
            if (!contenedor) return;

            // Crear sección de visualización de salones
            const visualizationSection = document.createElement('section');
            visualizationSection.className = 'visualization-section';

            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'section-header';
            sectionHeader.innerHTML = `
                <h2><i class="fas fa-th"></i> Visualización de Salones</h2>
                <div class="view-controls">
                    <div class="filter-controls">
                        <select id="filtro-piso" class="filter-select">
                            <option value="all">Todos los pisos</option>
                            <option value="1">Piso 1</option>
                            <option value="2">Piso 2</option>
                            <option value="3">Piso 3</option>
                            <option value="4">Piso 4</option>
                        </select>
                        <select id="filtro-edificio" class="filter-select">
                            <option value="all">Todos los edificios</option>
                            <option value="D">Edificio D</option>
                            <option value="E">Edificio E</option>
                            <option value="F">Edificio F</option>
                        </select>
                    </div>
                    <div class="search-salon-wrapper">
                        <input type="text" id="buscador-salon" class="search-salon-input" placeholder="Buscar grupo en salones...">
                        <i class="fas fa-search search-salon-icon"></i>
                    </div>
                </div>
            `;

            visualizationSection.appendChild(sectionHeader);

            // Vista de piso
            const floorViewContainer = document.createElement('div');
            floorViewContainer.className = 'floor-view-container';

            const floorSelector = document.createElement('div');
            floorSelector.className = 'floor-selector';

            for (let i = 1; i <= 4; i++) {
                const floorBtn = document.createElement('button');
                floorBtn.className = 'floor-btn';
                if (i === 1) floorBtn.classList.add('active');
                floorBtn.textContent = `Piso ${i}`;
                floorBtn.dataset.floor = i;
                floorBtn.addEventListener('click', () => {
                    document.querySelectorAll('.floor-btn').forEach(btn => btn.classList.remove('active'));
                    floorBtn.classList.add('active');
                    mostrarPiso(i);
                });
                floorSelector.appendChild(floorBtn);
            }

            floorViewContainer.appendChild(floorSelector);

            const floorMap = document.createElement('div');
            floorMap.id = 'floor-map';
            floorViewContainer.appendChild(floorMap);

            visualizationSection.appendChild(floorViewContainer);

            // Vista de lista
            const contenedorSalones = document.createElement('div');
            contenedorSalones.id = 'contenedor-salones';
            contenedorSalones.className = 'salons-container';
            visualizationSection.appendChild(contenedorSalones);

            // Agregar sección al contenedor principal
            contenedor.innerHTML = '';
            contenedor.appendChild(visualizationSection);

            // Mostrar mensaje inicial de acomodo
            mostrarMensajeAcomodamiento();

            // Mostrar información de grupos divididos si hay
            if (gruposDivididos !== null) {
                if (gruposDivididos.size > 0) {
                    mostrarSeccionGruposDivididos(gruposDivididos);
                } else {
                    mostrarMensajeSinGruposDivididos();
                }
            }

            // Función para mostrar un piso específico
            function mostrarPiso(piso) {
                const salonesPiso = salones.filter(salon => salon.piso === piso);
                const edificioSalones = {};

                salonesPiso.forEach(salon => {
                    if (!edificioSalones[salon.edificio]) {
                        edificioSalones[salon.edificio] = [];
                    }
                    edificioSalones[salon.edificio].push(salon);
                });

                floorMap.innerHTML = '';

                for (const [edificio, salonesEdificio] of Object.entries(edificioSalones)) {
                    const edificioDiv = document.createElement('div');
                    edificioDiv.className = 'edificio';

                    const tituloEdificio = document.createElement('h3');
                    tituloEdificio.textContent = `Edificio ${edificio}`;
                    edificioDiv.appendChild(tituloEdificio);

                    const salonesGrid = document.createElement('div');
                    salonesGrid.className = 'salon-grid';

                    salonesEdificio.forEach(salon => {
                        const salonDiv = document.createElement('div');
                        salonDiv.className = `salon ${salon.asignacionesBloques?.length > 0 ? 'ocupado' : 'libre'}`;
                        salonDiv.dataset.salonId = salon.id;

                        const salonHeader = document.createElement('div');
                        salonHeader.className = 'salon-header';
                        salonHeader.innerHTML = `
                            <div class="salon-title">${salon.id}</div>
                            <div class="salon-capacity">Cap: ${salon.capacidad}${salon.accesible ? ' ♿' : ''}</div>
                        `;
                        salonDiv.appendChild(salonHeader);

                        const salonContent = document.createElement('div');
                        salonContent.className = 'salon-content';

                        const diasSemana = ['LUNES', 'MARTES', 'MIÉRCOLES', 'JUEVES', 'VIERNES'];

                        diasSemana.forEach(dia => {
                            const asignacionesDia = salon.asignacionesBloques?.filter(asig =>
                                asig.dia === dia
                            ) || [];

                            const asignacionesOrdenadas = asignacionesDia.sort((a, b) => {
                                return a.horario.horaInicio.localeCompare(b.horario.horaInicio);
                            });

                            const bloques = [];
                            let tiempoActual = 7 * 60;
                            const finJornada = 22 * 60;

                            asignacionesOrdenadas.forEach(asignacion => {
                                const inicioAsignacion = convertirHoraAMinutos(asignacion.horario.horaInicio);
                                const finAsignacion = convertirHoraAMinutos(asignacion.horario.horaFin);

                                if (inicioAsignacion > tiempoActual) {
                                    bloques.push({
                                        horaInicio: convertirMinutosAHora(tiempoActual),
                                        horaFin: convertirMinutosAHora(inicioAsignacion),
                                        estado: 'Libre',
                                        grupo: null
                                    });
                                }

                                bloques.push({
                                    horaInicio: asignacion.horario.horaInicio,
                                    horaFin: asignacion.horario.horaFin,
                                    estado: 'Asignado',
                                    grupo: asignacion.grupoId
                                });

                                tiempoActual = finAsignacion;
                            });

                            if (tiempoActual < finJornada) {
                                bloques.push({
                                    horaInicio: convertirMinutosAHora(tiempoActual),
                                    horaFin: convertirMinutosAHora(finJornada),
                                    estado: 'Libre',
                                    grupo: null
                                });
                            }

                            const diaDiv = document.createElement('div');
                            diaDiv.className = 'dia-calendario';

                            const diaTitle = document.createElement('h4');
                            diaTitle.textContent = `🗓️ ${dia}`;
                            diaDiv.appendChild(diaTitle);

                            const table = document.createElement('table');
                            table.className = 'tabla-calendario';

                            const thead = document.createElement('thead');
                            thead.innerHTML = `
                                <tr>
                                    <th>Hora</th>
                                    <th>Estado</th>
                                    <th>Grupo</th>
                                </tr>
                            `;
                            table.appendChild(thead);

                            const tbody = document.createElement('tbody');

                            if (bloques.length === 0) {
                                tbody.innerHTML = `<tr><td>07:00–22:00</td><td>🟩 Libre</td><td>—</td></tr>`;
                            } else {
                                bloques.forEach(block => {
                                    const tr = document.createElement('tr');
                                    const estado = block.estado === 'Asignado' ? '🟦 Asignado' : '🟩 Libre';
                                    const grupoText = block.grupo || '—';
                                    tr.innerHTML = `<td>${block.horaInicio}–${block.horaFin}</td><td>${estado}</td><td>${grupoText}</td>`;
                                    tbody.appendChild(tr);
                                });
                            }

                            table.appendChild(tbody);
                            diaDiv.appendChild(table);
                            salonContent.appendChild(diaDiv);
                        });

                        salonDiv.appendChild(salonContent);
                        salonesGrid.appendChild(salonDiv);
                    });

                    edificioDiv.appendChild(salonesGrid);
                    floorMap.appendChild(edificioDiv);
                };

                // Actualizar lista de salones
                actualizarListaSalones(salonesPiso);
            }

            function actualizarListaSalones(salonesPiso) {
                contenedorSalones.innerHTML = '';

                salonesPiso.forEach(salon => {
                    const salonDiv = document.createElement('div');
                    salonDiv.className = `salon ${salon.asignacionesBloques?.length > 0 ? 'ocupado' : 'libre'}`;
                    salonDiv.dataset.salonId = salon.id;

                    const salonHeader = document.createElement('div');
                    salonHeader.className = 'salon-header';
                    salonHeader.innerHTML = `
                        <div class="salon-title">${salon.id}</div>
                        <div class="salon-capacity">Cap: ${salon.capacidad}${salon.accesible ? ' ♿' : ''}</div>
                    `;
                    salonDiv.appendChild(salonHeader);

                    const salonContent = document.createElement('div');
                    salonContent.className = 'salon-content';

                    const asignacionesBloques = salon.asignacionesBloques || [];
                    if (asignacionesBloques.length === 0) {
                        salonContent.innerHTML = '<div class="sin-asignaciones">Sin asignaciones</div>';
                    } else {
                        const tabla = document.createElement('table');
                        tabla.className = 'tabla-calendario';

                        const thead = document.createElement('thead');
                        thead.innerHTML = `
                            <tr>
                                <th>Día</th>
                                <th>Horario</th>
                                <th>Grupo</th>
                            </tr>
                        `;
                        tabla.appendChild(thead);

                        const tbody = document.createElement('tbody');

                        asignacionesBloques.forEach(asignacion => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${asignacion.dia}</td>
                                <td>${asignacion.horario.horaInicio} - ${asignacion.horario.horaFin}</td>
                                <td>${asignacion.grupoId}</td>
                            `;
                            tbody.appendChild(tr);
                        });

                        tabla.appendChild(tbody);
                        salonContent.appendChild(tabla);
                    }

                    salonDiv.appendChild(salonContent);
                    contenedorSalones.appendChild(salonDiv);
                });
            }

            function convertirHoraAMinutos(hora) {
                const [horas, minutos] = hora.split(':').map(Number);
                return horas * 60 + minutos;
            }

            function convertirMinutosAHora(minutos) {
                const horas = Math.floor(minutos / 60);
                const mins = minutos % 60;
                return `${horas.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }

            // Configurar filtros
            const filtroPiso = document.getElementById('filtro-piso');
            const filtroEdificio = document.getElementById('filtro-edificio');

            filtroPiso.addEventListener('change', () => {
                const pisoSeleccionado = filtroPiso.value;
                if (pisoSeleccionado === 'all') {
                    mostrarPiso(1); // Mostrar piso 1 por defecto
                } else {
                    mostrarPiso(parseInt(pisoSeleccionado));
                }
            });

            filtroEdificio.addEventListener('change', () => {
                const edificioSeleccionado = filtroEdificio.value;
                const pisoActual = parseInt(document.querySelector('.floor-btn.active').dataset.floor);

                if (edificioSeleccionado === 'all') {
                    mostrarPiso(pisoActual);
                } else {
                    const salonesPiso = salones.filter(salon =>
                        salon.piso === pisoActual && salon.edificio === edificioSeleccionado
                    );
                    actualizarListaSalones(salonesPiso);

                    // Actualizar vista de mapa
                    const floorMap = document.getElementById('floor-map');
                    const edificioDiv = floorMap.querySelector(`.edificio:has(.salon[data-salon-id^="${edificioSeleccionado}-"])`);
                    if (edificioDiv) {
                        floorMap.innerHTML = '';
                        floorMap.appendChild(edificioDiv);
                    }
                }
            });

            // Configurar buscador
            const buscadorSalon = document.getElementById('buscador-salon');
            buscadorSalon.addEventListener('input', buscarSalonPorGrupo);

            function buscarSalonPorGrupo() {
                const grupoBuscado = buscadorSalon.value.trim().toLowerCase();
                const salones = document.querySelectorAll('.salon');

                if (!grupoBuscado) {
                    salones.forEach(salon => {
                        salon.classList.remove('destacado', 'oculto');
                    });
                    return;
                }

                let salonesEncontrados = [];
                let salonesNoEncontrados = [];

                salones.forEach(salon => {
                    const gruposEnSalon = Array.from(salon.querySelectorAll('.tabla-calendario td')).map(el =>
                        el.textContent.toLowerCase()
                    );

                    const contieneGrupo = gruposEnSalon.some(grupo => grupo.includes(grupoBuscado));

                    if (contieneGrupo) {
                        salon.classList.add('destacado');
                        salon.classList.remove('oculto');
                        salonesEncontrados.push(salon);
                    } else {
                        salon.classList.remove('destacado');
                        salon.classList.add('oculto');
                        salonesNoEncontrados.push(salon);
                    }
                });

                if (salonesEncontrados.length > 0) {
                    salonesEncontrados.forEach(salon => {
                        const pisoContainer = salon.closest('.piso');
                        if (pisoContainer) {
                            pisoContainer.insertBefore(salon, pisoContainer.firstElementChild);
                        }
                    });

                    requestAnimationFrame(() => {
                        const primerSalonEncontrado = salonesEncontrados[0];
                        if (primerSalonEncontrado) {
                            primerSalonEncontrado.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }
                    });
                }

                if (salonesEncontrados.length === 0) {
                    mostrarNotificacion(`No se encontró el grupo "${buscadorSalon.value.trim()}" en ningún salón asignado`, 'advertencia');
                } else {
                    mostrarNotificación(`Se encontraron ${salonesEncontrados.length} salón(es) con el grupo "${buscadorSalon.value.trim()}"`, 'info');
                }
            }

            // Mostrar piso 1 por defecto
            mostrarPiso(1);
        }

        function mostrarMensajeAcomodamiento() {
            const contenedor = document.getElementById('content-section');

            const mensaje = document.createElement('div');
            mensaje.className = 'mensaje-acomodo-inicial';
            mensaje.innerHTML = `
                <div class="mensaje-content">
                    <i class="fas fa-cogs"></i>
                    <h3>Primero el acomodamiento</h3>
                    <p>Procesando archivos y asignando salones...</p>
                </div>
            `;

            contenedor.appendChild(mensaje);
        }

        function mostrarSeccionGruposDivididos(gruposDivididos) {
            const contenedor = document.getElementById('content-section');

            const seccionDivididos = document.createElement('div');
            seccionDivididos.className = 'grupos-divididos-section';

            const header = document.createElement('div');
            header.className = 'grupos-divididos-header';
            header.innerHTML = `
                <h3><i class="fas fa-split"></i> Grupos Divididos en Dos Salones</h3>
                <p class="grupos-divididos-subtitle">Los siguientes grupos utilizan dos salones distintos durante la semana:</p>
            `;

            seccionDivididos.appendChild(header);

            const listaDivididos = document.createElement('div');
            listaDivididos.className = 'grupos-divididos-lista';

            const gruposOrdenados = Array.from(gruposDivididos.entries()).sort((a, b) => a[0].localeCompare(b[0]));

            gruposOrdenados.forEach(([grupoId, info]) => {
                const salon1 = info.salones[0];
                const salon2 = info.salones[1];
                const dias1 = info.dias[salon1.id].join(', ');
                const dias2 = info.dias[salon2.id].join(', ');

                const itemDividido = document.createElement('div');
                itemDividido.className = 'grupo-dividido-item';

                itemDividido.innerHTML = `
                    <div class="grupo-dividido-header">
                        <span class="grupo-id">Grupo ${grupoId}</span>
                        <span class="division-arrow">→</span>
                        <span class="salones-division">${salon1.id} / ${salon2.id}</span>
                    </div>
                    <div class="grupo-dividido-detalles">
                        <div class="salon-detalle">
                            <span class="salon-nombre">${salon1.id}:</span>
                            <span class="salon-dias">${dias1}</span>
                        </div>
                        <div class="salon-detalle">
                            <span class="salon-nombre">${salon2.id}:</span>
                            <span class="salon-dias">${dias2}</span>
                        </div>
                    </div>
                `;

                listaDivididos.appendChild(itemDividido);
            });

            seccionDivididos.appendChild(listaDivididos);

            contenedor.appendChild(seccionDivididos);
        }

        function mostrarMensajeSinGruposDivididos() {
            const contenedor = document.getElementById('content-section');

            const mensaje = document.createElement('div');
            mensaje.className = 'sin-grupos-divididos';
            mensaje.innerHTML = `
                <div class="mensaje-content">
                    <i class="fas fa-check-circle"></i>
                    <h3>Sin Grupos Divididos</h3>
                    <p>Todos los grupos han sido asignados a un solo salón durante toda la semana.</p>
                </div>
            `;

            contenedor.appendChild(mensaje);
        }

        function mostrarReporte(reporte) {
            const contenedor = document.getElementById('content-section');

            // Crear sección de reporte
            const reportSection = document.createElement('section');
            reportSection.className = 'report-section';

            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'section-header';
            sectionHeader.innerHTML = `
                <h2><i class="fas fa-chart-bar"></i> Reporte de Asignación</h2>
                <div class="report-controls">
                    <button id="btn-exportar-reporte" class="btn btn-secondary">
                        <i class="fas fa-download"></i> Exportar Reporte
                    </button>
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="table"><i class="fas fa-table"></i></button>
                        <button class="view-btn" data-view="cards"><i class="fas fa-th-large"></i></button>
                    </div>
                </div>
            `;
            reportSection.appendChild(sectionHeader);

            // Tarjetas de resumen
            const summaryCards = document.createElement('div');
            summaryCards.className = 'summary-cards';

            const summaryItems = [
                { icon: 'fa-door-open', title: 'Salones Utilizados', value: reporte.resumen.asignadas },
                { icon: 'fa-users', title: 'Grupos Asignados', value: reporte.resumen.asignadas },
                { icon: 'fa-percentage', title: 'Ocupación', value: 'N/A' },
                { icon: 'fa-exclamation-triangle', title: 'Conflictos', value: reporte.resumen.errores }
            ];

            summaryItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'summary-card';
                card.innerHTML = `
                    <div class="card-icon">
                        <i class="fas ${item.icon}"></i>
                    </div>
                    <div class="card-content">
                        <h3>${item.value}</h3>
                        <p>${item.title}</p>
                    </div>
                `;
                summaryCards.appendChild(card);
            });

            reportSection.appendChild(summaryCards);

            // Contenido del reporte
            const reportContent = document.createElement('div');
            reportContent.className = 'report-content';

            // Tabla de asignación
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';

            const table = document.createElement('table');
            table.className = 'assignment-table';
            table.id = 'tabla-asignacion';

            const thead = document.createElement('thead');
            thead.innerHTML = `
                <tr>
                    <th>Grupo</th>
                    <th>Materia</th>
                    <th>Salón</th>
                    <th>Piso</th>
                    <th>Horario</th>
                    <th>Días</th>
                    <th>Estado</th>
                </tr>
            `;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            tbody.id = 'tabla-asignacion-body';

            reporte.detalleAsignaciones.forEach(asignacion => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${asignacion.grupo}</td>
                    <td>${asignacion.clase}</td>
                    <td>${asignacion.salon}</td>
                    <td>-</td>
                    <td>${asignacion.horario}</td>
                    <td>${asignacion.dia}</td>
                    <td class="estado-asignado">Asignado</td>
                `;
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            tableContainer.appendChild(table);
            reportContent.appendChild(tableContainer);

            reportSection.appendChild(reportContent);
            contenedor.appendChild(reportSection);

            // Configurar botón de exportación
            document.getElementById('btn-exportar-reporte').addEventListener('click', () => {
                exportarReporteCSV(reporte);
            });

            // Configurar toggle de vista
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const view = btn.dataset.view;
                    if (view === 'cards') {
                        mostrarVistaTarjetas(reporte);
                    } else {
                        mostrarVistaTabla(reporte);
                    }
                });
            });
        }

        function mostrarVistaTabla(reporte) {
            const tableContainer = document.querySelector('.table-container');
            const cardsView = document.getElementById('cards-view');

            if (cardsView) {
                cardsView.style.display = 'none';
            }

            tableContainer.style.display = 'block';
        }

        function mostrarVistaTarjetas(reporte) {
            const tableContainer = document.querySelector('.table-container');
            const reportContent = document.querySelector('.report-content');

            tableContainer.style.display = 'none';

            let cardsView = document.getElementById('cards-view');
            if (!cardsView) {
                cardsView = document.createElement('div');
                cardsView.id = 'cards-view';
                cardsView.className = 'cards-view';
                reportContent.appendChild(cardsView);
            }

            cardsView.innerHTML = '';
            cardsView.style.display = 'grid';
            cardsView.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
            cardsView.style.gap = '20px';

            reporte.detalleAsignaciones.forEach(asignacion => {
                const card = document.createElement('div');
                card.className = 'summary-card';
                card.innerHTML = `
                    <div class="card-icon">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="card-content">
                        <h3>${asignacion.grupo}</h3>
                        <p>${asignacion.clase}</p>
                        <p>${asignacion.salon}</p>
                        <p>${asignacion.horario}</p>
                        <p>${asignacion.dia}</p>
                    </div>
                `;
                cardsView.appendChild(card);
            });
        }

        function exportarReporteCSV(reporte) {
            let csv = 'Grupo,Materia,Salón,Piso,Horario,Día,Estado\n';

            reporte.detalleAsignaciones.forEach(asignacion => {
                csv += `${asignacion.grupo},${asignacion.clase},${asignacion.salon},-,${asignacion.horario},${asignacion.dia},Asignado\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `asignacion_salones_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function poblarTablaAsignacion(asignaciones) {
            // Esta función ya se implementa en mostrarReporte
        }

        function loadSection(section) {
            const contentSection = document.getElementById('content-section');
            if (!contentSection) return;

            // Set active link
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`.sidebar-link[onclick*="loadSection('${section}')"]`);
            if (activeLink) activeLink.classList.add('active');

            if (section === 'asignacion') {
                // Mostrar sección de asignación (ya está cargada)
                return;
            } else if (section === 'visualizacion') {
                if (!sistemaProcesado) {
                    mostrarNotificacion('Primero debe procesar los archivos y asignar salones', 'advertencia');
                    return;
                }

                // Mostrar visualización de salones
                mostrarSalonesEnInterfaz(sistemaProcesado.salones);
            } else if (section === 'reportes') {
                if (!sistemaProcesado) {
                    mostrarNotificación('Primero debe procesar los archivos y asignar salones', 'advertencia');
                    return;
                }

                // Generar y mostrar reporte
                const reporte = sistemaProcesado.generarReporte();
                mostrarReporte(reporte);
            } else if (section === 'configuracion') {
                // Mostrar configuración
                contentSection.innerHTML = `
                    <div class="section-header">
                        <h1>Configuración del Sistema</h1>
                        <p>Configura las opciones del sistema</p>
                    </div>
                    
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="card-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="card-content">
                                <h3>Información del Sistema</h3>
                                <p>Versión 2.0</p>
                                <p>Desarrollado por LIDE - UABC</p>
                                <p>Última actualización: ${new Date().toLocaleDateString()}</p>
                            </div>
                        </div>
                        
                        <div class="summary-card">
                            <div class="card-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="card-content">
                                <h3>Configuración de Asignación</h3>
                                <p>Máximo de reintentos: ${CONFIG.asignacion.maxReintentos}</p>
                                <p>Estrategia de fallback: ${CONFIG.asignacion.estrategiaFallback}</p>
                                <p>Permitir reubicación: ${CONFIG.asignacion.permitirReubicacion ? 'Sí' : 'No'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Cerrar sidebar en móviles
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const sidebarOverlay = document.getElementById('sidebarOverlay');
                const menuToggle = document.getElementById('menuToggle');

                if (sidebar && sidebarOverlay && menuToggle) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');

                    const icon = menuToggle.querySelector('i');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            }
        }

        // ============================================
        // INICIALIZACIÓN
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            // Configurar evento para carga de archivos
            document.getElementById('btn-procesar').addEventListener('click', cargarArchivosYAsignar);

            // Configurar área de arrastrar y soltar archivos
            const fileDropArea = document.getElementById('file-drop-area');
            const inputArchivos = document.getElementById('input-archivos');
            const fileList = document.getElementById('file-list');

            fileDropArea.addEventListener('click', () => {
                inputArchivos.click();
            });

            fileDropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileDropArea.style.backgroundColor = 'rgba(76, 175, 80, 0.2)';
            });

            fileDropArea.addEventListener('dragleave', () => {
                fileDropArea.style.backgroundColor = 'rgba(0, 0, 0, 0.2)';
            });

            fileDropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileDropArea.style.backgroundColor = 'rgba(0, 0, 0, 0.2)';

                if (e.dataTransfer.files.length > 0) {
                    inputArchivos.files = e.dataTransfer.files;
                    actualizarListaArchivos();
                }
            });

            inputArchivos.addEventListener('change', actualizarListaArchivos);

            function actualizarListaArchivos() {
                fileList.innerHTML = '';

                for (const archivo of inputArchivos.files) {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';

                    const fileName = document.createElement('span');
                    fileName.innerHTML = `<i class="fas fa-file-csv"></i> ${archivo.name}`;

                    const removeButton = document.createElement('button');
                    removeButton.innerHTML = '<i class="fas fa-times"></i>';
                    removeButton.addEventListener('click', () => {
                        const dt = new DataTransfer();
                        const files = Array.from(inputArchivos.files);

                        for (let i = 0; i < files.length; i++) {
                            if (files[i] !== archivo) {
                                dt.items.add(files[i]);
                            }
                        }

                        inputArchivos.files = dt.files;
                        actualizarListaArchivos();
                    });

                    fileItem.appendChild(fileName);
                    fileItem.appendChild(removeButton);
                    fileList.appendChild(fileItem);
                }
            }

            // Configurar menú lateral
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (menuToggle && sidebar && sidebarOverlay) {
                menuToggle.addEventListener('click', function () {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');

                    const icon = menuToggle.querySelector('i');
                    if (sidebar.classList.contains('active')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });

                sidebarOverlay.addEventListener('click', function () {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');

                    const icon = menuToggle.querySelector('i');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                });
            }

            // Configurar logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function () {
                    Swal.fire({
                        title: '¿Cerrar sesión?',
                        text: '¿Estás seguro de que quieres salir del sistema?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#4CAF50',
                        cancelButtonColor: '#f44336',
                        confirmButtonText: 'Sí, cerrar sesión',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = 'Index.html';
                        }
                    });
                });
            }

            // Actualizar información del usuario
            const userName = localStorage.getItem('userName');
            const userAvatar = document.getElementById('userAvatar');
            const userNameElement = document.getElementById('userName');

            if (userName && userAvatar) {
                userAvatar.textContent = userName.charAt(0).toUpperCase();
            }

            if (userName && userNameElement) {
                userNameElement.textContent = userName;
            }
        });
    </script>
</body>

</html>